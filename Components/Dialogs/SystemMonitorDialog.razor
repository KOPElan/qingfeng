@using QingFeng.Services
@using QingFeng.Models
@using Microsoft.AspNetCore.Components
@inject ISystemMonitorService SystemMonitorService
@implements IDisposable

<div class="modal-content-custom">
    <div class="modal-header-custom">
        <h6>
            <i class="@Icons.Material.Filled.DashboardCustomize"></i>
            @(Title ?? "系统监控")
        </h6>
    </div>
    <div class="modal-body-custom">
        <div style="height: 70vh; overflow-y: auto;">
            @if (systemInfo != null)
            {
                <!-- CPU Information -->
                <div class="pa-4 mb-4">
                    <h5 class="mb-3">
                        <i class="@Icons.Material.Filled.Speed"></i>
                        CPU信息
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>核心数：</strong>@systemInfo.Cpu.CoreCount</p>
                            <p><strong>架构：</strong>@systemInfo.Cpu.ProcessorName</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>使用率：</strong>@systemInfo.Cpu.UsagePercent%</p>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" style="width: @systemInfo.Cpu.UsagePercent%" aria-valuenow="@systemInfo.Cpu.UsagePercent" aria-valuemin="0" aria-valuemax="100">
                                    @systemInfo.Cpu.UsagePercent%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memory Information -->
                <div class="pa-4 mb-4">
                    <h5 class="mb-3">
                        <i class="@Icons.Material.Filled.Memory"></i>
                        内存信息
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>总内存：</strong>@systemInfo.Memory.TotalGB GB</p>
                            <p><strong>已使用：</strong>@systemInfo.Memory.UsedGB GB</p>
                            <p><strong>可用：</strong>@systemInfo.Memory.AvailableGB GB</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>使用率：</strong>@systemInfo.Memory.UsagePercent%</p>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" style="width: @systemInfo.Memory.UsagePercent%" aria-valuenow="@systemInfo.Memory.UsagePercent" aria-valuemin="0" aria-valuemax="100">
                                    @systemInfo.Memory.UsagePercent%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Disk Information -->
                <div class="pa-4 mb-4">
                    <h5 class="mb-3">
                        <i class="@Icons.Material.Filled.Storage"></i>
                        磁盘信息
                    </h5>
                    @if (systemInfo.Disks != null && systemInfo.Disks.Any())
                    {
                        foreach (var disk in systemInfo.Disks)
                        {
                            <div class="pa-3 mb-3">
                                <h6>@disk.Name</h6>
                                <p><strong>挂载点：</strong>@disk.MountPoint</p>
                                <p><strong>文件系统：</strong>@disk.FileSystem</p>
                                <p><strong>总容量：</strong>@disk.TotalGB</p>
                                <p><strong>已使用：</strong>@disk.UsedGB</p>
                                <p><strong>可用：</strong>@disk.AvailableGB</p>
                                <p class="mb-2"><strong>使用率：</strong>@disk.UsagePercent%</p>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" style="width: @disk.UsagePercent%" aria-valuenow="@disk.UsagePercent" aria-valuemin="0" aria-valuemax="100">
                                        @disk.UsagePercent%
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Network Information -->
                <div class="pa-4 mb-4">
                    <h5 class="mb-3">
                        <i class="@Icons.Material.Filled.NetworkCheck"></i>
                        网络信息
                    </h5>
                    @if (systemInfo.Networks != null && systemInfo.Networks.Any())
                    {
                        foreach (var network in systemInfo.Networks)
                        {
                            <div class="pa-3 mb-3">
                                <h6>@network.Name</h6>
                                <p><strong>描述：</strong>@network.Description</p>
                                <p><strong>状态：</strong>@network.Status</p>
                                <p><strong>接收：</strong>@network.ReceivedMB</p>
                                <p><strong>发送：</strong>@network.SentMB</p>
                            </div>
                        }
                    }
                </div>
            }
            else
            {
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
            }
        </div>
    </div>
    <div class="modal-footer-custom">
        <button type="button" class="btn btn-custom" @onclick="RefreshData">刷新</button>
        <button type="button" class="btn btn-custom" @onclick="Close">关闭</button>
    </div>
</div>

@code {
    [Parameter] public string? Title { get; set; }
    
    private SystemResourceInfo? systemInfo;
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
        
        // Auto-refresh every 5 seconds using System.Threading.Timer for consistency
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task RefreshData()
    {
        try
        {
            systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing system info: {ex.Message}");
        }
    }

    private void Close() { /* Dialog managed by parent component */ }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
