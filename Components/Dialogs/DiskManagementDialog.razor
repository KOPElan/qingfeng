@using QingFeng.Services
@using QingFeng.Models
@inject IDiskManagementService DiskManagementService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Storage" Class="mr-2" />
            @(Title ?? "磁盘管理")
        </MudText>
    </TitleContent>
    <DialogContent>
        <div style="height: 70vh; overflow-y: auto;">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Refresh" 
                       OnClick="RefreshData" 
                       Class="mb-4">
                刷新
            </MudButton>

            @if (!string.IsNullOrEmpty(message))
            {
                <MudAlert Severity="@(isError ? Severity.Error : Severity.Success)" 
                          Class="mb-4" 
                          CloseIconClicked="@(() => message = string.Empty)">
                    @message
                </MudAlert>
            }

            <!-- Disk List -->
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h5" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Storage" Class="mr-2" />
                    磁盘列表
                </MudText>
                @if (disks != null && disks.Any())
                {
                    <MudTable Items="@disks" Hover="true" Striped="true" Dense="false">
                        <HeaderContent>
                            <MudTh>名称</MudTh>
                            <MudTh>挂载点</MudTh>
                            <MudTh>文件系统</MudTh>
                            <MudTh>总容量</MudTh>
                            <MudTh>已使用</MudTh>
                            <MudTh>可用</MudTh>
                            <MudTh>使用率</MudTh>
                            <MudTh>状态</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="名称">@context.Name</MudTd>
                            <MudTd DataLabel="挂载点">@context.MountPoint</MudTd>
                            <MudTd DataLabel="文件系统">@context.FileSystem</MudTd>
                            <MudTd DataLabel="总容量">@(context.IsReady ? context.TotalGB : "N/A")</MudTd>
                            <MudTd DataLabel="已使用">@(context.IsReady ? context.UsedGB : "N/A")</MudTd>
                            <MudTd DataLabel="可用">@(context.IsReady ? context.AvailableGB : "N/A")</MudTd>
                            <MudTd DataLabel="使用率">
                                @if (context.IsReady)
                                {
                                    <MudProgressLinear Color="@GetProgressColor(context.UsagePercent)" 
                                                     Value="@context.UsagePercent" 
                                                     Size="Size.Small">
                                        <MudText Typo="Typo.body2">@context.UsagePercent%</MudText>
                                    </MudProgressLinear>
                                }
                                else
                                {
                                    <MudText>-</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="状态">
                                <MudChip T="string" Size="Size.Small" 
                                        Color="@(context.IsReady ? Color.Success : Color.Default)">
                                    @(context.IsReady ? "就绪" : "未就绪")
                                </MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else if (disks == null)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    <MudText Class="ml-2">加载中...</MudText>
                }
                else
                {
                    <MudText Color="Color.Secondary">没有找到磁盘</MudText>
                }
            </MudPaper>

            <!-- Mount/Unmount Section -->
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-4 mb-4">
                        <MudText Typo="Typo.h5" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.AddCircle" Class="mr-2" />
                            挂载磁盘
                        </MudText>
                        <MudTextField @bind-Value="devicePath" 
                                     Label="设备路径" 
                                     Variant="Variant.Outlined"
                                     Placeholder="/dev/sdb1"
                                     HelperText="例如：/dev/sdb1"
                                     Class="mb-3" />
                        <MudTextField @bind-Value="mountPoint" 
                                     Label="挂载点" 
                                     Variant="Variant.Outlined"
                                     Placeholder="/mnt/disk1"
                                     HelperText="例如：/mnt/disk1"
                                     Class="mb-3" />
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Success" 
                                  OnClick="MountDisk"
                                  Disabled="@isMounting"
                                  StartIcon="@Icons.Material.Filled.Upload">
                            @if (isMounting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">挂载中...</span>
                            }
                            else
                            {
                                <span>挂载</span>
                            }
                        </MudButton>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Elevation="2" Class="pa-4 mb-4">
                        <MudText Typo="Typo.h5" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.RemoveCircle" Class="mr-2" />
                            卸载磁盘
                        </MudText>
                        <MudTextField @bind-Value="unmountPoint" 
                                     Label="挂载点" 
                                     Variant="Variant.Outlined"
                                     Placeholder="/mnt/disk1"
                                     HelperText="输入要卸载的挂载点"
                                     Class="mb-3" />
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Error" 
                                  OnClick="UnmountDisk"
                                  Disabled="@isUnmounting"
                                  StartIcon="@Icons.Material.Filled.Eject">
                            @if (isUnmounting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">卸载中...</span>
                            }
                            else
                            {
                                <span>卸载</span>
                            }
                        </MudButton>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Shares Section -->
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h5" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Share" Class="mr-2" />
                    共享列表
                </MudText>
                @if (shares != null && shares.Any())
                {
                    <MudStack Spacing="2">
                        @foreach (var share in shares)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Folder" />
                                <MudText>@share</MudText>
                            </MudStack>
                        }
                    </MudStack>
                }
                else if (shares == null)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    <MudText Class="ml-2">加载中...</MudText>
                }
                else
                {
                    <MudText Color="Color.Secondary">没有找到共享</MudText>
                }
            </MudPaper>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Default">关闭</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public MudBlazor.IDialogReference? MudDialog { get; set; }
    [Parameter] public string? Title { get; set; }
    
    private List<DiskInfo>? disks;
    private List<string>? shares;
    private string devicePath = string.Empty;
    private string mountPoint = string.Empty;
    private string unmountPoint = string.Empty;
    private string message = string.Empty;
    private bool isError = false;
    private bool isMounting = false;
    private bool isUnmounting = false;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        disks = await DiskManagementService.GetAllDisksAsync();
        shares = await DiskManagementService.GetSharesAsync();
    }

    private async Task MountDisk()
    {
        if (string.IsNullOrWhiteSpace(devicePath) || string.IsNullOrWhiteSpace(mountPoint))
        {
            message = "请输入设备路径和挂载点";
            isError = true;
            return;
        }

        isMounting = true;
        message = string.Empty;
        
        try
        {
            var result = await DiskManagementService.MountDiskAsync(devicePath, mountPoint);
            message = result;
            isError = !result.Contains("Successfully");
            
            if (!isError)
            {
                devicePath = string.Empty;
                mountPoint = string.Empty;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            message = $"挂载失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isMounting = false;
        }
    }

    private async Task UnmountDisk()
    {
        if (string.IsNullOrWhiteSpace(unmountPoint))
        {
            message = "请输入挂载点";
            isError = true;
            return;
        }

        isUnmounting = true;
        message = string.Empty;
        
        try
        {
            var result = await DiskManagementService.UnmountDiskAsync(unmountPoint);
            message = result;
            isError = !result.Contains("Successfully");
            
            if (!isError)
            {
                unmountPoint = string.Empty;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            message = $"卸载失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isUnmounting = false;
        }
    }

    private Color GetProgressColor(double usagePercent)
    {
        if (usagePercent >= 90) return Color.Error;
        if (usagePercent >= 75) return Color.Warning;
        return Color.Success;
    }

    private void Close() => MudDialog?.Close();
}
