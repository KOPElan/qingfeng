@using QingFeng.Services
@using QingFeng.Models
@using Microsoft.AspNetCore.Components
@inject IDockerService DockerService

<div class="modal-content-custom">
    <div class="modal-header-custom">
        <h6>
            <i class="@Icons.Material.Filled.Article"></i>
            容器日志 - @ContainerName
        </h6>
    </div>
    <div class="modal-body-custom">
        @if (isLoadingLogs)
        {
            <div class="d-flex align-center justify-center pa-4">
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                <p class="ml-2">加载日志中...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(containerLogs))
        {
            <div class="pa-3" style="background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Courier New', monospace; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">
                @containerLogs
            </div>
        }
        else
        {
            <p>没有日志数据</p>
        }
    </div>
    <div class="modal-footer-custom">
        <button type="button" class="btn btn-custom" @onclick="RefreshLogs" disabled="@isLoadingLogs">刷新</button>
        <button type="button" class="btn btn-custom" @onclick="Close">关闭</button>
    </div>
</div>

@code {
    [Parameter] public string? ContainerId { get; set; }
    [Parameter] public string? ContainerName { get; set; }
    [Parameter] public EventCallback OnCloseDialog { get; set; }
    
    private bool isLoadingLogs = false;
    private string containerLogs = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        if (string.IsNullOrEmpty(ContainerId))
            return;

        isLoadingLogs = true;
        containerLogs = string.Empty;
        
        try
        {
            containerLogs = await DockerService.GetContainerLogsAsync(ContainerId, 1000);
            if (string.IsNullOrEmpty(containerLogs))
            {
                containerLogs = "没有日志数据";
            }
        }
        catch (Exception ex)
        {
            containerLogs = $"加载日志失败: {ex.Message}";
        }
        finally
        {
            isLoadingLogs = false;
        }
    }

    private async Task RefreshLogs()
    {
        await LoadLogs();
    }

    private async Task Close()
    {
        if (OnCloseDialog.HasDelegate)
        {
            await OnCloseDialog.InvokeAsync();
        }
    }
}
