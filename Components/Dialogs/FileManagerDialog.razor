@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Utilities
@inject IFileManagerService FileManagerService

<div class="modal-content-custom">
    <div class="modal-header-custom">
        <h6>
            <i class="@Icons.Material.Filled.Folder"></i>
            @(Title ?? "文件管理器")
        </h6>
    </div>
    <div class="modal-body-custom">
        <div style="height: 70vh; overflow: hidden; display: flex; flex-direction: column;">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mb-2">
                    @errorMessage
                    <button type="button" class="btn-close" @onclick="@(() => errorMessage = string.Empty)" aria-label="Close"></button>
                </div>
            }
            <!-- Toolbar -->
            <div style="padding: 12px 0; border-bottom: 1px solid var(--mud-palette-divider); display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                <button type="button" class="btn btn-link text-white" @onclick="GoBack" disabled="@(navigationHistory.Count <= 1)">
                    <i class="@Icons.Material.Filled.ArrowBack"></i>
                </button>
                <button type="button" class="btn btn-link text-white" @onclick="GoForward" disabled="@(forwardHistory.Count == 0)">
                    <i class="@Icons.Material.Filled.ArrowForward"></i>
                </button>
                
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                    <p class="small">Files</p>
                    @foreach (var part in GetPathParts())
                    {
                        <i class="@Icons.Material.Filled.ChevronRight"></i>
                        <a class="clickable" @onclick="(() => NavigateTo(part.Path))">@part.Name</a>
                    }
                    @if (files != null)
                    {
                        <span style="font-size: 13px; color: var(--mud-palette-text-secondary); margin-left: 8px;">@files.Count 项</span>
                    }
                </div>
                
                <button type="button" class="btn btn-link text-white" @onclick="ToggleViewMode">
                    <i class="@(isGridView ? Icons.Material.Filled.ViewList : Icons.Material.Filled.ViewModule)"></i>
                </button>
            </div>
            
            <!-- File Grid/List View -->
            <div style="flex: 1; overflow-y: auto; padding: 16px;">
                @if (isGridView)
                {
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 16px;">
                        @if (files != null && files.Any())
                        {
                            @foreach (var file in files.Where(f => f.Name != ".."))
                            {
                                <div style="display: flex; flex-direction: column; align-items: center; padding: 8px; border-radius: 8px; cursor: pointer;" 
                                     @onclick="@(() => NavigateTo(file.Path))">
                                    @if (file.IsDirectory)
                                    {
                                        <i class="@Icons.Material.Filled.Folder"></i>
                                    }
                                    else
                                    {
                                        <i class="@Icons.Material.Filled.InsertDriveFile"></i>
                                    }
                                    <div style="font-size: 12px; text-align: center; word-break: break-word;">@file.Name</div>
                                </div>
                            }
                        }
                        else if (files == null)
                        {
                            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                        }
                    </div>
                }
                else
                {
                    @if (files != null && files.Any())
                    {
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>名称</th>
                                    <th>类型</th>
                                    <th>大小</th>
                                    <th>修改时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var file in files)
                                {
                                    <tr>
                                        <td>
                                            @if (file.IsDirectory)
                                            {
                                                <a @onclick="(() => NavigateTo(file.Path))" style="cursor: pointer;">
                                                    <i class="@Icons.Material.Filled.Folder me-2"></i>
                                                    @file.Name
                                                </a>
                                            }
                                            else
                                            {
                                                <div class="d-flex align-items-center">
                                                    <i class="@Icons.Material.Filled.InsertDriveFile me-2"></i>
                                                    <span>@file.Name</span>
                                                </div>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @(file.IsDirectory ? "badge-warning" : "badge-info")">
                                                @(file.IsDirectory ? "文件夹" : "文件")
                                            </span>
                                        </td>
                                        <td>@file.SizeDisplay</td>
                                        <td>@file.LastModified.ToString("yyyy-MM-dd HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else if (files == null)
                    {
                        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                        <p class="ml-2">加载中...</p>
                    }
                    else
                    {
                        <p>此目录为空</p>
                    }
                }
            </div>
            
            <!-- Status Bar -->
            <div style="padding: 8px 0; border-top: 1px solid var(--mud-palette-divider); display: flex; justify-content: space-between; align-items: center; font-size: 13px; flex-shrink: 0;">
                <div style="color: var(--mud-palette-text-secondary);">
                    @GetSimplifiedPath()
                </div>
                <div style="color: var(--mud-palette-text-secondary);">
                    @if (storageTotal > 0)
                    {
                        <span>@FileUtilities.FormatSize(storageAvailable) 可用/@FileUtilities.FormatSize(storageTotal)</span>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer-custom">
        <button type="button" class="btn btn-custom" @onclick="Close">关闭</button>
    </div>
</div>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public EventCallback OnCloseDialog { get; set; }
    
    private List<FileItemInfo>? files;
    private string currentPath = string.Empty;
    private bool isGridView = true;
    private long storageTotal = 0;
    private long storageAvailable = 0;
    private string errorMessage = string.Empty;
    
    private Stack<string> navigationHistory = new Stack<string>();
    private Stack<string> forwardHistory = new Stack<string>();

    protected override async Task OnInitializedAsync()
    {
        // Start at user's home directory
        currentPath = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        if (string.IsNullOrEmpty(currentPath))
        {
            currentPath = "/";
        }
        
        navigationHistory.Push(currentPath);
        await RefreshFiles();
    }

    private async Task RefreshFiles()
    {
        try
        {
            files = await FileManagerService.GetFilesAsync(currentPath);
            var storage = await FileManagerService.GetStorageInfoAsync(currentPath);
            storageTotal = storage.total;
            storageAvailable = storage.available;
        }
        catch (Exception ex)
        {
            errorMessage = $"加载文件列表失败: {ex.Message}";
        }
    }

    private async Task NavigateTo(string path)
    {
        if (Directory.Exists(path))
        {
            if (currentPath != path)
            {
                navigationHistory.Push(currentPath);
                forwardHistory.Clear();
            }
            
            currentPath = path;
            await RefreshFiles();
        }
        else if (File.Exists(path))
        {
            // File navigation is not supported in this dialog
            errorMessage = $"无法打开文件: {Path.GetFileName(path)}。此对话框仅支持浏览文件夹。";
        }
    }

    private async Task GoBack()
    {
        if (navigationHistory.Count > 1)
        {
            forwardHistory.Push(currentPath);
            navigationHistory.Pop();
            currentPath = navigationHistory.Peek();
            await RefreshFiles();
        }
    }

    private async Task GoForward()
    {
        if (forwardHistory.Count > 0)
        {
            navigationHistory.Push(currentPath);
            currentPath = forwardHistory.Pop();
            await RefreshFiles();
        }
    }

    private void ToggleViewMode()
    {
        isGridView = !isGridView;
    }

    private List<(string Name, string Path)> GetPathParts()
    {
        var parts = new List<(string Name, string Path)>();
        
        if (string.IsNullOrEmpty(currentPath))
            return parts;
        
        var path = currentPath;
        var pathSegments = new List<string>();
        
        while (!string.IsNullOrEmpty(path))
        {
            var dirInfo = new DirectoryInfo(path);
            if (dirInfo.Parent == null)
            {
                pathSegments.Insert(0, path);
                break;
            }
            pathSegments.Insert(0, dirInfo.Name);
            path = dirInfo.Parent.FullName;
        }
        
        var currentBuild = "";
        foreach (var segment in pathSegments)
        {
            if (string.IsNullOrEmpty(currentBuild))
            {
                currentBuild = segment;
            }
            else
            {
                currentBuild = Path.Combine(currentBuild, segment);
            }
            parts.Add((segment, currentBuild));
        }
        
        return parts;
    }

    private string GetSimplifiedPath()
    {
        if (string.IsNullOrEmpty(currentPath))
            return "/";
        
        var parts = currentPath.Split(Path.DirectorySeparatorChar, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length <= 3)
            return $"/ {string.Join(" / ", parts)}";
        
        return $"/ {parts[0]} / ... / {parts[parts.Length - 1]}";
    }

    private async Task Close()
    {
        if (OnCloseDialog.HasDelegate)
        {
            await OnCloseDialog.InvokeAsync();
        }
    }
}
