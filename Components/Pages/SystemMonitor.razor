@page "/system-monitor"
@using QingFeng.Services
@using QingFeng.Models
@inject ISystemMonitorService SystemMonitorService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>ç³»ç»Ÿç›‘æ§</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Style="padding: 2rem;">
    <FluentLabel Typo="Typography.H3">ğŸ“Š ç³»ç»Ÿç›‘æ§</FluentLabel>

    <FluentButton Appearance="Appearance.Accent" OnClick="RefreshData" Style="align-self: flex-start; margin-bottom: 1rem;">
        ğŸ”„ åˆ·æ–°
    </FluentButton>

    @if (systemInfo != null)
    {
        <!-- CPU Information -->
        <FluentCard Style="margin-bottom: 1.5rem;">
            <FluentLabel Typo="Typography.H5">
                âš¡ CPUä¿¡æ¯
            </FluentLabel>
            <FluentStack Orientation="Orientation.Horizontal" Style="gap: 2rem; margin-top: 1rem;">
                <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                    <FluentLabel><strong>æ ¸å¿ƒæ•°ï¼š</strong>@systemInfo.Cpu.CoreCount</FluentLabel>
                    <FluentLabel><strong>æ¶æ„ï¼š</strong>@systemInfo.Cpu.ProcessorName</FluentLabel>
                </FluentStack>
                <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                    <FluentLabel><strong>ä½¿ç”¨ç‡ï¼š</strong>@systemInfo.Cpu.UsagePercent%</FluentLabel>
                    <FluentProgress Value="@((int)Math.Round(systemInfo.Cpu.UsagePercent))" Max="100" Style="width: 100%;" aria-label="CPUä½¿ç”¨ç‡" />
                </FluentStack>
            </FluentStack>
        </FluentCard>

        <!-- Memory Information -->
        <FluentCard Style="margin-bottom: 1.5rem;">
            <FluentLabel Typo="Typography.H5">
                ğŸ’¾ å†…å­˜ä¿¡æ¯
            </FluentLabel>
            <FluentStack Orientation="Orientation.Horizontal" Style="gap: 2rem; margin-top: 1rem;">
                <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                    <FluentLabel><strong>æ€»å†…å­˜ï¼š</strong>@systemInfo.Memory.TotalGB GB</FluentLabel>
                    <FluentLabel><strong>å·²ä½¿ç”¨ï¼š</strong>@systemInfo.Memory.UsedGB GB</FluentLabel>
                    <FluentLabel><strong>å¯ç”¨ï¼š</strong>@systemInfo.Memory.AvailableGB GB</FluentLabel>
                </FluentStack>
                <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                    <FluentLabel><strong>ä½¿ç”¨ç‡ï¼š</strong>@systemInfo.Memory.UsagePercent%</FluentLabel>
                    <FluentProgress Value="@((int)Math.Round(systemInfo.Memory.UsagePercent))" Max="100" Style="width: 100%;" aria-label="å†…å­˜ä½¿ç”¨ç‡" />
                </FluentStack>
            </FluentStack>
        </FluentCard>

        <!-- Disk Information -->
        <FluentCard Style="margin-bottom: 1.5rem;">
            <FluentLabel Typo="Typography.H5">
                ğŸ’¿ ç£ç›˜ä¿¡æ¯
            </FluentLabel>
            @if (systemInfo.Disks.Any())
            {
                <table style="width: 100%; border-collapse: collapse;" style="width: 100%; margin-top: 1rem;" role="table" aria-label="ç£ç›˜ä¿¡æ¯è¡¨">
                    <thead>
                        <tr>
                            <th scope="col">åç§°</th>
                            <th scope="col">æŒ‚è½½ç‚¹</th>
                            <th scope="col">æ–‡ä»¶ç³»ç»Ÿ</th>
                            <th scope="col">æ€»å®¹é‡</th>
                            <th scope="col">å·²ä½¿ç”¨</th>
                            <th scope="col">å¯ç”¨</th>
                            <th scope="col">ä½¿ç”¨ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var disk in systemInfo.Disks)
                        {
                            <tr>
                                <td>@disk.Name</td>
                                <td>@disk.MountPoint</td>
                                <td>@disk.FileSystem</td>
                                <td>@(disk.IsReady ? disk.TotalGB : "N/A")</td>
                                <td>@(disk.IsReady ? disk.UsedGB : "N/A")</td>
                                <td>@(disk.IsReady ? disk.AvailableGB : "N/A")</td>
                                <td>
                                    @if (disk.IsReady)
                                    {
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <FluentProgress Value="@((int)Math.Round(disk.UsagePercent))" Max="100" Style="flex: 1; min-width: 0;" />
                                            <span>@disk.UsagePercent%</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <span>æœªå°±ç»ª</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <FluentLabel Style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰æ‰¾åˆ°ç£ç›˜ä¿¡æ¯</FluentLabel>
            }
        </FluentCard>

        <!-- Network Information -->
        <FluentCard Style="margin-bottom: 1.5rem;">
            <FluentLabel Typo="Typography.H5">
                ğŸŒ ç½‘ç»œä¿¡æ¯
            </FluentLabel>
            @if (systemInfo.Networks.Any())
            {
                <table style="width: 100%; border-collapse: collapse;" style="width: 100%; margin-top: 1rem;" role="table" aria-label="ç½‘ç»œæ¥å£ä¿¡æ¯è¡¨">
                    <thead>
                        <tr>
                            <th scope="col">åç§°</th>
                            <th scope="col">æè¿°</th>
                            <th scope="col">çŠ¶æ€</th>
                            <th scope="col">å·²å‘é€</th>
                            <th scope="col">å·²æ¥æ”¶</th>
                            <th scope="col">IPåœ°å€</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var network in systemInfo.Networks)
                        {
                            <tr>
                                <td>@network.Name</td>
                                <td>@network.Description</td>
                                <td>
                                    <FluentBadge Appearance="Appearance.Accent" 
                                                 BackgroundColor="@(network.Status == "Up" ? "var(--success)" : "var(--neutral-fill-secondary)")">
                                        @network.Status
                                    </FluentBadge>
                                </td>
                                <td>@network.SentMB</td>
                                <td>@network.ReceivedMB</td>
                                <td>
                                    @if (network.IpAddresses.Any())
                                    {
                                        <ul style="list-style: none; padding: 0; margin: 0;" role="list" aria-label="IPåœ°å€åˆ—è¡¨">
                                            @foreach (var ip in network.IpAddresses)
                                            {
                                                <li><FluentLabel Typo="Typography.Body" Style="font-size: 0.875rem;">@ip</FluentLabel></li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <FluentLabel Style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰æ‰¾åˆ°ç½‘ç»œæ¥å£ä¿¡æ¯</FluentLabel>
            }
        </FluentCard>
    }
    else
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="align-items: center; gap: 0.5rem;">
            <FluentProgressRing />
            <FluentLabel>åŠ è½½ä¸­...</FluentLabel>
        </FluentStack>
    }
</FluentStack>

<style>
    .fluent-table {
        border-collapse: collapse;
    }

    .fluent-table th {
        text-align: left;
        padding: calc(var(--design-unit) * 3px);
        border-bottom: calc(var(--stroke-width, 1px) * 2) solid var(--neutral-stroke-divider-rest);
        font-weight: 600;
    }

    .fluent-table td {
        padding: calc(var(--design-unit) * 3px);
        border-bottom: var(--stroke-width, 1px) solid var(--neutral-stroke-divider-rest);
        vertical-align: middle;
    }

    .fluent-table tr:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
</style>

@code {
    private SystemResourceInfo? systemInfo;
    private System.Threading.Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
        
        // Auto-refresh every 5 seconds
        timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task RefreshData()
    {
        systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
