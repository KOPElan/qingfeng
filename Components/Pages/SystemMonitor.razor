@page "/system-monitor"
@using QingFeng.Services
@using QingFeng.Models
@inject ISystemMonitorService SystemMonitorService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>系统监控</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">系统监控</MudText>

<MudButton Variant="Variant.Filled" 
           Color="Color.Primary" 
           StartIcon="@Icons.Material.Filled.Refresh" 
           OnClick="RefreshData" 
           Class="mb-4">
    刷新
</MudButton>

@if (systemInfo != null)
{
    <!-- CPU Information -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudText Typo="Typo.h5" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Speed" Class="mr-2" />
            CPU信息
        </MudText>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText><strong>核心数：</strong>@systemInfo.Cpu.CoreCount</MudText>
                <MudText><strong>架构：</strong>@systemInfo.Cpu.ProcessorName</MudText>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudText Class="mb-2"><strong>使用率：</strong>@systemInfo.Cpu.UsagePercent%</MudText>
                <MudProgressLinear Color="Color.Primary" 
                                   Value="@systemInfo.Cpu.UsagePercent" 
                                   Size="Size.Large">
                    <MudText Typo="Typo.body1" Color="Color.Surface">@systemInfo.Cpu.UsagePercent%</MudText>
                </MudProgressLinear>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Memory Information -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudText Typo="Typo.h5" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Memory" Class="mr-2" />
            内存信息
        </MudText>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText><strong>总内存：</strong>@systemInfo.Memory.TotalGB</MudText>
                <MudText><strong>已使用：</strong>@systemInfo.Memory.UsedGB</MudText>
                <MudText><strong>可用：</strong>@systemInfo.Memory.AvailableGB</MudText>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudText Class="mb-2"><strong>使用率：</strong>@systemInfo.Memory.UsagePercent%</MudText>
                <MudProgressLinear Color="Color.Secondary" 
                                   Value="@systemInfo.Memory.UsagePercent" 
                                   Size="Size.Large">
                    <MudText Typo="Typo.body1" Color="Color.Surface">@systemInfo.Memory.UsagePercent%</MudText>
                </MudProgressLinear>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Disk Information -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudText Typo="Typo.h5" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Storage" Class="mr-2" />
            磁盘信息
        </MudText>
        @if (systemInfo.Disks.Any())
        {
            <MudTable Items="@systemInfo.Disks" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>名称</MudTh>
                    <MudTh>挂载点</MudTh>
                    <MudTh>文件系统</MudTh>
                    <MudTh>总容量</MudTh>
                    <MudTh>已使用</MudTh>
                    <MudTh>可用</MudTh>
                    <MudTh>使用率</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="名称">@context.Name</MudTd>
                    <MudTd DataLabel="挂载点">@context.MountPoint</MudTd>
                    <MudTd DataLabel="文件系统">@context.FileSystem</MudTd>
                    <MudTd DataLabel="总容量">@(context.IsReady ? context.TotalGB : "N/A")</MudTd>
                    <MudTd DataLabel="已使用">@(context.IsReady ? context.UsedGB : "N/A")</MudTd>
                    <MudTd DataLabel="可用">@(context.IsReady ? context.AvailableGB : "N/A")</MudTd>
                    <MudTd DataLabel="使用率">
                        @if (context.IsReady)
                        {
                            <MudProgressLinear Color="Color.Info" 
                                             Value="@context.UsagePercent" 
                                             Size="Size.Small">
                                <MudText Typo="Typo.body2">@context.UsagePercent%</MudText>
                            </MudProgressLinear>
                        }
                        else
                        {
                            <MudText>未就绪</MudText>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Color="Color.Secondary">没有找到磁盘信息</MudText>
        }
    </MudPaper>

    <!-- Network Information -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudText Typo="Typo.h5" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.NetworkCheck" Class="mr-2" />
            网络信息
        </MudText>
        @if (systemInfo.Networks.Any())
        {
            <MudTable Items="@systemInfo.Networks" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>名称</MudTh>
                    <MudTh>描述</MudTh>
                    <MudTh>状态</MudTh>
                    <MudTh>已发送</MudTh>
                    <MudTh>已接收</MudTh>
                    <MudTh>IP地址</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="名称">@context.Name</MudTd>
                    <MudTd DataLabel="描述">@context.Description</MudTd>
                    <MudTd DataLabel="状态">
                        <MudChip T="string" Size="Size.Small" 
                                Color="@(context.Status == "Up" ? Color.Success : Color.Default)">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="已发送">@context.SentMB</MudTd>
                    <MudTd DataLabel="已接收">@context.ReceivedMB</MudTd>
                    <MudTd DataLabel="IP地址">
                        @if (context.IpAddresses.Any())
                        {
                            foreach (var ip in context.IpAddresses)
                            {
                                <MudText Typo="Typo.body2">@ip</MudText>
                            }
                        }
                        else
                        {
                            <MudText>-</MudText>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Color="Color.Secondary">没有找到网络接口信息</MudText>
        }
    </MudPaper>
}
else
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText Class="ml-2">加载中...</MudText>
}

@code {
    private SystemResourceInfo? systemInfo;
    private System.Threading.Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
        
        // Auto-refresh every 5 seconds
        timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task RefreshData()
    {
        systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
