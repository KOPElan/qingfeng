@page "/system-monitor"
@using QingFeng.Services
@using QingFeng.Models
@inject ISystemMonitorService SystemMonitorService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>系统监控</PageTitle>

<h3 Class="mb-4">系统监控</h3>

<button type="button" class="btn btn-custom-primary" 
           OnClick="RefreshData" 
           Class="mb-4">
    刷新
</button>

@if (systemInfo != null)
{
    <!-- CPU Information -->
    <div Class="pa-4 mb-4">
        <h5 Class="mb-3">
            <i class="@Icons.Material.Filled.Speed"></i>
            CPU信息
        </h5>
        <div class="row">
            <div class="col-md-6">
                <p><strong>核心数：</strong>@systemInfo.Cpu.CoreCount</p>
                <p><strong>架构：</strong>@systemInfo.Cpu.ProcessorName</p>
            </div>
            <div class="col-md-6">
                <p Class="mb-2"><strong>使用率：</strong>@systemInfo.Cpu.UsagePercent%</p>
                <MudProgressLinear 
                                   Value="@systemInfo.Cpu.UsagePercent">
                    <p Typo="Typo.body1">@systemInfo.Cpu.UsagePercent%</p>
                </MudProgressLinear>
            </div>
        </div>
    </div>

    <!-- Memory Information -->
    <div Class="pa-4 mb-4">
        <h5 Class="mb-3">
            <i class="@Icons.Material.Filled.Memory"></i>
            内存信息
        </h5>
        <div class="row">
            <div class="col-md-6">
                <p><strong>总内存：</strong>@systemInfo.Memory.TotalGB</p>
                <p><strong>已使用：</strong>@systemInfo.Memory.UsedGB</p>
                <p><strong>可用：</strong>@systemInfo.Memory.AvailableGB</p>
            </div>
            <div class="col-md-6">
                <p Class="mb-2"><strong>使用率：</strong>@systemInfo.Memory.UsagePercent%</p>
                <MudProgressLinear 
                                   Value="@systemInfo.Memory.UsagePercent">
                    <p Typo="Typo.body1">@systemInfo.Memory.UsagePercent%</p>
                </MudProgressLinear>
            </div>
        </div>
    </div>

    <!-- Disk Information -->
    <div Class="pa-4 mb-4">
        <h5 Class="mb-3">
            <i class="@Icons.Material.Filled.Storage"></i>
            磁盘信息
        </h5>
        @if (systemInfo.Disks.Any())
        {
            <table class="table table-custom"><tbody>
                <thead><tr>
                    <th>名称</th>
                    <th>挂载点</th>
                    <th>文件系统</th>
                    <th>总容量</th>
                    <th>已使用</th>
                    <th>可用</th>
                    <th>使用率</th>
                </tr></thead>
                <tr>
                    <td>@context.Name</td>
                    <td>@context.MountPoint</td>
                    <td>@context.FileSystem</td>
                    <td>@(context.IsReady ? context.TotalGB : "N/A")</td>
                    <td>@(context.IsReady ? context.UsedGB : "N/A")</td>
                    <td>@(context.IsReady ? context.AvailableGB : "N/A")</td>
                    <td>
                        @if (context.IsReady)
                        {
                            <MudProgressLinear 
                                             Value="@context.UsagePercent">
                                <p class="small">@context.UsagePercent%</p>
                            </MudProgressLinear>
                        }
                        else
                        {
                            <p>未就绪</p>
                        }
                    </td>
                </tr>
            </tbody></table>
        }
        else
        {
            <p>没有找到磁盘信息</p>
        }
    </div>

    <!-- Network Information -->
    <div Class="pa-4 mb-4">
        <h5 Class="mb-3">
            <i class="@Icons.Material.Filled.NetworkCheck"></i>
            网络信息
        </h5>
        @if (systemInfo.Networks.Any())
        {
            <table class="table table-custom"><tbody>
                <thead><tr>
                    <th>名称</th>
                    <th>描述</th>
                    <th>状态</th>
                    <th>已发送</th>
                    <th>已接收</th>
                    <th>IP地址</th>
                </tr></thead>
                <tr>
                    <td>@context.Name</td>
                    <td>@context.Description</td>
                    <td>
                        <span class="badge badge-custom Color="@(context.Status == "Up" ? Color.Success : Color.Default)">
                            @context.Status
                        </span>
                    </td>
                    <td>@context.SentMB</td>
                    <td>@context.ReceivedMB</td>
                    <td>
                        @if (context.IpAddresses.Any())
                        {
                            foreach (var ip in context.IpAddresses)
                            {
                                <p class="small">@ip</p>
                            }
                        }
                        else
                        {
                            <p>-</p>
                        }
                    </td>
                </tr>
            </tbody></table>
        }
        else
        {
            <p>没有找到网络接口信息</p>
        }
    </div>
}
else
{
    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    <p Class="ml-2">加载中...</p>
}

@code {
    private SystemResourceInfo? systemInfo;
    private System.Threading.Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
        
        // Auto-refresh every 5 seconds
        timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task RefreshData()
    {
        systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
