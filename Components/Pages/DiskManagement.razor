@page "/disk-management"
@using QingFeng.Services
@using QingFeng.Models
@inject IDiskManagementService DiskManagementService
@rendermode InteractiveServer

<PageTitle>磁盘管理</PageTitle>

<h3 class="mb-4">磁盘管理</h3>

<button type="button" class="btn btn-custom-primary mb-4" @onclick="RefreshData">
    <i class="@Icons.Material.Filled.Refresh me-2"></i>
    刷新
</button>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success") mb-4">
        @message
        <button type="button" class="btn-close" @onclick="@(() => message = string.Empty)" aria-label="Close"></button>
    </div>
}

<!-- Disk Information -->
<div class="card-custom p-4 mb-4">
    <h5 class="mb-3">
        <i class="@Icons.Material.Filled.Storage me-2"></i>
        磁盘列表
    </h5>
    @if (disks != null && disks.Any())
    {
        <table class="table table-custom">
            <thead>
                <tr>
                    <th>名称</th>
                    <th>挂载点</th>
                    <th>文件系统</th>
                    <th>总容量</th>
                    <th>已使用</th>
                    <th>可用</th>
                    <th>使用率</th>
                    <th>状态</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var disk in disks)
                {
                    <tr>
                        <td>@disk.Name</td>
                        <td>@disk.MountPoint</td>
                        <td>@disk.FileSystem</td>
                        <td>@(disk.IsReady ? disk.TotalGB : "N/A")</td>
                        <td>@(disk.IsReady ? disk.UsedGB : "N/A")</td>
                        <td>@(disk.IsReady ? disk.AvailableGB : "N/A")</td>
                        <td>
                            @if (disk.IsReady)
                            {
                                <div class="progress-custom" style="height: 20px;">
                                    <div class="progress-bar-custom" style="width: @disk.UsagePercent%">
                                        <small>@disk.UsagePercent%</small>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td>
                            <span class="badge @(disk.IsReady ? "badge-success" : "badge-custom")">
                                @(disk.IsReady ? "就绪" : "未就绪")
                            </span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else if (isLoading)
    {
        <div class="d-flex align-items-center gap-2">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0">加载中...</p>
        </div>
    }
    else
    {
        <p class="text-muted-custom">没有找到磁盘信息</p>
    }
</div>

<!-- Mount/Unmount Operations -->
<div class="row">
    <div class="col-md-6">
        <div class="card-custom p-4 mb-4">
            <h5 class="mb-3">
                <i class="@Icons.Material.Filled.AddCircle me-2"></i>
                挂载磁盘
            </h5>
            <div class="mb-3">
                <label class="form-label">设备路径或挂载点</label>
                <input type="text" class="form-control-custom" @bind="mountPoint" placeholder="例如: /dev/sdb1 或 /mnt/disk" />
            </div>
            <button type="button" class="btn btn-custom-primary" @onclick="MountDisk" disabled="@(string.IsNullOrWhiteSpace(mountPoint) || isProcessing)">
                @if (isProcessing && currentOperation == "mount")
                {
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                }
                else
                {
                    <i class="@Icons.Material.Filled.Upload me-2"></i>
                }
                挂载
            </button>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card-custom p-4 mb-4">
            <h5 class="mb-3">
                <i class="@Icons.Material.Filled.RemoveCircle me-2"></i>
                卸载磁盘
            </h5>
            <div class="mb-3">
                <label class="form-label">挂载点</label>
                <input type="text" class="form-control-custom" @bind="unmountPoint" placeholder="例如: /mnt/disk" />
            </div>
            <button type="button" class="btn btn-outline-danger" @onclick="UnmountDisk" disabled="@(string.IsNullOrWhiteSpace(unmountPoint) || isProcessing)">
                @if (isProcessing && currentOperation == "unmount")
                {
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                }
                else
                {
                    <i class="@Icons.Material.Filled.Eject me-2"></i>
                }
                卸载
            </button>
        </div>
    </div>
</div>

@code {
    private List<DiskInfo> disks = new();
    private string message = string.Empty;
    private bool isError = false;
    private bool isLoading = false;
    private bool isProcessing = false;
    private string currentOperation = string.Empty;
    private string mountPoint = string.Empty;
    private string unmountPoint = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        isLoading = true;
        try
        {
            disks = await DiskManagementService.GetAllDisksAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task MountDisk()
    {
        if (string.IsNullOrWhiteSpace(mountPoint))
            return;

        isProcessing = true;
        currentOperation = "mount";
        message = string.Empty;
        
        try
        {
            // Parse device and mount point from input (format: "/dev/sdb1 /mnt/disk")
            var parts = mountPoint.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            var device = parts.Length > 0 ? parts[0] : mountPoint;
            var mount = parts.Length > 1 ? parts[1] : "/mnt/" + System.IO.Path.GetFileName(device);
            
            var result = await DiskManagementService.MountDiskAsync(device, mount);
            message = result;
            isError = false;
            mountPoint = string.Empty;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"挂载失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }

    private async Task UnmountDisk()
    {
        if (string.IsNullOrWhiteSpace(unmountPoint))
            return;

        isProcessing = true;
        currentOperation = "unmount";
        message = string.Empty;
        
        try
        {
            var result = await DiskManagementService.UnmountDiskAsync(unmountPoint);
            message = result;
            isError = false;
            unmountPoint = string.Empty;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"卸载失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }
}
