@page "/disk-management"
@using QingFeng.Services
@using QingFeng.Models
@inject IDiskManagementService DiskManagementService
@rendermode InteractiveServer

<PageTitle>磁盘管理</PageTitle>

<h3 class="mb-4">磁盘管理</h3>

<div class="d-flex gap-2 mb-4">
    <button type="button" class="btn btn-custom-primary" @onclick="RefreshData">
        <i class="@Icons.Material.Filled.Refresh me-2"></i>
        刷新
    </button>
    <button type="button" class="btn btn-outline-primary" @onclick="ShowMountWizard">
        <i class="@Icons.Material.Filled.AddCircle me-2"></i>
        挂载向导
    </button>
</div>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success") mb-4">
        @message
        <button type="button" class="btn-close" @onclick="@(() => message = string.Empty)" aria-label="Close"></button>
    </div>
}

<!-- All Block Devices -->
<div class="card-custom p-4 mb-4">
    <h5 class="mb-3">
        <i class="@Icons.Material.Filled.Storage me-2"></i>
        所有磁盘设备
    </h5>
    @if (allDisks != null && allDisks.Any())
    {
        <div class="table-responsive">
            <table class="table table-custom">
                <thead>
                    <tr>
                        <th>设备</th>
                        <th>类型</th>
                        <th>大小</th>
                        <th>文件系统</th>
                        <th>挂载点</th>
                        <th>使用率</th>
                        <th>UUID</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var disk in allDisks)
                    {
                        <tr class="@(disk.Type == "disk" ? "fw-bold" : "")">
                            <td>
                                @if (disk.Type == "disk")
                                {
                                    <i class="@Icons.Material.Filled.Storage me-1"></i>
                                }
                                else
                                {
                                    <span class="ms-3"></span>
                                }
                                @disk.DevicePath
                                @if (disk.IsRemovable)
                                {
                                    <span class="badge bg-info ms-1">可移动</span>
                                }
                            </td>
                            <td>@disk.Type</td>
                            <td>@disk.SizeDisplay</td>
                            <td>@(string.IsNullOrEmpty(disk.FileSystem) ? "-" : disk.FileSystem)</td>
                            <td>@(string.IsNullOrEmpty(disk.MountPoint) ? "-" : disk.MountPoint)</td>
                            <td>
                                @if (disk.IsReady && disk.TotalBytes > 0)
                                {
                                    <div class="progress-custom" style="height: 20px;">
                                        <div class="progress-bar-custom" style="width: @disk.UsagePercent%">
                                            <small>@disk.UsagePercent%</small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td><small>@FormatUuid(disk.UUID)</small></td>
                            <td>
                                @if (!string.IsNullOrEmpty(disk.MountPoint))
                                {
                                    <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => UnmountDiskAction(disk.MountPoint)">
                                        <i class="@Icons.Material.Filled.Eject me-1"></i>
                                        卸载
                                    </button>
                                }
                                else if (disk.Type == "part" || disk.Type == "disk")
                                {
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => ShowMountWizardForDisk(disk)">
                                        <i class="@Icons.Material.Filled.AddCircle me-1"></i>
                                        挂载
                                    </button>
                                }
                                @if (disk.Type == "disk")
                                {
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-1" @onclick="() => ShowPowerManagement(disk)">
                                        <i class="@Icons.Material.Filled.Power me-1"></i>
                                        电源
                                    </button>
                                }
                            </td>
                        </tr>
                        @if (disk.Children != null)
                        {
                            @foreach (var child in disk.Children)
                            {
                                <tr>
                                    <td>
                                        <span class="ms-3">└─ </span>
                                        @child.DevicePath
                                    </td>
                                    <td>@child.Type</td>
                                    <td>@child.SizeDisplay</td>
                                    <td>@(string.IsNullOrEmpty(child.FileSystem) ? "-" : child.FileSystem)</td>
                                    <td>@(string.IsNullOrEmpty(child.MountPoint) ? "-" : child.MountPoint)</td>
                                    <td>
                                        @if (child.IsReady && child.TotalBytes > 0)
                                        {
                                            <div class="progress-custom" style="height: 20px;">
                                                <div class="progress-bar-custom" style="width: @child.UsagePercent%">
                                                    <small>@child.UsagePercent%</small>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td><small>@FormatUuid(child.UUID)</small></td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(child.MountPoint))
                                        {
                                            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => UnmountDiskAction(child.MountPoint)">
                                                <i class="@Icons.Material.Filled.Eject me-1"></i>
                                                卸载
                                            </button>
                                        }
                                        else if (child.Type == "part")
                                        {
                                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => ShowMountWizardForDisk(child)">
                                                <i class="@Icons.Material.Filled.AddCircle me-1"></i>
                                                挂载
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <div class="d-flex align-items-center gap-2">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0">加载中...</p>
        </div>
    }
    else
    {
        <p class="text-muted-custom">没有找到磁盘信息</p>
    }
</div>

<!-- Network Disks -->
<div class="card-custom p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
            <i class="@Icons.Material.Filled.SettingsEthernet me-2"></i>
            网络磁盘
        </h5>
        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ShowNetworkMountWizard">
            <i class="@Icons.Material.Filled.AddCircle me-1"></i>
            挂载网络磁盘
        </button>
    </div>
    @if (networkDisks != null && networkDisks.Any())
    {
        <div class="table-responsive">
            <table class="table table-custom">
                <thead>
                    <tr>
                        <th>类型</th>
                        <th>服务器</th>
                        <th>共享路径</th>
                        <th>挂载点</th>
                        <th>大小</th>
                        <th>使用率</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var disk in networkDisks)
                    {
                        <tr>
                            <td>
                                <span class="badge @(disk.DiskType == NetworkDiskType.CIFS ? "bg-primary" : "bg-success")">
                                    @disk.DiskType.ToString()
                                </span>
                            </td>
                            <td>@disk.Server</td>
                            <td>@disk.SharePath</td>
                            <td>@disk.MountPoint</td>
                            <td>@disk.SizeDisplay</td>
                            <td>
                                @if (disk.IsReady && disk.TotalBytes > 0)
                                {
                                    <div class="progress-custom" style="height: 20px;">
                                        <div class="progress-bar-custom" style="width: @disk.UsagePercent%">
                                            <small>@disk.UsagePercent%</small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => UnmountDiskAction(disk.MountPoint)">
                                    <i class="@Icons.Material.Filled.Eject me-1"></i>
                                    卸载
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <div class="d-flex align-items-center gap-2">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0">加载中...</p>
        </div>
    }
    else
    {
        <p class="text-muted-custom">没有挂载的网络磁盘</p>
    }
</div>

<!-- Mount Wizard Modal -->
@if (showMountWizard)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="@Icons.Material.Filled.AddCircle me-2"></i>
                        磁盘挂载向导
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideMountWizard"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(wizardMessage))
                    {
                        <div class="alert @(wizardError ? "alert-danger" : "alert-success") mb-3">
                            @wizardMessage
                            <button type="button" class="btn-close" @onclick="@(() => wizardMessage = string.Empty)"></button>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">设备路径 *</label>
                        <input type="text" class="form-control-custom" @bind="wizardDevicePath" placeholder="/dev/sdb1" />
                        <small class="form-text text-muted-custom">例如: /dev/sdb1</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">挂载点 *</label>
                        <input type="text" class="form-control-custom" @bind="wizardMountPoint" placeholder="/mnt/mydisk" />
                        <small class="form-text text-muted-custom">例如: /mnt/mydisk</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">文件系统类型（可选）</label>
                        <select class="form-control-custom" @bind="wizardFileSystem">
                            <option value="">自动检测</option>
                            @foreach (var fs in availableFileSystems)
                            {
                                <option value="@fs">@fs</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">挂载选项（可选）</label>
                        <input type="text" class="form-control-custom" @bind="wizardOptions" placeholder="defaults" />
                        <small class="form-text text-muted-custom">例如: defaults, rw, noatime</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">挂载类型 *</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mountType" id="tempMount" value="temp" @onchange="@(() => wizardPermanent = false)" checked="@(!wizardPermanent)">
                            <label class="form-check-label" for="tempMount">
                                临时挂载（仅当前会话，重启后失效）
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mountType" id="permMount" value="perm" @onchange="@(() => wizardPermanent = true)" checked="@wizardPermanent">
                            <label class="form-check-label" for="permMount">
                                永久挂载（写入 /etc/fstab，重启后自动挂载）
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideMountWizard">取消</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="ExecuteMountWizard" disabled="@(string.IsNullOrWhiteSpace(wizardDevicePath) || string.IsNullOrWhiteSpace(wizardMountPoint) || isProcessing)">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="@Icons.Material.Filled.Check me-1"></i>
                        挂载
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

<!-- Power Management Modal -->
@if (showPowerManagement)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="@Icons.Material.Filled.Power me-2"></i>
                        磁盘电源管理 - @selectedDiskForPower?.Name
                    </h5>
                    <button type="button" class="btn-close" @onclick="HidePowerManagement"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(powerMessage))
                    {
                        <div class="alert @(powerError ? "alert-danger" : "alert-success") mb-3">
                            @powerMessage
                            <button type="button" class="btn-close" @onclick="@(() => powerMessage = string.Empty)"></button>
                        </div>
                    }

                    <h6>当前状态</h6>
                    @if (!string.IsNullOrEmpty(powerStatus))
                    {
                        // 尝试从 hdparm 输出中解析关键信息
                        var lines = powerStatus
                            .Split(new[] { "\r\n", "\n" }, StringSplitOptions.RemoveEmptyEntries);
                        string deviceLine = lines.Length > 0 ? lines[0].Trim() : string.Empty;
                        string stateLine = lines.FirstOrDefault(
                            l => l.Contains("drive state is", StringComparison.OrdinalIgnoreCase)
                              || l.Contains("drive state:", StringComparison.OrdinalIgnoreCase)
                        );
                        string driveState = string.Empty;
                        if (!string.IsNullOrEmpty(stateLine))
                        {
                            var idx = stateLine.IndexOf(':');
                            driveState = idx >= 0 && idx + 1 < stateLine.Length
                                ? stateLine[(idx + 1)..].Trim()
                                : stateLine.Trim();
                        }
                        <div class="border rounded p-2 mb-2 bg-light">
                            @if (!string.IsNullOrEmpty(deviceLine))
                            {
                                <div><strong>设备:</strong> @deviceLine</div>
                            }
                            @if (!string.IsNullOrEmpty(driveState))
                            {
                                <div class="mt-1">
                                    <strong>电源状态:</strong> @driveState
                                </div>
                            }
                            else
                            {
                                <div class="mt-1 text-muted">
                                    无法从输出中解析详细电源状态，以下为原始信息。
                                </div>
                            }
                        </div>
                        <details class="mb-3">
                            <summary class="text-muted" style="cursor: pointer;">查看原始 hdparm 输出</summary>
                            <pre class="bg-light p-2 rounded mt-2 mb-0"><code>@powerStatus</code></pre>
                        </details>
                    }
                    else
                    {
                        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" @onclick="CheckPowerStatus">
                            查询状态
                        </button>
                    }

                    <h6 class="mt-3">自动休眠设置</h6>
                    <div class="mb-3">
                        <label class="form-label">休眠超时时间（分钟）</label>
                        <input type="number" class="form-control-custom" @bind="spinDownTimeout" min="0" max="240" />
                        <small class="form-text text-muted-custom">0 = 禁用自动休眠，1-240 分钟</small>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="SetSpinDown" disabled="@isProcessing">
                        @if (isProcessing && currentOperation == "spindown")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        设置休眠超时
                    </button>

                    <h6 class="mt-4">APM 电源管理级别</h6>
                    <div class="mb-3">
                        <label class="form-label">APM 级别（1-255）</label>
                        <input type="number" class="form-control-custom" @bind="apmLevel" min="1" max="255" />
                        <small class="form-text text-muted-custom">1 = 最省电，255 = 最高性能</small>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="SetApmLevel" disabled="@isProcessing">
                        @if (isProcessing && currentOperation == "apm")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        设置 APM 级别
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HidePowerManagement">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

<!-- Network Mount Wizard Modal -->
@if (showNetworkMountWizard)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="@Icons.Material.Filled.SettingsEthernet me-2"></i>
                        网络磁盘挂载向导
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideNetworkMountWizard"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(networkWizardMessage))
                    {
                        <div class="alert @(networkWizardError ? "alert-danger" : "alert-success") mb-3">
                            @networkWizardMessage
                            <button type="button" class="btn-close" @onclick="@(() => networkWizardMessage = string.Empty)"></button>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">网络磁盘类型 *</label>
                        <select class="form-control-custom" @bind="networkWizardType">
                            <option value="@NetworkDiskType.CIFS">CIFS/SMB (Windows共享)</option>
                            <option value="@NetworkDiskType.NFS">NFS (Linux共享)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">服务器地址 *</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardServer" placeholder="192.168.1.100 或 server.local" />
                        <small class="form-text text-muted-custom">服务器IP地址或主机名</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">共享路径 *</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardSharePath" placeholder="@(networkWizardType == NetworkDiskType.CIFS ? "share" : "export/path")" />
                        <small class="form-text text-muted-custom">
                            @if (networkWizardType == NetworkDiskType.CIFS)
                            {
                                <text>Windows共享名称，如: share 或 Documents</text>
                            }
                            else
                            {
                                <text>NFS导出路径，如: export/data 或 mnt/storage</text>
                            }
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">挂载点 *</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardMountPoint" placeholder="/mnt/network" />
                        <small class="form-text text-muted-custom">本地挂载目录，如: /mnt/network</small>
                    </div>

                    @if (networkWizardType == NetworkDiskType.CIFS)
                    {
                        <div class="mb-3">
                            <label class="form-label">用户名（可选）</label>
                            <input type="text" class="form-control-custom" @bind="networkWizardUsername" placeholder="username" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">密码（可选）</label>
                            <input type="password" class="form-control-custom" @bind="networkWizardPassword" placeholder="password" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">域（可选）</label>
                            <input type="text" class="form-control-custom" @bind="networkWizardDomain" placeholder="WORKGROUP" />
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">挂载选项（可选）</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardOptions" placeholder="默认选项" />
                        <small class="form-text text-muted-custom">
                            @if (networkWizardType == NetworkDiskType.CIFS)
                            {
                                <text>如: vers=3.0,uid=1000,gid=1000</text>
                            }
                            else
                            {
                                <text>如: rw,sync,hard,intr</text>
                            }
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">挂载类型 *</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="networkMountType" id="networkTempMount" value="temp" @onchange="@(() => networkWizardPermanent = false)" checked="@(!networkWizardPermanent)">
                            <label class="form-check-label" for="networkTempMount">
                                临时挂载（仅当前会话，重启后失效）
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="networkMountType" id="networkPermMount" value="perm" @onchange="@(() => networkWizardPermanent = true)" checked="@networkWizardPermanent">
                            <label class="form-check-label" for="networkPermMount">
                                永久挂载（写入 /etc/fstab，重启后自动挂载）
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideNetworkMountWizard">取消</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="ExecuteNetworkMountWizard" disabled="@(string.IsNullOrWhiteSpace(networkWizardServer) || string.IsNullOrWhiteSpace(networkWizardSharePath) || string.IsNullOrWhiteSpace(networkWizardMountPoint) || isProcessing)">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="@Icons.Material.Filled.Check me-1"></i>
                        挂载
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private List<DiskInfo> allDisks = new();
    private List<string> availableFileSystems = new();
    private string message = string.Empty;
    private bool isError = false;
    private bool isLoading = false;
    private bool isProcessing = false;
    private string currentOperation = string.Empty;

    // Mount Wizard
    private bool showMountWizard = false;
    private string wizardDevicePath = string.Empty;
    private string wizardMountPoint = string.Empty;
    private string wizardFileSystem = string.Empty;
    private string wizardOptions = string.Empty;
    private bool wizardPermanent = false;
    private string wizardMessage = string.Empty;
    private bool wizardError = false;

    // Network Mount Wizard
    private bool showNetworkMountWizard = false;
    private NetworkDiskType networkWizardType = NetworkDiskType.CIFS;
    private string networkWizardServer = string.Empty;
    private string networkWizardSharePath = string.Empty;
    private string networkWizardMountPoint = string.Empty;
    private string networkWizardUsername = string.Empty;
    private string networkWizardPassword = string.Empty;
    private string networkWizardDomain = string.Empty;
    private string networkWizardOptions = string.Empty;
    private bool networkWizardPermanent = false;
    private string networkWizardMessage = string.Empty;
    private bool networkWizardError = false;
    private List<NetworkDiskInfo> networkDisks = new();

    // Power Management
    private bool showPowerManagement = false;
    private DiskInfo? selectedDiskForPower = null;
    private string powerStatus = string.Empty;
    private string powerMessage = string.Empty;
    private bool powerError = false;
    private int spinDownTimeout = 0;
    private int apmLevel = 128;

    protected override async Task OnInitializedAsync()
    {
        availableFileSystems = await DiskManagementService.GetAvailableFileSystemsAsync();
        await RefreshData();
    }

    private async Task RefreshData()
    {
        isLoading = true;
        try
        {
            allDisks = await DiskManagementService.GetAllBlockDevicesAsync();
            networkDisks = await DiskManagementService.GetNetworkDisksAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowMountWizard()
    {
        wizardDevicePath = string.Empty;
        wizardMountPoint = string.Empty;
        wizardFileSystem = string.Empty;
        wizardOptions = string.Empty;
        wizardPermanent = false;
        wizardMessage = string.Empty;
        wizardError = false;
        showMountWizard = true;
    }

    private void ShowMountWizardForDisk(DiskInfo disk)
    {
        wizardDevicePath = disk.DevicePath;
        wizardMountPoint = $"/mnt/{disk.Name}";
        wizardFileSystem = disk.FileSystem ?? string.Empty;
        wizardOptions = string.Empty;
        wizardPermanent = false;
        wizardMessage = string.Empty;
        wizardError = false;
        showMountWizard = true;
    }

    private void HideMountWizard()
    {
        showMountWizard = false;
    }

    private async Task ExecuteMountWizard()
    {
        if (string.IsNullOrWhiteSpace(wizardDevicePath) || string.IsNullOrWhiteSpace(wizardMountPoint))
            return;

        isProcessing = true;
        wizardMessage = string.Empty;

        try
        {
            string result;
            if (wizardPermanent)
            {
                result = await DiskManagementService.MountDiskPermanentAsync(
                    wizardDevicePath, 
                    wizardMountPoint, 
                    string.IsNullOrWhiteSpace(wizardFileSystem) ? null : wizardFileSystem,
                    string.IsNullOrWhiteSpace(wizardOptions) ? null : wizardOptions);
            }
            else
            {
                result = await DiskManagementService.MountDiskAsync(
                    wizardDevicePath, 
                    wizardMountPoint, 
                    string.IsNullOrWhiteSpace(wizardFileSystem) ? null : wizardFileSystem,
                    string.IsNullOrWhiteSpace(wizardOptions) ? null : wizardOptions);
            }

            var operationResult = new
            {
                Success = result.Contains("Successfully", StringComparison.OrdinalIgnoreCase),
                Message = result
            };

            wizardMessage = operationResult.Message;
            wizardError = !operationResult.Success;
            if (!wizardError)
            {
                await RefreshData();
                await Task.Delay(2000);
                HideMountWizard();
            }
        }
        catch (Exception ex)
        {
            wizardMessage = $"挂载失败: {ex.Message}";
            wizardError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task UnmountDiskAction(string mountPoint)
    {
        if (string.IsNullOrWhiteSpace(mountPoint))
            return;

        isProcessing = true;
        message = string.Empty;

        try
        {
            var result = await DiskManagementService.UnmountDiskAsync(mountPoint);
            message = result;
            isError = !result.Contains("Successfully");
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"卸载失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowNetworkMountWizard()
    {
        networkWizardType = NetworkDiskType.CIFS;
        networkWizardServer = string.Empty;
        networkWizardSharePath = string.Empty;
        networkWizardMountPoint = string.Empty;
        networkWizardUsername = string.Empty;
        networkWizardPassword = string.Empty;
        networkWizardDomain = string.Empty;
        networkWizardOptions = string.Empty;
        networkWizardPermanent = false;
        networkWizardMessage = string.Empty;
        networkWizardError = false;
        showNetworkMountWizard = true;
    }

    private void HideNetworkMountWizard()
    {
        showNetworkMountWizard = false;
    }

    private async Task ExecuteNetworkMountWizard()
    {
        if (string.IsNullOrWhiteSpace(networkWizardServer) || 
            string.IsNullOrWhiteSpace(networkWizardSharePath) || 
            string.IsNullOrWhiteSpace(networkWizardMountPoint))
            return;

        isProcessing = true;
        networkWizardMessage = string.Empty;

        try
        {
            string result;
            if (networkWizardPermanent)
            {
                result = await DiskManagementService.MountNetworkDiskPermanentAsync(
                    networkWizardServer,
                    networkWizardSharePath,
                    networkWizardMountPoint,
                    networkWizardType,
                    string.IsNullOrWhiteSpace(networkWizardUsername) ? null : networkWizardUsername,
                    string.IsNullOrWhiteSpace(networkWizardPassword) ? null : networkWizardPassword,
                    string.IsNullOrWhiteSpace(networkWizardDomain) ? null : networkWizardDomain,
                    string.IsNullOrWhiteSpace(networkWizardOptions) ? null : networkWizardOptions);
            }
            else
            {
                result = await DiskManagementService.MountNetworkDiskAsync(
                    networkWizardServer,
                    networkWizardSharePath,
                    networkWizardMountPoint,
                    networkWizardType,
                    string.IsNullOrWhiteSpace(networkWizardUsername) ? null : networkWizardUsername,
                    string.IsNullOrWhiteSpace(networkWizardPassword) ? null : networkWizardPassword,
                    string.IsNullOrWhiteSpace(networkWizardDomain) ? null : networkWizardDomain,
                    string.IsNullOrWhiteSpace(networkWizardOptions) ? null : networkWizardOptions);
            }

            var operationResult = new
            {
                Success = result.Contains("Successfully", StringComparison.OrdinalIgnoreCase),
                Message = result
            };

            networkWizardMessage = operationResult.Message;
            networkWizardError = !operationResult.Success;
            if (!networkWizardError)
            {
                await RefreshData();
                await Task.Delay(2000);
                // Clear sensitive data from memory
                networkWizardPassword = string.Empty;
                HideNetworkMountWizard();
            }
        }
        catch (Exception ex)
        {
            networkWizardMessage = $"挂载失败: {ex.Message}";
            networkWizardError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowPowerManagement(DiskInfo disk)
    {
        selectedDiskForPower = disk;
        powerStatus = string.Empty;
        powerMessage = string.Empty;
        powerError = false;
        spinDownTimeout = 0;
        apmLevel = 128;
        showPowerManagement = true;
    }

    private void HidePowerManagement()
    {
        showPowerManagement = false;
        selectedDiskForPower = null;
    }

    private async Task CheckPowerStatus()
    {
        if (selectedDiskForPower == null)
            return;

        powerMessage = string.Empty;
        try
        {
            powerStatus = await DiskManagementService.GetDiskPowerStatusAsync(selectedDiskForPower.DevicePath);
        }
        catch (Exception ex)
        {
            powerMessage = $"查询失败: {ex.Message}";
            powerError = true;
        }
    }

    private async Task SetSpinDown()
    {
        if (selectedDiskForPower == null)
            return;

        isProcessing = true;
        currentOperation = "spindown";
        powerMessage = string.Empty;

        try
        {
            var result = await DiskManagementService.SetDiskSpinDownAsync(selectedDiskForPower.DevicePath, spinDownTimeout);
            powerMessage = result;
            powerError = !result.Contains("Set") && !result.Contains("Disabled");
        }
        catch (Exception ex)
        {
            powerMessage = $"设置失败: {ex.Message}";
            powerError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }

    private async Task SetApmLevel()
    {
        if (selectedDiskForPower == null)
            return;

        isProcessing = true;
        currentOperation = "apm";
        powerMessage = string.Empty;

        try
        {
            var result = await DiskManagementService.SetDiskApmLevelAsync(selectedDiskForPower.DevicePath, apmLevel);
            powerMessage = result;
            powerError = !result.Contains("Set");
        }
        catch (Exception ex)
        {
            powerMessage = $"设置失败: {ex.Message}";
            powerError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }

    private string FormatUuid(string uuid)
    {
        if (string.IsNullOrEmpty(uuid))
        {
            return "-";
        }
        
        return uuid.Length > 8 ? uuid[..8] + "..." : uuid;
    }
}
