@page "/disk-management"
@using QingFeng.Services
@using QingFeng.Models
@inject IDiskManagementService DiskManagementService
@rendermode InteractiveServer

<PageTitle>磁盘管理</PageTitle>

<h3 Class="mb-4">磁盘管理</h3>

<button type="button" class="btn btn-custom-primary" 
           OnClick="RefreshData" 
           Class="mb-4">
    刷新
</button>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert" class="@(isError ? "alert-danger" : "alert-success")" 
              Class="mb-4" 
              CloseIconClicked="@(() => message = string.Empty)">
        @message
    </div>
}

<!-- Disk List -->
<div Class="pa-4 mb-4">
    <h5 Class="mb-3">
        <i class="@Icons.Material.Filled.Storage"></i>
        磁盘列表
    </h5>
    @if (disks != null && disks.Any())
    {
        <table class="table table-custom"><tbody>
            <thead><tr>
                <th>名称</th>
                <th>挂载点</th>
                <th>文件系统</th>
                <th>总容量</th>
                <th>已使用</th>
                <th>可用</th>
                <th>使用率</th>
                <th>状态</th>
            </tr></thead>
            <tr>
                <td>@context.Name</td>
                <td>@context.MountPoint</td>
                <td>@context.FileSystem</td>
                <td>@(context.IsReady ? context.TotalGB : "N/A")</td>
                <td>@(context.IsReady ? context.UsedGB : "N/A")</td>
                <td>@(context.IsReady ? context.AvailableGB : "N/A")</td>
                <td>
                    @if (context.IsReady)
                    {
                        <div class="progress-custom"><div class="progress-bar-custom" style="width: @context.UsagePercent%">
                            <p class="small">@context.UsagePercent%</p>
                        </div></div>
                    }
                    else
                    {
                        <p>-</p>
                    }
                </td>
                <td>
                    <span class="badge badge-custom Color="@(context.IsReady ? Color.Success : Color.Default)">
                        @(context.IsReady ? "就绪" : "未就绪")
                    </span>
                </td>
            </tr>
        </tbody></table>
    }
    else if (disks == null)
    {
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p Class="ml-2">加载中...</p>
    }
    else
    {
        <p>没有找到磁盘</p>
    }
</div>

<!-- Mount/Unmount Section -->
<div class="row">
    <div class="col-md-6">
        <div Class="pa-4 mb-4">
            <h5 Class="mb-3">
                <i class="@Icons.Material.Filled.AddCircle"></i>
                挂载磁盘
            </h5>
            <pField @@bind-value="devicePath" 
                         Label="设备路径" placeholder="/dev/sdb1"
                         HelperText="例如：/dev/sdb1"
                         Class="mb-3" />
            <MudTextField @@bind-value="mountPoint" 
                         Label="挂载点" placeholder="/mnt/disk1"
                         HelperText="例如：/mnt/disk1"
                         Class="mb-3" />
            <button type="button" class="btn btn-custom-primary" 
                      OnClick="MountDisk" disabled="@isMounting">
                @if (isMounting)
                {
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <span class="ml-2">挂载中...</span>
                }
                else
                {
                    <span>挂载</span>
                }
            </button>
        </div>
    </div>

    <div class="col-md-6">
        <div Class="pa-4 mb-4">
            <h5 Class="mb-3">
                <i class="@Icons.Material.Filled.RemoveCircle"></i>
                卸载磁盘
            </h5>
            <MudTextField @@bind-value="unmountPoint" 
                         Label="挂载点" placeholder="/mnt/disk1"
                         HelperText="输入要卸载的挂载点"
                         Class="mb-3" />
            <button type="button" class="btn btn-custom-primary" 
                      OnClick="UnmountDisk" disabled="@isUnmounting">
                @if (isUnmounting)
                {
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <span class="ml-2">卸载中...</span>
                }
                else
                {
                    <span>卸载</span>
                }
            </button>
        </div>
    </div>
</div>

<!-- Shares Section -->
<div Class="pa-4 mb-4">
    <h5 Class="mb-3">
        <i class="@Icons.Material.Filled.Share"></i>
        共享列表
    </h5>
    @if (shares != null && shares.Any())
    {
        <div class="d-flex flex-column gap-2" Spacing="2">
            @foreach (var share in shares)
            {
                <div class="d-flex flex-column gap-2" Row="true" AlignItems="AlignItems.Center">
                    <i class="@Icons.Material.Filled.Folder"></i>
                    <span>@share</p>
                </div>
            }
        </div>
    }
    else if (shares == null)
    {
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p Class="ml-2">加载中...</p>
    }
    else
    {
        <p>没有找到共享</p>
    }
</div>

@code {
    private List<DiskInfo>? disks;
    private List<string>? shares;
    private string devicePath = string.Empty;
    private string mountPoint = string.Empty;
    private string unmountPoint = string.Empty;
    private string message = string.Empty;
    private bool isError = false;
    private bool isMounting = false;
    private bool isUnmounting = false;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        disks = await DiskManagementService.GetAllDisksAsync();
        shares = await DiskManagementService.GetSharesAsync();
    }

    private async Task MountDisk()
    {
        if (string.IsNullOrWhiteSpace(devicePath) || string.IsNullOrWhiteSpace(mountPoint))
        {
            message = "请输入设备路径和挂载点";
            isError = true;
            return;
        }

        isMounting = true;
        message = string.Empty;
        
        try
        {
            var result = await DiskManagementService.MountDiskAsync(devicePath, mountPoint);
            message = result;
            isError = !result.Contains("Successfully");
            
            if (!isError)
            {
                devicePath = string.Empty;
                mountPoint = string.Empty;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            message = $"挂载失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isMounting = false;
        }
    }

    private async Task UnmountDisk()
    {
        if (string.IsNullOrWhiteSpace(unmountPoint))
        {
            message = "请输入挂载点";
            isError = true;
            return;
        }

        isUnmounting = true;
        message = string.Empty;
        
        try
        {
            var result = await DiskManagementService.UnmountDiskAsync(unmountPoint);
            message = result;
            isError = !result.Contains("Successfully");
            
            if (!isError)
            {
                unmountPoint = string.Empty;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            message = $"卸载失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isUnmounting = false;
        }
    }

    private Color GetProgressColor(double usagePercent)
    {
        if (usagePercent >= 90) return Color.Error;
        if (usagePercent >= 75) return Color.Warning;
        return Color.Success;
    }
}
