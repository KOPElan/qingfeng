@page "/disk-management"
@using QingFeng.Services
@using QingFeng.Models
@inherits AuthorizedPageBase
@inject IDiskManagementService DiskManagementService
@rendermode InteractiveServer

<PageTitle>ç£ç›˜ç®¡ç†</PageTitle>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="padding: 2rem;">
<FluentLabel Typo="Typography.H3">ğŸ’¿ ç£ç›˜ç®¡ç†</FluentLabel>

<FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; margin-bottom: 1rem;">
    <FluentButton Appearance="Appearance.Accent" OnClick="RefreshData">
        ğŸ”„ åˆ·æ–°
    </FluentButton>
    <FluentButton Appearance="Appearance.Outline" OnClick="ShowMountWizard">
        â• æŒ‚è½½å‘å¯¼
    </FluentButton>
</FluentStack>

@if (!string.IsNullOrEmpty(message))
{
    <FluentMessageBar Intent="@(isError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
        @message
        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => message = string.Empty)" aria-label="Close" Style="margin-left: auto;">
            âœ•
        </FluentButton>
    </FluentMessageBar>
}

<!-- All Block Devices -->
<div class="card-custom p-4 mb-4">
    <h5 class="mb-3">
        <i class="@Icons.Material.Filled.Storage me-2"></i>
        æ‰€æœ‰ç£ç›˜è®¾å¤‡
    </h5>
    @if (allDisks != null && allDisks.Any())
    {
        <div class="table-responsive">
            <table class="table table-custom">
                <thead>
                    <tr>
                        <th>è®¾å¤‡</th>
                        <th>ç±»å‹</th>
                        <th>å¤§å°</th>
                        <th>æ–‡ä»¶ç³»ç»Ÿ</th>
                        <th>æŒ‚è½½ç‚¹</th>
                        <th>ä½¿ç”¨ç‡</th>
                        <th>UUID</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var disk in allDisks)
                    {
                        <tr class="@(disk.Type == "disk" ? "fw-bold" : "")">
                            <td>
                                @if (disk.Type == "disk")
                                {
                                    <i class="@Icons.Material.Filled.Storage me-1"></i>
                                }
                                else
                                {
                                    <span class="ms-3"></span>
                                }
                                @disk.DevicePath
                                @if (disk.IsRemovable)
                                {
                                    <span class="badge bg-info ms-1">å¯ç§»åŠ¨</span>
                                }
                            </td>
                            <td>@disk.Type</td>
                            <td>@disk.SizeDisplay</td>
                            <td>@(string.IsNullOrEmpty(disk.FileSystem) ? "-" : disk.FileSystem)</td>
                            <td>@(string.IsNullOrEmpty(disk.MountPoint) ? "-" : disk.MountPoint)</td>
                            <td>
                                @if (disk.IsReady && disk.TotalBytes > 0)
                                {
                                    <div class="progress-custom" style="height: 20px;">
                                        <div class="progress-bar-custom" style="width: @disk.UsagePercent%">
                                            <small>@disk.UsagePercent%</small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td><small>@FormatUuid(disk.UUID)</small></td>
                            <td>
                                @if (!string.IsNullOrEmpty(disk.MountPoint))
                                {
                                    <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => UnmountDiskAction(disk.MountPoint)">
                                        <i class="@Icons.Material.Filled.Eject me-1"></i>
                                        å¸è½½
                                    </button>
                                }
                                else if (disk.Type == "part" || disk.Type == "disk")
                                {
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => ShowMountWizardForDisk(disk)">
                                        <i class="@Icons.Material.Filled.AddCircle me-1"></i>
                                        æŒ‚è½½
                                    </button>
                                }
                                @if (disk.Type == "disk")
                                {
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-1" @onclick="() => ShowPowerManagement(disk)">
                                        <i class="@Icons.Material.Filled.Power me-1"></i>
                                        ç”µæº
                                    </button>
                                }
                            </td>
                        </tr>
                        @if (disk.Children != null)
                        {
                            @foreach (var child in disk.Children)
                            {
                                <tr>
                                    <td>
                                        <span class="ms-3">â””â”€ </span>
                                        @child.DevicePath
                                    </td>
                                    <td>@child.Type</td>
                                    <td>@child.SizeDisplay</td>
                                    <td>@(string.IsNullOrEmpty(child.FileSystem) ? "-" : child.FileSystem)</td>
                                    <td>@(string.IsNullOrEmpty(child.MountPoint) ? "-" : child.MountPoint)</td>
                                    <td>
                                        @if (child.IsReady && child.TotalBytes > 0)
                                        {
                                            <div class="progress-custom" style="height: 20px;">
                                                <div class="progress-bar-custom" style="width: @child.UsagePercent%">
                                                    <small>@child.UsagePercent%</small>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td><small>@FormatUuid(child.UUID)</small></td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(child.MountPoint))
                                        {
                                            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => UnmountDiskAction(child.MountPoint)">
                                                <i class="@Icons.Material.Filled.Eject me-1"></i>
                                                å¸è½½
                                            </button>
                                        }
                                        else if (child.Type == "part")
                                        {
                                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => ShowMountWizardForDisk(child)">
                                                <i class="@Icons.Material.Filled.AddCircle me-1"></i>
                                                æŒ‚è½½
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <div class="d-flex align-items-center gap-2">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0">åŠ è½½ä¸­...</p>
        </div>
    }
    else
    {
        <p class="text-muted-custom">æ²¡æœ‰æ‰¾åˆ°ç£ç›˜ä¿¡æ¯</p>
    }
</div>

<!-- Network Disks -->
<div class="card-custom p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
            <i class="@Icons.Material.Filled.SettingsEthernet me-2"></i>
            ç½‘ç»œç£ç›˜
        </h5>
        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ShowNetworkMountWizard">
            <i class="@Icons.Material.Filled.AddCircle me-1"></i>
            æŒ‚è½½ç½‘ç»œç£ç›˜
        </button>
    </div>
    @if (networkDisks != null && networkDisks.Any())
    {
        <div class="table-responsive">
            <table class="table table-custom">
                <thead>
                    <tr>
                        <th>ç±»å‹</th>
                        <th>æœåŠ¡å™¨</th>
                        <th>å…±äº«è·¯å¾„</th>
                        <th>æŒ‚è½½ç‚¹</th>
                        <th>å¤§å°</th>
                        <th>ä½¿ç”¨ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var disk in networkDisks)
                    {
                        <tr>
                            <td>
                                <span class="badge @(disk.DiskType == NetworkDiskType.CIFS ? "bg-primary" : "bg-success")">
                                    @disk.DiskType.ToString()
                                </span>
                            </td>
                            <td>@disk.Server</td>
                            <td>@disk.SharePath</td>
                            <td>@disk.MountPoint</td>
                            <td>@disk.SizeDisplay</td>
                            <td>
                                @if (disk.IsReady && disk.TotalBytes > 0)
                                {
                                    <div class="progress-custom" style="height: 20px;">
                                        <div class="progress-bar-custom" style="width: @disk.UsagePercent%">
                                            <small>@disk.UsagePercent%</small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => UnmountDiskAction(disk.MountPoint)">
                                    <i class="@Icons.Material.Filled.Eject me-1"></i>
                                    å¸è½½
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <div class="d-flex align-items-center gap-2">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0">åŠ è½½ä¸­...</p>
        </div>
    }
    else
    {
        <p class="text-muted-custom">æ²¡æœ‰æŒ‚è½½çš„ç½‘ç»œç£ç›˜</p>
    }
</div>
</FluentStack>

<!-- Mount Wizard Modal -->
@if (showMountWizard)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="@Icons.Material.Filled.AddCircle me-2"></i>
                        ç£ç›˜æŒ‚è½½å‘å¯¼
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideMountWizard"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(wizardMessage))
                    {
                        <div class="alert @(wizardError ? "alert-danger" : "alert-success") mb-3">
                            @wizardMessage
                            <button type="button" class="btn-close" @onclick="@(() => wizardMessage = string.Empty)"></button>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">è®¾å¤‡è·¯å¾„ *</label>
                        <input type="text" class="form-control-custom" @bind="wizardDevicePath" placeholder="/dev/sdb1" />
                        <small class="form-text text-muted-custom">ä¾‹å¦‚: /dev/sdb1</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æŒ‚è½½ç‚¹ *</label>
                        <input type="text" class="form-control-custom" @bind="wizardMountPoint" placeholder="/mnt/mydisk" />
                        <small class="form-text text-muted-custom">ä¾‹å¦‚: /mnt/mydisk</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
                        <select class="form-control-custom" @bind="wizardFileSystem">
                            <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                            @foreach (var fs in availableFileSystems)
                            {
                                <option value="@fs">@fs</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æŒ‚è½½é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-control-custom" @bind="wizardOptions" placeholder="defaults" />
                        <small class="form-text text-muted-custom">ä¾‹å¦‚: defaults, rw, noatime</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æŒ‚è½½ç±»å‹ *</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mountType" id="tempMount" value="temp" @onchange="@(() => wizardPermanent = false)" checked="@(!wizardPermanent)">
                            <label class="form-check-label" for="tempMount">
                                ä¸´æ—¶æŒ‚è½½ï¼ˆä»…å½“å‰ä¼šè¯ï¼Œé‡å¯åå¤±æ•ˆï¼‰
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mountType" id="permMount" value="perm" @onchange="@(() => wizardPermanent = true)" checked="@wizardPermanent">
                            <label class="form-check-label" for="permMount">
                                æ°¸ä¹…æŒ‚è½½ï¼ˆå†™å…¥ /etc/fstabï¼Œé‡å¯åè‡ªåŠ¨æŒ‚è½½ï¼‰
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideMountWizard">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="ExecuteMountWizard" disabled="@(string.IsNullOrWhiteSpace(wizardDevicePath) || string.IsNullOrWhiteSpace(wizardMountPoint) || isProcessing)">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="@Icons.Material.Filled.Check me-1"></i>
                        æŒ‚è½½
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

<!-- Power Management Modal -->
@if (showPowerManagement)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="@Icons.Material.Filled.Power me-2"></i>
                        ç£ç›˜ç”µæºç®¡ç† - @selectedDiskForPower?.Name
                    </h5>
                    <button type="button" class="btn-close" @onclick="HidePowerManagement"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(powerMessage))
                    {
                        <div class="alert @(powerError ? "alert-danger" : "alert-success") mb-3">
                            @powerMessage
                            <button type="button" class="btn-close" @onclick="@(() => powerMessage = string.Empty)"></button>
                        </div>
                    }

                    <h6>å½“å‰çŠ¶æ€</h6>
                    @if (!string.IsNullOrEmpty(powerStatus))
                    {
                        // å°è¯•ä» hdparm è¾“å‡ºä¸­è§£æå…³é”®ä¿¡æ¯
                        var lines = powerStatus
                            .Split(new[] { "\r\n", "\n" }, StringSplitOptions.RemoveEmptyEntries);
                        string deviceLine = lines.Length > 0 ? lines[0].Trim() : string.Empty;
                        string stateLine = lines.FirstOrDefault(
                            l => l.Contains("drive state is", StringComparison.OrdinalIgnoreCase)
                              || l.Contains("drive state:", StringComparison.OrdinalIgnoreCase)
                        );
                        string driveState = string.Empty;
                        if (!string.IsNullOrEmpty(stateLine))
                        {
                            var idx = stateLine.IndexOf(':');
                            driveState = idx >= 0 && idx + 1 < stateLine.Length
                                ? stateLine[(idx + 1)..].Trim()
                                : stateLine.Trim();
                        }
                        <div class="border rounded p-2 mb-2 bg-light">
                            @if (!string.IsNullOrEmpty(deviceLine))
                            {
                                <div><strong>è®¾å¤‡:</strong> @deviceLine</div>
                            }
                            @if (!string.IsNullOrEmpty(driveState))
                            {
                                <div class="mt-1">
                                    <strong>ç”µæºçŠ¶æ€:</strong> @driveState
                                </div>
                            }
                            else
                            {
                                <div class="mt-1 text-muted">
                                    æ— æ³•ä»è¾“å‡ºä¸­è§£æè¯¦ç»†ç”µæºçŠ¶æ€ï¼Œä»¥ä¸‹ä¸ºåŸå§‹ä¿¡æ¯ã€‚
                                </div>
                            }
                        </div>
                        <details class="mb-3">
                            <summary class="text-muted" style="cursor: pointer;">æŸ¥çœ‹åŸå§‹ hdparm è¾“å‡º</summary>
                            <pre class="bg-light p-2 rounded mt-2 mb-0"><code>@powerStatus</code></pre>
                        </details>
                    }
                    else
                    {
                        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" @onclick="CheckPowerStatus">
                            æŸ¥è¯¢çŠ¶æ€
                        </button>
                    }

                    <h6 class="mt-3">è‡ªåŠ¨ä¼‘çœ è®¾ç½®</h6>
                    <div class="mb-3">
                        <label class="form-label">ä¼‘çœ è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" class="form-control-custom" @bind="spinDownTimeout" min="0" max="240" />
                        <small class="form-text text-muted-custom">0 = ç¦ç”¨è‡ªåŠ¨ä¼‘çœ ï¼Œ1-240 åˆ†é’Ÿ</small>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="SetSpinDown" disabled="@isProcessing">
                        @if (isProcessing && currentOperation == "spindown")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        è®¾ç½®ä¼‘çœ è¶…æ—¶
                    </button>

                    <h6 class="mt-4">APM ç”µæºç®¡ç†çº§åˆ«</h6>
                    <div class="mb-3">
                        <label class="form-label">APM çº§åˆ«ï¼ˆ1-255ï¼‰</label>
                        <input type="number" class="form-control-custom" @bind="apmLevel" min="1" max="255" />
                        <small class="form-text text-muted-custom">1 = æœ€çœç”µï¼Œ255 = æœ€é«˜æ€§èƒ½</small>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="SetApmLevel" disabled="@isProcessing">
                        @if (isProcessing && currentOperation == "apm")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        è®¾ç½® APM çº§åˆ«
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HidePowerManagement">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

<!-- Network Mount Wizard Modal -->
@if (showNetworkMountWizard)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="@Icons.Material.Filled.SettingsEthernet me-2"></i>
                        ç½‘ç»œç£ç›˜æŒ‚è½½å‘å¯¼
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideNetworkMountWizard"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(networkWizardMessage))
                    {
                        <div class="alert @(networkWizardError ? "alert-danger" : "alert-success") mb-3">
                            @networkWizardMessage
                            <button type="button" class="btn-close" @onclick="@(() => networkWizardMessage = string.Empty)"></button>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">ç½‘ç»œç£ç›˜ç±»å‹ *</label>
                        <select class="form-control-custom" @bind="networkWizardType">
                            <option value="@NetworkDiskType.CIFS">CIFS/SMB (Windowså…±äº«)</option>
                            <option value="@NetworkDiskType.NFS">NFS (Linuxå…±äº«)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æœåŠ¡å™¨åœ°å€ *</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardServer" placeholder="192.168.1.100 æˆ– server.local" />
                        <small class="form-text text-muted-custom">æœåŠ¡å™¨IPåœ°å€æˆ–ä¸»æœºå</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å…±äº«è·¯å¾„ *</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardSharePath" placeholder="@(networkWizardType == NetworkDiskType.CIFS ? "share" : "export/path")" />
                        <small class="form-text text-muted-custom">
                            @if (networkWizardType == NetworkDiskType.CIFS)
                            {
                                <text>Windowså…±äº«åç§°ï¼Œå¦‚: share æˆ– Documents</text>
                            }
                            else
                            {
                                <text>NFSå¯¼å‡ºè·¯å¾„ï¼Œå¦‚: export/data æˆ– mnt/storage</text>
                            }
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æŒ‚è½½ç‚¹ *</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardMountPoint" placeholder="/mnt/network" />
                        <small class="form-text text-muted-custom">æœ¬åœ°æŒ‚è½½ç›®å½•ï¼Œå¦‚: /mnt/network</small>
                    </div>

                    @if (networkWizardType == NetworkDiskType.CIFS)
                    {
                        <div class="mb-3">
                            <label class="form-label">ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="form-control-custom" @bind="networkWizardUsername" placeholder="username" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="password" class="form-control-custom" @bind="networkWizardPassword" placeholder="password" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">åŸŸï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="form-control-custom" @bind="networkWizardDomain" placeholder="WORKGROUP" />
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">æŒ‚è½½é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-control-custom" @bind="networkWizardOptions" placeholder="é»˜è®¤é€‰é¡¹" />
                        <small class="form-text text-muted-custom">
                            @if (networkWizardType == NetworkDiskType.CIFS)
                            {
                                <text>å¦‚: vers=3.0,uid=1000,gid=1000</text>
                            }
                            else
                            {
                                <text>å¦‚: rw,sync,hard,intr</text>
                            }
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æŒ‚è½½ç±»å‹ *</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="networkMountType" id="networkTempMount" value="temp" @onchange="@(() => networkWizardPermanent = false)" checked="@(!networkWizardPermanent)">
                            <label class="form-check-label" for="networkTempMount">
                                ä¸´æ—¶æŒ‚è½½ï¼ˆä»…å½“å‰ä¼šè¯ï¼Œé‡å¯åå¤±æ•ˆï¼‰
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="networkMountType" id="networkPermMount" value="perm" @onchange="@(() => networkWizardPermanent = true)" checked="@networkWizardPermanent">
                            <label class="form-check-label" for="networkPermMount">
                                æ°¸ä¹…æŒ‚è½½ï¼ˆå†™å…¥ /etc/fstabï¼Œé‡å¯åè‡ªåŠ¨æŒ‚è½½ï¼‰
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideNetworkMountWizard">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="ExecuteNetworkMountWizard" disabled="@(string.IsNullOrWhiteSpace(networkWizardServer) || string.IsNullOrWhiteSpace(networkWizardSharePath) || string.IsNullOrWhiteSpace(networkWizardMountPoint) || isProcessing)">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="@Icons.Material.Filled.Check me-1"></i>
                        æŒ‚è½½
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private List<DiskInfo> allDisks = new();
    private List<string> availableFileSystems = new();
    private string message = string.Empty;
    private bool isError = false;
    private bool isLoading = false;
    private bool isProcessing = false;
    private string currentOperation = string.Empty;

    // Mount Wizard
    private bool showMountWizard = false;
    private string wizardDevicePath = string.Empty;
    private string wizardMountPoint = string.Empty;
    private string wizardFileSystem = string.Empty;
    private string wizardOptions = string.Empty;
    private bool wizardPermanent = false;
    private string wizardMessage = string.Empty;
    private bool wizardError = false;

    // Network Mount Wizard
    private bool showNetworkMountWizard = false;
    private NetworkDiskType networkWizardType = NetworkDiskType.CIFS;
    private string networkWizardServer = string.Empty;
    private string networkWizardSharePath = string.Empty;
    private string networkWizardMountPoint = string.Empty;
    private string networkWizardUsername = string.Empty;
    private string networkWizardPassword = string.Empty;
    private string networkWizardDomain = string.Empty;
    private string networkWizardOptions = string.Empty;
    private bool networkWizardPermanent = false;
    private string networkWizardMessage = string.Empty;
    private bool networkWizardError = false;
    private List<NetworkDiskInfo> networkDisks = new();

    // Power Management
    private bool showPowerManagement = false;
    private DiskInfo? selectedDiskForPower = null;
    private string powerStatus = string.Empty;
    private string powerMessage = string.Empty;
    private bool powerError = false;
    private int spinDownTimeout = 0;
    private int apmLevel = 128;

    protected override async Task OnInitializedAsync()
    {
        availableFileSystems = await DiskManagementService.GetAvailableFileSystemsAsync();
        await RefreshData();
    }

    private async Task RefreshData()
    {
        isLoading = true;
        try
        {
            allDisks = await DiskManagementService.GetAllBlockDevicesAsync();
            networkDisks = await DiskManagementService.GetNetworkDisksAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowMountWizard()
    {
        wizardDevicePath = string.Empty;
        wizardMountPoint = string.Empty;
        wizardFileSystem = string.Empty;
        wizardOptions = string.Empty;
        wizardPermanent = false;
        wizardMessage = string.Empty;
        wizardError = false;
        showMountWizard = true;
    }

    private void ShowMountWizardForDisk(DiskInfo disk)
    {
        wizardDevicePath = disk.DevicePath;
        wizardMountPoint = $"/mnt/{disk.Name}";
        wizardFileSystem = disk.FileSystem ?? string.Empty;
        wizardOptions = string.Empty;
        wizardPermanent = false;
        wizardMessage = string.Empty;
        wizardError = false;
        showMountWizard = true;
    }

    private void HideMountWizard()
    {
        showMountWizard = false;
    }

    private async Task ExecuteMountWizard()
    {
        if (string.IsNullOrWhiteSpace(wizardDevicePath) || string.IsNullOrWhiteSpace(wizardMountPoint))
            return;

        isProcessing = true;
        wizardMessage = string.Empty;

        try
        {
            string result;
            if (wizardPermanent)
            {
                result = await DiskManagementService.MountDiskPermanentAsync(
                    wizardDevicePath, 
                    wizardMountPoint, 
                    string.IsNullOrWhiteSpace(wizardFileSystem) ? null : wizardFileSystem,
                    string.IsNullOrWhiteSpace(wizardOptions) ? null : wizardOptions);
            }
            else
            {
                result = await DiskManagementService.MountDiskAsync(
                    wizardDevicePath, 
                    wizardMountPoint, 
                    string.IsNullOrWhiteSpace(wizardFileSystem) ? null : wizardFileSystem,
                    string.IsNullOrWhiteSpace(wizardOptions) ? null : wizardOptions);
            }

            var operationResult = new
            {
                Success = result.Contains("Successfully", StringComparison.OrdinalIgnoreCase),
                Message = result
            };

            wizardMessage = operationResult.Message;
            wizardError = !operationResult.Success;
            if (!wizardError)
            {
                await RefreshData();
                await Task.Delay(2000);
                HideMountWizard();
            }
        }
        catch (Exception ex)
        {
            wizardMessage = $"æŒ‚è½½å¤±è´¥: {ex.Message}";
            wizardError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task UnmountDiskAction(string mountPoint)
    {
        if (string.IsNullOrWhiteSpace(mountPoint))
            return;

        isProcessing = true;
        message = string.Empty;

        try
        {
            var result = await DiskManagementService.UnmountDiskAsync(mountPoint);
            message = result;
            isError = !result.Contains("Successfully");
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"å¸è½½å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowNetworkMountWizard()
    {
        networkWizardType = NetworkDiskType.CIFS;
        networkWizardServer = string.Empty;
        networkWizardSharePath = string.Empty;
        networkWizardMountPoint = string.Empty;
        networkWizardUsername = string.Empty;
        networkWizardPassword = string.Empty;
        networkWizardDomain = string.Empty;
        networkWizardOptions = string.Empty;
        networkWizardPermanent = false;
        networkWizardMessage = string.Empty;
        networkWizardError = false;
        showNetworkMountWizard = true;
    }

    private void HideNetworkMountWizard()
    {
        showNetworkMountWizard = false;
    }

    private async Task ExecuteNetworkMountWizard()
    {
        if (string.IsNullOrWhiteSpace(networkWizardServer) || 
            string.IsNullOrWhiteSpace(networkWizardSharePath) || 
            string.IsNullOrWhiteSpace(networkWizardMountPoint))
            return;

        isProcessing = true;
        networkWizardMessage = string.Empty;

        try
        {
            string result;
            if (networkWizardPermanent)
            {
                result = await DiskManagementService.MountNetworkDiskPermanentAsync(
                    networkWizardServer,
                    networkWizardSharePath,
                    networkWizardMountPoint,
                    networkWizardType,
                    string.IsNullOrWhiteSpace(networkWizardUsername) ? null : networkWizardUsername,
                    string.IsNullOrWhiteSpace(networkWizardPassword) ? null : networkWizardPassword,
                    string.IsNullOrWhiteSpace(networkWizardDomain) ? null : networkWizardDomain,
                    string.IsNullOrWhiteSpace(networkWizardOptions) ? null : networkWizardOptions);
            }
            else
            {
                result = await DiskManagementService.MountNetworkDiskAsync(
                    networkWizardServer,
                    networkWizardSharePath,
                    networkWizardMountPoint,
                    networkWizardType,
                    string.IsNullOrWhiteSpace(networkWizardUsername) ? null : networkWizardUsername,
                    string.IsNullOrWhiteSpace(networkWizardPassword) ? null : networkWizardPassword,
                    string.IsNullOrWhiteSpace(networkWizardDomain) ? null : networkWizardDomain,
                    string.IsNullOrWhiteSpace(networkWizardOptions) ? null : networkWizardOptions);
            }

            var operationResult = new
            {
                Success = result.Contains("Successfully", StringComparison.OrdinalIgnoreCase),
                Message = result
            };

            networkWizardMessage = operationResult.Message;
            networkWizardError = !operationResult.Success;
            if (!networkWizardError)
            {
                await RefreshData();
                await Task.Delay(2000);
                // Clear sensitive data from memory
                networkWizardPassword = string.Empty;
                HideNetworkMountWizard();
            }
        }
        catch (Exception ex)
        {
            networkWizardMessage = $"æŒ‚è½½å¤±è´¥: {ex.Message}";
            networkWizardError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowPowerManagement(DiskInfo disk)
    {
        selectedDiskForPower = disk;
        powerStatus = string.Empty;
        powerMessage = string.Empty;
        powerError = false;
        spinDownTimeout = 0;
        apmLevel = 128;
        showPowerManagement = true;
    }

    private void HidePowerManagement()
    {
        showPowerManagement = false;
        selectedDiskForPower = null;
    }

    private async Task CheckPowerStatus()
    {
        if (selectedDiskForPower == null)
            return;

        powerMessage = string.Empty;
        try
        {
            powerStatus = await DiskManagementService.GetDiskPowerStatusAsync(selectedDiskForPower.DevicePath);
        }
        catch (Exception ex)
        {
            powerMessage = $"æŸ¥è¯¢å¤±è´¥: {ex.Message}";
            powerError = true;
        }
    }

    private async Task SetSpinDown()
    {
        if (selectedDiskForPower == null)
            return;

        isProcessing = true;
        currentOperation = "spindown";
        powerMessage = string.Empty;

        try
        {
            var result = await DiskManagementService.SetDiskSpinDownAsync(selectedDiskForPower.DevicePath, spinDownTimeout);
            powerMessage = result;
            powerError = !result.Contains("Set") && !result.Contains("Disabled");
        }
        catch (Exception ex)
        {
            powerMessage = $"è®¾ç½®å¤±è´¥: {ex.Message}";
            powerError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }

    private async Task SetApmLevel()
    {
        if (selectedDiskForPower == null)
            return;

        isProcessing = true;
        currentOperation = "apm";
        powerMessage = string.Empty;

        try
        {
            var result = await DiskManagementService.SetDiskApmLevelAsync(selectedDiskForPower.DevicePath, apmLevel);
            powerMessage = result;
            powerError = !result.Contains("Set");
        }
        catch (Exception ex)
        {
            powerMessage = $"è®¾ç½®å¤±è´¥: {ex.Message}";
            powerError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }

    private string FormatUuid(string uuid)
    {
        if (string.IsNullOrEmpty(uuid))
        {
            return "-";
        }
        
        return uuid.Length > 8 ? uuid[..8] + "..." : uuid;
    }
}
