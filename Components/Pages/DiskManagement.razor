@page "/disk-management"
@using QingFeng.Services
@using QingFeng.Models
@inherits AuthorizedPageBase
@inject IDiskManagementService DiskManagementService
@rendermode InteractiveServer

<PageTitle>ç£ç›˜ç®¡ç†</PageTitle>

<style>
    .fluent-table {
        border-collapse: collapse;
    }

    .fluent-table th {
        text-align: left;
        padding: calc(var(--design-unit) * 3px);
        border-bottom: calc(var(--stroke-width, 1px) * 2) solid var(--neutral-stroke-divider-rest);
        font-weight: 600;
    }

    .fluent-table td {
        padding: calc(var(--design-unit) * 3px);
        border-bottom: var(--stroke-width, 1px) solid var(--neutral-stroke-divider-rest);
        vertical-align: middle;
    }

    .fluent-table tr:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
</style>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="padding: 2rem;">
<FluentLabel Typo="Typography.H3">ğŸ’¿ ç£ç›˜ç®¡ç†</FluentLabel>

<FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; margin-bottom: 1rem;">
    <FluentButton Appearance="Appearance.Accent" OnClick="RefreshData">
        ğŸ”„ åˆ·æ–°
    </FluentButton>
    <FluentButton Appearance="Appearance.Outline" OnClick="ShowMountWizard">
        â• æŒ‚è½½å‘å¯¼
    </FluentButton>
    <FluentButton Appearance="Appearance.Outline" OnClick="ShowFeatureDetection">
        ğŸ” åŠŸèƒ½æ£€æµ‹
    </FluentButton>
</FluentStack>

@if (!string.IsNullOrEmpty(message))
{
    <FluentMessageBar Intent="@(isError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
        @message
        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => message = string.Empty)" aria-label="Close" Style="margin-left: auto;">
            âœ•
        </FluentButton>
    </FluentMessageBar>
}

<!-- All Block Devices -->
<FluentCard Style="margin-bottom: 1.5rem;">
    <FluentLabel Typo="Typography.H5">
        ğŸ’¾ æ‰€æœ‰ç£ç›˜è®¾å¤‡
    </FluentLabel>
    @if (allDisks != null && allDisks.Any())
    {
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="æ‰€æœ‰ç£ç›˜è®¾å¤‡">
                <thead>
                    <tr>
                        <th scope="col">è®¾å¤‡</th>
                        <th scope="col">ç±»å‹</th>
                        <th scope="col">å¤§å°</th>
                        <th scope="col">æ–‡ä»¶ç³»ç»Ÿ</th>
                        <th scope="col">æŒ‚è½½ç‚¹</th>
                        <th scope="col">ä½¿ç”¨ç‡</th>
                        <th scope="col">UUID</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var disk in allDisks)
                    {
                        <tr class="@(disk.Type == "disk" ? "fw-bold" : "")">
                            <td>
                                @if (disk.Type == "disk")
                                {
                                    <i class="@Icons.Material.Filled.Storage me-1"></i>
                                }
                                else
                                {
                                    <span class="ms-3"></span>
                                }
                                @disk.DevicePath
                                @if (disk.IsRemovable)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#0078D4" Style="margin-left: 0.25rem;">å¯ç§»åŠ¨</FluentBadge>
                                }
                            </td>
                            <td>@disk.Type</td>
                            <td>@disk.SizeDisplay</td>
                            <td>@(string.IsNullOrEmpty(disk.FileSystem) ? "-" : disk.FileSystem)</td>
                            <td>@(string.IsNullOrEmpty(disk.MountPoint) ? "-" : disk.MountPoint)</td>
                            <td>
                                @if (disk.IsReady && disk.TotalBytes > 0)
                                {
                                    <FluentStack Orientation="Orientation.Horizontal" Style="align-items: center; gap: 0.5rem;">
                                        <FluentProgress Value="@((int)disk.UsagePercent)" Max="100" Style="flex: 1; min-width: 100px;" />
                                        <small>@disk.UsagePercent%</small>
                                    </FluentStack>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td><small>@FormatUuid(disk.UUID)</small></td>
                            <td>
                                @if (!string.IsNullOrEmpty(disk.MountPoint))
                                {
                                    <FluentButton Appearance="Appearance.Outline" OnClick="() => UnmountDiskAction(disk.MountPoint)" Title="å¸è½½" Style="font-size: 0.875rem;">
                                        âï¸ å¸è½½
                                    </FluentButton>
                                }
                                else if (disk.Type == "part" || disk.Type == "disk")
                                {
                                    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowMountWizardForDisk(disk)" Title="æŒ‚è½½" Style="font-size: 0.875rem;">
                                        â• æŒ‚è½½
                                    </FluentButton>
                                }
                                @if (disk.Type == "disk")
                                {
                                    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowPowerManagement(disk)" Title="ç”µæº" Style="font-size: 0.875rem; margin-left: 0.25rem;">
                                        ğŸ”Œ ç”µæº
                                    </FluentButton>
                                }
                            </td>
                        </tr>
                        @if (disk.Children != null)
                        {
                            @foreach (var child in disk.Children)
                            {
                                <tr>
                                    <td>
                                        <span class="ms-3">â””â”€ </span>
                                        @child.DevicePath
                                    </td>
                                    <td>@child.Type</td>
                                    <td>@child.SizeDisplay</td>
                                    <td>@(string.IsNullOrEmpty(child.FileSystem) ? "-" : child.FileSystem)</td>
                                    <td>@(string.IsNullOrEmpty(child.MountPoint) ? "-" : child.MountPoint)</td>
                                    <td>
                                        @if (child.IsReady && child.TotalBytes > 0)
                                        {
                                            <FluentStack Orientation="Orientation.Horizontal" Style="align-items: center; gap: 0.5rem;">
                                                <FluentProgress Value="@((int)child.UsagePercent)" Max="100" Style="flex: 1; min-width: 100px;" />
                                                <small>@child.UsagePercent%</small>
                                            </FluentStack>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td><small>@FormatUuid(child.UUID)</small></td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(child.MountPoint))
                                        {
                                            <FluentButton Appearance="Appearance.Outline" OnClick="() => UnmountDiskAction(child.MountPoint)" Title="å¸è½½" Style="font-size: 0.875rem;">
                                                âï¸ å¸è½½
                                            </FluentButton>
                                        }
                                        else if (child.Type == "part")
                                        {
                                            <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowMountWizardForDisk(child)" Title="æŒ‚è½½" Style="font-size: 0.875rem;">
                                                â• æŒ‚è½½
                                            </FluentButton>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center; margin-top: 1rem;">
            <FluentProgressRing />
            <p style="margin: 0;">åŠ è½½ä¸­...</p>
        </FluentStack>
    }
    else
    {
        <p style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰æ‰¾åˆ°ç£ç›˜ä¿¡æ¯</p>
    }
</FluentCard>

<!-- Network Disks -->
<FluentCard Style="margin-bottom: 1.5rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸŒ ç½‘ç»œç£ç›˜
        </FluentLabel>
        <FluentButton Appearance="Appearance.Outline" OnClick="ShowNetworkMountWizard" Style="font-size: 0.875rem;">
            â• æŒ‚è½½ç½‘ç»œç£ç›˜
        </FluentButton>
    </FluentStack>
    @if (networkDisks != null && networkDisks.Any())
    {
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="ç½‘ç»œç£ç›˜">
                <thead>
                    <tr>
                        <th scope="col">ç±»å‹</th>
                        <th scope="col">æœåŠ¡å™¨</th>
                        <th scope="col">å…±äº«è·¯å¾„</th>
                        <th scope="col">æŒ‚è½½ç‚¹</th>
                        <th scope="col">å¤§å°</th>
                        <th scope="col">ä½¿ç”¨ç‡</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var disk in networkDisks)
                    {
                        <tr>
                            <td>
                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="@(disk.DiskType == NetworkDiskType.CIFS ? "var(--accent-fill-rest)" : "#107C10")">
                                    @disk.DiskType.ToString()
                                </FluentBadge>
                            </td>
                            <td>@disk.Server</td>
                            <td>@disk.SharePath</td>
                            <td>@disk.MountPoint</td>
                            <td>@disk.SizeDisplay</td>
                            <td>
                                @if (disk.IsReady && disk.TotalBytes > 0)
                                {
                                    <FluentStack Orientation="Orientation.Horizontal" Style="align-items: center; gap: 0.5rem;">
                                        <FluentProgress Value="@((int)disk.UsagePercent)" Max="100" Style="flex: 1; min-width: 100px;" />
                                        <small>@disk.UsagePercent%</small>
                                    </FluentStack>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td>
                                <FluentButton Appearance="Appearance.Outline" OnClick="() => UnmountDiskAction(disk.MountPoint)" Title="å¸è½½" Style="font-size: 0.875rem;">
                                    âï¸ å¸è½½
                                </FluentButton>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center; margin-top: 1rem;">
            <FluentProgressRing />
            <p style="margin: 0;">åŠ è½½ä¸­...</p>
        </FluentStack>
    }
    else
    {
        <p style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰æŒ‚è½½çš„ç½‘ç»œç£ç›˜</p>
    }
</FluentCard>
</FluentStack>

<!-- Mount Wizard Modal -->
<FluentDialog Hidden="@(!showMountWizard)" Modal="true" OnDismiss="HideMountWizard" Style="width: 90%; max-width: 800px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">â• ç£ç›˜æŒ‚è½½å‘å¯¼</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(wizardMessage))
        {
            <FluentMessageBar Intent="@(wizardError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
                @wizardMessage
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => wizardMessage = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                    âœ•
                </FluentButton>
            </FluentMessageBar>
        }

        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            <div>
                <FluentLabel>è®¾å¤‡è·¯å¾„ *</FluentLabel>
                <FluentTextField @bind-Value="wizardDevicePath" Placeholder="/dev/sdb1" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">ä¾‹å¦‚: /dev/sdb1</small>
            </div>

            <div>
                <FluentLabel>æŒ‚è½½ç‚¹ *</FluentLabel>
                <FluentTextField @bind-Value="wizardMountPoint" Placeholder="/mnt/mydisk" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">ä¾‹å¦‚: /mnt/mydisk</small>
            </div>

            <div>
                <FluentLabel>æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                <select @bind="wizardFileSystem" style="width: 100%; padding: calc(var(--design-unit) * 2px); border: 1px solid var(--neutral-stroke-rest); border-radius: calc(var(--control-corner-radius) * 1px); background-color: var(--neutral-fill-input-rest); color: var(--neutral-foreground-rest);">
                    <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                    @foreach (var fs in availableFileSystems)
                    {
                        <option value="@fs">@fs</option>
                    }
                </select>
            </div>

            <div>
                <FluentLabel>æŒ‚è½½é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                <FluentTextField @bind-Value="wizardOptions" Placeholder="defaults" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">ä¾‹å¦‚: defaults, rw, noatime</small>
            </div>

            <div>
                <FluentLabel>æŒ‚è½½ç±»å‹ *</FluentLabel>
                <FluentRadioGroup @bind-Value="wizardPermanent">
                    <FluentRadio Value="@(false)">ä¸´æ—¶æŒ‚è½½ï¼ˆä»…å½“å‰ä¼šè¯ï¼Œé‡å¯åå¤±æ•ˆï¼‰</FluentRadio>
                    <FluentRadio Value="@(true)">æ°¸ä¹…æŒ‚è½½ï¼ˆå†™å…¥ /etc/fstabï¼Œé‡å¯åè‡ªåŠ¨æŒ‚è½½ï¼‰</FluentRadio>
                </FluentRadioGroup>
            </div>
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideMountWizard">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="ExecuteMountWizard" Disabled="@(string.IsNullOrWhiteSpace(wizardDevicePath) || string.IsNullOrWhiteSpace(wizardMountPoint) || isProcessing)">
            @if (isProcessing)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            âœ“ æŒ‚è½½
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Power Management Modal -->
<FluentDialog Hidden="@(!showPowerManagement)" Modal="true" OnDismiss="HidePowerManagement" Style="width: 90%; max-width: 600px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">ğŸ”Œ ç£ç›˜ç”µæºç®¡ç† - @selectedDiskForPower?.Name</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(powerMessage))
        {
            <FluentMessageBar Intent="@(powerError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
                @powerMessage
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => powerMessage = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                    âœ•
                </FluentButton>
            </FluentMessageBar>
        }

        <FluentLabel Typo="Typography.H6">å½“å‰çŠ¶æ€</FluentLabel>
        @if (!string.IsNullOrEmpty(powerStatus))
        {
            // å°è¯•ä» hdparm è¾“å‡ºä¸­è§£æå…³é”®ä¿¡æ¯
            var lines = powerStatus
                .Split(new[] { "\r\n", "\n" }, StringSplitOptions.RemoveEmptyEntries);
            string deviceLine = lines.Length > 0 ? lines[0].Trim() : string.Empty;
            string stateLine = lines.FirstOrDefault(
                l => l.Contains("drive state is", StringComparison.OrdinalIgnoreCase)
                  || l.Contains("drive state:", StringComparison.OrdinalIgnoreCase)
            );
            string driveState = string.Empty;
            if (!string.IsNullOrEmpty(stateLine))
            {
                var idx = stateLine.IndexOf(':');
                driveState = idx >= 0 && idx + 1 < stateLine.Length
                    ? stateLine[(idx + 1)..].Trim()
                    : stateLine.Trim();
            }
            <div style="border: 1px solid var(--neutral-stroke-divider-rest); border-radius: 4px; padding: 0.5rem; margin-bottom: 0.5rem; background-color: var(--neutral-layer-2);">
                @if (!string.IsNullOrEmpty(deviceLine))
                {
                    <div><strong>è®¾å¤‡:</strong> @deviceLine</div>
                }
                @if (!string.IsNullOrEmpty(driveState))
                {
                    <div style="margin-top: 0.25rem;">
                        <strong>ç”µæºçŠ¶æ€:</strong> @driveState
                    </div>
                }
                else
                {
                    <div style="margin-top: 0.25rem; color: var(--neutral-foreground-hint);">
                        æ— æ³•ä»è¾“å‡ºä¸­è§£æè¯¦ç»†ç”µæºçŠ¶æ€ï¼Œä»¥ä¸‹ä¸ºåŸå§‹ä¿¡æ¯ã€‚
                    </div>
                }
            </div>
            <details style="margin-bottom: 1rem;">
                <summary style="color: var(--neutral-foreground-hint); cursor: pointer;">æŸ¥çœ‹åŸå§‹ hdparm è¾“å‡º</summary>
                <pre style="background-color: var(--neutral-layer-2); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; margin-bottom: 0; overflow-x: auto;"><code>@powerStatus</code></pre>
            </details>
        }
        else
        {
            <FluentButton Appearance="Appearance.Outline" OnClick="CheckPowerStatus" Style="margin-bottom: 1rem; font-size: 0.875rem;">
                æŸ¥è¯¢çŠ¶æ€
            </FluentButton>
        }

        <FluentLabel Typo="Typography.H6" Style="margin-top: 1rem;">è‡ªåŠ¨ä¼‘çœ è®¾ç½®</FluentLabel>
        <div style="margin-bottom: 1rem;">
            <FluentLabel>ä¼‘çœ è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</FluentLabel>
            <FluentNumberField @bind-Value="spinDownTimeout" Min="0" Max="330" Style="width: 100%;" />
            <small style="color: var(--neutral-foreground-hint);">0 = ç¦ç”¨è‡ªåŠ¨ä¼‘çœ ï¼Œ1-330 åˆ†é’Ÿï¼ˆæœ€é•¿ 5.5 å°æ—¶ï¼‰ã€‚è®¾ç½®å°†å†™å…¥ /etc/hdparm.conf å¹¶æ°¸ä¹…ç”Ÿæ•ˆã€‚æ³¨æ„ï¼š21 åˆ†é’Ÿä»¥ä¸Šçš„å€¼å°†å‘ä¸Šå–æ•´åˆ° 30 åˆ†é’Ÿçš„å€æ•°ã€‚</small>
        </div>
        <FluentButton Appearance="Appearance.Outline" OnClick="SetSpinDown" Disabled="@isProcessing" Style="font-size: 0.875rem;">
            @if (isProcessing && currentOperation == "spindown")
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.25rem;" />
            }
            è®¾ç½®ä¼‘çœ è¶…æ—¶ï¼ˆæ°¸ä¹…ï¼‰
        </FluentButton>

        <FluentLabel Typo="Typography.H6" Style="margin-top: 1.5rem;">APM ç”µæºç®¡ç†çº§åˆ«</FluentLabel>
        <div style="margin-bottom: 1rem;">
            <FluentLabel>APM çº§åˆ«ï¼ˆ1-255ï¼‰</FluentLabel>
            <FluentNumberField @bind-Value="apmLevel" Min="1" Max="255" Style="width: 100%;" />
            <small style="color: var(--neutral-foreground-hint);">1 = æœ€çœç”µï¼Œ255 = æœ€é«˜æ€§èƒ½ã€‚è®¾ç½®å°†å†™å…¥ /etc/hdparm.conf å¹¶æ°¸ä¹…ç”Ÿæ•ˆã€‚</small>
        </div>
        <FluentButton Appearance="Appearance.Outline" OnClick="SetApmLevel" Disabled="@isProcessing" Style="font-size: 0.875rem;">
            @if (isProcessing && currentOperation == "apm")
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.25rem;" />
            }
            è®¾ç½® APM çº§åˆ«ï¼ˆæ°¸ä¹…ï¼‰
        </FluentButton>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HidePowerManagement">å…³é—­</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Network Mount Wizard Modal -->
<FluentDialog Hidden="@(!showNetworkMountWizard)" Modal="true" OnDismiss="HideNetworkMountWizard" Style="width: 90%; max-width: 800px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">ğŸŒ ç½‘ç»œç£ç›˜æŒ‚è½½å‘å¯¼</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(networkWizardMessage))
        {
            <FluentMessageBar Intent="@(networkWizardError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
                @networkWizardMessage
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => networkWizardMessage = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                    âœ•
                </FluentButton>
            </FluentMessageBar>
        }

        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            <div>
                <FluentLabel>ç½‘ç»œç£ç›˜ç±»å‹ *</FluentLabel>
                <select @bind="networkWizardType" style="width: 100%; padding: calc(var(--design-unit) * 2px); border: 1px solid var(--neutral-stroke-rest); border-radius: calc(var(--control-corner-radius) * 1px); background-color: var(--neutral-fill-input-rest); color: var(--neutral-foreground-rest);">
                    <option value="@NetworkDiskType.CIFS">CIFS/SMB (Windowså…±äº«)</option>
                    <option value="@NetworkDiskType.NFS">NFS (Linuxå…±äº«)</option>
                </select>
            </div>

            <div>
                <FluentLabel>æœåŠ¡å™¨åœ°å€ *</FluentLabel>
                <FluentTextField @bind-Value="networkWizardServer" Placeholder="192.168.1.100 æˆ– server.local" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">æœåŠ¡å™¨IPåœ°å€æˆ–ä¸»æœºå</small>
            </div>

            <div>
                <FluentLabel>å…±äº«è·¯å¾„ *</FluentLabel>
                <FluentTextField @bind-Value="networkWizardSharePath" Placeholder="@(networkWizardType == NetworkDiskType.CIFS ? "share" : "export/path")" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">
                    @if (networkWizardType == NetworkDiskType.CIFS)
                    {
                        <text>Windowså…±äº«åç§°ï¼Œå¦‚: share æˆ– Documents</text>
                    }
                    else
                    {
                        <text>NFSå¯¼å‡ºè·¯å¾„ï¼Œå¦‚: export/data æˆ– mnt/storage</text>
                    }
                </small>
            </div>

            <div>
                <FluentLabel>æŒ‚è½½ç‚¹ *</FluentLabel>
                <FluentTextField @bind-Value="networkWizardMountPoint" Placeholder="/mnt/network" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">æœ¬åœ°æŒ‚è½½ç›®å½•ï¼Œå¦‚: /mnt/network</small>
            </div>

            @if (networkWizardType == NetworkDiskType.CIFS)
            {
                <div>
                    <FluentLabel>ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</FluentLabel>
                    <FluentTextField @bind-Value="networkWizardUsername" Placeholder="username" Style="width: 100%;" />
                </div>

                <div>
                    <FluentLabel>å¯†ç ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                    <FluentTextField @bind-Value="networkWizardPassword" Placeholder="password" TextFieldType="TextFieldType.Password" Style="width: 100%;" />
                </div>

                <div>
                    <FluentLabel>åŸŸï¼ˆå¯é€‰ï¼‰</FluentLabel>
                    <FluentTextField @bind-Value="networkWizardDomain" Placeholder="WORKGROUP" Style="width: 100%;" />
                </div>
            }

            <div>
                <FluentLabel>æŒ‚è½½é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                <FluentTextField @bind-Value="networkWizardOptions" Placeholder="é»˜è®¤é€‰é¡¹" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">
                    @if (networkWizardType == NetworkDiskType.CIFS)
                    {
                        <text>å¦‚: vers=3.0,uid=1000,gid=1000</text>
                    }
                    else
                    {
                        <text>å¦‚: rw,sync,hard,intr</text>
                    }
                </small>
            </div>

            <div>
                <FluentLabel>æŒ‚è½½ç±»å‹ *</FluentLabel>
                <FluentRadioGroup @bind-Value="networkWizardPermanent">
                    <FluentRadio Value="@(false)">ä¸´æ—¶æŒ‚è½½ï¼ˆä»…å½“å‰ä¼šè¯ï¼Œé‡å¯åå¤±æ•ˆï¼‰</FluentRadio>
                    <FluentRadio Value="@(true)">æ°¸ä¹…æŒ‚è½½ï¼ˆå†™å…¥ /etc/fstabï¼Œé‡å¯åè‡ªåŠ¨æŒ‚è½½ï¼‰</FluentRadio>
                </FluentRadioGroup>
            </div>
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideNetworkMountWizard">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="ExecuteNetworkMountWizard" Disabled="@(string.IsNullOrWhiteSpace(networkWizardServer) || string.IsNullOrWhiteSpace(networkWizardSharePath) || string.IsNullOrWhiteSpace(networkWizardMountPoint) || isProcessing)">
            @if (isProcessing)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            âœ“ æŒ‚è½½
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Feature Detection Dialog -->
<FluentDialog Hidden="@(!showFeatureDetection)" Modal="true" OnDismiss="HideFeatureDetection" Style="width: 90%; max-width: 900px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">ğŸ” ç£ç›˜ç®¡ç†åŠŸèƒ½æ£€æµ‹</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (featureDetectionResult == null)
        {
            <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center;">
                <FluentProgressRing />
                <p style="margin: 0;">æ­£åœ¨æ£€æµ‹ç³»ç»ŸåŠŸèƒ½...</p>
            </FluentStack>
        }
        else
        {
            <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
                <div>
                    <FluentLabel Typo="Typography.H6">æ£€æµ‹åˆ°çš„æ“ä½œç³»ç»Ÿ</FluentLabel>
                    <p style="margin: 0.5rem 0;">@featureDetectionResult.DetectedOS</p>
                </div>
                
                <div>
                    <FluentLabel Typo="Typography.H6">æ€»ç»“</FluentLabel>
                    <FluentMessageBar Intent="@(featureDetectionResult.AllRequiredFeaturesAvailable ? MessageIntent.Success : MessageIntent.Warning)" Style="margin-top: 0.5rem;">
                        @featureDetectionResult.Summary
                    </FluentMessageBar>
                </div>
                
                <div>
                    <FluentLabel Typo="Typography.H6">åŠŸèƒ½éœ€æ±‚è¯¦æƒ…</FluentLabel>
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="fluent-table" style="width: 100%;" role="table" aria-label="åŠŸèƒ½éœ€æ±‚">
                            <thead>
                                <tr>
                                    <th scope="col">çŠ¶æ€</th>
                                    <th scope="col">å·¥å…·/åŒ…</th>
                                    <th scope="col">ç±»å‹</th>
                                    <th scope="col">è¯´æ˜</th>
                                    <th scope="col">å®‰è£…å‘½ä»¤</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var req in featureDetectionResult.Requirements)
                                {
                                    <tr>
                                        <td>
                                            @if (req.Status == FeatureStatus.Available)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#107C10">âœ“ å·²å®‰è£…</FluentBadge>
                                            }
                                            else if (req.Status == FeatureStatus.Missing)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">âœ— ç¼ºå¤±</FluentBadge>
                                            }
                                            else
                                            {
                                                <FluentBadge Appearance="Appearance.Neutral">N/A</FluentBadge>
                                            }
                                        </td>
                                        <td><code>@req.Name</code></td>
                                        <td>
                                            @if (req.IsRequired)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">å¿…éœ€</FluentBadge>
                                            }
                                            else
                                            {
                                                <FluentBadge Appearance="Appearance.Neutral">å¯é€‰</FluentBadge>
                                            }
                                        </td>
                                        <td>@req.Description</td>
                                        <td>
                                            @if (req.Status == FeatureStatus.Missing && !string.IsNullOrEmpty(req.InstallCommand))
                                            {
                                                <details>
                                                    <summary style="cursor: pointer; color: var(--accent-fill-rest);">æŸ¥çœ‹å®‰è£…å‘½ä»¤</summary>
                                                    <pre style="background-color: var(--neutral-layer-2); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto; font-size: 0.875rem;"><code>@req.InstallCommand</code></pre>
                                                </details>
                                            }
                                            else if (req.Status == FeatureStatus.Available)
                                            {
                                                <span style="color: var(--neutral-foreground-hint);">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                
                @if (!featureDetectionResult.AllRequiredFeaturesAvailable)
                {
                    <FluentMessageBar Intent="MessageIntent.Warning">
                        <strong>æ³¨æ„ï¼š</strong>ç¼ºå°‘å¿…éœ€å·¥å…·ä¼šå¯¼è‡´ç£ç›˜ç®¡ç†åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚è¯·æŒ‰ç…§ä¸Šè¿°å®‰è£…å‘½ä»¤å®‰è£…ç¼ºå¤±çš„å·¥å…·ã€‚
                    </FluentMessageBar>
                }
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideFeatureDetection">å…³é—­</FluentButton>
        @if (featureDetectionResult != null)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="RunFeatureDetection">
                ğŸ”„ é‡æ–°æ£€æµ‹
            </FluentButton>
        }
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<DiskInfo> allDisks = new();
    private List<string> availableFileSystems = new();
    private string message = string.Empty;
    private bool isError = false;
    private bool isLoading = false;
    private bool isProcessing = false;
    private string currentOperation = string.Empty;

    // Mount Wizard
    private bool showMountWizard = false;
    private string wizardDevicePath = string.Empty;
    private string wizardMountPoint = string.Empty;
    private string wizardFileSystem = string.Empty;
    private string wizardOptions = string.Empty;
    private bool wizardPermanent = false;
    private string wizardMessage = string.Empty;
    private bool wizardError = false;

    // Network Mount Wizard
    private bool showNetworkMountWizard = false;
    private NetworkDiskType networkWizardType = NetworkDiskType.CIFS;
    private string networkWizardServer = string.Empty;
    private string networkWizardSharePath = string.Empty;
    private string networkWizardMountPoint = string.Empty;
    private string networkWizardUsername = string.Empty;
    private string networkWizardPassword = string.Empty;
    private string networkWizardDomain = string.Empty;
    private string networkWizardOptions = string.Empty;
    private bool networkWizardPermanent = false;
    private string networkWizardMessage = string.Empty;
    private bool networkWizardError = false;
    private List<NetworkDiskInfo> networkDisks = new();

    // Power Management
    private bool showPowerManagement = false;
    private DiskInfo? selectedDiskForPower = null;
    private string powerStatus = string.Empty;
    private string powerMessage = string.Empty;
    private bool powerError = false;
    private int spinDownTimeout = 0;
    private int apmLevel = 128;
    
    // Feature Detection
    private bool showFeatureDetection = false;
    private DiskManagementFeatureDetection? featureDetectionResult = null;

    protected override async Task OnInitializedAsync()
    {
        availableFileSystems = await DiskManagementService.GetAvailableFileSystemsAsync();
        await RefreshData();
    }

    private async Task RefreshData()
    {
        isLoading = true;
        try
        {
            allDisks = await DiskManagementService.GetAllBlockDevicesAsync();
            networkDisks = await DiskManagementService.GetNetworkDisksAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowMountWizard()
    {
        wizardDevicePath = string.Empty;
        wizardMountPoint = string.Empty;
        wizardFileSystem = string.Empty;
        wizardOptions = string.Empty;
        wizardPermanent = false;
        wizardMessage = string.Empty;
        wizardError = false;
        showMountWizard = true;
    }

    private void ShowMountWizardForDisk(DiskInfo disk)
    {
        wizardDevicePath = disk.DevicePath;
        wizardMountPoint = $"/mnt/{disk.Name}";
        wizardFileSystem = disk.FileSystem ?? string.Empty;
        wizardOptions = string.Empty;
        wizardPermanent = false;
        wizardMessage = string.Empty;
        wizardError = false;
        showMountWizard = true;
    }

    private void HideMountWizard()
    {
        showMountWizard = false;
    }

    private async Task ExecuteMountWizard()
    {
        if (string.IsNullOrWhiteSpace(wizardDevicePath) || string.IsNullOrWhiteSpace(wizardMountPoint))
            return;

        isProcessing = true;
        wizardMessage = string.Empty;

        try
        {
            string result;
            if (wizardPermanent)
            {
                result = await DiskManagementService.MountDiskPermanentAsync(
                    wizardDevicePath, 
                    wizardMountPoint, 
                    string.IsNullOrWhiteSpace(wizardFileSystem) ? null : wizardFileSystem,
                    string.IsNullOrWhiteSpace(wizardOptions) ? null : wizardOptions);
            }
            else
            {
                result = await DiskManagementService.MountDiskAsync(
                    wizardDevicePath, 
                    wizardMountPoint, 
                    string.IsNullOrWhiteSpace(wizardFileSystem) ? null : wizardFileSystem,
                    string.IsNullOrWhiteSpace(wizardOptions) ? null : wizardOptions);
            }

            var operationResult = new
            {
                Success = result.Contains("Successfully", StringComparison.OrdinalIgnoreCase),
                Message = result
            };

            wizardMessage = operationResult.Message;
            wizardError = !operationResult.Success;
            if (!wizardError)
            {
                await RefreshData();
                await Task.Delay(2000);
                HideMountWizard();
            }
        }
        catch (Exception ex)
        {
            wizardMessage = $"æŒ‚è½½å¤±è´¥: {ex.Message}";
            wizardError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task UnmountDiskAction(string mountPoint)
    {
        if (string.IsNullOrWhiteSpace(mountPoint))
            return;

        isProcessing = true;
        message = string.Empty;

        try
        {
            var result = await DiskManagementService.UnmountDiskAsync(mountPoint);
            message = result;
            isError = !result.Contains("Successfully");
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"å¸è½½å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowNetworkMountWizard()
    {
        networkWizardType = NetworkDiskType.CIFS;
        networkWizardServer = string.Empty;
        networkWizardSharePath = string.Empty;
        networkWizardMountPoint = string.Empty;
        networkWizardUsername = string.Empty;
        networkWizardPassword = string.Empty;
        networkWizardDomain = string.Empty;
        networkWizardOptions = string.Empty;
        networkWizardPermanent = false;
        networkWizardMessage = string.Empty;
        networkWizardError = false;
        showNetworkMountWizard = true;
    }

    private void HideNetworkMountWizard()
    {
        showNetworkMountWizard = false;
    }

    private async Task ExecuteNetworkMountWizard()
    {
        if (string.IsNullOrWhiteSpace(networkWizardServer) || 
            string.IsNullOrWhiteSpace(networkWizardSharePath) || 
            string.IsNullOrWhiteSpace(networkWizardMountPoint))
            return;

        isProcessing = true;
        networkWizardMessage = string.Empty;

        try
        {
            string result;
            if (networkWizardPermanent)
            {
                result = await DiskManagementService.MountNetworkDiskPermanentAsync(
                    networkWizardServer,
                    networkWizardSharePath,
                    networkWizardMountPoint,
                    networkWizardType,
                    string.IsNullOrWhiteSpace(networkWizardUsername) ? null : networkWizardUsername,
                    string.IsNullOrWhiteSpace(networkWizardPassword) ? null : networkWizardPassword,
                    string.IsNullOrWhiteSpace(networkWizardDomain) ? null : networkWizardDomain,
                    string.IsNullOrWhiteSpace(networkWizardOptions) ? null : networkWizardOptions);
            }
            else
            {
                result = await DiskManagementService.MountNetworkDiskAsync(
                    networkWizardServer,
                    networkWizardSharePath,
                    networkWizardMountPoint,
                    networkWizardType,
                    string.IsNullOrWhiteSpace(networkWizardUsername) ? null : networkWizardUsername,
                    string.IsNullOrWhiteSpace(networkWizardPassword) ? null : networkWizardPassword,
                    string.IsNullOrWhiteSpace(networkWizardDomain) ? null : networkWizardDomain,
                    string.IsNullOrWhiteSpace(networkWizardOptions) ? null : networkWizardOptions);
            }

            var operationResult = new
            {
                Success = result.Contains("Successfully", StringComparison.OrdinalIgnoreCase),
                Message = result
            };

            networkWizardMessage = operationResult.Message;
            networkWizardError = !operationResult.Success;
            if (!networkWizardError)
            {
                await RefreshData();
                await Task.Delay(2000);
                // Clear sensitive data from memory
                networkWizardPassword = string.Empty;
                HideNetworkMountWizard();
            }
        }
        catch (Exception ex)
        {
            networkWizardMessage = $"æŒ‚è½½å¤±è´¥: {ex.Message}";
            networkWizardError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ShowPowerManagement(DiskInfo disk)
    {
        selectedDiskForPower = disk;
        powerStatus = string.Empty;
        powerMessage = string.Empty;
        powerError = false;
        
        // Load existing power settings from hdparm.conf
        var settings = await DiskManagementService.GetDiskPowerSettingsAsync(disk.DevicePath);
        spinDownTimeout = settings.SpinDownTimeoutMinutes;
        apmLevel = settings.ApmLevel ?? 128;
        
        showPowerManagement = true;
    }

    private void HidePowerManagement()
    {
        showPowerManagement = false;
        selectedDiskForPower = null;
    }

    private async Task CheckPowerStatus()
    {
        if (selectedDiskForPower == null)
            return;

        powerMessage = string.Empty;
        try
        {
            powerStatus = await DiskManagementService.GetDiskPowerStatusAsync(selectedDiskForPower.DevicePath);
        }
        catch (Exception ex)
        {
            powerMessage = $"æŸ¥è¯¢å¤±è´¥: {ex.Message}";
            powerError = true;
        }
    }

    private async Task SetSpinDown()
    {
        if (selectedDiskForPower == null)
            return;

        isProcessing = true;
        currentOperation = "spindown";
        powerMessage = string.Empty;

        try
        {
            var result = await DiskManagementService.SetDiskSpinDownAsync(selectedDiskForPower.DevicePath, spinDownTimeout);
            powerMessage = result;
            powerError = !result.Contains("Set") && !result.Contains("Disabled");
        }
        catch (Exception ex)
        {
            powerMessage = $"è®¾ç½®å¤±è´¥: {ex.Message}";
            powerError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }

    private async Task SetApmLevel()
    {
        if (selectedDiskForPower == null)
            return;

        isProcessing = true;
        currentOperation = "apm";
        powerMessage = string.Empty;

        try
        {
            var result = await DiskManagementService.SetDiskApmLevelAsync(selectedDiskForPower.DevicePath, apmLevel);
            powerMessage = result;
            powerError = !result.Contains("Set");
        }
        catch (Exception ex)
        {
            powerMessage = $"è®¾ç½®å¤±è´¥: {ex.Message}";
            powerError = true;
        }
        finally
        {
            isProcessing = false;
            currentOperation = string.Empty;
        }
    }

    private string FormatUuid(string uuid)
    {
        if (string.IsNullOrEmpty(uuid))
        {
            return "-";
        }
        
        return uuid.Length > 8 ? uuid[..8] + "..." : uuid;
    }
    
    private async Task ShowFeatureDetection()
    {
        showFeatureDetection = true;
        featureDetectionResult = null;
        await RunFeatureDetection();
    }
    
    private async Task RunFeatureDetection()
    {
        try
        {
            featureDetectionResult = await DiskManagementService.DetectFeaturesAsync();
        }
        catch (Exception ex)
        {
            featureDetectionResult = new DiskManagementFeatureDetection
            {
                DetectedOS = "Unknown",
                Summary = $"æ£€æµ‹å¤±è´¥: {ex.Message}",
                AllRequiredFeaturesAvailable = false,
                Requirements = new List<FeatureRequirement>()
            };
        }
    }
    
    private void HideFeatureDetection()
    {
        showFeatureDetection = false;
    }
}
