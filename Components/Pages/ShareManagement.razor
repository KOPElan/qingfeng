@page "/share-management"
@using QingFeng.Services
@using QingFeng.Models
@inherits AuthorizedPageBase
@inject IShareManagementService ShareManagementService
@rendermode InteractiveServer

<PageTitle>å…±äº«ç›®å½•ç®¡ç†</PageTitle>

<style>
    .fluent-table {
        border-collapse: collapse;
    }

    .fluent-table th {
        text-align: left;
        padding: calc(var(--design-unit) * 3px);
        border-bottom: calc(var(--stroke-width, 1px) * 2) solid var(--neutral-stroke-divider-rest);
        font-weight: 600;
    }

    .fluent-table td {
        padding: calc(var(--design-unit) * 3px);
        border-bottom: var(--stroke-width, 1px) solid var(--neutral-stroke-divider-rest);
        vertical-align: middle;
    }

    .fluent-table tr:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
</style>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="padding: 2rem;">
<FluentLabel Typo="Typography.H3">ğŸ“ å…±äº«ç›®å½•ç®¡ç†</FluentLabel>

<FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; margin-bottom: 1rem;">
    <FluentButton Appearance="Appearance.Accent" OnClick="RefreshData">
        ğŸ”„ åˆ·æ–°
    </FluentButton>
    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowAddShareDialog()">
        â• æ·»åŠ å…±äº«
    </FluentButton>
</FluentStack>

@if (!string.IsNullOrEmpty(message))
{
    <FluentMessageBar Intent="@(isError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
        @message
        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => message = string.Empty)" aria-label="Close" Style="margin-left: auto;">
            âœ•
        </FluentButton>
    </FluentMessageBar>
}

<!-- CIFS/Samba Shares -->
<FluentCard Style="margin-bottom: 1.5rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸ’¼ Samba/CIFS å…±äº«
        </FluentLabel>
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
            <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowAddShareDialog(ShareType.CIFS)" Style="font-size: 0.875rem;">
                â• æ·»åŠ  CIFS å…±äº«
            </FluentButton>
            <FluentButton Appearance="Appearance.Outline" OnClick="RestartSambaService" Style="font-size: 0.875rem;">
                ğŸ”„ é‡å¯æœåŠ¡
            </FluentButton>
        </FluentStack>
    </FluentStack>
    @if (cifsShares != null && cifsShares.Any())
    {
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="CIFSå…±äº«">
                <thead>
                    <tr>
                        <th scope="col">å…±äº«å</th>
                        <th scope="col">è·¯å¾„</th>
                        <th scope="col">è¯´æ˜</th>
                        <th scope="col">å¯æµè§ˆ</th>
                        <th scope="col">åªè¯»</th>
                        <th scope="col">å…è®¸è®¿å®¢</th>
                        <th scope="col">æœ‰æ•ˆç”¨æˆ·</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var share in cifsShares)
                    {
                        <tr>
                            <td><strong>@share.Name</strong></td>
                            <td>@share.Path</td>
                            <td>@share.Comment</td>
                            <td>
                                @if (share.Browseable)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#107C10">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">å¦</FluentBadge>
                                }
                            </td>
                            <td>
                                @if (share.ReadOnly)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">å¦</FluentBadge>
                                }
                            </td>
                            <td>
                                @if (share.GuestOk)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#FFB900">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">å¦</FluentBadge>
                                }
                            </td>
                            <td>@(string.IsNullOrWhiteSpace(share.ValidUsers) ? "æ‰€æœ‰ç”¨æˆ·" : share.ValidUsers)</td>
                            <td>
                                <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
                                    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowEditShareDialog(share)" Title="ç¼–è¾‘æƒé™" Style="font-size: 0.875rem;">
                                        âœï¸ ç¼–è¾‘
                                    </FluentButton>
                                    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowRemoveConfirmation(share)" Title="åˆ é™¤å…±äº«" Style="font-size: 0.875rem;">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </FluentButton>
                                </FluentStack>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center; margin-top: 1rem;">
            <FluentProgressRing />
            <p style="margin: 0;">åŠ è½½ä¸­...</p>
        </FluentStack>
    }
    else
    {
        <p style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰é…ç½®çš„ CIFS å…±äº«</p>
    }
</FluentCard>

<!-- NFS Exports -->
<FluentCard Style="margin-bottom: 1.5rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸŒ NFS å¯¼å‡º
        </FluentLabel>
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
            <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowAddShareDialog(ShareType.NFS)" Style="font-size: 0.875rem;">
                â• æ·»åŠ  NFS å¯¼å‡º
            </FluentButton>
            <FluentButton Appearance="Appearance.Outline" OnClick="RestartNfsService" Style="font-size: 0.875rem;">
                ğŸ”„ é‡å¯æœåŠ¡
            </FluentButton>
        </FluentStack>
    </FluentStack>
    @if (nfsShares != null && nfsShares.Any())
    {
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="NFSå¯¼å‡º">
                <thead>
                    <tr>
                        <th scope="col">å¯¼å‡ºè·¯å¾„</th>
                        <th scope="col">å…è®¸ä¸»æœº</th>
                        <th scope="col">é€‰é¡¹</th>
                        <th scope="col">åªè¯»</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var share in nfsShares)
                    {
                        <tr>
                            <td><strong>@share.Path</strong></td>
                            <td>@share.AllowedHosts</td>
                            <td><code style="font-size: 0.875rem;">@share.NfsOptions</code></td>
                            <td>
                                @if (share.ReadOnly)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#107C10">è¯»å†™</FluentBadge>
                                }
                            </td>
                            <td>
                                <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
                                    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowEditShareDialog(share)" Title="ç¼–è¾‘å¯¼å‡º" Style="font-size: 0.875rem;">
                                        âœï¸ ç¼–è¾‘
                                    </FluentButton>
                                    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowRemoveConfirmation(share)" Title="åˆ é™¤å¯¼å‡º" Style="font-size: 0.875rem;">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </FluentButton>
                                </FluentStack>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center; margin-top: 1rem;">
            <FluentProgressRing />
            <p style="margin: 0;">åŠ è½½ä¸­...</p>
        </FluentStack>
    }
    else
    {
        <p style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰é…ç½®çš„ NFS å¯¼å‡º</p>
    }
</FluentCard>
</FluentStack>

<!-- Add/Edit Share Dialog -->
<FluentDialog Hidden="@(!showShareDialog)" Modal="true" OnDismiss="HideShareDialog" Style="width: 90%; max-width: 700px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">@(isEditMode ? "âœï¸ ç¼–è¾‘å…±äº«" : "â• æ·»åŠ å…±äº«")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(dialogMessage))
        {
            <FluentMessageBar Intent="@(dialogError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
                @dialogMessage
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => dialogMessage = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                    âœ•
                </FluentButton>
            </FluentMessageBar>
        }

        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            @if (!isEditMode)
            {
                <div>
                    <FluentLabel>å…±äº«ç±»å‹ *</FluentLabel>
                    <FluentRadioGroup @bind-Value="shareRequest.Type">
                        <FluentRadio Value="@ShareType.CIFS">CIFS/Samba (Windows å…±äº«)</FluentRadio>
                        <FluentRadio Value="@ShareType.NFS">NFS (Linux/Unix å…±äº«)</FluentRadio>
                    </FluentRadioGroup>
                </div>
            }

            @if (shareRequest.Type == ShareType.CIFS)
            {
                <div>
                    <FluentLabel>å…±äº«å *</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.Name" Placeholder="MyShare" Style="width: 100%;" Disabled="@isEditMode" />
                    <small style="color: var(--neutral-foreground-hint);">ç½‘ç»œä¸Šæ˜¾ç¤ºçš„å…±äº«åç§°</small>
                </div>
            }

            <div>
                <FluentLabel>æœ¬åœ°è·¯å¾„ *</FluentLabel>
                <FluentTextField @bind-Value="shareRequest.Path" Placeholder="/srv/shares/data" Style="width: 100%;" Disabled="@(isEditMode && shareRequest.Type == ShareType.NFS)" />
                <small style="color: var(--neutral-foreground-hint);">è¦å…±äº«çš„æœ¬åœ°ç›®å½•è·¯å¾„</small>
            </div>

            @if (shareRequest.Type == ShareType.CIFS)
            {
                <div>
                    <FluentLabel>è¯´æ˜ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.Comment" Placeholder="å…±äº«æ–‡ä»¶å¤¹è¯´æ˜" Style="width: 100%;" />
                </div>

                <div>
                    <FluentStack Orientation="Orientation.Horizontal" Style="gap: 1.5rem; flex-wrap: wrap;">
                        <FluentCheckbox @bind-Value="shareRequest.Browseable">å¯æµè§ˆ</FluentCheckbox>
                        <FluentCheckbox @bind-Value="shareRequest.ReadOnly">åªè¯»</FluentCheckbox>
                        <FluentCheckbox @bind-Value="shareRequest.GuestOk">å…è®¸è®¿å®¢è®¿é—®</FluentCheckbox>
                    </FluentStack>
                </div>

                <div>
                    <FluentLabel>æœ‰æ•ˆç”¨æˆ·ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.ValidUsers" Placeholder="user1, user2, group" Style="width: 100%;" />
                    <small style="color: var(--neutral-foreground-hint);">å…è®¸è®¿é—®çš„ç”¨æˆ·åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”ã€‚ä½¿ç”¨ @@ å‰ç¼€è¡¨ç¤ºç»„ã€‚ç•™ç©ºè¡¨ç¤ºå…è®¸æ‰€æœ‰ç”¨æˆ·</small>
                </div>

                @if (shareRequest.ReadOnly)
                {
                    <div>
                        <FluentLabel>å†™å…¥åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                        <FluentTextField @bind-Value="shareRequest.WriteList" Placeholder="admin, admins" Style="width: 100%;" />
                        <small style="color: var(--neutral-foreground-hint);">åœ¨åªè¯»å…±äº«ä¸­å…è®¸å†™å…¥çš„ç”¨æˆ·åˆ—è¡¨ã€‚ä½¿ç”¨ @@ å‰ç¼€è¡¨ç¤ºç»„</small>
                    </div>
                }
            }
            else
            {
                <div>
                    <FluentLabel>å…è®¸ä¸»æœº *</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.AllowedHosts" Placeholder="*" Style="width: 100%;" />
                    <small style="color: var(--neutral-foreground-hint);">å…è®¸è®¿é—®çš„ä¸»æœºï¼Œå¦‚: * (æ‰€æœ‰), 192.168.1.0/24, host.domain.com</small>
                </div>

                <div>
                    <FluentLabel>NFS é€‰é¡¹</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.NfsOptions" Placeholder="rw,sync,no_subtree_check" Style="width: 100%;" />
                    <small style="color: var(--neutral-foreground-hint);">NFS å¯¼å‡ºé€‰é¡¹ï¼Œå¦‚: rw, ro, sync, async, no_subtree_check</small>
                </div>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideShareDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="SaveShare" Disabled="@(string.IsNullOrWhiteSpace(shareRequest.Path) || (shareRequest.Type == ShareType.CIFS && string.IsNullOrWhiteSpace(shareRequest.Name)) || isProcessing)">
            @if (isProcessing)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            âœ“ @(isEditMode ? "ä¿å­˜" : "æ·»åŠ ")
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Remove Confirmation Dialog -->
<FluentDialog Hidden="@(!showRemoveDialog)" Modal="true" OnDismiss="HideRemoveDialog" Style="width: 90%; max-width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">âš ï¸ ç¡®è®¤åˆ é™¤</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (shareToRemove != null)
        {
            <p>ç¡®å®šè¦åˆ é™¤@(shareToRemove.Type == ShareType.CIFS ? "å…±äº«" : "å¯¼å‡º") <strong>@(shareToRemove.Type == ShareType.CIFS ? shareToRemove.Name : shareToRemove.Path)</strong> å—ï¼Ÿ</p>
            <p style="color: var(--neutral-foreground-hint);">æ­¤æ“ä½œå°†ä»é…ç½®æ–‡ä»¶ä¸­åˆ é™¤è¯¥å…±äº«è®¾ç½®ã€‚</p>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideRemoveDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="ConfirmRemove" Disabled="@isProcessing">
            @if (isProcessing)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            ç¡®è®¤åˆ é™¤
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<ShareInfo> cifsShares = new();
    private List<ShareInfo> nfsShares = new();
    private bool isLoading = false;
    private bool isProcessing = false;
    private string message = string.Empty;
    private bool isError = false;
    
    // Share dialog
    private bool showShareDialog = false;
    private bool isEditMode = false;
    private string dialogMessage = string.Empty;
    private bool dialogError = false;
    private ShareRequest shareRequest = new();
    private string? originalShareName = null;
    
    // Remove dialog
    private bool showRemoveDialog = false;
    private ShareInfo? shareToRemove = null;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender && IsAuthorized)
        {
            await RefreshData();
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        isLoading = true;
        message = string.Empty;
        
        try
        {
            cifsShares = await ShareManagementService.GetCifsSharesAsync();
            nfsShares = await ShareManagementService.GetNfsSharesAsync();
        }
        catch (Exception ex)
        {
            message = $"åŠ è½½å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddShareDialog(ShareType? type = null)
    {
        isEditMode = false;
        shareRequest = new ShareRequest
        {
            Type = type ?? ShareType.CIFS,
            Browseable = true,
            AllowedHosts = "*",
            NfsOptions = "rw,sync,no_subtree_check"
        };
        originalShareName = null;
        dialogMessage = string.Empty;
        dialogError = false;
        showShareDialog = true;
    }

    private void ShowEditShareDialog(ShareInfo share)
    {
        isEditMode = true;
        shareRequest = new ShareRequest
        {
            Name = share.Name,
            Path = share.Path,
            Type = share.Type,
            Comment = share.Comment,
            Browseable = share.Browseable,
            ReadOnly = share.ReadOnly,
            GuestOk = share.GuestOk,
            ValidUsers = share.ValidUsers,
            WriteList = share.WriteList,
            AllowedHosts = share.AllowedHosts,
            NfsOptions = share.NfsOptions
        };
        originalShareName = share.Type == ShareType.CIFS ? share.Name : share.Path;
        dialogMessage = string.Empty;
        dialogError = false;
        showShareDialog = true;
    }

    private void HideShareDialog()
    {
        showShareDialog = false;
    }

    private async Task SaveShare()
    {
        isProcessing = true;
        dialogMessage = string.Empty;
        
        try
        {
            string result;
            
            if (isEditMode)
            {
                // Update existing share
                if (shareRequest.Type == ShareType.CIFS)
                {
                    result = await ShareManagementService.UpdateCifsShareAsync(originalShareName!, shareRequest);
                }
                else
                {
                    result = await ShareManagementService.UpdateNfsShareAsync(originalShareName!, shareRequest);
                }
            }
            else
            {
                // Add new share
                if (shareRequest.Type == ShareType.CIFS)
                {
                    result = await ShareManagementService.AddCifsShareAsync(shareRequest);
                }
                else
                {
                    result = await ShareManagementService.AddNfsShareAsync(shareRequest);
                }
            }
            
            dialogMessage = result;
            dialogError = !result.Contains("Success", StringComparison.OrdinalIgnoreCase);
            
            if (!dialogError)
            {
                await Task.Delay(1500);
                showShareDialog = false;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            dialogMessage = $"æ“ä½œå¤±è´¥: {ex.Message}";
            dialogError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowRemoveConfirmation(ShareInfo share)
    {
        shareToRemove = share;
        showRemoveDialog = true;
    }

    private void HideRemoveDialog()
    {
        showRemoveDialog = false;
        shareToRemove = null;
    }

    private async Task ConfirmRemove()
    {
        if (shareToRemove == null)
            return;

        isProcessing = true;
        message = string.Empty;
        
        try
        {
            string result;
            
            if (shareToRemove.Type == ShareType.CIFS)
            {
                result = await ShareManagementService.RemoveCifsShareAsync(shareToRemove.Name);
            }
            else
            {
                result = await ShareManagementService.RemoveNfsShareAsync(shareToRemove.Path);
            }
            
            message = result;
            isError = !result.Contains("Success", StringComparison.OrdinalIgnoreCase);
            
            if (!isError)
            {
                showRemoveDialog = false;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            message = $"åˆ é™¤å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartSambaService()
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            var result = await ShareManagementService.RestartSambaServiceAsync();
            message = result;
            isError = !result.Contains("Success", StringComparison.OrdinalIgnoreCase);
        }
        catch (Exception ex)
        {
            message = $"é‡å¯æœåŠ¡å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartNfsService()
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            var result = await ShareManagementService.RestartNfsServiceAsync();
            message = result;
            isError = !result.Contains("Success", StringComparison.OrdinalIgnoreCase);
        }
        catch (Exception ex)
        {
            message = $"é‡å¯æœåŠ¡å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }
}
