@page "/share-management"
@using QingFeng.Services
@using QingFeng.Models
@inherits AuthorizedPageBase
@inject IShareManagementService ShareManagementService
@rendermode InteractiveServer

<PageTitle>å…±äº«ç›®å½•ç®¡ç†</PageTitle>

<style>
    .fluent-table {
        border-collapse: collapse;
    }

    .fluent-table th {
        text-align: left;
        padding: calc(var(--design-unit) * 3px);
        border-bottom: calc(var(--stroke-width, 1px) * 2) solid var(--neutral-stroke-divider-rest);
        font-weight: 600;
    }

    .fluent-table td {
        padding: calc(var(--design-unit) * 3px);
        border-bottom: var(--stroke-width, 1px) solid var(--neutral-stroke-divider-rest);
        vertical-align: middle;
    }

    .fluent-table tr:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
</style>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="padding: 2rem;">
<FluentLabel Typo="Typography.H3">ğŸ“ å…±äº«ç›®å½•ç®¡ç†</FluentLabel>

<FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; margin-bottom: 1rem;">
    <FluentButton Appearance="Appearance.Accent" OnClick="RefreshData">
        ğŸ”„ åˆ·æ–°
    </FluentButton>
    <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowAddShareDialog()">
        â• æ·»åŠ å…±äº«
    </FluentButton>
    <FluentButton Appearance="Appearance.Outline" OnClick="ShowFeatureDetection">
        ğŸ” åŠŸèƒ½æ£€æµ‹
    </FluentButton>
</FluentStack>

@if (!string.IsNullOrEmpty(message))
{
    <FluentMessageBar Intent="@(isError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
        @message
        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => message = string.Empty)" aria-label="Close" Style="margin-left: auto;">
            âœ•
        </FluentButton>
    </FluentMessageBar>
}

<!-- CIFS/Samba Shares -->
<FluentCard Style="margin-bottom: 1.5rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸ’¼ Samba/CIFS å…±äº«
        </FluentLabel>
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
            <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowAddShareDialog(ShareType.CIFS)" Style="font-size: 0.875rem;">
                â• æ·»åŠ  CIFS å…±äº«
            </FluentButton>
            <FluentButton Appearance="Appearance.Outline" OnClick="RestartSambaService" Style="font-size: 0.875rem;">
                ğŸ”„ é‡å¯æœåŠ¡
            </FluentButton>
        </FluentStack>
    </FluentStack>
    @if (cifsShares != null && cifsShares.Any())
    {
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="CIFSå…±äº«">
                <thead>
                    <tr>
                        <th scope="col">å…±äº«å</th>
                        <th scope="col">è·¯å¾„</th>
                        <th scope="col">è¯´æ˜</th>
                        <th scope="col">å¯æµè§ˆ</th>
                        <th scope="col">åªè¯»</th>
                        <th scope="col">å…è®¸è®¿å®¢</th>
                        <th scope="col">æœ‰æ•ˆç”¨æˆ·</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var share in cifsShares)
                    {
                        <tr>
                            <td><strong>@share.Name</strong></td>
                            <td>@share.Path</td>
                            <td>@share.Comment</td>
                            <td>
                                @if (share.Browseable)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#107C10">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">å¦</FluentBadge>
                                }
                            </td>
                            <td>
                                @if (share.ReadOnly)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">å¦</FluentBadge>
                                }
                            </td>
                            <td>
                                @if (share.GuestOk)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#FFB900">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">å¦</FluentBadge>
                                }
                            </td>
                            <td>@(string.IsNullOrWhiteSpace(share.ValidUsers) ? "æ‰€æœ‰ç”¨æˆ·" : share.ValidUsers)</td>
                            <td>
                                <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
                                    <FluentButton Appearance="Appearance.Outline" 
                                                  OnClick="() => ShowEditShareDialog(share)" 
                                                  Title="ç¼–è¾‘æƒé™" 
                                                  aria-label="@($"ç¼–è¾‘å…±äº« {share.Name}")"
                                                  Style="font-size: 0.875rem;">
                                        âœï¸ ç¼–è¾‘
                                    </FluentButton>
                                    <FluentButton Appearance="Appearance.Outline" 
                                                  OnClick="() => ShowRemoveConfirmation(share)" 
                                                  Title="åˆ é™¤å…±äº«" 
                                                  aria-label="@($"åˆ é™¤å…±äº« {share.Name}")"
                                                  Style="font-size: 0.875rem;">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </FluentButton>
                                </FluentStack>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center; margin-top: 1rem;">
            <FluentProgressRing />
            <p style="margin: 0;">åŠ è½½ä¸­...</p>
        </FluentStack>
    }
    else
    {
        <p style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰é…ç½®çš„ CIFS å…±äº«</p>
    }
</FluentCard>

<!-- NFS Exports -->
<FluentCard Style="margin-bottom: 1.5rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸŒ NFS å¯¼å‡º
        </FluentLabel>
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
            <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowAddShareDialog(ShareType.NFS)" Style="font-size: 0.875rem;">
                â• æ·»åŠ  NFS å¯¼å‡º
            </FluentButton>
            <FluentButton Appearance="Appearance.Outline" OnClick="RestartNfsService" Style="font-size: 0.875rem;">
                ğŸ”„ é‡å¯æœåŠ¡
            </FluentButton>
        </FluentStack>
    </FluentStack>
    @if (nfsShares != null && nfsShares.Any())
    {
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="NFSå¯¼å‡º">
                <thead>
                    <tr>
                        <th scope="col">å¯¼å‡ºè·¯å¾„</th>
                        <th scope="col">å…è®¸ä¸»æœº</th>
                        <th scope="col">é€‰é¡¹</th>
                        <th scope="col">åªè¯»</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var share in nfsShares)
                    {
                        <tr>
                            <td><strong>@share.Path</strong></td>
                            <td>@share.AllowedHosts</td>
                            <td><code style="font-size: 0.875rem;">@share.NfsOptions</code></td>
                            <td>
                                @if (share.ReadOnly)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">æ˜¯</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#107C10">è¯»å†™</FluentBadge>
                                }
                            </td>
                            <td>
                                <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
                                    <FluentButton Appearance="Appearance.Outline" 
                                                  OnClick="() => ShowEditShareDialog(share)" 
                                                  Title="ç¼–è¾‘å¯¼å‡º" 
                                                  aria-label="@($"ç¼–è¾‘å¯¼å‡º {share.Path}")"
                                                  Style="font-size: 0.875rem;">
                                        âœï¸ ç¼–è¾‘
                                    </FluentButton>
                                    <FluentButton Appearance="Appearance.Outline" 
                                                  OnClick="() => ShowRemoveConfirmation(share)" 
                                                  Title="åˆ é™¤å¯¼å‡º" 
                                                  aria-label="@($"åˆ é™¤å¯¼å‡º {share.Path}")"
                                                  Style="font-size: 0.875rem;">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </FluentButton>
                                </FluentStack>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoading)
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center; margin-top: 1rem;">
            <FluentProgressRing />
            <p style="margin: 0;">åŠ è½½ä¸­...</p>
        </FluentStack>
    }
    else
    {
        <p style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰é…ç½®çš„ NFS å¯¼å‡º</p>
    }
</FluentCard>

<!-- Samba Users -->
<FluentCard Style="margin-bottom: 1.5rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸ‘¤ Samba ç”¨æˆ·ç®¡ç†
        </FluentLabel>
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
            <FluentButton Appearance="Appearance.Outline" OnClick="() => ShowAddSambaUserDialog()" Style="font-size: 0.875rem;">
                â• æ·»åŠ  Samba ç”¨æˆ·
            </FluentButton>
            <FluentButton Appearance="Appearance.Outline" OnClick="RefreshSambaUsers" Style="font-size: 0.875rem;">
                ğŸ”„ åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
            </FluentButton>
        </FluentStack>
    </FluentStack>
    @if (sambaUsers != null && sambaUsers.Any())
    {
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="Sambaç”¨æˆ·">
                <thead>
                    <tr>
                        <th scope="col">ç”¨æˆ·å</th>
                        <th scope="col">ç”¨æˆ·ID</th>
                        <th scope="col">çŠ¶æ€</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in sambaUsers)
                    {
                        <tr>
                            <td><strong>@user.Username</strong></td>
                            <td>@user.Uid</td>
                            <td>
                                @if (user.HasSambaPassword)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#107C10">å·²å¯ç”¨</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">æœªå¯ç”¨</FluentBadge>
                                }
                            </td>
                            <td>
                                <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
                                    <FluentButton Appearance="Appearance.Outline" 
                                                  OnClick="() => ShowChangeSambaPasswordDialog(user.Username)" 
                                                  Title="ä¿®æ”¹å¯†ç " 
                                                  aria-label="@($"ä¿®æ”¹ç”¨æˆ· {user.Username} çš„å¯†ç ")"
                                                  Style="font-size: 0.875rem;">
                                        ğŸ”‘ ä¿®æ”¹å¯†ç 
                                    </FluentButton>
                                    <FluentButton Appearance="Appearance.Outline" 
                                                  OnClick="() => ShowRemoveSambaUserConfirmation(user.Username)" 
                                                  Title="åˆ é™¤ç”¨æˆ·" 
                                                  aria-label="@($"åˆ é™¤ç”¨æˆ· {user.Username}")"
                                                  Style="font-size: 0.875rem;">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </FluentButton>
                                </FluentStack>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (isLoadingSambaUsers)
    {
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center; margin-top: 1rem;">
            <FluentProgressRing />
            <p style="margin: 0;">åŠ è½½ä¸­...</p>
        </FluentStack>
    }
    else
    {
        <p style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰é…ç½®çš„ Samba ç”¨æˆ·</p>
    }
</FluentCard>
</FluentStack>

<!-- Add/Edit Share Dialog -->
<FluentDialog Hidden="@(!showShareDialog)" Modal="true" OnDismiss="HideShareDialog" Style="width: 90%; max-width: 700px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">@(isEditMode ? "âœï¸ ç¼–è¾‘å…±äº«" : "â• æ·»åŠ å…±äº«")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(dialogMessage))
        {
            <FluentMessageBar Intent="@(dialogError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
                @dialogMessage
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => dialogMessage = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                    âœ•
                </FluentButton>
            </FluentMessageBar>
        }

        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            @if (!isEditMode)
            {
                <div>
                    <FluentLabel>å…±äº«ç±»å‹ *</FluentLabel>
                    <FluentRadioGroup @bind-Value="shareRequest.Type">
                        <FluentRadio Value="@ShareType.CIFS">CIFS/Samba (Windows å…±äº«)</FluentRadio>
                        <FluentRadio Value="@ShareType.NFS">NFS (Linux/Unix å…±äº«)</FluentRadio>
                    </FluentRadioGroup>
                </div>
            }

            @if (shareRequest.Type == ShareType.CIFS)
            {
                <div>
                    <FluentLabel>å…±äº«å *</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.Name" Placeholder="MyShare" Style="width: 100%;" Disabled="@isEditMode" />
                    <small style="color: var(--neutral-foreground-hint);">ç½‘ç»œä¸Šæ˜¾ç¤ºçš„å…±äº«åç§°</small>
                </div>
            }

            <div>
                <FluentLabel>æœ¬åœ°è·¯å¾„ *</FluentLabel>
                <FluentAutocomplete TOption="string"
                                    Value="@shareRequest.Path"
                                    ValueChanged="@OnPathValueChanged"
                                    OnOptionsSearch="@OnSearchDirectories"
                                    SelectedOptionsChanged="@OnPathSelected"
                                    Placeholder="/srv/shares/data"
                                    Style="width: 100%;"
                                    Disabled="@(isEditMode && shareRequest.Type == ShareType.NFS)"
                                    MaximumSelectedOptions="1"
                                    OptionText="@(item => item)" />
                <small style="color: var(--neutral-foreground-hint);">è¦å…±äº«çš„æœ¬åœ°ç›®å½•è·¯å¾„ã€‚è¾“å…¥æ—¶ä¼šæ˜¾ç¤ºç›®å½•å»ºè®®</small>
            </div>

            @if (shareRequest.Type == ShareType.CIFS)
            {
                <div>
                    <FluentLabel>è¯´æ˜ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.Comment" Placeholder="å…±äº«æ–‡ä»¶å¤¹è¯´æ˜" Style="width: 100%;" />
                </div>

                <div>
                    <FluentStack Orientation="Orientation.Horizontal" Style="gap: 1.5rem; flex-wrap: wrap;">
                        <FluentCheckbox @bind-Value="shareRequest.Browseable">å¯æµè§ˆ</FluentCheckbox>
                        <FluentCheckbox @bind-Value="shareRequest.ReadOnly">åªè¯»</FluentCheckbox>
                        <FluentCheckbox @bind-Value="shareRequest.GuestOk">å…è®¸è®¿å®¢è®¿é—®</FluentCheckbox>
                    </FluentStack>
                </div>

                <div>
                    <FluentLabel>æœ‰æ•ˆç”¨æˆ·ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.ValidUsers" Placeholder="user1, user2, group" Style="width: 100%;" />
                    <small style="color: var(--neutral-foreground-hint);">å…è®¸è®¿é—®çš„ç”¨æˆ·åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”ã€‚ä½¿ç”¨ &commat; å‰ç¼€è¡¨ç¤ºç»„ã€‚ç•™ç©ºè¡¨ç¤ºå…è®¸æ‰€æœ‰ç”¨æˆ·</small>
                </div>

                @if (shareRequest.ReadOnly)
                {
                    <div>
                        <FluentLabel>å†™å…¥åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰</FluentLabel>
                        <FluentTextField @bind-Value="shareRequest.WriteList" Placeholder="admin, admins" Style="width: 100%;" />
                        <small style="color: var(--neutral-foreground-hint);">åœ¨åªè¯»å…±äº«ä¸­å…è®¸å†™å…¥çš„ç”¨æˆ·åˆ—è¡¨ã€‚ä½¿ç”¨ &commat; å‰ç¼€è¡¨ç¤ºç»„</small>
                    </div>
                }
                
                <div>
                    <FluentLabel>æ–‡ä»¶åˆ›å»ºæƒé™ (Create Mask)</FluentLabel>
                    <FluentSelect TOption="string" @bind-Value="shareRequest.CreateMask" Style="width: 100%;">
                        <FluentOption Value="@("0644")">0644 (rw-r--r--) - æ‰€æœ‰è€…è¯»å†™ï¼Œå…¶ä»–äººåªè¯»</FluentOption>
                        <FluentOption Value="@("0664")">0664 (rw-rw-r--) - æ‰€æœ‰è€…å’Œç»„è¯»å†™ï¼Œå…¶ä»–äººåªè¯»</FluentOption>
                        <FluentOption Value="@("0744")">0744 (rwxr--r--) - æ‰€æœ‰è€…å…¨éƒ¨æƒé™ï¼Œå…¶ä»–äººåªè¯»</FluentOption>
                        <FluentOption Value="@("0755")">0755 (rwxr-xr-x) - æ‰€æœ‰è€…å…¨éƒ¨æƒé™ï¼Œå…¶ä»–äººè¯»å’Œæ‰§è¡Œ</FluentOption>
                        <FluentOption Value="@("0774")">0774 (rwxrwxr--) - æ‰€æœ‰è€…å’Œç»„å…¨éƒ¨æƒé™ï¼Œå…¶ä»–äººåªè¯»</FluentOption>
                        <FluentOption Value="@("0777")">0777 (rwxrwxrwx) - æ‰€æœ‰äººå…¨éƒ¨æƒé™</FluentOption>
                    </FluentSelect>
                    <small style="color: var(--neutral-foreground-hint);">æ–°åˆ›å»ºæ–‡ä»¶çš„é»˜è®¤æƒé™</small>
                </div>
                
                <div>
                    <FluentLabel>ç›®å½•åˆ›å»ºæƒé™ (Directory Mask)</FluentLabel>
                    <FluentSelect TOption="string" @bind-Value="shareRequest.DirectoryMask" Style="width: 100%;">
                        <FluentOption Value="@("0755")">0755 (rwxr-xr-x) - æ‰€æœ‰è€…å…¨éƒ¨æƒé™ï¼Œå…¶ä»–äººè¯»å’Œæ‰§è¡Œ</FluentOption>
                        <FluentOption Value="@("0775")">0775 (rwxrwxr-x) - æ‰€æœ‰è€…å’Œç»„å…¨éƒ¨æƒé™ï¼Œå…¶ä»–äººè¯»å’Œæ‰§è¡Œ</FluentOption>
                        <FluentOption Value="@("0770")">0770 (rwxrwx---) - æ‰€æœ‰è€…å’Œç»„å…¨éƒ¨æƒé™</FluentOption>
                        <FluentOption Value="@("0777")">0777 (rwxrwxrwx) - æ‰€æœ‰äººå…¨éƒ¨æƒé™</FluentOption>
                    </FluentSelect>
                    <small style="color: var(--neutral-foreground-hint);">æ–°åˆ›å»ºç›®å½•çš„é»˜è®¤æƒé™</small>
                </div>
            }
            else
            {
                <div>
                    <FluentLabel>å…è®¸ä¸»æœº *</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.AllowedHosts" Placeholder="*" Style="width: 100%;" />
                    <small style="color: var(--neutral-foreground-hint);">å…è®¸è®¿é—®çš„ä¸»æœºï¼Œå¦‚: * (æ‰€æœ‰), 192.168.1.0/24, host.domain.com</small>
                </div>

                <div>
                    <FluentLabel>NFS é€‰é¡¹</FluentLabel>
                    <FluentTextField @bind-Value="shareRequest.NfsOptions" Placeholder="rw,sync,no_subtree_check" Style="width: 100%;" />
                    <small style="color: var(--neutral-foreground-hint);">NFS å¯¼å‡ºé€‰é¡¹ï¼Œå¦‚: rw, ro, sync, async, no_subtree_check</small>
                </div>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideShareDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="SaveShare" Disabled="@(string.IsNullOrWhiteSpace(shareRequest.Path) || (shareRequest.Type == ShareType.CIFS && string.IsNullOrWhiteSpace(shareRequest.Name)) || isProcessing)">
            @if (isProcessing)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            âœ“ @(isEditMode ? "ä¿å­˜" : "æ·»åŠ ")
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Remove Confirmation Dialog -->
<FluentDialog Hidden="@(!showRemoveDialog)" Modal="true" OnDismiss="HideRemoveDialog" Style="width: 90%; max-width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">âš ï¸ ç¡®è®¤åˆ é™¤</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (shareToRemove != null)
        {
            <p>ç¡®å®šè¦åˆ é™¤@(shareToRemove.Type == ShareType.CIFS ? "å…±äº«" : "å¯¼å‡º") <strong>@(shareToRemove.Type == ShareType.CIFS ? shareToRemove.Name : shareToRemove.Path)</strong> å—ï¼Ÿ</p>
            <p style="color: var(--neutral-foreground-hint);">æ­¤æ“ä½œå°†ä»é…ç½®æ–‡ä»¶ä¸­åˆ é™¤è¯¥å…±äº«è®¾ç½®ã€‚</p>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideRemoveDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="ConfirmRemove" Disabled="@isProcessing">
            @if (isProcessing)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            ç¡®è®¤åˆ é™¤
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Feature Detection Dialog -->
<FluentDialog Hidden="@(!showFeatureDetection)" Modal="true" OnDismiss="HideFeatureDetection" Style="width: 90%; max-width: 900px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">ğŸ” å…±äº«ç®¡ç†åŠŸèƒ½æ£€æµ‹</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (featureDetectionResult == null)
        {
            <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem; align-items: center;">
                <FluentProgressRing />
                <p style="margin: 0;">æ­£åœ¨æ£€æµ‹ç³»ç»ŸåŠŸèƒ½...</p>
            </FluentStack>
        }
        else
        {
            <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
                <div>
                    <FluentLabel Typo="Typography.H6">æ£€æµ‹åˆ°çš„æ“ä½œç³»ç»Ÿ</FluentLabel>
                    <p style="margin: 0.5rem 0;">@featureDetectionResult.DetectedOS</p>
                </div>
                
                <div>
                    <FluentLabel Typo="Typography.H6">æ€»ç»“</FluentLabel>
                    <FluentMessageBar Intent="@(featureDetectionResult.AllRequiredFeaturesAvailable ? MessageIntent.Success : MessageIntent.Warning)" Style="margin-top: 0.5rem;">
                        @featureDetectionResult.Summary
                    </FluentMessageBar>
                </div>
                
                <div>
                    <FluentLabel Typo="Typography.H6">åŠŸèƒ½éœ€æ±‚è¯¦æƒ…</FluentLabel>
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="fluent-table" style="width: 100%;" role="table" aria-label="åŠŸèƒ½éœ€æ±‚">
                            <thead>
                                <tr>
                                    <th scope="col">çŠ¶æ€</th>
                                    <th scope="col">æœåŠ¡/å·¥å…·</th>
                                    <th scope="col">ç±»å‹</th>
                                    <th scope="col">è¯´æ˜</th>
                                    <th scope="col">å®‰è£…å‘½ä»¤</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var req in featureDetectionResult.Requirements)
                                {
                                    <tr>
                                        <td>
                                            @if (req.Status == FeatureStatus.Available)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#107C10">âœ“ å¯ç”¨</FluentBadge>
                                            }
                                            else if (req.Status == FeatureStatus.Missing)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">âœ— ç¼ºå¤±</FluentBadge>
                                            }
                                            else
                                            {
                                                <FluentBadge Appearance="Appearance.Neutral">N/A</FluentBadge>
                                            }
                                        </td>
                                        <td><code>@req.Name</code></td>
                                        <td>
                                            @if (req.IsRequired)
                                            {
                                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="#D13438">å¿…éœ€</FluentBadge>
                                            }
                                            else
                                            {
                                                <FluentBadge Appearance="Appearance.Neutral">å¯é€‰</FluentBadge>
                                            }
                                        </td>
                                        <td>@req.Description</td>
                                        <td>
                                            @if (req.Status == FeatureStatus.Missing && !string.IsNullOrEmpty(req.InstallCommand))
                                            {
                                                <details>
                                                    <summary style="cursor: pointer; color: var(--accent-fill-rest);">æŸ¥çœ‹å®‰è£…å‘½ä»¤</summary>
                                                    <pre style="background-color: var(--neutral-layer-2); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto; font-size: 0.875rem;"><code>@req.InstallCommand</code></pre>
                                                </details>
                                            }
                                            else if (req.Status == FeatureStatus.Available)
                                            {
                                                <span style="color: var(--neutral-foreground-hint);">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <FluentMessageBar Intent="MessageIntent.Info">
                    <strong>æç¤ºï¼š</strong>æ‰€æœ‰å·¥å…·éƒ½æ˜¯å¯é€‰çš„ã€‚CIFS/Samba å·¥å…·ç”¨äº Windows å…±äº«ï¼ŒNFS å·¥å…·ç”¨äº Linux/Unix å…±äº«ã€‚æ ¹æ®éœ€è¦å®‰è£…ç›¸åº”å·¥å…·å³å¯ã€‚
                </FluentMessageBar>
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideFeatureDetection">å…³é—­</FluentButton>
        @if (featureDetectionResult != null)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="RunFeatureDetection">
                ğŸ”„ é‡æ–°æ£€æµ‹
            </FluentButton>
        }
    </FluentDialogFooter>
</FluentDialog>

<!-- Add Samba User Dialog -->
<FluentDialog Hidden="@(!showAddSambaUserDialog)" Modal="true" OnDismiss="HideAddSambaUserDialog" Style="width: 90%; max-width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">â• æ·»åŠ  Samba ç”¨æˆ·</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(sambaUserDialogMessage))
        {
            <FluentMessageBar Intent="@(sambaUserDialogError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
                @sambaUserDialogMessage
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => sambaUserDialogMessage = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                    âœ•
                </FluentButton>
            </FluentMessageBar>
        }

        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            <div>
                <FluentLabel>ç”¨æˆ·å *</FluentLabel>
                <FluentTextField @bind-Value="sambaUserRequest.Username" Placeholder="username" Style="width: 100%;" />
                <small style="color: var(--neutral-foreground-hint);">å¿…é¡»æ˜¯å·²å­˜åœ¨çš„ Unix ç”¨æˆ·å</small>
            </div>

            <div>
                <FluentLabel>å¯†ç  *</FluentLabel>
                <FluentTextField @bind-Value="sambaUserRequest.Password" Placeholder="è¾“å…¥å¯†ç " Style="width: 100%;" Type="InputType.Password" />
                <small style="color: var(--neutral-foreground-hint);">Samba ç”¨æˆ·å¯†ç </small>
            </div>
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideAddSambaUserDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="SaveSambaUser" Disabled="@(string.IsNullOrWhiteSpace(sambaUserRequest.Username) || string.IsNullOrWhiteSpace(sambaUserRequest.Password) || isProcessingSambaUser)">
            @if (isProcessingSambaUser)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            âœ“ æ·»åŠ 
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Change Samba User Password Dialog -->
<FluentDialog Hidden="@(!showChangeSambaPasswordDialog)" Modal="true" OnDismiss="HideChangeSambaPasswordDialog" Style="width: 90%; max-width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">ğŸ”‘ ä¿®æ”¹ Samba ç”¨æˆ·å¯†ç </FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(sambaPasswordDialogMessage))
        {
            <FluentMessageBar Intent="@(sambaPasswordDialogError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
                @sambaPasswordDialogMessage
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => sambaPasswordDialogMessage = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                    âœ•
                </FluentButton>
            </FluentMessageBar>
        }

        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            <div>
                <FluentLabel>ç”¨æˆ·å</FluentLabel>
                <FluentTextField Value="@selectedSambaUsername" Style="width: 100%;" Disabled="true" />
            </div>

            <div>
                <FluentLabel>æ–°å¯†ç  *</FluentLabel>
                <FluentTextField @bind-Value="newSambaPassword" Placeholder="è¾“å…¥æ–°å¯†ç " Style="width: 100%;" Type="InputType.Password" />
            </div>
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideChangeSambaPasswordDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="SaveSambaPassword" Disabled="@(string.IsNullOrWhiteSpace(newSambaPassword) || isProcessingSambaPassword)">
            @if (isProcessingSambaPassword)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            âœ“ ä¿å­˜
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Remove Samba User Confirmation Dialog -->
<FluentDialog Hidden="@(!showRemoveSambaUserDialog)" Modal="true" OnDismiss="HideRemoveSambaUserDialog" Style="width: 90%; max-width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">âš ï¸ ç¡®è®¤åˆ é™¤ Samba ç”¨æˆ·</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <p>ç¡®å®šè¦åˆ é™¤ Samba ç”¨æˆ· <strong>@sambaUserToRemove</strong> å—ï¼Ÿ</p>
        <p style="color: var(--neutral-foreground-hint);">æ­¤æ“ä½œå°†åˆ é™¤è¯¥ç”¨æˆ·çš„ Samba å¯†ç ï¼Œä½†ä¸ä¼šåˆ é™¤ç³»ç»Ÿç”¨æˆ·ã€‚</p>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="HideRemoveSambaUserDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="ConfirmRemoveSambaUser" Disabled="@isProcessingSambaUser">
            @if (isProcessingSambaUser)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            ç¡®è®¤åˆ é™¤
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<ShareInfo> cifsShares = new();
    private List<ShareInfo> nfsShares = new();
    private bool isLoading = false;
    private bool isProcessing = false;
    private string message = string.Empty;
    private bool isError = false;
    
    // Share dialog
    private bool showShareDialog = false;
    private bool isEditMode = false;
    private string dialogMessage = string.Empty;
    private bool dialogError = false;
    private ShareRequest shareRequest = new();
    private string? originalShareName = null;
    
    // Remove dialog
    private bool showRemoveDialog = false;
    private ShareInfo? shareToRemove = null;
    
    // Samba users
    private List<SambaUser> sambaUsers = new();
    private bool isLoadingSambaUsers = false;
    
    // Samba user dialogs
    private bool showAddSambaUserDialog = false;
    private bool showChangeSambaPasswordDialog = false;
    private bool showRemoveSambaUserDialog = false;
    private bool isProcessingSambaUser = false;
    private bool isProcessingSambaPassword = false;
    private string sambaUserDialogMessage = string.Empty;
    private bool sambaUserDialogError = false;
    private string sambaPasswordDialogMessage = string.Empty;
    private bool sambaPasswordDialogError = false;
    private SambaUserRequest sambaUserRequest = new();
    private string selectedSambaUsername = string.Empty;
    private string newSambaPassword = string.Empty;
    private string sambaUserToRemove = string.Empty;
    
    // Feature Detection
    private bool showFeatureDetection = false;
    private ShareManagementFeatureDetection? featureDetectionResult = null;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender && IsAuthorized)
        {
            await RefreshData();
            await RefreshSambaUsers();
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        isLoading = true;
        message = string.Empty;
        
        try
        {
            cifsShares = await ShareManagementService.GetCifsSharesAsync();
            nfsShares = await ShareManagementService.GetNfsSharesAsync();
        }
        catch (Exception ex)
        {
            message = $"åŠ è½½å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddShareDialog(ShareType? type = null)
    {
        isEditMode = false;
        shareRequest = new ShareRequest
        {
            Type = type ?? ShareType.CIFS,
            Browseable = true,
            CreateMask = "0744",
            DirectoryMask = "0755",
            AllowedHosts = "*",
            NfsOptions = "rw,sync,no_subtree_check"
        };
        originalShareName = null;
        dialogMessage = string.Empty;
        dialogError = false;
        showShareDialog = true;
    }

    private void ShowEditShareDialog(ShareInfo share)
    {
        isEditMode = true;
        shareRequest = new ShareRequest
        {
            Name = share.Name,
            Path = share.Path,
            Type = share.Type,
            Comment = share.Comment,
            Browseable = share.Browseable,
            ReadOnly = share.ReadOnly,
            GuestOk = share.GuestOk,
            ValidUsers = share.ValidUsers,
            WriteList = share.WriteList,
            CreateMask = share.CreateMask,
            DirectoryMask = share.DirectoryMask,
            AllowedHosts = share.AllowedHosts,
            NfsOptions = share.NfsOptions
        };
        originalShareName = share.Type == ShareType.CIFS ? share.Name : share.Path;
        dialogMessage = string.Empty;
        dialogError = false;
        showShareDialog = true;
    }

    private void HideShareDialog()
    {
        showShareDialog = false;
    }

    private async Task SaveShare()
    {
        isProcessing = true;
        dialogMessage = string.Empty;
        
        try
        {
            var result = isEditMode
                ? (shareRequest.Type == ShareType.CIFS
                    ? await ShareManagementService.UpdateCifsShareAsync(originalShareName!, shareRequest)
                    : await ShareManagementService.UpdateNfsShareAsync(originalShareName!, shareRequest))
                : (shareRequest.Type == ShareType.CIFS
                    ? await ShareManagementService.AddCifsShareAsync(shareRequest)
                    : await ShareManagementService.AddNfsShareAsync(shareRequest));
            
            dialogMessage = result;
            dialogError = !result.Contains("Successfully", StringComparison.OrdinalIgnoreCase);
            
            if (!dialogError)
            {
                await Task.Delay(1500);
                showShareDialog = false;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            dialogMessage = $"æ“ä½œå¤±è´¥: {ex.Message}";
            dialogError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowRemoveConfirmation(ShareInfo share)
    {
        shareToRemove = share;
        showRemoveDialog = true;
    }

    private void HideRemoveDialog()
    {
        showRemoveDialog = false;
        shareToRemove = null;
    }

    private async Task ConfirmRemove()
    {
        if (shareToRemove == null)
            return;

        isProcessing = true;
        message = string.Empty;
        
        try
        {
            var result = shareToRemove.Type == ShareType.CIFS
                ? await ShareManagementService.RemoveCifsShareAsync(shareToRemove.Name)
                : await ShareManagementService.RemoveNfsShareAsync(shareToRemove.Path);
            
            message = result;
            isError = !result.Contains("Successfully", StringComparison.OrdinalIgnoreCase);
            
            if (!isError)
            {
                showRemoveDialog = false;
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            message = $"åˆ é™¤å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartSambaService()
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            var result = await ShareManagementService.RestartSambaServiceAsync();
            message = result;
            isError = !result.Contains("Successfully", StringComparison.OrdinalIgnoreCase);
        }
        catch (Exception ex)
        {
            message = $"é‡å¯æœåŠ¡å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartNfsService()
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            var result = await ShareManagementService.RestartNfsServiceAsync();
            message = result;
            isError = !result.Contains("Successfully", StringComparison.OrdinalIgnoreCase);
        }
        catch (Exception ex)
        {
            message = $"é‡å¯æœåŠ¡å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }
    
    private async Task ShowFeatureDetection()
    {
        showFeatureDetection = true;
        featureDetectionResult = null;
        await RunFeatureDetection();
    }
    
    private async Task RunFeatureDetection()
    {
        try
        {
            featureDetectionResult = await ShareManagementService.DetectFeaturesAsync();
        }
        catch (Exception ex)
        {
            featureDetectionResult = new ShareManagementFeatureDetection
            {
                DetectedOS = "Unknown",
                Summary = $"æ£€æµ‹å¤±è´¥: {ex.Message}",
                AllRequiredFeaturesAvailable = false,
                Requirements = new List<FeatureRequirement>()
            };
        }
    }
    
    private void HideFeatureDetection()
    {
        showFeatureDetection = false;
    }
    
    // Samba User Management Methods
    private async Task RefreshSambaUsers()
    {
        isLoadingSambaUsers = true;
        message = string.Empty;
        
        try
        {
            sambaUsers = await ShareManagementService.GetSambaUsersAsync();
        }
        catch (Exception ex)
        {
            message = $"åŠ è½½ Samba ç”¨æˆ·å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isLoadingSambaUsers = false;
        }
    }
    
    private void ShowAddSambaUserDialog()
    {
        sambaUserRequest = new SambaUserRequest();
        sambaUserDialogMessage = string.Empty;
        sambaUserDialogError = false;
        showAddSambaUserDialog = true;
    }
    
    private void HideAddSambaUserDialog()
    {
        showAddSambaUserDialog = false;
    }
    
    private async Task SaveSambaUser()
    {
        isProcessingSambaUser = true;
        sambaUserDialogMessage = string.Empty;
        
        try
        {
            var result = await ShareManagementService.AddSambaUserAsync(sambaUserRequest);
            sambaUserDialogMessage = result.Message;
            sambaUserDialogError = !result.Success;
            
            if (result.Success)
            {
                await Task.Delay(1500);
                showAddSambaUserDialog = false;
                await RefreshSambaUsers();
            }
        }
        catch (Exception ex)
        {
            sambaUserDialogMessage = $"æ·»åŠ ç”¨æˆ·å¤±è´¥: {ex.Message}";
            sambaUserDialogError = true;
        }
        finally
        {
            isProcessingSambaUser = false;
        }
    }
    
    private void ShowChangeSambaPasswordDialog(string username)
    {
        selectedSambaUsername = username;
        newSambaPassword = string.Empty;
        sambaPasswordDialogMessage = string.Empty;
        sambaPasswordDialogError = false;
        showChangeSambaPasswordDialog = true;
    }
    
    private void HideChangeSambaPasswordDialog()
    {
        showChangeSambaPasswordDialog = false;
    }
    
    private async Task SaveSambaPassword()
    {
        isProcessingSambaPassword = true;
        sambaPasswordDialogMessage = string.Empty;
        
        try
        {
            var result = await ShareManagementService.UpdateSambaUserPasswordAsync(selectedSambaUsername, newSambaPassword);
            sambaPasswordDialogMessage = result.Message;
            sambaPasswordDialogError = !result.Success;
            
            if (result.Success)
            {
                await Task.Delay(1500);
                showChangeSambaPasswordDialog = false;
            }
        }
        catch (Exception ex)
        {
            sambaPasswordDialogMessage = $"ä¿®æ”¹å¯†ç å¤±è´¥: {ex.Message}";
            sambaPasswordDialogError = true;
        }
        finally
        {
            isProcessingSambaPassword = false;
        }
    }
    
    private void ShowRemoveSambaUserConfirmation(string username)
    {
        sambaUserToRemove = username;
        showRemoveSambaUserDialog = true;
    }
    
    private void HideRemoveSambaUserDialog()
    {
        showRemoveSambaUserDialog = false;
        sambaUserToRemove = string.Empty;
    }
    
    // Directory autocomplete method
    private async Task OnSearchDirectories(OptionsSearchEventArgs<string> e)
    {
        var searchText = e.Text ?? string.Empty;
        var options = new List<string>();
        
        // If empty, show common root directories
        if (string.IsNullOrWhiteSpace(searchText))
        {
            options = new List<string> { "/home", "/mnt", "/srv", "/opt", "/var", "/tmp" };
            e.Items = options;
            return;
        }
        
        try
        {
            // Validate input to prevent path traversal attacks
            if (searchText.Contains("..") || searchText.Contains("~"))
            {
                e.Items = new List<string> { searchText };
                return;
            }
            
            // Determine the directory to search
            string searchDir;
            string prefix;
            
            if (searchText.EndsWith("/"))
            {
                // User typed a complete path with trailing slash, search in that directory
                searchDir = searchText;
                prefix = searchText;
            }
            else
            {
                // Extract directory and partial name
                var lastSlash = searchText.LastIndexOf('/');
                if (lastSlash >= 0)
                {
                    searchDir = searchText.Substring(0, lastSlash + 1);
                    if (string.IsNullOrEmpty(searchDir))
                    {
                        searchDir = "/";
                    }
                    prefix = searchText.Substring(0, lastSlash + 1);
                }
                else
                {
                    searchDir = "/";
                    prefix = "/";
                }
            }
            
            // Get directories from the specified path
            if (Directory.Exists(searchDir))
            {
                var directories = Directory.GetDirectories(searchDir)
                    .Select(d => prefix + Path.GetFileName(d))
                    .Where(d => d.StartsWith(searchText, StringComparison.OrdinalIgnoreCase))
                    .Take(10)
                    .ToList();
                
                options = directories;
            }
        }
        catch (UnauthorizedAccessException)
        {
            // User doesn't have permission to access this directory, return empty
        }
        catch (DirectoryNotFoundException)
        {
            // Directory doesn't exist, return empty
        }
        catch (Exception ex)
        {
            // Log other errors but continue
            System.Diagnostics.Debug.WriteLine($"Error searching directories: {ex.Message}");
        }
        
        e.Items = options.Any() ? options : new List<string> { searchText };
    }
    
    // Handle directory path selection from autocomplete
    private void OnPathSelected(IEnumerable<string> selectedPaths)
    {
        var path = selectedPaths?.FirstOrDefault();
        if (!string.IsNullOrEmpty(path))
        {
            shareRequest.Path = path;
        }
    }
    
    // Handle manual path input changes
    private void OnPathValueChanged(string value)
    {
        shareRequest.Path = value ?? string.Empty;
    }
    
    private async Task ConfirmRemoveSambaUser()
    {
        if (string.IsNullOrEmpty(sambaUserToRemove))
            return;

        isProcessingSambaUser = true;
        message = string.Empty;
        
        try
        {
            var result = await ShareManagementService.RemoveSambaUserAsync(sambaUserToRemove);
            message = result.Message;
            isError = !result.Success;
            
            if (result.Success)
            {
                showRemoveSambaUserDialog = false;
                await RefreshSambaUsers();
            }
        }
        catch (Exception ex)
        {
            message = $"åˆ é™¤ç”¨æˆ·å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessingSambaUser = false;
        }
    }
}
