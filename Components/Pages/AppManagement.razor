@page "/app-management"
@using QingFeng.Services
@using QingFeng.Models
@inject IApplicationService ApplicationService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>åº”ç”¨ç®¡ç† - æ¸…é£</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <FluentLabel Typo="Typography.H3">ğŸ“± åº”ç”¨ç®¡ç†</FluentLabel>
        <FluentButton Appearance="Appearance.Accent" OnClick="ShowAddDialog">
            â• æ·»åŠ åº”ç”¨
        </FluentButton>
    </FluentStack>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
        @foreach (var app in applications)
        {
            <FluentCard Style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; transition: transform 0.2s;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="width: 50px; height: 50px; border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; background: @app.IconColor; box-shadow: var(--elevation-shadow-card-rest);">
                        <i class="bi @app.Icon"></i>
                    </div>
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: @(app.IsOnline ? "var(--success)" : "var(--error)"); box-shadow: 0 0 8px @(app.IsOnline ? "var(--success)" : "var(--error)");"></div>
                </div>
                <div style="flex: 1;">
                    <h5 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 0.5rem 0;">@app.Title</h5>
                    <p style="font-size: 0.875rem; color: var(--neutral-foreground-hint); margin: 0 0 0.75rem 0;">@app.Description</p>
                    <FluentBadge Appearance="Appearance.Accent" Style="background: rgba(96, 165, 250, 0.2); color: #60a5fa;">@app.Category</FluentBadge>
                    <div style="font-size: 0.75rem; color: var(--neutral-foreground-hint); margin-top: 0.5rem; word-break: break-all;">@app.Url</div>
                </div>
                <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.5rem;">
                    <FluentButton Appearance="Appearance.Outline" OnClick="() => EditApplication(app)" IconOnly="true" Title="ç¼–è¾‘">
                        âœï¸
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Outline" 
                                  BackgroundColor="@(app.IsPinnedToDock ? "var(--warning)" : "")"
                                  OnClick="() => TogglePin(app)" 
                                  IconOnly="true"
                                  Title="@(app.IsPinnedToDock ? "ä»Dockå–æ¶ˆå›ºå®š" : "å›ºå®šåˆ°Dock")">
                        ğŸ“Œ
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Outline" OnClick="() => DeleteApplication(app)" IconOnly="true" Title="åˆ é™¤">
                        ğŸ—‘ï¸
                    </FluentButton>
                </FluentStack>
            </FluentCard>
        }
    </div>

    @if (!applications.Any())
    {
        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 4rem 2rem;">
            <div style="font-size: 4rem; color: var(--neutral-foreground-hint);">ğŸ“­</div>
            <FluentLabel Style="color: var(--neutral-foreground-hint);">è¿˜æ²¡æœ‰åº”ç”¨</FluentLabel>
            <FluentButton Appearance="Appearance.Accent" OnClick="ShowAddDialog">æ·»åŠ ç¬¬ä¸€ä¸ªåº”ç”¨</FluentButton>
        </FluentStack>
    }
</FluentStack>

<FluentDialog Hidden="@(!showDialog)" Modal="true" OnDismiss="CloseDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">@(editingApp.Id > 0 ? "ç¼–è¾‘åº”ç”¨" : "æ·»åŠ åº”ç”¨")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            <FluentTextField Label="åº”ç”¨åç§°" @bind-Value="editingApp.Title" Placeholder="ä¾‹å¦‚: Jellyfin" Style="width: 100%;" />
            <FluentTextField Label="URL" @bind-Value="editingApp.Url" Placeholder="http://localhost:8096" Style="width: 100%;" />
            <FluentStack Orientation="Orientation.Vertical">
                <FluentLabel>å›¾æ ‡ (Bootstrap Icon)</FluentLabel>
                <FluentTextField @bind-Value="editingApp.Icon" Placeholder="bi-film" Style="width: 100%;" />
                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 0.875rem;">
                    è®¿é—® <a href="https://icons.getbootstrap.com/" target="_blank">Bootstrap Icons</a> æŸ¥æ‰¾å›¾æ ‡
                </FluentLabel>
            </FluentStack>
            <FluentStack Orientation="Orientation.Vertical">
                <FluentLabel>å›¾æ ‡é¢œè‰²</FluentLabel>
                <input type="color" @bind="editingApp.IconColor" style="width: 100%; height: 40px; border-radius: 4px;">
            </FluentStack>
            <FluentTextField Label="æè¿°" @bind-Value="editingApp.Description" Placeholder="åª’ä½“æœåŠ¡å™¨" Style="width: 100%;" />
            <FluentTextField Label="åˆ†ç±»" @bind-Value="editingApp.Category" Placeholder="MEDIA" Style="width: 100%;" />
            <FluentSwitch Label="åœ¨çº¿çŠ¶æ€" @bind-Value="editingApp.IsOnline" />
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="SaveApplication">ä¿å­˜</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<Application> applications = new();
    private Application editingApp = new();
    private bool showDialog = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadApplicationsAsync();
    }

    private async Task LoadApplicationsAsync()
    {
        applications = await ApplicationService.GetAllApplicationsAsync();
    }

    private void ShowAddDialog()
    {
        editingApp = new Application
        {
            IconColor = "#3b82f6",
            Icon = "bi-app",
            IsOnline = true
        };
        showDialog = true;
    }

    private void EditApplication(Application app)
    {
        editingApp = new Application
        {
            Id = app.Id,
            AppId = app.AppId,
            Title = app.Title,
            Url = app.Url,
            Icon = app.Icon,
            IconColor = app.IconColor,
            Description = app.Description,
            Category = app.Category,
            IsOnline = app.IsOnline,
            SortOrder = app.SortOrder,
            IsPinnedToDock = app.IsPinnedToDock
        };
        showDialog = true;
    }

    private async Task SaveApplication()
    {
        try
        {
            await ApplicationService.SaveApplicationAsync(editingApp);
            await LoadApplicationsAsync();
            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving application: {ex.Message}");
        }
    }

    private async Task DeleteApplication(Application app)
    {
        // Use AppId instead of Title to prevent XSS
        if (await JSRuntime.InvokeAsync<bool>("confirm", "ç¡®å®šè¦åˆ é™¤æ­¤åº”ç”¨å—?"))
        {
            await ApplicationService.DeleteApplicationAsync(app.AppId);
            await LoadApplicationsAsync();
        }
    }

    private async Task TogglePin(Application app)
    {
        await ApplicationService.TogglePinToDockAsync(app.AppId);
        await LoadApplicationsAsync();
    }

    private void CloseDialog()
    {
        showDialog = false;
        editingApp = new();
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;
}

<style>
    .apps-grid-management {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .app-card-management {
        transition: transform 0.2s;
    }

    .app-card-management:hover {
        transform: translateY(-4px);
    }

    .app-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .app-icon-small {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .app-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .app-status-indicator.online {
        background: #10b981;
        box-shadow: 0 0 8px #10b981;
    }

    .app-status-indicator.offline {
        background: #ef4444;
        box-shadow: 0 0 8px #ef4444;
    }

    .app-card-body {
        margin-bottom: 1rem;
    }

    .app-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--neutral-foreground-rest);
        margin-bottom: 0.5rem;
    }

    .app-description {
        font-size: 0.875rem;
        color: var(--neutral-foreground-hint);
        margin-bottom: 0.5rem;
    }

    .app-url {
        font-size: 0.75rem;
        color: var(--neutral-foreground-hint);
        margin-top: 0.5rem;
        word-break: break-all;
    }
</style>
