@page "/"
@using QingFeng.Services
@using QingFeng.Models
@inject ISystemMonitorService SystemMonitorService
@inject IApplicationService ApplicationService
@inject ISystemSettingService SystemSettingService
@inject ILocalizationService LocalizationService
@inject IAuthenticationService AuthService
@inject NavigationManager NavigationManager
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>@LocalizationService.GetString("AppTitle") - @LocalizationService.GetString("HomePortal")</PageTitle>

@if (isCheckingAuth)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
}
else
{
<FluentStack Orientation="Orientation.Vertical" Style="min-height: 100vh; padding: 2rem; position: relative; overflow-x: hidden;">
    
    <FluentStack Orientation="Orientation.Vertical" Style="position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; width: 100%;">
        <!-- Header -->
        <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 3rem;">
            <FluentStack Orientation="Orientation.Horizontal" Style="align-items: center; gap: 0.75rem;">
                <i class="bi bi-house-door-fill" style="font-size: 1.5rem;"></i>
                <FluentLabel Typo="Typography.H5">@LocalizationService.GetString("HomePortal")</FluentLabel>
            </FluentStack>
            <FluentButton Appearance="Appearance.Stealth" OnClick="NavigateToSettings" Title="@LocalizationService.GetString("Settings")" IconOnly="true">
                ⚙️
            </FluentButton>
        </FluentStack>

        <!-- Clock and Date -->
        <FluentStack Orientation="Orientation.Vertical" Style="text-align: center; margin-bottom: 3rem;">
            <FluentLabel Typo="Typography.Header" Style="font-size: 6rem; font-weight: 700; line-height: 1;">@CurrentTime</FluentLabel>
            <FluentLabel Typo="Typography.Body" Style="font-size: 1.25rem; margin-top: 0.5rem; color: var(--accent-fill-rest);">@CurrentDateString</FluentLabel>
        </FluentStack>

        <!-- Status Cards Row 1 -->
        <FluentStack Orientation="Orientation.Horizontal" Style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; display: grid;">
            <!-- Weather Card -->
            <FluentCard Style="padding: 1.5rem; min-height: 150px; position: relative;">
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 0.75rem;">
                    <FluentLabel Style="font-size: 0.875rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.05em;">@LocalizationService.GetString("Weather")</FluentLabel>
                    <FluentStack Orientation="Orientation.Horizontal" Style="align-items: baseline; gap: 0.5rem; margin-top: 0.5rem;">
                        <FluentLabel Style="font-size: 2rem; font-weight: 700;">@Temperature</FluentLabel>
                        <FluentLabel Style="font-size: 1rem;">@WeatherCondition</FluentLabel>
                    </FluentStack>
                </FluentStack>
                <i class="bi bi-cloud-sun-fill" style="position: absolute; top: 1.5rem; right: 1.5rem; font-size: 3rem; opacity: 0.5;"></i>
            </FluentCard>

            <!-- CPU Card -->
            <FluentCard Style="padding: 1.5rem; min-height: 150px;">
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 0.75rem;">
                    <i class="bi bi-cpu-fill" style="font-size: 1.5rem;"></i>
                    <FluentLabel Style="font-size: 0.875rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.05em;">@LocalizationService.GetString("CPU")</FluentLabel>
                    <FluentProgress Value="@((int)CpuUsage)" Max="100" Style="width: 100%; margin: 0.5rem 0;" aria-label="@LocalizationService.GetString("CPU")" />
                    <FluentLabel Style="font-size: 1.5rem; font-weight: 700;">@CpuUsage.ToString("F1")%</FluentLabel>
                </FluentStack>
            </FluentCard>

            <!-- Network Card -->
            <FluentCard Style="padding: 1.5rem; min-height: 150px;">
                <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-around;">
                    <FluentStack Orientation="Orientation.Vertical" Style="align-items: center; gap: 0.5rem;">
                        <i class="bi bi-arrow-down" style="font-size: 1.5rem;"></i>
                        <FluentLabel Style="font-size: 0.75rem; text-transform: uppercase; font-weight: 600;">@LocalizationService.GetString("Download")</FluentLabel>
                        <FluentLabel Style="font-size: 1rem; font-weight: 700;">@DownloadSpeed</FluentLabel>
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Vertical" Style="align-items: center; gap: 0.5rem;">
                        <i class="bi bi-arrow-up" style="font-size: 1.5rem;"></i>
                        <FluentLabel Style="font-size: 0.75rem; text-transform: uppercase; font-weight: 600;">@LocalizationService.GetString("Upload")</FluentLabel>
                        <FluentLabel Style="font-size: 1rem; font-weight: 700;">@UploadSpeed</FluentLabel>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentStack>

        <!-- Status Cards Row 2 -->
        <FluentStack Orientation="Orientation.Horizontal" Style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; display: grid;">
            <!-- RAM Card -->
            <FluentCard Style="padding: 1.5rem; min-height: 150px;">
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 0.75rem;">
                    <i class="bi bi-memory" style="font-size: 1.5rem;"></i>
                    <FluentLabel Style="font-size: 0.875rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.05em;">@LocalizationService.GetString("RAM")</FluentLabel>
                    <FluentProgress Value="@((int)RamUsage)" Max="100" Style="width: 100%; margin: 0.5rem 0;" aria-label="@LocalizationService.GetString("RAM")" />
                    <FluentLabel Style="font-size: 1.5rem; font-weight: 700;">@RamUsage.ToString("F1")%</FluentLabel>
                </FluentStack>
            </FluentCard>
        </FluentStack>

        <!-- Application Center -->
        <FluentStack Orientation="Orientation.Vertical" Style="margin-top: 2rem; padding-bottom: 100px;">
            <FluentStack Orientation="Orientation.Horizontal" Style="align-items: center; margin-bottom: 1.5rem; gap: 0.5rem;">
                <i class="bi bi-grid-3x3-gap-fill" style="font-size: 1.5rem;"></i>
                <FluentLabel Typo="Typography.H6">@LocalizationService.GetString("AppCenter")</FluentLabel>
            </FluentStack>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1.5rem;">
                @foreach (var app in applications)
                {
                    <FluentCard @onclick="() => OpenApplication(app)" Style="padding: 1.5rem 1rem; gap: 0.75rem; cursor: pointer; position: relative; display: flex; flex-direction: column; align-items: center; transition: transform 0.2s;">
                        <div style="position: absolute; top: 0.75rem; right: 0.75rem; width: 0.625rem; height: 0.625rem; border-radius: 50%; background: @(app.IsOnline ? "var(--success)" : "var(--error)"); box-shadow: 0 0 0 2px var(--neutral-fill-layer-rest);"></div>
                        <div style="width: 64px; height: 64px; border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; background: @app.IconColor; margin-bottom: 0.5rem;">
                            <i class="bi @app.Icon" style="font-size: 32px;"></i>
                        </div>
                        <FluentLabel Style="font-size: 0.875rem; font-weight: 600; text-align: center;">@app.Title</FluentLabel>
                        <FluentLabel Style="font-size: 0.75rem; text-transform: uppercase; font-weight: 600; color: var(--neutral-foreground-hint);">@app.Category</FluentLabel>
                    </FluentCard>
                }
                
                <!-- Add App Button -->
                <FluentCard @onclick="NavigateToAppManagement" Style="padding: 1.5rem 1rem; gap: 0.75rem; cursor: pointer; border: 2px dashed var(--neutral-stroke-divider-rest); background: transparent; display: flex; flex-direction: column; align-items: center; transition: border-color 0.2s;">
                    <div style="width: 64px; height: 64px; border-radius: 2rem; font-size: 32px; display: flex; align-items: center; justify-content: center; background: var(--neutral-fill-stealth-rest); margin-bottom: 0.5rem;">
                        <i class="bi bi-plus-lg"></i>
                    </div>
                    <FluentLabel Style="font-size: 0.875rem; font-weight: 600; text-align: center;">@LocalizationService.GetString("AddApp")</FluentLabel>
                </FluentCard>
            </div>
        </FluentStack>
    </FluentStack>
</FluentStack>
}

@code {
    private bool isCheckingAuth = true;
    private SystemResourceInfo? systemInfo;
    private List<Application> applications = new();
    private Timer? refreshTimer;
    
    // Display properties
    private string CurrentTime => DateTime.Now.ToString("HH:mm");
    private string CurrentDateString => DateTime.Now.ToString("yyyy年MM月dd日 星期") + GetDayOfWeek();
    private string Temperature = "18°C";
    private string WeatherCondition = "晴朗";
    private double CpuUsage => systemInfo?.Cpu.UsagePercent ?? 0;
    private double RamUsage => CalculateRamUsage();
    private string DownloadSpeed = "24MB/s";
    private string UploadSpeed = "12MB/s";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && isCheckingAuth)
        {
            // Check authentication first
            var hasAdmin = await AuthService.HasAdminUserAsync();
            if (!hasAdmin)
            {
                // No admin exists, redirect to initial setup
                NavigationManager.NavigateTo("/initial-setup", forceLoad: true);
                return;
            }

            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                // Not logged in, redirect to login
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }

            isCheckingAuth = false;
            StateHasChanged();

            // Continue with normal initialization
            await LoadDataAsync();
            
            // Set up auto-refresh timer (every 5 seconds)
            refreshTimer = new Timer(async _ => await InvokeAsync(async () =>
            {
                await LoadDataAsync();
                StateHasChanged();
            }), null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task LoadDataAsync()
    {
        try
        {
            // Load system info
            systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
            
            // Load applications (limit to 11, leaving space for Add button)
            applications = (await ApplicationService.GetAllApplicationsAsync()).Take(11).ToList();
            
            // Load network stats
            if (systemInfo?.Networks != null && systemInfo.Networks.Any())
            {
                var primaryInterface = systemInfo.Networks.First();
                DownloadSpeed = FormatSpeed(primaryInterface.BytesReceived);
                UploadSpeed = FormatSpeed(primaryInterface.BytesSent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private double CalculateRamUsage()
    {
        if (systemInfo?.Memory == null) return 0;
        
        // Use the UsagePercent property directly instead of parsing strings
        return systemInfo.Memory.UsagePercent;
    }

    private string FormatSpeed(long bytes)
    {
        if (bytes < 1024) return $"{bytes}B/s";
        if (bytes < 1024 * 1024) return $"{bytes / 1024}KB/s";
        return $"{bytes / (1024 * 1024)}MB/s";
    }

    private string GetDayOfWeek()
    {
        return DateTime.Now.DayOfWeek switch
        {
            DayOfWeek.Monday => LocalizationService.GetString("Monday"),
            DayOfWeek.Tuesday => LocalizationService.GetString("Tuesday"),
            DayOfWeek.Wednesday => LocalizationService.GetString("Wednesday"),
            DayOfWeek.Thursday => LocalizationService.GetString("Thursday"),
            DayOfWeek.Friday => LocalizationService.GetString("Friday"),
            DayOfWeek.Saturday => LocalizationService.GetString("Saturday"),
            DayOfWeek.Sunday => LocalizationService.GetString("Sunday"),
            _ => ""
        };
    }

    private void OpenApplication(Application app)
    {
        if (!string.IsNullOrEmpty(app.Url))
        {
            NavigationManager.NavigateTo(app.Url, true);
        }
    }

    private void NavigateToSettings()
    {
        NavigationManager.NavigateTo("/settings");
    }

    private void NavigateToAppManagement()
    {
        NavigationManager.NavigateTo("/app-management");
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
