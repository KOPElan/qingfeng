@page "/"
@using QingFeng.Services
@using QingFeng.Models
@using System.Text.Json
@inject ISystemMonitorService SystemMonitorService
@inject IDockerService DockerService
@inject IHomeConfigService HomeConfigService
@inject IDialogService DialogService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>清风 - 个人主页</PageTitle>

<div class="homepage-container">
    <div class="hero-section">
        <div class="hero-icon">
            <MudIcon Icon="@Icons.Material.Filled.WbSunny" Size="Size.Large" />
        </div>
        <MudText Typo="Typo.h3" Class="hero-greeting">@GreetingText</MudText>
        
        <div class="hero-content">
            <!-- Recents Panel -->
            <MudPaper Class="hero-panel recents-panel" Elevation="3">
                <MudText Typo="Typo.subtitle2" Class="panel-header">Recents</MudText>
                <div class="recent-items">
                    <div class="recent-item">
                        <MudIcon Icon="@Icons.Material.Filled.AudioFile" Class="recent-icon" Style="color: #c084fc;" />
                        <div class="recent-info">
                            <MudText Typo="Typo.body2">Vida La Vida</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">MP3</MudText>
                        </div>
                    </div>
                    <div class="recent-item">
                        <MudIcon Icon="@Icons.Material.Filled.Description" Class="recent-icon" Style="color: #60a5fa;" />
                        <div class="recent-info">
                            <MudText Typo="Typo.body2">Home 2 Write-up Draft</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">TXT</MudText>
                        </div>
                    </div>
                    <div class="recent-item">
                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Class="recent-icon" Style="color: #34d399;" />
                        <div class="recent-info">
                            <MudText Typo="Typo.body2">3rd Quarter Financials</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">XLSX</MudText>
                        </div>
                    </div>
                </div>
            </MudPaper>

            <!-- System Stats Cards -->
            <div class="stats-cards">
                @if (systemInfo is null)
                {
                    <MudSkeleton Height="140px" Width="100%" Animation="Animation.Wave" />
                }
                else
                {
                    <MudPaper Class="stat-card-new" Elevation="3">
                        <MudIcon Icon="@Icons.Material.Filled.Thermostat" Class="stat-icon" />
                        <div class="stat-content">
                            <MudText Typo="Typo.caption" Class="text-muted">Optimal</MudText>
                            <MudText Typo="Typo.h6">@(systemInfo.Cpu.UsagePercent < 50 ? "0" : systemInfo.Cpu.UsagePercent)°C</MudText>
                        </div>
                    </MudPaper>
                    <MudPaper Class="stat-card-new" Elevation="3">
                        <MudIcon Icon="@Icons.Material.Filled.Storage" Class="stat-icon" />
                        <div class="stat-content">
                            <MudText Typo="Typo.caption" Class="text-muted">Free</MudText>
                            <MudText Typo="Typo.h6">@DiskTotalGb</MudText>
                        </div>
                    </MudPaper>
                    <MudPaper Class="stat-card-new" Elevation="3">
                        <MudIcon Icon="@Icons.Material.Filled.Memory" Class="stat-icon" />
                        <div class="stat-content">
                            <MudText Typo="Typo.caption" Class="text-muted">Memory</MudText>
                            <MudText Typo="Typo.h6">@systemInfo.Memory.UsedGB</MudText>
                        </div>
                    </MudPaper>
                }
            </div>

            <!-- Activity Panel -->
            <MudPaper Class="hero-panel activity-panel" Elevation="3">
                <div class="activity-items">
                    <div class="activity-item">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Style="color: #fbbf24;" Size="Size.Small" />
                        <MudText Typo="Typo.body2">Following update</MudText>
                    </div>
                    <div class="activity-item">
                        <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Style="color: #fb923c;" Size="Size.Small" />
                        <MudText Typo="Typo.body2">Reaction</MudText>
                    </div>
                    <div class="activity-item">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Style="color: #94a3b8;" Size="Size.Small" />
                        <MudText Typo="Typo.body2">Profile update</MudText>
                    </div>
                    <div class="activity-item">
                        <MudIcon Icon="@Icons.Material.Filled.Chat" Style="color: #94a3b8;" Size="Size.Small" />
                        <MudText Typo="Typo.body2" Class="text-muted">Reaction</MudText>
                    </div>
                </div>
                <div class="activity-count">
                    <MudText Typo="Typo.h4" Class="text-muted" Style="opacity: 0.3;">128</MudText>
                </div>
            </MudPaper>
        </div>
    </div>

    <!-- App Grid Section -->
    <div class="apps-section">
        <div class="apps-header">
            <MudText Typo="Typo.subtitle2" Class="section-label">Files</MudText>
            <MudText Typo="Typo.subtitle2" Class="section-label">Settings</MudText>
            <MudText Typo="Typo.subtitle2" Class="section-label">Nostr Relay</MudText>
        </div>
        
        <div class="apps-grid">
            @foreach (var shortcut in OrderedShortcuts.Take(12))
            {
                <a href="@shortcut.Url" class="app-item" target="@(shortcut.Url.StartsWith("http") ? "_blank" : "_self")" rel="noreferrer">
                    <div class="app-icon" style="background: @GetAppColor(shortcut.Id);">
                        <MudIcon Icon="@ResolveIcon(shortcut.Icon)" Size="Size.Large" />
                    </div>
                    <MudText Typo="Typo.caption" Class="app-title">@shortcut.Title</MudText>
                </a>
            }
        </div>

        <div class="carousel-dots">
            <div class="dot active"></div>
            <div class="dot"></div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-section">
        <MudTextField T="string" Placeholder="Search" Variant="Variant.Outlined" 
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                      Class="search-input" />
        <MudText Typo="Typo.caption" Class="text-muted">⌘K</MudText>
    </div>

    <!-- Dock -->
    <div class="bottom-dock">
        <MudPaper Class="dock-panel" Elevation="8">
            @if (PinnedShortcuts.Count > 0)
            {
                @foreach (var shortcut in PinnedShortcuts.Take(6))
                {
                    @if (IsInternalManagementPage(shortcut.Url))
                    {
                        <div class="dock-icon" 
                             @onclick="async () => await OpenInModal(shortcut)" 
                             @onkeydown="(e) => HandleKeyDown(e, shortcut)"
                             tabindex="0" 
                             role="button" 
                             aria-label="@shortcut.Title"
                             style="cursor: pointer;">
                            <div class="dock-icon-bg" style="background: @GetAppColor(shortcut.Id);">
                                <MudIcon Icon="@ResolveIcon(shortcut.Icon)" Size="Size.Medium" />
                            </div>
                        </div>
                    }
                    else
                    {
                        <a href="@SanitizeUrl(shortcut.Url)" class="dock-icon" target="@(IsExternalUrl(shortcut.Url) ? "_blank" : "_self")" rel="noreferrer">
                            <div class="dock-icon-bg" style="background: @GetAppColor(shortcut.Id);">
                                <MudIcon Icon="@ResolveIcon(shortcut.Icon)" Size="Size.Medium" />
                            </div>
                        </a>
                    }
                }
            }
            else
            {
                @foreach (var shortcut in defaultShortcuts.Where(s => s.IsPinned).Take(6))
                {
                    @if (IsInternalManagementPage(shortcut.Url))
                    {
                        <div class="dock-icon" 
                             @onclick="async () => await OpenInModal(shortcut)" 
                             @onkeydown="(e) => HandleKeyDown(e, shortcut)"
                             tabindex="0" 
                             role="button" 
                             aria-label="@shortcut.Title"
                             style="cursor: pointer;">
                            <div class="dock-icon-bg" style="background: @GetAppColor(shortcut.Id);">
                                <MudIcon Icon="@ResolveIcon(shortcut.Icon)" Size="Size.Medium" />
                            </div>
                        </div>
                    }
                    else
                    {
                        <a href="@SanitizeUrl(shortcut.Url)" class="dock-icon" target="@(IsExternalUrl(shortcut.Url) ? "_blank" : "_self")" rel="noreferrer">
                            <div class="dock-icon-bg" style="background: @GetAppColor(shortcut.Id);">
                                <MudIcon Icon="@ResolveIcon(shortcut.Icon)" Size="Size.Medium" />
                            </div>
                        </a>
                    }
                }
            }
        </MudPaper>
    </div>
</div>

@code {
    private SystemResourceInfo? systemInfo;
    private List<DockerContainerInfo> dockerContainers = new();
    private List<ShortcutLink> allShortcuts = new();
    private List<ShortcutLink> customShortcuts = new();
    private readonly List<ShortcutLink> defaultShortcuts = new()
    {
        new ShortcutLink { Id = "internal-home", Title = "主页", Url = "/", Icon = Icons.Material.Filled.Home, Description = "清风入口", Category = Constants.BuiltInCategory, IsPinned = true },
        new ShortcutLink { Id = "internal-monitor", Title = "系统监控", Url = "/system-monitor", Icon = Icons.Material.Filled.DashboardCustomize, Description = "CPU / 内存 / 磁盘", Category = Constants.BuiltInCategory, IsPinned = true },
        new ShortcutLink { Id = "internal-docker", Title = "Docker 管理", Url = "/docker", Icon = Icons.Material.Filled.Dns, Description = "容器与镜像", Category = Constants.BuiltInCategory },
        new ShortcutLink { Id = "internal-disk", Title = "磁盘管理", Url = "/disk-management", Icon = Icons.Material.Filled.Storage, Description = "卷与存储", Category = Constants.BuiltInCategory },
        new ShortcutLink { Id = "internal-files", Title = "文件管理", Url = "/file-manager", Icon = Icons.Material.Filled.Folder, Description = "浏览文件", Category = Constants.BuiltInCategory },
        new ShortcutLink { Id = "ha", Title = "Home Assistant", Url = "http://homeassistant.local:8123", Icon = Icons.Material.Filled.Home, Description = "智能家居面板", Category = "自托管", IsPinned = true },
        new ShortcutLink { Id = "pihole", Title = "Pi-hole", Url = "http://pi.hole/admin", Icon = Icons.Material.Filled.Security, Description = "网络广告拦截", Category = "自托管" },
        new ShortcutLink { Id = "plex", Title = "Plex", Url = "http://localhost:32400/web", Icon = Icons.Material.Filled.Tv, Description = "媒体中心", Category = "影音" },
        new ShortcutLink { Id = "jellyfin", Title = "Jellyfin", Url = "http://localhost:8096", Icon = Icons.Material.Filled.PlayCircleFilled, Description = "家庭影院", Category = "影音" },
        new ShortcutLink { Id = "transmission", Title = "Transmission", Url = "http://localhost:9091", Icon = Icons.Material.Filled.SwapVert, Description = "下载任务", Category = "工具" },
        new ShortcutLink { Id = "adguard", Title = "AdGuard Home", Url = "http://localhost:3000", Icon = "Icons.Material.Filled.VerifiedUser", Description = "DNS 过滤", Category = "自托管" },
        new ShortcutLink { Id = "tailscale", Title = "Tailscale", Url = "https://login.tailscale.com/admin", Icon = Icons.Material.Filled.VpnLock, Description = "内网穿透", Category = "网络" },
        new ShortcutLink { Id = "etherpad", Title = "Etherpad", Url = "http://localhost:9001", Icon = Icons.Material.Filled.EditNote, Description = "协作笔记", Category = "协作" }
    };

    private ShortcutLink draftShortcut = new()
    {
        Id = Guid.NewGuid().ToString("N"),
        Icon = Icons.Material.Filled.Link,
        IsPinned = true
    };
    private int diskCount;
    private int networkCount;

    private static readonly JsonSerializerOptions StorageOptions = new()
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        WriteIndented = false
    };

    private string GreetingText => DateTime.Now.Hour switch
    {
        >= 6 and < 12 => "早上好，欢迎回来",
        >= 12 and < 18 => "下午好，保持专注",
        _ => "晚上好，注意休息"
    };

    private string DiskUsedGb => systemInfo is null ? "0 GB" : $"{SumDisks(d => d.UsedBytes) / 1024d / 1024d / 1024d:F2} GB";
    private string DiskTotalGb => systemInfo is null ? "0 GB" : $"{SumDisks(d => d.TotalBytes) / 1024d / 1024d / 1024d:F2} GB";
    private double DiskUsagePercent => systemInfo is null || SumDisks(d => d.TotalBytes) <= 0 ? 0 : Math.Round(SumDisks(d => d.UsedBytes) / SumDisks(d => d.TotalBytes) * 100, 1);
    private string ActiveInterfacesSummary => systemInfo?.Networks is null || systemInfo.Networks.Count == 0
        ? "暂无网络信息"
        : string.Join(" · ", systemInfo.Networks.Take(2).Select(n => n.Name));

    private IEnumerable<ShortcutLink> OrderedShortcuts => allShortcuts
        .OrderByDescending(l => l.IsPinned)
        .ThenBy(l => l.Category)
        .ThenBy(l => l.Title);

    private List<ShortcutLink> PinnedShortcuts => allShortcuts.Where(s => s.IsPinned).Take(16).ToList();

    private bool _stateLoaded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _stateLoaded)
            return;

        _stateLoaded = true;
        await LoadStateAsync();
        await RefreshData();
    }

    private async Task RefreshData()
    {
        systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
        diskCount = systemInfo?.Disks?.Count ?? 0;
        networkCount = systemInfo?.Networks?.Count ?? 0;
        dockerContainers = await DockerService.GetContainersAsync(false);
        StateHasChanged();
    }

    private async Task LoadStateAsync()
    {
        try
        {
            // Try to migrate from localStorage if database is empty
            await MigrateFromLocalStorageAsync();

            // Load all shortcuts from database
            allShortcuts = await HomeConfigService.GetAllShortcutsAsync();
            customShortcuts = allShortcuts.Where(s => !s.Category.StartsWith(Constants.BuiltInCategory)).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading state: {ex.Message}");
            // Fallback to default shortcuts
            allShortcuts = defaultShortcuts.ToList();
            customShortcuts = new List<ShortcutLink>();
        }
    }

    private async Task MigrateFromLocalStorageAsync()
    {
        try
        {
            // Check if we've already migrated
            var migrated = await HomeConfigService.GetConfigAsync("localStorage_migrated");
            if (migrated == "true")
                return;

            // Get data from localStorage
            var pinnedJson = await JS.InvokeAsync<string?>("localStorage.getItem", "qingfeng-pinned-shortcuts");
            var customJson = await JS.InvokeAsync<string?>("localStorage.getItem", "qingfeng-custom-shortcuts");

            if (!string.IsNullOrWhiteSpace(pinnedJson))
            {
                var pinnedIds = JsonSerializer.Deserialize<HashSet<string>>(pinnedJson, StorageOptions);
                if (pinnedIds != null)
                {
                    // Update pinned states in database
                    foreach (var id in pinnedIds)
                    {
                        try
                        {
                            await HomeConfigService.TogglePinAsync(id);
                        }
                        catch { /* Continue on error */ }
                    }
                }
            }

            if (!string.IsNullOrWhiteSpace(customJson))
            {
                var customShortcuts = JsonSerializer.Deserialize<List<ShortcutLink>>(customJson, StorageOptions);
                if (customShortcuts != null)
                {
                    // Save custom shortcuts to database
                    foreach (var shortcut in customShortcuts)
                    {
                        try
                        {
                            await HomeConfigService.SaveShortcutAsync(shortcut);
                        }
                        catch { /* Continue on error */ }
                    }
                }
            }

            // Mark as migrated
            await HomeConfigService.SetConfigAsync("localStorage_migrated", "true");

            // Optionally clear localStorage
            await JS.InvokeVoidAsync("localStorage.removeItem", "qingfeng-pinned-shortcuts");
            await JS.InvokeVoidAsync("localStorage.removeItem", "qingfeng-custom-shortcuts");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Migration error: {ex.Message}");
        }
    }

    private bool CanSubmit => !string.IsNullOrWhiteSpace(draftShortcut.Title) && !string.IsNullOrWhiteSpace(draftShortcut.Url);

    private async Task AddShortcut()
    {
        if (!CanSubmit)
            return;

        // Validate URL to prevent XSS
        var sanitizedUrl = SanitizeUrl(draftShortcut.Url);
        if (sanitizedUrl == "#")
        {
            // Invalid URL, don't save
            return;
        }

        if (string.IsNullOrWhiteSpace(draftShortcut.Id))
        {
            draftShortcut.Id = Guid.NewGuid().ToString("N");
        }

        var newShortcut = new ShortcutLink
        {
            Id = draftShortcut.Id,
            Title = draftShortcut.Title,
            Url = sanitizedUrl,
            Icon = string.IsNullOrWhiteSpace(draftShortcut.Icon) ? Icons.Material.Filled.Link : draftShortcut.Icon,
            Description = draftShortcut.Description,
            Category = string.IsNullOrWhiteSpace(draftShortcut.Category) ? "自定义" : draftShortcut.Category,
            IsPinned = draftShortcut.IsPinned,
            IsDocker = draftShortcut.IsDocker
        };

        await HomeConfigService.SaveShortcutAsync(newShortcut);

        draftShortcut = new ShortcutLink
        {
            Id = Guid.NewGuid().ToString("N"),
            Icon = Icons.Material.Filled.Link,
            IsPinned = true
        };

        await LoadStateAsync();
    }

    private async Task TogglePin(ShortcutLink shortcut)
    {
        await HomeConfigService.TogglePinAsync(shortcut.Id);
        await LoadStateAsync();
    }

    private void PrefillFromContainer(DockerContainerInfo container, string? guessUrl)
    {
        draftShortcut = new ShortcutLink
        {
            Id = Guid.NewGuid().ToString("N"),
            Title = container.Name,
            Url = string.IsNullOrWhiteSpace(guessUrl) ? string.Empty : guessUrl,
            Icon = Icons.Material.Filled.SettingsEthernet,
            Description = container.Image,
            Category = "Docker",
            IsPinned = true,
            IsDocker = true
        };
    }

    private bool IsCustom(ShortcutLink shortcut) => !shortcut.Category.StartsWith(Constants.BuiltInCategory);

    private async Task RemoveShortcut(ShortcutLink shortcut)
    {
        if (!IsCustom(shortcut))
            return;

        await HomeConfigService.DeleteShortcutAsync(shortcut.Id);
        await LoadStateAsync();
    }

    private string GuessContainerUrl(DockerContainerInfo container)
    {
        var portString = container.Ports.FirstOrDefault();
        if (string.IsNullOrWhiteSpace(portString))
            return string.Empty;

        var parts = portString.Split(':', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0 || !int.TryParse(parts[0], out var publicPort))
            return string.Empty;

        return $"http://localhost:{publicPort}";
    }

    private double SumDisks(Func<DiskInfo, long> selector)
    {
        return systemInfo?.Disks?.Where(d => d.IsReady).Select(selector).Sum() ?? 0;
    }

    private string ResolveIcon(string icon)
    {
        return string.IsNullOrWhiteSpace(icon) ? Icons.Material.Filled.Link : icon;
    }

    private string GetAppColor(string id)
    {
        return id switch
        {
            "internal-home" => "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
            "internal-monitor" => "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
            "internal-docker" => "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
            "internal-disk" => "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
            "internal-files" => "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
            "ha" => "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",
            "pihole" => "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
            "plex" => "linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%)",
            "jellyfin" => "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
            "transmission" => "linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%)",
            "adguard" => "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)",
            "tailscale" => "linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)",
            "etherpad" => "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
            _ => "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
        };
    }

    private bool IsInternalManagementPage(string url)
    {
        return url == Constants.InternalPages.SystemMonitor ||
               url == Constants.InternalPages.Docker ||
               url == Constants.InternalPages.DiskManagement ||
               url == Constants.InternalPages.FileManager;
    }

    private async Task OpenInModal(ShortcutLink shortcut)
    {
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.ExtraExtraLarge, 
            FullWidth = true,
            CloseButton = true,
            FullScreen = true
        };

        var parameters = new DialogParameters
        {
            { "Title", shortcut.Title }
        };

        switch (shortcut.Url)
        {
            case var url when url == Constants.InternalPages.SystemMonitor:
                await DialogService.ShowAsync<QingFeng.Components.Dialogs.SystemMonitorDialog>(shortcut.Title, parameters, options);
                break;
            case var url when url == Constants.InternalPages.Docker:
                await DialogService.ShowAsync<QingFeng.Components.Dialogs.DockerDialog>(shortcut.Title, parameters, options);
                break;
            case var url when url == Constants.InternalPages.DiskManagement:
                await DialogService.ShowAsync<QingFeng.Components.Dialogs.DiskManagementDialog>(shortcut.Title, parameters, options);
                break;
            case var url when url == Constants.InternalPages.FileManager:
                await DialogService.ShowAsync<QingFeng.Components.Dialogs.FileManagerDialog>(shortcut.Title, parameters, options);
                break;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e, ShortcutLink shortcut)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            await OpenInModal(shortcut);
        }
    }

    private bool IsExternalUrl(string url)
    {
        return url.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
               url.StartsWith("https://", StringComparison.OrdinalIgnoreCase);
    }

    private string SanitizeUrl(string url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return "#";

        // Allow only http, https, and relative URLs
        var lowerUrl = url.Trim().ToLowerInvariant();
        if (lowerUrl.StartsWith("javascript:") ||
            lowerUrl.StartsWith("data:") ||
            lowerUrl.StartsWith("vbscript:") ||
            lowerUrl.StartsWith("file:"))
        {
            return "#";
        }

        return url;
    }
}
