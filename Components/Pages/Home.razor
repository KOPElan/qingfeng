@page "/"
@using QingFeng.Services
@using QingFeng.Models
@inject ISystemMonitorService SystemMonitorService
@inject IApplicationService ApplicationService
@inject ISystemSettingService SystemSettingService
@inject ILocalizationService LocalizationService
@inject IAuthenticationService AuthService
@inject NavigationManager NavigationManager
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>@LocalizationService.GetString("AppTitle") - @LocalizationService.GetString("HomePortal")</PageTitle>

@if (isCheckingAuth)
{
    <div class="loading-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
<div class="home-portal-container">
    <!-- Background Gradient -->
    <div class="gradient-bg">
        <div class="gradient-blob gradient-blob-1"></div>
        <div class="gradient-blob gradient-blob-2"></div>
        <div class="gradient-blob gradient-blob-3"></div>
    </div>

    <div class="home-content">
        <!-- Header -->
        <header class="home-header">
            <div class="header-brand">
                <i class="bi bi-house-door-fill icon-md color-primary-blue"></i>
                <span class="brand-title">@LocalizationService.GetString("HomePortal")</span>
            </div>
            <button class="settings-btn" @onclick="NavigateToSettings" title="@LocalizationService.GetString("Settings")">
                <i class="bi bi-gear-fill"></i>
            </button>
        </header>

        <!-- Clock and Date -->
        <div class="clock-section">
            <div class="time-display">@CurrentTime</div>
            <div class="date-display">@CurrentDateString</div>
        </div>

        <!-- Status Cards Row -->
        <div class="status-cards-row">
            <!-- Weather Card -->
            <div class="status-card weather-card">
                <div class="card-content">
                    <span class="card-label">@LocalizationService.GetString("Weather")</span>
                    <div class="weather-display">
                        <span class="temperature">@Temperature</span>
                        <span class="weather-condition">@WeatherCondition</span>
                    </div>
                </div>
                <i class="bi bi-cloud-sun-fill weather-icon"></i>
            </div>

            <!-- CPU Card -->
            <div class="status-card cpu-card">
                <div class="card-content">
                    <i class="bi bi-cpu-fill card-icon"></i>
                    <span class="card-label">@LocalizationService.GetString("CPU")</span>
                    <div class="progress-container">
                        <div class="progress-bar cpu-progress" style="width: @CpuUsage%"></div>
                    </div>
                    <span class="card-value">@CpuUsage%</span>
                </div>
            </div>

            <!-- Network Card -->
            <div class="status-card network-card">
                <div class="card-content-network">
                    <div class="network-item">
                        <i class="bi bi-arrow-down"></i>
                        <span class="network-label">@LocalizationService.GetString("Download")</span>
                        <span class="network-value">@DownloadSpeed</span>
                    </div>
                    <div class="network-item">
                        <i class="bi bi-arrow-up"></i>
                        <span class="network-label">@LocalizationService.GetString("Upload")</span>
                        <span class="network-value">@UploadSpeed</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-cards-row">
            <!-- RAM Card -->
            <div class="status-card ram-card">
                <div class="card-content">
                    <i class="bi bi-memory card-icon"></i>
                    <span class="card-label">@LocalizationService.GetString("RAM")</span>
                    <div class="progress-container">
                        <div class="progress-bar ram-progress" style="width: @RamUsage%"></div>
                    </div>
                    <span class="card-value">@RamUsage%</span>
                </div>
            </div>
        </div>

        <!-- Application Center -->
        <div class="apps-section">
            <div class="apps-header">
                <i class="bi bi-grid-3x3-gap-fill"></i>
                <span class="apps-title">@LocalizationService.GetString("AppCenter")</span>
            </div>
            <div class="apps-grid">
                @foreach (var app in applications)
                {
                    <div class="app-item" @onclick="() => OpenApplication(app)">
                        <div class="app-status @(app.IsOnline ? "online" : "offline")"></div>
                        <div class="app-icon" style="background: @app.IconColor;">
                            <i class="bi @app.Icon"></i>
                        </div>
                        <span class="app-title">@app.Title</span>
                        <span class="app-category">@app.Category</span>
                    </div>
                }
                
                <!-- Add App Button -->
                <div class="app-item add-app-btn" @onclick="NavigateToAppManagement">
                    <div class="add-app-icon">
                        <i class="bi bi-plus-lg"></i>
                    </div>
                    <span class="app-title">@LocalizationService.GetString("AddApp")</span>
                </div>
            </div>
        </div>
    </div>
</div>
}

@code {
    private bool isCheckingAuth = true;
    private SystemResourceInfo? systemInfo;
    private List<Application> applications = new();
    private Timer? refreshTimer;
    
    // Display properties
    private string CurrentTime => DateTime.Now.ToString("HH:mm");
    private string CurrentDateString => DateTime.Now.ToString("yyyy年MM月dd日 星期") + GetDayOfWeek();
    private string Temperature = "18°C";
    private string WeatherCondition = "晴朗";
    private double CpuUsage => systemInfo?.Cpu.UsagePercent ?? 0;
    private double RamUsage => CalculateRamUsage();
    private string DownloadSpeed = "24MB/s";
    private string UploadSpeed = "12MB/s";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && isCheckingAuth)
        {
            // Check authentication first
            var hasAdmin = await AuthService.HasAdminUserAsync();
            if (!hasAdmin)
            {
                // No admin exists, redirect to initial setup
                NavigationManager.NavigateTo("/initial-setup", forceLoad: true);
                return;
            }

            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                // Not logged in, redirect to login
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }

            isCheckingAuth = false;
            StateHasChanged();

            // Continue with normal initialization
            await LoadDataAsync();
            
            // Set up auto-refresh timer (every 5 seconds)
            refreshTimer = new Timer(async _ => await InvokeAsync(async () =>
            {
                await LoadDataAsync();
                StateHasChanged();
            }), null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task LoadDataAsync()
    {
        try
        {
            // Load system info
            systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
            
            // Load applications (limit to 11, leaving space for Add button)
            applications = (await ApplicationService.GetAllApplicationsAsync()).Take(11).ToList();
            
            // Load network stats
            if (systemInfo?.Networks != null && systemInfo.Networks.Any())
            {
                var primaryInterface = systemInfo.Networks.First();
                DownloadSpeed = FormatSpeed(primaryInterface.BytesReceived);
                UploadSpeed = FormatSpeed(primaryInterface.BytesSent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private double CalculateRamUsage()
    {
        if (systemInfo?.Memory == null) return 0;
        
        // Use the UsagePercent property directly instead of parsing strings
        return systemInfo.Memory.UsagePercent;
    }

    private string FormatSpeed(long bytes)
    {
        if (bytes < 1024) return $"{bytes}B/s";
        if (bytes < 1024 * 1024) return $"{bytes / 1024}KB/s";
        return $"{bytes / (1024 * 1024)}MB/s";
    }

    private string GetDayOfWeek()
    {
        return DateTime.Now.DayOfWeek switch
        {
            DayOfWeek.Monday => LocalizationService.GetString("Monday"),
            DayOfWeek.Tuesday => LocalizationService.GetString("Tuesday"),
            DayOfWeek.Wednesday => LocalizationService.GetString("Wednesday"),
            DayOfWeek.Thursday => LocalizationService.GetString("Thursday"),
            DayOfWeek.Friday => LocalizationService.GetString("Friday"),
            DayOfWeek.Saturday => LocalizationService.GetString("Saturday"),
            DayOfWeek.Sunday => LocalizationService.GetString("Sunday"),
            _ => ""
        };
    }

    private void OpenApplication(Application app)
    {
        if (!string.IsNullOrEmpty(app.Url))
        {
            NavigationManager.NavigateTo(app.Url, true);
        }
    }

    private void NavigateToSettings()
    {
        NavigationManager.NavigateTo("/settings");
    }

    private void NavigateToAppManagement()
    {
        NavigationManager.NavigateTo("/app-management");
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
