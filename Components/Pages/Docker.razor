@page "/docker"
@using QingFeng.Services
@using QingFeng.Models
@inject IDockerService DockerService
@rendermode InteractiveServer

<PageTitle>Docker管理</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Docker管理</MudText>

<MudButton Variant="Variant.Filled" 
           Color="Color.Primary" 
           StartIcon="@Icons.Material.Filled.Refresh" 
           OnClick="RefreshData" 
           Class="mb-4">
    刷新
</MudButton>

@if (!string.IsNullOrEmpty(message))
{
    <MudAlert Severity="@(isError ? Severity.Error : Severity.Success)" 
              Class="mb-4" 
              CloseIconClicked="@(() => message = string.Empty)">
        @message
    </MudAlert>
}

@if (!isDockerAvailable)
{
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <strong>警告：</strong> Docker服务不可用。请确保Docker已安装并正在运行。
    </MudAlert>
}

<!-- Containers Section -->
<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudText Typo="Typo.h5" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-2" />
        容器列表
    </MudText>
    @if (containers != null && containers.Any())
    {
        <MudTable Items="@containers" Hover="true" Striped="true" Dense="false">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>名称</MudTh>
                <MudTh>镜像</MudTh>
                <MudTh>状态</MudTh>
                <MudTh>端口</MudTh>
                <MudTh>创建时间</MudTh>
                <MudTh>操作</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID"><MudText Typo="Typo.body2" Style="font-family: monospace;">@context.Id</MudText></MudTd>
                <MudTd DataLabel="名称">@context.Name</MudTd>
                <MudTd DataLabel="镜像">@context.Image</MudTd>
                <MudTd DataLabel="状态">
                    <MudChip T="string" Size="Size.Small" Color="@GetStateColor(context.State)">
                        @context.State
                    </MudChip>
                    <MudText Typo="Typo.caption">@context.Status</MudText>
                </MudTd>
                <MudTd DataLabel="端口">
                    @if (context.Ports.Any())
                    {
                        foreach (var port in context.Ports)
                        {
                            <MudText Typo="Typo.caption">@port</MudText>
                        }
                    }
                    else
                    {
                        <MudText>-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="创建时间">@context.Created.ToString("yyyy-MM-dd HH:mm")</MudTd>
                <MudTd DataLabel="操作">
                    <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                        @if (context.State == "running")
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Stop" 
                                          Color="Color.Warning" 
                                          OnClick="@(() => StopContainer(context.Id))"
                                          Disabled="@isProcessing"
                                          Size="Size.Small" />
                            <MudIconButton Icon="@Icons.Material.Filled.RestartAlt" 
                                          Color="Color.Info" 
                                          OnClick="@(() => RestartContainer(context.Id))"
                                          Disabled="@isProcessing"
                                          Size="Size.Small" />
                        }
                        else
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" 
                                          Color="Color.Success" 
                                          OnClick="@(() => StartContainer(context.Id))"
                                          Disabled="@isProcessing"
                                          Size="Size.Small" />
                        }
                        <MudIconButton Icon="@Icons.Material.Filled.Article" 
                                      Color="Color.Primary" 
                                      OnClick="@(() => ViewLogs(context.Id, context.Name))"
                                      Disabled="@isProcessing"
                                      Size="Size.Small" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                      Color="Color.Error" 
                                      OnClick="@(() => RemoveContainer(context.Id))"
                                      Disabled="@isProcessing"
                                      Size="Size.Small" />
                    </MudButtonGroup>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else if (containers == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Class="ml-2">加载中...</MudText>
    }
    else
    {
        <MudText Color="Color.Secondary">没有找到容器</MudText>
    }
</MudPaper>

<!-- Images Section -->
<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudText Typo="Typo.h5" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.Layers" Class="mr-2" />
        镜像列表
    </MudText>
    @if (images != null && images.Any())
    {
        <MudTable Items="@images" Hover="true" Striped="true" Dense="false">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>标签</MudTh>
                <MudTh>大小</MudTh>
                <MudTh>创建时间</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID"><MudText Typo="Typo.body2" Style="font-family: monospace;">@context.Id</MudText></MudTd>
                <MudTd DataLabel="标签">
                    @if (context.RepoTags.Any())
                    {
                        foreach (var tag in context.RepoTags)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@tag</MudChip>
                        }
                    }
                    else
                    {
                        <MudText Color="Color.Secondary">&lt;none&gt;</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="大小">@context.SizeMB</MudTd>
                <MudTd DataLabel="创建时间">@context.Created.ToString("yyyy-MM-dd HH:mm")</MudTd>
            </RowTemplate>
        </MudTable>
    }
    else if (images == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Class="ml-2">加载中...</MudText>
    }
    else
    {
        <MudText Color="Color.Secondary">没有找到镜像</MudText>
    }
</MudPaper>

<!-- Logs Dialog -->
@if (showLogsDialog)
{
    <MudDialog Options="dialogOptions">
        <TitleContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Article" Class="mr-2" />
                容器日志 - @selectedContainerName
            </MudText>
        </TitleContent>
        <DialogContent>
            @if (isLoadingLogs)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Class="ml-2">加载日志中...</MudText>
            }
            else if (!string.IsNullOrEmpty(containerLogs))
            {
                <MudPaper Elevation="0" Class="pa-3" Style="background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Courier New', monospace; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">
                    @containerLogs
                </MudPaper>
            }
            else
            {
                <MudText Color="Color.Secondary">没有日志数据</MudText>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="@(() => showLogsDialog = false)" Color="Color.Primary">关闭</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    private List<DockerContainerInfo>? containers;
    private List<DockerImageInfo>? images;
    private string message = string.Empty;
    private bool isError = false;
    private bool isProcessing = false;
    private bool isDockerAvailable = false;
    private bool showLogsDialog = false;
    private bool isLoadingLogs = false;
    private string containerLogs = string.Empty;
    private string selectedContainerName = string.Empty;
    
    private DialogOptions dialogOptions = new DialogOptions
    {
        MaxWidth = MaxWidth.Large,
        FullWidth = true,
        CloseOnEscapeKey = true
    };

    protected override async Task OnInitializedAsync()
    {
        isDockerAvailable = await DockerService.IsDockerAvailableAsync();
        if (isDockerAvailable)
        {
            await RefreshData();
        }
    }

    private async Task RefreshData()
    {
        containers = await DockerService.GetContainersAsync(true);
        images = await DockerService.GetImagesAsync();
    }

    private async Task StartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StartContainerAsync(containerId);
            message = $"容器 {containerId} 已启动";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"启动容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task StopContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StopContainerAsync(containerId);
            message = $"容器 {containerId} 已停止";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"停止容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RestartContainerAsync(containerId);
            message = $"容器 {containerId} 已重启";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"重启容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RemoveContainer(string containerId)
    {
        if (!confirm($"确定要删除容器 {containerId} 吗？"))
            return;

        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RemoveContainerAsync(containerId);
            message = $"容器 {containerId} 已删除";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"删除容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ViewLogs(string containerId, string containerName)
    {
        selectedContainerName = containerName;
        showLogsDialog = true;
        isLoadingLogs = true;
        containerLogs = string.Empty;
        
        try
        {
            containerLogs = await DockerService.GetContainerLogsAsync(containerId, 1000);
            if (string.IsNullOrEmpty(containerLogs))
            {
                containerLogs = "没有日志数据";
            }
        }
        catch (Exception ex)
        {
            containerLogs = $"加载日志失败: {ex.Message}";
        }
        finally
        {
            isLoadingLogs = false;
        }
    }

    private bool confirm(string message)
    {
        // This would typically use JS interop for a proper confirmation dialog
        // For now, we'll just return true
        return true;
    }

    private Color GetStateColor(string state)
    {
        return state.ToLower() switch
        {
            "running" => Color.Success,
            "exited" => Color.Default,
            "paused" => Color.Warning,
            "restarting" => Color.Info,
            _ => Color.Default
        };
    }
}
