@page "/docker"
@using QingFeng.Services
@using QingFeng.Models
@inherits AuthorizedPageBase
@inject IDockerService DockerService
@rendermode InteractiveServer

<PageTitle>Dockerç®¡ç†</PageTitle>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="padding: 2rem;">
    <FluentLabel Typo="Typography.H3">ğŸ³ Dockerç®¡ç†</FluentLabel>

    <FluentButton Appearance="Appearance.Accent" OnClick="RefreshData" Style="align-self: flex-start; margin-bottom: 1rem;">
        ğŸ”„ åˆ·æ–°
    </FluentButton>

    @if (!string.IsNullOrEmpty(message))
    {
        <FluentMessageBar Intent="@(isError ? MessageIntent.Error : MessageIntent.Success)" Style="margin-bottom: 1rem;">
            @message
            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => message = string.Empty)" aria-label="Close" Style="margin-left: auto;">
                âœ•
            </FluentButton>
        </FluentMessageBar>
    }

    @if (!isDockerAvailable)
    {
        <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-bottom: 1rem;">
            <strong>è­¦å‘Šï¼š</strong> DockeræœåŠ¡ä¸å¯ç”¨ã€‚è¯·ç¡®ä¿Dockerå·²å®‰è£…å¹¶æ­£åœ¨è¿è¡Œã€‚
        </FluentMessageBar>
    }

    <!-- Containers Section -->
    <FluentCard Style="margin-bottom: 1.5rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸ“¦ å®¹å™¨åˆ—è¡¨
        </FluentLabel>
        @if (containers != null && containers.Any())
        {
            <table style="width: 100%; border-collapse: collapse;" style="width: 100%; margin-top: 1rem;" role="table" aria-label="å®¹å™¨åˆ—è¡¨">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">åç§°</th>
                        <th scope="col">é•œåƒ</th>
                        <th scope="col">çŠ¶æ€</th>
                        <th scope="col">ç«¯å£</th>
                        <th scope="col">åˆ›å»ºæ—¶é—´</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var container in containers)
                    {
                        <tr>
                            <td><small style="font-family: monospace;">@container.Id.Substring(0, Math.Min(12, container.Id.Length))</small></td>
                            <td>@container.Name</td>
                            <td>@container.Image</td>
                            <td>
                                <FluentBadge Appearance="Appearance.Accent" BackgroundColor="@(container.State == "running" ? "var(--success)" : "var(--neutral-foreground-rest)")">
                                    @container.State
                                </FluentBadge>
                                <br />
                                <small style="color: var(--neutral-foreground-hint);">@container.Status</small>
                            </td>
                            <td>
                                @if (container.Ports.Any())
                                {
                                    @foreach (var port in container.Ports)
                                    {
                                        <small style="display: block;">@port</small>
                                    }
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td>@container.Created.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>
                                <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.25rem;">
                                    @if (container.State == "running")
                                    {
                                        <FluentButton Appearance="Appearance.Outline" Disabled="@isProcessing" OnClick="@(() => StopContainer(container.Id))" Title="åœæ­¢" IconOnly="true">
                                            â¸ï¸
                                        </FluentButton>
                                        <FluentButton Appearance="Appearance.Outline" Disabled="@isProcessing" OnClick="@(() => RestartContainer(container.Id))" Title="é‡å¯" IconOnly="true">
                                            ğŸ”„
                                        </FluentButton>
                                    }
                                    else
                                    {
                                        <FluentButton Appearance="Appearance.Outline" Disabled="@isProcessing" OnClick="@(() => StartContainer(container.Id))" Title="å¯åŠ¨" IconOnly="true">
                                            â–¶ï¸
                                        </FluentButton>
                                    }
                                    <FluentButton Appearance="Appearance.Outline" OnClick="@(() => ShowContainerLogs(container))" Title="æŸ¥çœ‹æ—¥å¿—" IconOnly="true">
                                        ğŸ“„
                                    </FluentButton>
                                </FluentStack>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <FluentLabel Style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰æ‰¾åˆ°å®¹å™¨</FluentLabel>
        }
    </FluentCard>

    <!-- Images Section -->
    <FluentCard Style="margin-bottom: 1.5rem;">
        <FluentLabel Typo="Typography.H5">
            ğŸ—‚ï¸ é•œåƒåˆ—è¡¨
        </FluentLabel>
        @if (images != null && images.Any())
        {
            <table style="width: 100%; border-collapse: collapse;" style="width: 100%; margin-top: 1rem;" role="table" aria-label="é•œåƒåˆ—è¡¨">
                <thead>
                    <tr>
                        <th scope="col">ä»“åº“</th>
                        <th scope="col">æ ‡ç­¾</th>
                        <th scope="col">ID</th>
                        <th scope="col">å¤§å°</th>
                        <th scope="col">åˆ›å»ºæ—¶é—´</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var image in images)
                    {
                        <tr>
                            <td>@(image.RepoTags.FirstOrDefault()?.Split(':')[0] ?? "æ— ")</td>
                            <td>@(image.RepoTags.FirstOrDefault()?.Split(':').LastOrDefault() ?? "latest")</td>
                            <td><small style="font-family: monospace;">@image.Id.Substring(0, Math.Min(12, image.Id.Length))</small></td>
                            <td>@image.SizeMB</td>
                            <td>@image.Created.ToString("yyyy-MM-dd HH:mm")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <FluentLabel Style="color: var(--neutral-foreground-hint); margin-top: 1rem;">æ²¡æœ‰æ‰¾åˆ°é•œåƒ</FluentLabel>
        }
    </FluentCard>
</FluentStack>

<!-- Container Logs Dialog -->
<FluentDialog Hidden="@(!showLogsDialog)" Modal="true" OnDismiss="CloseLogsDialog" Style="width: 90%; max-width: 1200px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">
            ğŸ“„ å®¹å™¨æ—¥å¿— - @selectedContainerName
        </FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (isLoadingLogs)
        {
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="padding: 2rem;">
                <FluentProgressRing />
                <FluentLabel>åŠ è½½æ—¥å¿—ä¸­...</FluentLabel>
            </FluentStack>
        }
        else if (!string.IsNullOrEmpty(containerLogs))
        {
            <div style="background: var(--neutral-layer-1); padding: 1rem; border-radius: var(--control-corner-radius); font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 1px solid var(--neutral-stroke-divider-rest);">
                @containerLogs
            </div>
        }
        else
        {
            <FluentLabel>æ²¡æœ‰æ—¥å¿—æ•°æ®</FluentLabel>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseLogsDialog">å…³é—­</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="RefreshLogs" Disabled="@isLoadingLogs">
            ğŸ”„ åˆ·æ–°
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<DockerContainerInfo> containers = new();
    private List<DockerImageInfo> images = new();
    private string message = string.Empty;
    private bool isError = false;
    private bool isProcessing = false;
    private bool isDockerAvailable = true;
    
    // Container logs dialog state
    private bool showLogsDialog = false;
    private bool isLoadingLogs = false;
    private string containerLogs = string.Empty;
    private string selectedContainerId = string.Empty;
    private string selectedContainerName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        isDockerAvailable = await DockerService.IsDockerAvailableAsync();
        if (isDockerAvailable)
        {
            await RefreshData();
        }
    }

    private async Task RefreshData()
    {
        containers = await DockerService.GetContainersAsync(true);
        images = await DockerService.GetImagesAsync();
    }

    private async Task StartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StartContainerAsync(containerId);
            message = $"å®¹å™¨å·²å¯åŠ¨";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"å¯åŠ¨å®¹å™¨å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task StopContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StopContainerAsync(containerId);
            message = $"å®¹å™¨å·²åœæ­¢";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"åœæ­¢å®¹å™¨å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RestartContainerAsync(containerId);
            message = $"å®¹å™¨å·²é‡å¯";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"é‡å¯å®¹å™¨å¤±è´¥: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ShowContainerLogs(DockerContainerInfo container)
    {
        selectedContainerId = container.Id;
        selectedContainerName = container.Name;
        showLogsDialog = true;
        StateHasChanged();
        await LoadContainerLogs();
    }

    private async Task LoadContainerLogs()
    {
        if (string.IsNullOrEmpty(selectedContainerId))
            return;

        isLoadingLogs = true;
        containerLogs = string.Empty;
        
        try
        {
            containerLogs = await DockerService.GetContainerLogsAsync(selectedContainerId, 1000);
            if (string.IsNullOrEmpty(containerLogs))
            {
                containerLogs = "æ²¡æœ‰æ—¥å¿—æ•°æ®";
            }
        }
        catch (Exception ex)
        {
            containerLogs = $"åŠ è½½æ—¥å¿—å¤±è´¥: {ex.Message}";
        }
        finally
        {
            isLoadingLogs = false;
        }
    }

    private async Task RefreshLogs()
    {
        await LoadContainerLogs();
    }

    private void CloseLogsDialog()
    {
        showLogsDialog = false;
        containerLogs = string.Empty;
        selectedContainerId = string.Empty;
        selectedContainerName = string.Empty;
    }
}
