@page "/docker"
@using QingFeng.Services
@using QingFeng.Models
@inherits AuthorizedPageBase
@inject IDockerService DockerService
@inject QingFeng.Services.IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Docker管理</PageTitle>

@if (!IsAuthorized)
{
    <div class="loading-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    return;
}

<h3 class="mb-4">Docker管理</h3>

<button type="button" class="btn btn-custom-primary mb-4" @onclick="RefreshData">
    <i class="@Icons.Material.Filled.Refresh me-2"></i>
    刷新
</button>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success") mb-4">
        @message
        <button type="button" class="btn-close" @onclick="@(() => message = string.Empty)" aria-label="Close"></button>
    </div>
}

@if (!isDockerAvailable)
{
    <div class="alert alert-warning mb-4">
        <strong>警告：</strong> Docker服务不可用。请确保Docker已安装并正在运行。
    </div>
}

<!-- Containers Section -->
<div class="card-custom p-4 mb-4">
    <h5 class="mb-3">
        <i class="@Icons.Material.Filled.Inventory me-2"></i>
        容器列表
    </h5>
    @if (containers != null && containers.Any())
    {
        <table class="table table-custom">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>名称</th>
                    <th>镜像</th>
                    <th>状态</th>
                    <th>端口</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var container in containers)
                {
                    <tr>
                        <td><small style="font-family: monospace;">@container.Id.Substring(0, Math.Min(12, container.Id.Length))</small></td>
                        <td>@container.Name</td>
                        <td>@container.Image</td>
                        <td>
                            <span class="badge @(container.State == "running" ? "badge-success" : "badge-custom")">
                                @container.State
                            </span>
                            <br />
                            <small class="text-muted-custom">@container.Status</small>
                        </td>
                        <td>
                            @if (container.Ports.Any())
                            {
                                @foreach (var port in container.Ports)
                                {
                                    <small class="d-block">@port</small>
                                }
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td>@container.Created.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                @if (container.State == "running")
                                {
                                    <button type="button" class="btn btn-outline-warning" @onclick="@(() => StopContainer(container.Id))" disabled="@isProcessing" title="停止">
                                        <i class="@Icons.Material.Filled.Stop"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-info" @onclick="@(() => RestartContainer(container.Id))" disabled="@isProcessing" title="重启">
                                        <i class="@Icons.Material.Filled.RestartAlt"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-outline-success" @onclick="@(() => StartContainer(container.Id))" disabled="@isProcessing" title="启动">
                                        <i class="@Icons.Material.Filled.PlayArrow"></i>
                                    </button>
                                }
                                <button type="button" class="btn btn-outline-secondary" @onclick="@(() => ShowContainerLogs(container))" title="查看日志">
                                    <i class="@Icons.Material.Filled.Article"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted-custom">没有找到容器</p>
    }
</div>

<!-- Images Section -->
<div class="card-custom p-4 mb-4">
    <h5 class="mb-3">
        <i class="@Icons.Material.Filled.Layers me-2"></i>
        镜像列表
    </h5>
    @if (images != null && images.Any())
    {
        <table class="table table-custom">
            <thead>
                <tr>
                    <th>仓库</th>
                    <th>标签</th>
                    <th>ID</th>
                    <th>大小</th>
                    <th>创建时间</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var image in images)
                {
                    <tr>
                        <td>@(image.RepoTags.FirstOrDefault()?.Split(':')[0] ?? "无")</td>
                        <td>@(image.RepoTags.FirstOrDefault()?.Split(':').LastOrDefault() ?? "latest")</td>
                        <td><small style="font-family: monospace;">@image.Id.Substring(0, Math.Min(12, image.Id.Length))</small></td>
                        <td>@image.SizeMB</td>
                        <td>@image.Created.ToString("yyyy-MM-dd HH:mm")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted-custom">没有找到镜像</p>
    }
</div>

@code {
    private List<DockerContainerInfo> containers = new();
    private List<DockerImageInfo> images = new();
    private string message = string.Empty;
    private bool isError = false;
    private bool isProcessing = false;
    private bool isDockerAvailable = true;

    protected override async Task OnInitializedAsync()
    {
        isDockerAvailable = await DockerService.IsDockerAvailableAsync();
        if (isDockerAvailable)
        {
            await RefreshData();
        }
    }

    private async Task RefreshData()
    {
        containers = await DockerService.GetContainersAsync(true);
        images = await DockerService.GetImagesAsync();
    }

    private async Task StartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StartContainerAsync(containerId);
            message = $"容器已启动";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"启动容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task StopContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StopContainerAsync(containerId);
            message = $"容器已停止";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"停止容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RestartContainerAsync(containerId);
            message = $"容器已重启";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"重启容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ShowContainerLogs(DockerContainerInfo container)
    {
        var parameters = new Dictionary<string, object>
        {
            { "ContainerId", container.Id },
            { "ContainerName", container.Name }
        };
        
        var options = new DialogOptions 
        { 
            MaxWidth = true, 
            FullWidth = true,
            CloseButton = true
        };
        
        await DialogService.ShowAsync<QingFeng.Components.Dialogs.ContainerLogsDialog>(
            $"容器日志 - {container.Name}", parameters, options);
    }
}
