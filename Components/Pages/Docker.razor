@page "/docker"
@using QingFeng.Services
@using QingFeng.Models
@inject IDockerService DockerService
@rendermode InteractiveServer

<PageTitle>Docker管理</PageTitle>

<h1>Docker管理</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="RefreshData">
        <span class="bi bi-arrow-clockwise"></span> 刷新
    </button>
</div>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
        @message
        <button type="button" class="btn-close" @onclick="() => message = string.Empty"></button>
    </div>
}

@if (!isDockerAvailable)
{
    <div class="alert alert-warning">
        <strong>警告：</strong> Docker服务不可用。请确保Docker已安装并正在运行。
    </div>
}

<!-- Containers Section -->
<div class="card mb-3">
    <div class="card-header">
        <h5><span class="bi bi-box"></span> 容器列表</h5>
    </div>
    <div class="card-body">
        @if (containers != null && containers.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>镜像</th>
                            <th>状态</th>
                            <th>端口</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var container in containers)
                        {
                            <tr>
                                <td><code>@container.Id</code></td>
                                <td>@container.Name</td>
                                <td>@container.Image</td>
                                <td>
                                    <span class="badge @GetStateClass(container.State)">
                                        @container.State
                                    </span>
                                    <br />
                                    <small>@container.Status</small>
                                </td>
                                <td>
                                    @if (container.Ports.Any())
                                    {
                                        @foreach (var port in container.Ports)
                                        {
                                            <div><small>@port</small></div>
                                        }
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                                <td>@container.Created.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        @if (container.State == "running")
                                        {
                                            <button class="btn btn-warning" @onclick="() => StopContainer(container.Id)" 
                                                    disabled="@isProcessing">
                                                <span class="bi bi-stop-circle"></span>
                                            </button>
                                            <button class="btn btn-info" @onclick="() => RestartContainer(container.Id)" 
                                                    disabled="@isProcessing">
                                                <span class="bi bi-arrow-clockwise"></span>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-success" @onclick="() => StartContainer(container.Id)" 
                                                    disabled="@isProcessing">
                                                <span class="bi bi-play-circle"></span>
                                            </button>
                                        }
                                        <button class="btn btn-danger" @onclick="() => RemoveContainer(container.Id)" 
                                                disabled="@isProcessing">
                                            <span class="bi bi-trash"></span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else if (containers == null)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>加载中...</p>
            </div>
        }
        else
        {
            <p>没有找到容器</p>
        }
    </div>
</div>

<!-- Images Section -->
<div class="card mb-3">
    <div class="card-header">
        <h5><span class="bi bi-layers"></span> 镜像列表</h5>
    </div>
    <div class="card-body">
        @if (images != null && images.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>标签</th>
                            <th>大小</th>
                            <th>创建时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var image in images)
                        {
                            <tr>
                                <td><code>@image.Id</code></td>
                                <td>
                                    @if (image.RepoTags.Any())
                                    {
                                        @foreach (var tag in image.RepoTags)
                                        {
                                            <div>@tag</div>
                                        }
                                    }
                                    else
                                    {
                                        <span>&lt;none&gt;</span>
                                    }
                                </td>
                                <td>@image.SizeMB</td>
                                <td>@image.Created.ToString("yyyy-MM-dd HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else if (images == null)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>加载中...</p>
            </div>
        }
        else
        {
            <p>没有找到镜像</p>
        }
    </div>
</div>

@code {
    private List<DockerContainerInfo>? containers;
    private List<DockerImageInfo>? images;
    private string message = string.Empty;
    private bool isError = false;
    private bool isProcessing = false;
    private bool isDockerAvailable = false;

    protected override async Task OnInitializedAsync()
    {
        isDockerAvailable = await DockerService.IsDockerAvailableAsync();
        if (isDockerAvailable)
        {
            await RefreshData();
        }
    }

    private async Task RefreshData()
    {
        containers = await DockerService.GetContainersAsync(true);
        images = await DockerService.GetImagesAsync();
    }

    private async Task StartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StartContainerAsync(containerId);
            message = $"容器 {containerId} 已启动";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"启动容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task StopContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StopContainerAsync(containerId);
            message = $"容器 {containerId} 已停止";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"停止容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RestartContainerAsync(containerId);
            message = $"容器 {containerId} 已重启";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"重启容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RemoveContainer(string containerId)
    {
        if (!confirm($"确定要删除容器 {containerId} 吗？"))
            return;

        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RemoveContainerAsync(containerId);
            message = $"容器 {containerId} 已删除";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"删除容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private bool confirm(string message)
    {
        // This would typically use JS interop for a proper confirmation dialog
        // For now, we'll just return true
        return true;
    }

    private string GetStateClass(string state)
    {
        return state.ToLower() switch
        {
            "running" => "bg-success",
            "exited" => "bg-secondary",
            "paused" => "bg-warning",
            "restarting" => "bg-info",
            _ => "bg-secondary"
        };
    }
}
