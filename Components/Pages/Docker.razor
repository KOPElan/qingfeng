@page "/docker"
@using QingFeng.Services
@using QingFeng.Models
@inject IDockerService DockerService
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Docker管理</PageTitle>

<h3 Class="mb-4">Docker管理</h3>

<button type="button" class="btn btn-custom-primary" 
           OnClick="RefreshData" 
           Class="mb-4">
    刷新
</button>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert" class="@(isError ? "alert-danger" : "alert-success")" 
              Class="mb-4" 
              CloseIconClicked="@(() => message = string.Empty)">
        @message
    </div>
}

@if (!isDockerAvailable)
{
    <div class="alert" Severity="Severity.Warning" Class="mb-4">
        <strong>警告：</strong> Docker服务不可用。请确保Docker已安装并正在运行。
    </div>
}

<!-- Containers Section -->
<div Class="pa-4 mb-4">
    <h5 Class="mb-3">
        <i class="@Icons.Material.Filled.Inventory"></i>
        容器列表
    </h5>
    @if (containers != null && containers.Any())
    {
        <table class="table table-custom"><tbody>
            <thead><tr>
                <th>ID</th>
                <th>名称</th>
                <th>镜像</th>
                <th>状态</th>
                <th>端口</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr></thead>
            <tr>
                <td><p class="small" Style="font-family: monospace;">@context.Id</p></td>
                <td>@context.Name</td>
                <td>@context.Image</td>
                <td>
                    <span class="badge badge-custom Color="@GetStateColor(context.State)">
                        @context.State
                    </span>
                    <small class="text-muted-custom">@context.Status</small>
                </td>
                <td>
                    @if (context.Ports.Any())
                    {
                        foreach (var port in context.Ports)
                        {
                            <small class="text-muted-custom">@port</small>
                        }
                    }
                    else
                    {
                        <p>-</p>
                    }
                </td>
                <td>@context.Created.ToString("yyyy-MM-dd HH:mm")</td>
                <td>
                    <div class="btn-group">
                        @if (context.State == "running")
                        {
                            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.Stop" @onclick="(() => StopContainer(context.Id))" disabled="@isProcessing" />
                            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.RestartAlt" @onclick="(() => RestartContainer(context.Id))" disabled="@isProcessing" />
                        }
                        else
                        {
                            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.PlayArrow" @onclick="(() => StartContainer(context.Id))" disabled="@isProcessing" />
                        }
                        <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.Article" @onclick="(() => ViewLogs(context.Id, context.Name))" disabled="@isProcessing" />
                        <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.Delete" @onclick="(() => RemoveContainer(context.Id))" disabled="@isProcessing" />
                    </div>
                </td>
            </tr>
        </tbody></table>
    }
    else if (containers == null)
    {
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p Class="ml-2">加载中...</p>
    }
    else
    {
        <p>没有找到容器</p>
    }
</div>

<!-- Images Section -->
<div Class="pa-4 mb-4">
    <h5 Class="mb-3">
        <i class="@Icons.Material.Filled.Layers"></i>
        镜像列表
    </h5>
    @if (images != null && images.Any())
    {
        <table class="table table-custom"><tbody>
            <thead><tr>
                <th>ID</th>
                <th>标签</th>
                <th>大小</th>
                <th>创建时间</th>
            </tr></thead>
            <tr>
                <td><p class="small" Style="font-family: monospace;">@context.Id</p></td>
                <td>
                    @if (context.RepoTags.Any())
                    {
                        foreach (var tag in context.RepoTags)
                        {
                            <span class="badge badge-custom>@tag</span>
                        }
                    }
                    else
                    {
                        <p>&lt;none&gt;</p>
                    }
                </td>
                <td>@context.SizeMB</td>
                <td>@context.Created.ToString("yyyy-MM-dd HH:mm")</td>
            </tr>
        </tbody></table>
    }
    else if (images == null)
    {
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p Class="ml-2">加载中...</p>
    }
    else
    {
        <p>没有找到镜像</p>
    }
</div>



@code {
    private List<DockerContainerInfo>? containers;
    private List<DockerImageInfo>? images;
    private string message = string.Empty;
    private bool isError = false;
    private bool isProcessing = false;
    private bool isDockerAvailable = false;

    protected override async Task OnInitializedAsync()
    {
        isDockerAvailable = await DockerService.IsDockerAvailableAsync();
        if (isDockerAvailable)
        {
            await RefreshData();
        }
    }

    private async Task RefreshData()
    {
        containers = await DockerService.GetContainersAsync(true);
        images = await DockerService.GetImagesAsync();
    }

    private async Task StartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StartContainerAsync(containerId);
            message = $"容器 {containerId} 已启动";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"启动容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task StopContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.StopContainerAsync(containerId);
            message = $"容器 {containerId} 已停止";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"停止容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RestartContainer(string containerId)
    {
        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RestartContainerAsync(containerId);
            message = $"容器 {containerId} 已重启";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"重启容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RemoveContainer(string containerId)
    {
        if (!confirm($"确定要删除容器 {containerId} 吗？"))
            return;

        isProcessing = true;
        message = string.Empty;
        
        try
        {
            await DockerService.RemoveContainerAsync(containerId);
            message = $"容器 {containerId} 已删除";
            isError = false;
            await RefreshData();
        }
        catch (Exception ex)
        {
            message = $"删除容器失败: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ViewLogs(string containerId, string containerName)
    {
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.ExtraLarge, 
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var parameters = new DialogParameters
        {
            { "ContainerId", containerId },
            { "ContainerName", containerName }
        };

        await DialogService.ShowAsync<QingFeng.Components.Dialogs.ContainerLogsDialog>(
            $"容器日志 - {containerName}", 
            parameters, 
            options);
    }

    private bool confirm(string message)
    {
        // This would typically use JS interop for a proper confirmation dialog
        // For now, we'll just return true
        return true;
    }

    private Color GetStateColor(string state)
    {
        return state.ToLower() switch
        {
            "running" => Color.Success,
            "exited" => Color.Default,
            "paused" => Color.Warning,
            "restarting" => Color.Info,
            _ => Color.Default
        };
    }
}
