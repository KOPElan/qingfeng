@page "/user-management"
@using QingFeng.Services
@using QingFeng.Models
@inherits AuthorizedPageBase
@rendermode InteractiveServer

<PageTitle>ç”¨æˆ·ç®¡ç†</PageTitle>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <FluentLabel Typo="Typography.H4" aria-label="ç”¨æˆ·ç®¡ç†">
            ğŸ‘¥ ç”¨æˆ·ç®¡ç†
        </FluentLabel>
        <FluentButton Appearance="Appearance.Accent" OnClick="ShowCreateUserDialog" aria-label="åˆ›å»ºç”¨æˆ·">
            â• åˆ›å»ºç”¨æˆ·
        </FluentButton>
    </FluentStack>

    @if (!string.IsNullOrEmpty(message))
    {
        <FluentMessageBar Intent="@(isError ? MessageIntent.Error : MessageIntent.Success)" 
                          Style="margin-bottom: 1rem;"
                          OnDismiss="@(() => message = string.Empty)">
            @message
        </FluentMessageBar>
    }

    <FluentCard>
        @if (users == null)
        {
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="padding: 3rem;">
                <FluentProgressRing />
            </FluentStack>
        }
        else if (users.Count == 0)
        {
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="padding: 3rem;">
                <FluentLabel>æš‚æ— ç”¨æˆ·</FluentLabel>
            </FluentStack>
        }
        else
        {
            <table class="fluent-table" style="width: 100%;" role="table" aria-label="ç”¨æˆ·åˆ—è¡¨">
                <thead>
                    <tr>
                        <th scope="col">ç”¨æˆ·å</th>
                        <th scope="col">è§’è‰²</th>
                        <th scope="col">åˆ›å»ºæ—¶é—´</th>
                        <th scope="col">æœ€åç™»å½•</th>
                        <th scope="col">çŠ¶æ€</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr>
                            <td>
                                <span aria-label="ç”¨æˆ·" role="img">ğŸ‘¤</span> @user.Username
                            </td>
                            <td>
                                @if (user.Role == "Admin")
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="var(--error)">ç®¡ç†å‘˜</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">æ™®é€šç”¨æˆ·</FluentBadge>
                                }
                            </td>
                            <td>@user.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                            <td>@(user.LastLoginAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "ä»æœªç™»å½•")</td>
                            <td>
                                @if (user.IsActive)
                                {
                                    <FluentBadge Appearance="Appearance.Accent" BackgroundColor="var(--success)">æ¿€æ´»</FluentBadge>
                                }
                                else
                                {
                                    <FluentBadge Appearance="Appearance.Neutral">ç¦ç”¨</FluentBadge>
                                }
                            </td>
                            <td>
                                @if (user.Username != CurrentUsername)
                                {
                                    <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => ShowDeleteConfirmation(user))" Title="@($"åˆ é™¤ç”¨æˆ· {user.Username}")">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </FluentButton>
                                }
                                else
                                {
                                    <FluentLabel Style="color: var(--neutral-foreground-hint);">å½“å‰ç”¨æˆ·</FluentLabel>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </FluentCard>
</FluentStack>

<FluentDialog Hidden="@(!showCreateDialog)" Modal="true" OnDismiss="CloseCreateDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">åˆ›å»ºæ–°ç”¨æˆ·</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (!string.IsNullOrEmpty(dialogError))
        {
            <FluentMessageBar Intent="MessageIntent.Error" Style="margin-bottom: 1rem;">
                @dialogError
            </FluentMessageBar>
        }
        <FluentStack Orientation="Orientation.Vertical">
            <FluentTextField @bind-Value="newUsername" Label="ç”¨æˆ·å" Placeholder="è¯·è¾“å…¥ç”¨æˆ·å" Style="width: 100%;" />
            <FluentTextField @bind-Value="newPassword" Type="TextFieldType.Password" Label="å¯†ç " Placeholder="è¯·è¾“å…¥å¯†ç " Style="width: 100%;" />
            <FluentTextField @bind-Value="newPasswordConfirm" Type="TextFieldType.Password" Label="ç¡®è®¤å¯†ç " Placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " Style="width: 100%;" />
            <FluentSelect TOption="string" 
                          Label="è§’è‰²"
                          Items="@(new[] { User.RoleUser, User.RoleAdmin })"
                          OptionText="@(item => item == User.RoleAdmin ? "ç®¡ç†å‘˜" : "æ™®é€šç”¨æˆ·")"
                          OptionValue="@(item => item)"
                          @bind-Value="newUserRole"
                          Style="width: 100%;" />
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseCreateDialog">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="CreateUser" Disabled="@isCreating">
            @if (isCreating)
            {
                <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 0.5rem;" />
            }
            åˆ›å»º
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<FluentDialog Hidden="@(!showDeleteConfirmDialog)" Modal="true" OnDismiss="CloseDeleteConfirmation">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">ç¡®è®¤åˆ é™¤</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Horizontal" Style="gap: 0.25rem;">
            <FluentLabel>ç¡®å®šè¦åˆ é™¤ç”¨æˆ·</FluentLabel>
            <FluentLabel Style="font-weight: 600;">@userToDelete?.Username</FluentLabel>
            <FluentLabel>å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</FluentLabel>
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseDeleteConfirmation">å–æ¶ˆ</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="ConfirmDeleteUser" BackgroundColor="var(--error)">
            ğŸ—‘ï¸ åˆ é™¤
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<style>
    .fluent-table {
        border-collapse: collapse;
    }

    .fluent-table th {
        text-align: left;
        padding: calc(var(--design-unit) * 3px);
        border-bottom: calc(var(--stroke-width, 1px) * 2) solid var(--neutral-stroke-divider-rest);
        font-weight: 600;
    }

    .fluent-table td {
        padding: calc(var(--design-unit) * 3px);
        border-bottom: var(--stroke-width, 1px) solid var(--neutral-stroke-divider-rest);
        vertical-align: middle;
    }

    .fluent-table tr:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
</style>

@code {
    private List<User>? users;
    private string message = "";
    private bool isError = false;
    private bool showCreateDialog = false;
    private bool showDeleteConfirmDialog = false;
    private User? userToDelete;
    private string newUsername = "";
    private string newPassword = "";
    private string newPasswordConfirm = "";
    private string newUserRole = User.RoleUser;
    private string dialogError = "";
    private bool isCreating = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (IsAuthorized)
        {
            await LoadUsersAsync();
        }
    }

    private async Task LoadUsersAsync()
    {
        try
        {
            users = await AuthService.GetAllUsersAsync();
        }
        catch (Exception ex)
        {
            message = $"åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼š{ex.Message}";
            isError = true;
        }
    }

    private void ShowCreateUserDialog()
    {
        newUsername = "";
        newPassword = "";
        newPasswordConfirm = "";
        newUserRole = User.RoleUser;
        dialogError = "";
        showCreateDialog = true;
    }

    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }

    private string? ValidateUserInput()
    {
        if (string.IsNullOrWhiteSpace(newUsername))
            return "è¯·è¾“å…¥ç”¨æˆ·å";

        if (newUsername.Length < 3)
            return "ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦";

        if (string.IsNullOrWhiteSpace(newPassword))
            return "è¯·è¾“å…¥å¯†ç ";

        if (newPassword.Length < 8)
            return "å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦";

        // Check password complexity
        bool hasUpper = newPassword.Any(char.IsUpper);
        bool hasLower = newPassword.Any(char.IsLower);
        bool hasDigit = newPassword.Any(char.IsDigit);
        bool hasSpecial = newPassword.Any(c => !char.IsLetterOrDigit(c));

        if (!(hasUpper && hasLower && hasDigit && hasSpecial))
            return "å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦";

        if (newPassword != newPasswordConfirm)
            return "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´";

        return null;
    }

    private async Task CreateUser()
    {
        dialogError = "";

        var validationError = ValidateUserInput();
        if (validationError != null)
        {
            dialogError = validationError;
            return;
        }

        try
        {
            isCreating = true;
            StateHasChanged();

            await AuthService.CreateUserAsync(newUsername, newPassword, newUserRole);

            message = "ç”¨æˆ·åˆ›å»ºæˆåŠŸ";
            isError = false;
            showCreateDialog = false;

            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            dialogError = $"åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼š{ex.Message}";
        }
        finally
        {
            isCreating = false;
            StateHasChanged();
        }
    }

    private void ShowDeleteConfirmation(User user)
    {
        userToDelete = user;
        showDeleteConfirmDialog = true;
    }

    private void CloseDeleteConfirmation()
    {
        userToDelete = null;
        showDeleteConfirmDialog = false;
    }

    private async Task ConfirmDeleteUser()
    {
        if (userToDelete == null)
            return;

        try
        {
            await AuthService.DeleteUserAsync(userToDelete.Id);
            message = $"ç”¨æˆ· {userToDelete.Username} å·²åˆ é™¤";
            isError = false;
            showDeleteConfirmDialog = false;
            userToDelete = null;
            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            message = $"åˆ é™¤ç”¨æˆ·å¤±è´¥ï¼š{ex.Message}";
            isError = true;
            showDeleteConfirmDialog = false;
        }
    }
}

