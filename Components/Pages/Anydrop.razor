@page "/anydrop"
@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Utilities
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@inject IAnydropService AnydropService
@inject IJSRuntime JSRuntime
@inject ILogger<Anydrop> Logger
@rendermode InteractiveServer

<PageTitle>云笈 - Anydrop</PageTitle>

<style>
    .anydrop-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 180px);
        max-width: 1200px;
        margin: 0 auto;
        background: var(--neutral-layer-1);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--elevation-shadow-card-rest);
    }

    .anydrop-header {
        padding: 20px 24px;
        background: var(--neutral-layer-2);
        border-bottom: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
    }

    .anydrop-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--neutral-foreground-rest);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .anydrop-search {
        flex: 1;
        max-width: 400px;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
        display: flex;
        flex-direction: column-reverse;
        gap: 16px;
    }

    .message-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        background: var(--neutral-layer-2);
        border-radius: 12px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        transition: all 0.2s;
    }

    .message-item:hover {
        border-color: var(--accent-fill-rest);
        box-shadow: var(--elevation-shadow-card-hover);
    }

    .message-item.highlight {
        border-color: var(--accent-fill-rest);
        background: var(--accent-fill-subtle);
        animation: highlight-pulse 1s ease-in-out;
    }

    @@keyframes highlight-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .message-time {
        font-size: 12px;
        color: var(--neutral-foreground-hint);
    }

    .message-content {
        color: var(--neutral-foreground-rest);
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.5;
    }

    .attachments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 12px;
    }

    .attachment-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        background: var(--neutral-layer-3);
        border-radius: 8px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        cursor: pointer;
        transition: all 0.2s;
    }

    .attachment-item:hover {
        border-color: var(--accent-fill-rest);
        transform: translateY(-2px);
    }

    .attachment-preview {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 4px;
    }

    .attachment-video {
        width: 100%;
        height: 150px;
        border-radius: 4px;
    }

    .attachment-icon {
        width: 100%;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--neutral-layer-4);
        border-radius: 4px;
    }

    .attachment-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .attachment-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--neutral-foreground-rest);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .attachment-size {
        font-size: 11px;
        color: var(--neutral-foreground-hint);
    }

    .input-container {
        padding: 20px 24px;
        background: var(--neutral-layer-2);
        border-top: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .input-row {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .text-input {
        flex: 1;
    }

    .send-button {
        height: 40px;
    }

    .file-upload-area {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .selected-file {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--neutral-layer-3);
        border-radius: 6px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        font-size: 12px;
    }

    .loading-indicator {
        text-align: center;
        padding: 20px;
        color: var(--neutral-foreground-hint);
    }

    .no-messages {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        color: var(--neutral-foreground-hint);
    }
</style>

<div class="anydrop-container">
    <div class="anydrop-header">
        <div class="anydrop-title">
            <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.Cloud())" />
            <span>云笈</span>
        </div>
        <div class="anydrop-search">
            <FluentSearch @bind-Value="@searchTerm" 
                         Placeholder="搜索消息和文件..." 
                         @oninput="OnSearchInput"
                         Immediate="true"
                         style="width: 100%;" />
        </div>
    </div>

    <div class="messages-container" @ref="messagesContainer" @onscroll="OnScroll">
        @if (isLoading && messages.Count == 0)
        {
            <div class="loading-indicator">
                <FluentProgressRing />
                <div style="margin-top: 12px;">加载中...</div>
            </div>
        }
        else if (messages.Count == 0 && !isSearching)
        {
            <div class="no-messages">
                <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Cloud())" Color="Color.Accent" />
                <div style="font-size: 18px; font-weight: 500;">欢迎使用云笈</div>
                <div>开始记录您的文字、图片、视频和文件吧！</div>
            </div>
        }
        else if (messages.Count == 0 && isSearching)
        {
            <div class="no-messages">
                <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Search())" />
                <div>未找到匹配的消息</div>
            </div>
        }
        else
        {
            @foreach (var message in messages)
            {
                <div class="message-item" id="message-@message.Id" @key="message.Id">
                    <div class="message-header">
                        <div class="message-time">
                            @message.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                        </div>
                        <FluentButton Appearance="Appearance.Lightweight" 
                                     IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Delete())"
                                     OnClick="@(() => DeleteMessage(message.Id))" />
                    </div>

                    @if (!string.IsNullOrWhiteSpace(message.Content))
                    {
                        <div class="message-content">@message.Content</div>
                    }

                    @if (message.Attachments != null && message.Attachments.Any())
                    {
                        <div class="attachments-grid">
                            @foreach (var attachment in message.Attachments)
                            {
                                <div class="attachment-item" @onclick="@(() => DownloadAttachment(attachment.Id))">
                                    @if (attachment.AttachmentType == "Image")
                                    {
                                        <img src="/api/anydrop/attachment/@attachment.Id/preview" 
                                             alt="@attachment.FileName" 
                                             class="attachment-preview" 
                                             loading="lazy" />
                                    }
                                    else if (attachment.AttachmentType == "Video")
                                    {
                                        <video class="attachment-video" controls>
                                            <source src="/api/anydrop/attachment/@attachment.Id/preview" 
                                                   type="@attachment.ContentType">
                                        </video>
                                    }
                                    else
                                    {
                                        <div class="attachment-icon">
                                            <FluentIcon Value="@GetIconForAttachment(attachment)" Size="@IconSize.Size48" />
                                        </div>
                                    }
                                    <div class="attachment-info">
                                        <div class="attachment-name" title="@attachment.FileName">
                                            @attachment.FileName
                                        </div>
                                        <div class="attachment-size">
                                            @FileUtilities.FormatSize(attachment.FileSize)
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            @if (hasMore && !isSearching)
            {
                <div class="loading-indicator">
                    @if (isLoadingMore)
                    {
                        <FluentProgressRing />
                        <div style="margin-top: 12px;">加载更多...</div>
                    }
                    else
                    {
                        <FluentButton Appearance="Appearance.Outline" OnClick="LoadMoreMessages">
                            加载更多消息
                        </FluentButton>
                    }
                </div>
            }
        }
    </div>

    <div class="input-container">
        @if (selectedFiles.Count > 0)
        {
            <div class="file-upload-area">
                @foreach (var file in selectedFiles)
                {
                    <div class="selected-file">
                        <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Document())" />
                        <span>@file.Name (@FileUtilities.FormatSize(file.Size))</span>
                        <FluentButton Appearance="Appearance.Lightweight" 
                                     IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Dismiss())"
                                     OnClick="@(() => RemoveFile(file))" />
                    </div>
                }
            </div>
        }

        <div class="input-row">
            <InputFile @ref="fileInput" 
                      multiple 
                      accept="*/*"
                      OnChange="@OnFilesSelected"
                      style="display: none;" id="fileInput" />
            
            <FluentButton Appearance="Appearance.Outline" 
                         IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Attach())"
                         OnClick="OpenFileDialog"
                         Title="添加文件"
                         Disabled="@isSending" />

            <div class="text-input">
                <FluentTextArea @bind-Value="@messageContent" 
                              Placeholder="输入消息..." 
                              Rows="1"
                              Resize="TextAreaResize.Vertical"
                              @onkeydown="OnKeyDown"
                              Disabled="@isSending"
                              style="width: 100%;" />
            </div>

            <FluentButton Appearance="Appearance.Accent" 
                         IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Send())"
                         OnClick="SendMessage"
                         Disabled="@(isSending || (string.IsNullOrWhiteSpace(messageContent) && selectedFiles.Count == 0))"
                         class="send-button">
                @(isSending ? "发送中..." : "发送")
            </FluentButton>
        </div>
    </div>
</div>

@code {
    private List<AnydropMessage> messages = new();
    private string messageContent = string.Empty;
    private string searchTerm = string.Empty;
    private List<IBrowserFile> selectedFiles = new();
    private InputFile? fileInput;
    private ElementReference messagesContainer;
    private bool isLoading = false;
    private bool isLoadingMore = false;
    private bool isSending = false;
    private bool hasMore = true;
    private bool isSearching = false;
    private int? lastMessageId = null;
    private System.Threading.Timer? searchDebounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadMessages();
    }

    private async Task LoadMessages()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            messages = await AnydropService.GetMessagesAsync(20);
            hasMore = messages.Count == 20;
            lastMessageId = messages.Any() ? messages.Min(m => m.Id) : null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading messages");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreMessages()
    {
        if (!hasMore || isLoadingMore || isSearching || lastMessageId == null)
            return;

        isLoadingMore = true;
        StateHasChanged();

        try
        {
            var moreMessages = await AnydropService.GetMessagesAsync(20, lastMessageId);
            if (moreMessages.Count > 0)
            {
                messages.AddRange(moreMessages);
                lastMessageId = moreMessages.Min(m => m.Id);
                hasMore = moreMessages.Count == 20;
            }
            else
            {
                hasMore = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading more messages");
        }
        finally
        {
            isLoadingMore = false;
            StateHasChanged();
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        
        // Debounce search
        searchDebounceTimer?.Dispose();
        searchDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () => await PerformSearch());
        }, null, 500, Timeout.Infinite);
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            isSearching = false;
            await LoadMessages();
            return;
        }

        isSearching = true;
        isLoading = true;
        StateHasChanged();

        try
        {
            messages = await AnydropService.SearchMessagesAsync(searchTerm);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching messages");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnScroll()
    {
        // Check if scrolled to top for infinite scroll
        var scrollTop = await JSRuntime.InvokeAsync<double>("eval", 
            "document.querySelector('.messages-container').scrollTop");
        
        if (scrollTop <= 100 && !isLoadingMore)
        {
            await LoadMoreMessages();
        }
    }

    private async Task SendMessage()
    {
        if (isSending || (string.IsNullOrWhiteSpace(messageContent) && selectedFiles.Count == 0))
            return;

        isSending = true;
        StateHasChanged();

        try
        {
            // Determine message type
            var messageType = "Text";
            if (selectedFiles.Count > 0)
            {
                if (string.IsNullOrWhiteSpace(messageContent))
                {
                    // Pure file message
                    var firstFile = selectedFiles.First();
                    if (firstFile.ContentType.StartsWith("image/"))
                        messageType = "Image";
                    else if (firstFile.ContentType.StartsWith("video/"))
                        messageType = "Video";
                    else
                        messageType = "File";
                }
                else
                {
                    messageType = "Mixed";
                }
            }

            // Create message
            var message = await AnydropService.CreateMessageAsync(messageContent, messageType);

            // Upload attachments
            foreach (var file in selectedFiles)
            {
                try
                {
                    using var stream = file.OpenReadStream(maxAllowedSize: 2147483648); // 2GB max
                    await AnydropService.AddAttachmentAsync(
                        message.Id, 
                        file.Name, 
                        stream, 
                        file.Size, 
                        file.ContentType);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error uploading file: {FileName}", file.Name);
                }
            }

            // Refresh message to get attachments
            var refreshedMessage = await AnydropService.GetMessageByIdAsync(message.Id);
            if (refreshedMessage != null)
            {
                // Add to top of list
                messages.Insert(0, refreshedMessage);
            }

            // Clear input
            messageContent = string.Empty;
            selectedFiles.Clear();
            
            // Scroll to bottom (which is top in reverse flex)
            await JSRuntime.InvokeVoidAsync("eval", 
                "document.querySelector('.messages-container').scrollTop = 0");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error sending message");
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        selectedFiles.AddRange(e.GetMultipleFiles(100));
        StateHasChanged();
    }

    private void RemoveFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);
        StateHasChanged();
    }

    private async Task OpenFileDialog()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('fileInput').click()");
    }

    private async Task DownloadAttachment(int attachmentId)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("open", $"/api/anydrop/attachment/{attachmentId}/download", "_blank");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading attachment");
        }
    }

    private async Task DeleteMessage(int messageId)
    {
        try
        {
            await AnydropService.DeleteMessageAsync(messageId);
            messages.RemoveAll(m => m.Id == messageId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting message");
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private Icon GetIconForAttachment(AnydropAttachment attachment)
    {
        return attachment.AttachmentType switch
        {
            "Document" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Document(),
            "Audio" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Speaker1(),
            "Video" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Video(),
            "Image" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Image(),
            _ => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.DocumentText()
        };
    }

    public void Dispose()
    {
        searchDebounceTimer?.Dispose();
    }
}
