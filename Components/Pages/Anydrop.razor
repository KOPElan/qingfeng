@page "/anydrop"
@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Utilities
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using static QingFeng.Models.UploadStatus
@inject IAnydropService AnydropService
@inject IJSRuntime JSRuntime
@inject ILogger<Anydrop> Logger
@rendermode InteractiveServer

<PageTitle>‰∫ëÁ¨à - Anydrop</PageTitle>

<style>
    .anydrop-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 180px);
        max-width: 1200px;
        margin: 0 auto;
        background: var(--neutral-layer-1);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--elevation-shadow-card-rest);
    }

    .anydrop-header {
        padding: 20px 24px;
        background: var(--neutral-layer-2);
        border-bottom: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .anydrop-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
    }

    .anydrop-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--neutral-foreground-rest);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .anydrop-search {
        flex: 1;
        max-width: 400px;
    }

    .anydrop-tabs {
        display: flex;
        gap: 8px;
    }

    .tab-button {
        padding: 8px 16px;
        border: none;
        background: transparent;
        color: var(--neutral-foreground-hint);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        font-size: 14px;
        font-weight: 500;
    }

    .tab-button:hover {
        color: var(--neutral-foreground-rest);
    }

    .tab-button.active {
        color: var(--accent-fill-rest);
        border-bottom-color: var(--accent-fill-rest);
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
        display: flex;
        flex-direction: column-reverse;
        gap: 16px;
    }

    .message-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        background: var(--neutral-layer-2);
        border-radius: 12px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        transition: all 0.2s;
    }

    .message-item:hover {
        border-color: var(--accent-fill-rest);
        box-shadow: var(--elevation-shadow-card-hover);
    }

    .message-item.highlight {
        border-color: var(--accent-fill-rest);
        background: var(--accent-fill-subtle);
        animation: highlight-pulse 1s ease-in-out;
    }

    @@keyframes highlight-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .message-time {
        font-size: 12px;
        color: var(--neutral-foreground-hint);
    }

    .message-content {
        color: var(--neutral-foreground-rest);
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.5;
    }

    .link-metadata-card {
        display: flex;
        gap: 12px;
        padding: 12px;
        margin-top: 12px;
        background: var(--neutral-layer-3);
        border-radius: 8px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        cursor: pointer;
        transition: all 0.2s;
    }

    .link-metadata-card:hover {
        border-color: var(--accent-fill-rest);
        background: var(--neutral-layer-4);
        box-shadow: var(--elevation-shadow-card-hover);
    }

    .link-metadata-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        background: var(--accent-fill-subtle);
        border-radius: 6px;
        flex-shrink: 0;
        color: var(--accent-fill-rest);
    }

    .link-metadata-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        overflow: hidden;
    }

    .link-metadata-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--neutral-foreground-rest);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .link-metadata-description {
        font-size: 12px;
        color: var(--neutral-foreground-hint);
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.4;
    }

    .link-metadata-url {
        font-size: 11px;
        color: var(--accent-fill-rest);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .link-metadata-loading {
        display: flex;
        align-items: center;
        font-size: 12px;
        color: var(--neutral-foreground-hint);
        font-style: italic;
    }

    .attachments-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
    }

    .attachment-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        background: var(--neutral-layer-3);
        border-radius: 8px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        cursor: pointer;
        transition: all 0.2s;
        max-width: 100%;
        position: relative;
    }

    .attachment-item:hover {
        border-color: var(--accent-fill-rest);
        transform: translateY(-2px);
        box-shadow: var(--elevation-shadow-card-hover);
    }
    
    .attachment-item.uploading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .attachment-item.pending {
        opacity: 0.8;
        pointer-events: none;
    }
    
    .attachment-item.failed {
        border-color: var(--error-fill-rest);
        background: var(--error-fill-subtle);
    }

    .attachment-upload-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        border-radius: 8px;
        z-index: 10;
    }
    
    .attachment-upload-overlay.attachment-failed {
        background: rgba(220, 38, 38, 0.1);
    }

    .attachment-preview {
        width: 100%;
        max-width: 400px;
        height: auto;
        max-height: 300px;
        object-fit: contain;
        border-radius: 4px;
    }

    .attachment-video {
        width: 100%;
        max-width: 400px;
        max-height: 300px;
        border-radius: 4px;
    }

    .attachment-icon {
        width: 100%;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--neutral-layer-4);
        border-radius: 4px;
    }

    .attachment-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .attachment-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--neutral-foreground-rest);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .attachment-size {
        font-size: 11px;
        color: var(--neutral-foreground-hint);
    }

    .input-container {
        padding: 20px 24px;
        background: var(--neutral-layer-2);
        border-top: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .input-row {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .text-input {
        flex: 1;
    }

    .message-textarea {
        outline: none;
        transition: border-color 0.2s;
    }

    .message-textarea:focus {
        border-color: var(--accent-fill-rest) !important;
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.1);
    }

    .message-textarea:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .send-button {
        height: 40px;
    }

    .file-upload-area {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .selected-file {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--neutral-layer-3);
        border-radius: 6px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        font-size: 12px;
    }

    .loading-indicator {
        text-align: center;
        padding: 20px;
        color: var(--neutral-foreground-hint);
    }

    .no-messages {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        color: var(--neutral-foreground-hint);
    }

    /* Grid view for images/videos */
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        padding: 20px 24px;
    }

    .media-grid-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 1px solid var(--neutral-stroke-layer-rest);
        transition: all 0.2s;
    }

    .media-grid-item:hover {
        transform: translateY(-4px);
        box-shadow: var(--elevation-shadow-card-hover);
        border-color: var(--accent-fill-rest);
    }

    .media-grid-item img,
    .media-grid-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .media-grid-item-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        padding: 8px;
        color: white;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .media-grid-item-checkbox {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 5;
    }

    .media-grid-item.selected {
        border: 3px solid var(--accent-fill-rest);
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
    }

    .selection-toolbar {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--neutral-layer-2);
        border-radius: 8px;
        padding: 12px 20px;
        box-shadow: var(--elevation-shadow-flyout);
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 100;
        border: 1px solid var(--neutral-stroke-layer-rest);
    }

    .selection-count {
        font-size: 14px;
        color: var(--neutral-foreground-rest);
        font-weight: 500;
    }

    .tab-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--neutral-foreground-hint);
    }

    /* Modal styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--neutral-layer-1);
        border-radius: 12px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: var(--elevation-shadow-dialog);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px 24px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .preview-modal-content {
        max-width: 1200px;
        width: 90vw;
    }

    .preview-image,
    .preview-video {
        max-width: 100%;
        max-height: 70vh;
        margin: 0 auto;
        display: block;
    }

    .search-modal-content {
        width: 600px;
    }

    .search-result-item {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--neutral-stroke-layer-rest);
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .search-result-item:hover {
        background: var(--neutral-layer-2);
        border-color: var(--accent-fill-rest);
    }

    .search-result-time {
        font-size: 12px;
        color: var(--neutral-foreground-hint);
        margin-bottom: 4px;
    }

    .search-result-content {
        color: var(--neutral-foreground-rest);
    }

    /* Timeline styles */
    .timeline-group {
        margin-bottom: 32px;
    }

    .timeline-header {
        position: sticky;
        top: 0;
        background: var(--neutral-layer-1);
        z-index: 10;
        padding: 12px 0;
        margin-bottom: 16px;
        border-bottom: 2px solid var(--accent-fill-rest);
    }

    .timeline-date {
        font-size: 18px;
        font-weight: 600;
        color: var(--neutral-foreground-rest);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .timeline-count {
        font-size: 14px;
        font-weight: 400;
        color: var(--neutral-foreground-hint);
    }
</style>

<div class="anydrop-container">
    <div class="anydrop-header">
        <div class="anydrop-header-top">
            <div class="anydrop-title">
                <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.Cloud())" />
                <span>‰∫ëÁ¨à</span>
            </div>
            <div class="anydrop-search">
                <FluentButton Appearance="Appearance.Outline" 
                             IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Search())"
                             OnClick="OpenSearchModal"
                             Title="ÊêúÁ¥¢Ê∂àÊÅØÂíåÊñá‰ª∂">
                    ÊêúÁ¥¢
                </FluentButton>
            </div>
        </div>
        <div class="anydrop-tabs">
            <button class="tab-button @(currentTab == "all" ? "active" : "")" @onclick='() => SetTab("all")'>
                ÂÖ®ÈÉ®
            </button>
            <button class="tab-button @(currentTab == "images" ? "active" : "")" @onclick='() => SetTab("images")'>
                ÂõæÁâá
            </button>
            <button class="tab-button @(currentTab == "videos" ? "active" : "")" @onclick='() => SetTab("videos")'>
                ËßÜÈ¢ë
            </button>
            <button class="tab-button @(currentTab == "files" ? "active" : "")" @onclick='() => SetTab("files")'>
                Êñá‰ª∂
            </button>
        </div>
    </div>

    <div class="messages-container" @ref="messagesContainer" @onscroll="OnScroll">
        @if (isLoading && messages.Count == 0)
        {
            <div class="loading-indicator">
                <FluentProgressRing />
                <div style="margin-top: 12px;">Âä†ËΩΩ‰∏≠...</div>
            </div>
        }
        else if (messages.Count == 0 && !isSearching)
        {
            <div class="no-messages">
                <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Cloud())" Color="Color.Accent" />
                <div style="font-size: 18px; font-weight: 500;">Ê¨¢Ëøé‰ΩøÁî®‰∫ëÁ¨à</div>
                <div>ÂºÄÂßãËÆ∞ÂΩïÊÇ®ÁöÑÊñáÂ≠ó„ÄÅÂõæÁâá„ÄÅËßÜÈ¢ëÂíåÊñá‰ª∂ÂêßÔºÅ</div>
            </div>
        }
        else if (messages.Count == 0 && isSearching)
        {
            <div class="no-messages">
                <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Search())" />
                <div>Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊ∂àÊÅØ</div>
            </div>
        }
        else if (currentTab == "images" || currentTab == "videos" || currentTab == "files")
        {
            @if (isTabLoading)
            {
                <div class="tab-loading">
                    <FluentProgressRing />
                    <div style="margin-left: 12px;">Âä†ËΩΩ‰∏≠...</div>
                </div>
            }
            else if (currentTab == "images" || currentTab == "videos")
            {
                <!-- Grid view for images/videos with timeline -->
                <div style="padding: 20px 24px; overflow-y: auto;">
                    @{
                        var groupedByDate = tabFilteredAttachments
                            .GroupBy(x => x.Message.CreatedAt.ToLocalTime().Date)
                            .OrderByDescending(g => g.Key);
                    }
                    
                    @foreach (var dateGroup in groupedByDate)
                    {
                        <div class="timeline-group" @key="dateGroup.Key">
                            <div class="timeline-header">
                                <div class="timeline-date">
                                    @if (dateGroup.Key.Date == DateTime.Today)
                                    {
                                        <span>‰ªäÂ§©</span>
                                    }
                                    else if (dateGroup.Key.Date == DateTime.Today.AddDays(-1))
                                    {
                                        <span>Êò®Â§©</span>
                                    }
                                    else if (dateGroup.Key.Year == DateTime.Today.Year)
                                    {
                                        <span>@dateGroup.Key.ToString("MÊúàdÊó•")</span>
                                    }
                                    else
                                    {
                                        <span>@dateGroup.Key.ToString("yyyyÂπ¥MÊúàdÊó•")</span>
                                    }
                                    <span class="timeline-count">(@dateGroup.Count() È°π)</span>
                                </div>
                            </div>
                            <div class="media-grid">
                                @foreach (var item in dateGroup)
                                {
                                    var isSelected = selectedAttachmentIds.Contains(item.Attachment.Id);
                                    <div class="media-grid-item @(isSelected ? "selected" : "")" @key="item.Attachment.Id">
                                        <div class="media-grid-item-checkbox" @onclick:stopPropagation="true">
                                            <FluentCheckbox Value="@isSelected" 
                                                          ValueChanged="@((bool value) => ToggleAttachmentSelection(item.Attachment.Id, value))" />
                                        </div>
                                        <div @onclick="@(() => OpenPreviewModal(item.Attachment))">
                                            @if (item.Attachment.AttachmentType == "Image")
                                            {
                                                <img src="/api/anydrop/attachment/@item.Attachment.Id/preview" 
                                                     alt="@item.Attachment.FileName" 
                                                     loading="lazy" />
                                            }
                                            else if (item.Attachment.AttachmentType == "Video")
                                            {
                                                <video aria-label="@item.Attachment.FileName">
                                                    <source src="/api/anydrop/attachment/@item.Attachment.Id/preview" 
                                                           type="@item.Attachment.ContentType">
                                                </video>
                                            }
                                            <div class="media-grid-item-overlay">
                                                @item.Attachment.FileName
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else if (currentTab == "files")
            {
                <!-- List view for files -->
                <div style="padding: 20px 24px; overflow-y: auto;">
                    @{
                        var groupedByDate = tabFilteredAttachments
                            .GroupBy(x => x.Message.CreatedAt.ToLocalTime().Date)
                            .OrderByDescending(g => g.Key);
                    }
                    
                    @foreach (var dateGroup in groupedByDate)
                    {
                        <div class="timeline-group" @key="dateGroup.Key">
                            <div class="timeline-header">
                                <div class="timeline-date">
                                    @if (dateGroup.Key.Date == DateTime.Today)
                                    {
                                        <span>‰ªäÂ§©</span>
                                    }
                                    else if (dateGroup.Key.Date == DateTime.Today.AddDays(-1))
                                    {
                                        <span>Êò®Â§©</span>
                                    }
                                    else if (dateGroup.Key.Year == DateTime.Today.Year)
                                    {
                                        <span>@dateGroup.Key.ToString("MÊúàdÊó•")</span>
                                    }
                                    else
                                    {
                                        <span>@dateGroup.Key.ToString("yyyyÂπ¥MÊúàdÊó•")</span>
                                    }
                                    <span class="timeline-count">(@dateGroup.Count() È°π)</span>
                                </div>
                            </div>
                            <div class="attachments-grid">
                                @foreach (var item in dateGroup)
                                {
                                    var isSelected = selectedAttachmentIds.Contains(item.Attachment.Id);
                                    <div class="attachment-item @(isSelected ? "selected" : "")" style="position: relative;" @key="item.Attachment.Id">
                                        <div style="position: absolute; top: 8px; right: 8px; z-index: 5;" @onclick:stopPropagation="true">
                                            <FluentCheckbox Value="@isSelected" 
                                                          ValueChanged="@((bool value) => ToggleAttachmentSelection(item.Attachment.Id, value))" />
                                        </div>
                                        <div @onclick="@(() => DownloadAttachment(item.Attachment.Id))">
                                            <div class="attachment-icon">
                                                <FluentIcon Value="@GetIconForAttachment(item.Attachment)" Size="@IconSize.Size48" />
                                            </div>
                                            <div class="attachment-info">
                                                <div class="attachment-name" title="@item.Attachment.FileName">
                                                    @item.Attachment.FileName
                                                </div>
                                                <div class="attachment-size">
                                                    @FileUtilities.FormatSize(item.Attachment.FileSize)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            @foreach (var message in FilteredMessages)
            {
                <div class="message-item" id="message-@message.Id" @key="message.Id">
                    <div class="message-header">
                        <div class="message-time">
                            @message.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                        </div>
                        <FluentButton Appearance="Appearance.Lightweight" 
                                     IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Delete())"
                                     OnClick="@(() => DeleteMessage(message.Id))" />
                    </div>

                    @if (!string.IsNullOrWhiteSpace(message.Content))
                    {
                        <div class="message-content">@message.Content</div>
                    }

                    @if (!string.IsNullOrEmpty(message.LinkUrl))
                    {
                        <div class="link-metadata-card" @onclick="@(() => OpenLinkInNewTab(message.LinkUrl))">
                            <div class="link-metadata-icon">
                                <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.Link())" />
                            </div>
                            <div class="link-metadata-content">
                                @if (!string.IsNullOrEmpty(message.LinkTitle))
                                {
                                    <div class="link-metadata-title">@message.LinkTitle</div>
                                }
                                else if (loadingMetadataMessageIds.Contains(message.Id))
                                {
                                    <div class="link-metadata-loading">
                                        <FluentProgressRing Style="width: 16px; height: 16px;" />
                                        <span style="margin-left: 8px;">Ê≠£Âú®Ëé∑ÂèñÈìæÊé•‰ø°ÊÅØ...</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(message.LinkDescription))
                                {
                                    <div class="link-metadata-description">@message.LinkDescription</div>
                                }
                                <div class="link-metadata-url">@message.LinkUrl</div>
                            </div>
                        </div>
                    }

                    @if (message.Attachments != null && message.Attachments.Any())
                    {
                        <div class="attachments-grid">
                            @foreach (var attachment in message.Attachments)
                            {
                                <div class="attachment-item @GetAttachmentStatusClass(attachment)" @onclick="@(() => HandleAttachmentClick(attachment))">
                                    @if (attachment.UploadStatus == Pending || attachment.UploadStatus == Uploading)
                                    {
                                        <div class="attachment-upload-overlay">
                                            <FluentProgressRing Style="width: 32px; height: 32px;" />
                                            <div style="margin-top: 8px; font-size: 12px; color: var(--neutral-foreground-rest);">
                                                @(attachment.UploadStatus == Pending ? "Á≠âÂæÖ‰∏ä‰º†..." : "‰∏ä‰º†‰∏≠...")
                                            </div>
                                        </div>
                                    }
                                    else if (attachment.UploadStatus == Failed)
                                    {
                                        <div class="attachment-upload-overlay attachment-failed">
                                            <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size32.DismissCircle())" Color="Color.Error" />
                                            <div style="margin-top: 8px; font-size: 12px; color: var(--error-foreground-rest);">
                                                ‰∏ä‰º†Â§±Ë¥•
                                            </div>
                                            @if (!string.IsNullOrEmpty(attachment.UploadErrorMessage))
                                            {
                                                <div style="font-size: 10px; color: var(--neutral-foreground-hint); margin-top: 4px;">
                                                    @attachment.UploadErrorMessage
                                                </div>
                                            }
                                        </div>
                                    }
                                    
                                    @if (attachment.UploadStatus == Completed)
                                    {
                                        @if (attachment.AttachmentType == "Image")
                                        {
                                            <img src="/api/anydrop/attachment/@attachment.Id/preview" 
                                                 alt="@attachment.FileName" 
                                                 class="attachment-preview" 
                                                 loading="lazy" />
                                        }
                                        else if (attachment.AttachmentType == "Video")
                                        {
                                            <video class="attachment-video" controls>
                                                <source src="/api/anydrop/attachment/@attachment.Id/preview" 
                                                       type="@attachment.ContentType">
                                            </video>
                                        }
                                        else
                                        {
                                            <div class="attachment-icon">
                                                <FluentIcon Value="@GetIconForAttachment(attachment)" Size="@IconSize.Size48" />
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="attachment-icon">
                                            <FluentIcon Value="@GetIconForAttachment(attachment)" Size="@IconSize.Size48" />
                                        </div>
                                    }
                                    
                                    <div class="attachment-info">
                                        <div class="attachment-name" title="@attachment.FileName">
                                            @attachment.FileName
                                        </div>
                                        <div class="attachment-size">
                                            @FileUtilities.FormatSize(attachment.FileSize)
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            @if (hasMore && !isSearching)
            {
                <div class="loading-indicator">
                    @if (isLoadingMore)
                    {
                        <FluentProgressRing />
                        <div style="margin-top: 12px;">Âä†ËΩΩÊõ¥Â§ö...</div>
                    }
                    else
                    {
                        <FluentButton Appearance="Appearance.Outline" OnClick="LoadMoreMessages">
                            Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
                        </FluentButton>
                    }
                </div>
            }
        }
    </div>

    @* Selection toolbar for multi-select *@
    @if (selectedAttachmentIds.Count > 0)
    {
        <div class="selection-toolbar">
            <span class="selection-count">Â∑≤ÈÄâÊã© @selectedAttachmentIds.Count È°π</span>
            <FluentButton Appearance="Appearance.Accent"
                         IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Send())"
                         OnClick="SendSelectedAttachments">
                ÂèëÈÄÅÈÄâ‰∏≠È°π
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral"
                         IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Dismiss())"
                         OnClick="ClearSelection">
                ÂèñÊ∂àÈÄâÊã©
            </FluentButton>
        </div>
    }

    <div class="input-container">
        @if (selectedFiles.Count > 0)
        {
            <div class="file-upload-area">
                @foreach (var file in selectedFiles)
                {
                    <div class="selected-file">
                        <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Document())" />
                        <span>@file.Name (@FileUtilities.FormatSize(file.Size))</span>
                        <FluentButton Appearance="Appearance.Lightweight" 
                                     IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Dismiss())"
                                     OnClick="@(() => RemoveFile(file))" />
                    </div>
                }
            </div>
        }

        <div class="input-row">
            <InputFile @ref="mediaFileInput" 
                      multiple 
                      accept="image/*,video/*"
                      OnChange="@OnMediaFilesSelected"
                      style="display: none;" id="mediaFileInput" />
            
            <InputFile @ref="documentFileInput" 
                      multiple 
                      accept="*/*"
                      OnChange="@OnDocumentFilesSelected"
                      style="display: none;" id="documentFileInput" />
            
            <FluentButton Appearance="Appearance.Outline" 
                         IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Image())"
                         OnClick="OpenMediaFileDialog"
                         Title="Ê∑ªÂä†ÂõæÁâá/ËßÜÈ¢ë"
                         Disabled="@isSending" />

            <FluentButton Appearance="Appearance.Outline" 
                         IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Document())"
                         OnClick="OpenDocumentFileDialog"
                         Title="Ê∑ªÂä†Êñá‰ª∂"
                         Disabled="@isSending" />

            <div class="text-input">
                <textarea @bind="messageContent" 
                         @bind:event="oninput"
                         placeholder="ËæìÂÖ•Ê∂àÊÅØ..." 
                         rows="1"
                         @onkeydown="OnKeyDown"
                         disabled="@isSending"
                         style="width: 100%; padding: 10px; border: 1px solid var(--neutral-stroke-layer-rest); border-radius: 4px; background: var(--neutral-layer-1); color: var(--neutral-foreground-rest); font-family: inherit; font-size: 14px; resize: vertical; min-height: 40px;"
                         class="message-textarea"></textarea>
            </div>

            <FluentButton Appearance="Appearance.Accent" 
                         IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Send())"
                         OnClick="SendMessage"
                         Disabled="@(isSending || (string.IsNullOrWhiteSpace(messageContent) && selectedFiles.Count == 0))"
                         class="send-button">
                @(isSending ? "ÂèëÈÄÅ‰∏≠..." : "ÂèëÈÄÅ")
            </FluentButton>
        </div>
    </div>
</div>

@* Preview Modal *@
@if (showPreviewModal && selectedAttachment != null)
{
    <div class="modal-backdrop" @onclick="ClosePreviewModal">
        <div class="modal-content preview-modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3 style="margin: 0;">@selectedAttachment.FileName</h3>
                <FluentButton Appearance="Appearance.Lightweight"
                             IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Dismiss())"
                             OnClick="ClosePreviewModal" />
            </div>
            <div class="modal-body" style="text-align: center;">
                @if (selectedAttachment.AttachmentType == "Image")
                {
                    <img src="/api/anydrop/attachment/@selectedAttachment.Id/preview"
                         alt="@selectedAttachment.FileName"
                         class="preview-image" />
                }
                else if (selectedAttachment.AttachmentType == "Video")
                {
                    <video class="preview-video" controls>
                        <source src="/api/anydrop/attachment/@selectedAttachment.Id/preview"
                               type="@selectedAttachment.ContentType">
                    </video>
                }
            </div>
            <div class="modal-footer">
                <FluentButton Appearance="Appearance.Neutral"
                             OnClick="ClosePreviewModal">
                    ÂÖ≥Èó≠
                </FluentButton>
                <FluentButton Appearance="Appearance.Accent"
                             IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowDownload())"
                             OnClick="@(() => DownloadAttachment(selectedAttachment.Id))">
                    ‰∏ãËΩΩ
                </FluentButton>
            </div>
        </div>
    </div>
}

@* Search Modal *@
@if (showSearchModal)
{
    <div class="modal-backdrop" @onclick="CloseSearchModal">
        <div class="modal-content search-modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3 style="margin: 0;">ÊêúÁ¥¢Ê∂àÊÅØÂíåÊñá‰ª∂</h3>
                <FluentButton Appearance="Appearance.Lightweight"
                             IconEnd="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Dismiss())"
                             OnClick="CloseSearchModal" />
            </div>
            <div class="modal-body">
                <FluentSearch @bind-Value="@modalSearchTerm"
                             Placeholder="ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç..."
                             @oninput="OnModalSearchInput"
                             Immediate="true"
                             style="width: 100%; margin-bottom: 20px;" />

                @if (isModalSearching && searchResults.Count == 0)
                {
                    <div style="text-align: center; padding: 20px; color: var(--neutral-foreground-hint);">
                        <FluentProgressRing />
                        <div style="margin-top: 12px;">ÊêúÁ¥¢‰∏≠...</div>
                    </div>
                }
                else if (searchResults.Count == 0 && !string.IsNullOrWhiteSpace(modalSearchTerm))
                {
                    <div style="text-align: center; padding: 20px; color: var(--neutral-foreground-hint);">
                        Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊ∂àÊÅØ
                    </div>
                }
                else if (searchResults.Count > 0)
                {
                    @foreach (var result in searchResults)
                    {
                        <div class="search-result-item" @onclick="@(() => NavigateToMessage(result.Id))">
                            <div class="search-result-time">
                                @result.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                            </div>
                            <div class="search-result-content">
                                @if (!string.IsNullOrWhiteSpace(result.Content))
                                {
                                    <span>@result.Content</span>
                                }
                                else if (result.Attachments != null && result.Attachments.Any())
                                {
                                    <span>üìé @result.Attachments.First().FileName</span>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    // Constants
    private const long MaxFileSize = 2147483648; // 2GB max upload size
    
    private List<AnydropMessage> messages = new();
    private string messageContent = string.Empty;
    private string searchTerm = string.Empty;
    private string modalSearchTerm = string.Empty;
    private List<IBrowserFile> selectedFiles = new();
    private InputFile? mediaFileInput;
    private InputFile? documentFileInput;
    private ElementReference messagesContainer;
    private bool isLoading = false;
    private bool isLoadingMore = false;
    private bool isSending = false;
    private bool hasMore = true;
    private bool isSearching = false;
    private bool isModalSearching = false;
    private int? lastMessageId = null;
    private System.Threading.Timer? searchDebounceTimer;
    private System.Threading.Timer? modalSearchDebounceTimer;
    private string currentTab = "all";
    private CancellationTokenSource? _uploadCancellationTokenSource;
    private List<Task> _activeUploadTasks = new();
    
    // Tab-specific state
    private bool isTabLoading = false;
    private List<(AnydropMessage Message, AnydropAttachment Attachment)> tabFilteredAttachments = new();
    
    // Multi-select state
    private HashSet<int> selectedAttachmentIds = new();
    
    // Modal states
    private bool showPreviewModal = false;
    private bool showSearchModal = false;
    private AnydropAttachment? selectedAttachment = null;
    private List<AnydropMessage> searchResults = new();
    private HashSet<int> loadingMetadataMessageIds = new();

    private IEnumerable<AnydropMessage> FilteredMessages
    {
        get
        {
            if (currentTab == "all")
                return messages;
            else if (currentTab == "images")
                return messages.Where(m => m.MessageType == "Image");
            else if (currentTab == "videos")
                return messages.Where(m => m.MessageType == "Video");
            else if (currentTab == "files")
                return messages.Where(m => m.MessageType == "File" || m.MessageType == "Document" || m.MessageType == "Audio" || m.MessageType == "Other");
            return messages;
        }
    }

    private async Task SetTab(string tab)
    {
        currentTab = tab;
        selectedAttachmentIds.Clear(); // Clear selection when switching tabs
        
        // Load tab content asynchronously for image/video/file tabs
        if (tab == "images" || tab == "videos" || tab == "files")
        {
            await LoadTabContentAsync(tab);
        }
        
        StateHasChanged();
    }

    private async Task LoadTabContentAsync(string tab)
    {
        isTabLoading = true;
        StateHasChanged();
        
        // Small delay to show loading state
        await Task.Delay(50);
        
        try
        {
            // Filter attachments based on tab type
            var filteredMessages = tab switch
            {
                "images" => messages.Where(m => m.MessageType == "Image"),
                "videos" => messages.Where(m => m.MessageType == "Video"),
                "files" => messages.Where(m => m.MessageType == "File" || m.MessageType == "Document" || m.MessageType == "Audio" || m.MessageType == "Other"),
                _ => Enumerable.Empty<AnydropMessage>()
            };
            
            tabFilteredAttachments = filteredMessages
                .Where(m => m.Attachments != null && m.Attachments.Any())
                .SelectMany(m => m.Attachments
                    .Where(a => a.UploadStatus == Completed)
                    .Select(a => (Message: m, Attachment: a)))
                .ToList();
        }
        finally
        {
            isTabLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleAttachmentSelection(int attachmentId, bool isSelected)
    {
        if (isSelected)
        {
            selectedAttachmentIds.Add(attachmentId);
        }
        else
        {
            selectedAttachmentIds.Remove(attachmentId);
        }
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedAttachmentIds.Clear();
        StateHasChanged();
    }

    private async Task SendSelectedAttachments()
    {
        if (selectedAttachmentIds.Count == 0)
            return;
            
        isSending = true;
        StateHasChanged();
        
        try
        {
            // Get all selected attachments
            var selectedAttachments = tabFilteredAttachments
                .Where(item => selectedAttachmentIds.Contains(item.Attachment.Id))
                .Select(item => item.Attachment)
                .ToList();
            
            // Create a new message for selected attachments
            var messageContent = $"ËΩ¨Âèë {selectedAttachments.Count} ‰∏™Êñá‰ª∂";
            var newMessage = await AnydropService.CreateMessageAsync(messageContent, "File");
            
            // For each selected attachment, create a copy linked to the new message
            foreach (var attachment in selectedAttachments)
            {
                try
                {
                    // Read the file from the original attachment
                    var (fileBytes, fileName, contentType) = await AnydropService.DownloadAttachmentAsync(attachment.Id);
                    
                    // Upload as a new attachment for the new message
                    using var stream = new MemoryStream(fileBytes);
                    await AnydropService.AddAttachmentAsync(newMessage.Id, fileName, stream, fileBytes.Length, contentType);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error copying attachment {AttachmentId}", attachment.Id);
                }
            }
            
            // Reload messages to show the new message
            await LoadMessages();
            
            // Clear selection
            ClearSelection();
            
            // Show success notification (optional - could use toast/notification service)
            Logger.LogInformation("Successfully sent {Count} selected attachments", selectedAttachments.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error sending selected attachments");
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadMessages();
    }

    private async Task LoadMessages()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            messages = await AnydropService.GetMessagesAsync(20);
            hasMore = messages.Count == 20;
            lastMessageId = messages.Any() ? messages.Min(m => m.Id) : null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading messages");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreMessages()
    {
        if (!hasMore || isLoadingMore || isSearching || lastMessageId == null)
            return;

        isLoadingMore = true;
        StateHasChanged();

        try
        {
            var moreMessages = await AnydropService.GetMessagesAsync(20, lastMessageId);
            if (moreMessages.Count > 0)
            {
                messages.AddRange(moreMessages);
                lastMessageId = moreMessages.Min(m => m.Id);
                hasMore = moreMessages.Count == 20;
            }
            else
            {
                hasMore = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading more messages");
        }
        finally
        {
            isLoadingMore = false;
            StateHasChanged();
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        
        // Debounce search
        searchDebounceTimer?.Dispose();
        searchDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () => await PerformSearch());
        }, null, 500, Timeout.Infinite);
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            isSearching = false;
            await LoadMessages();
            return;
        }

        isSearching = true;
        isLoading = true;
        StateHasChanged();

        try
        {
            messages = await AnydropService.SearchMessagesAsync(searchTerm);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching messages");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnScroll()
    {
        // Check if scrolled to top for infinite scroll
        var scrollTop = await JSRuntime.InvokeAsync<double>("eval", 
            "document.querySelector('.messages-container').scrollTop");
        
        if (scrollTop <= 100 && !isLoadingMore)
        {
            await LoadMoreMessages();
        }
    }

    private async Task SendMessage()
    {
        if (isSending || (string.IsNullOrWhiteSpace(messageContent) && selectedFiles.Count == 0))
            return;

        isSending = true;
        StateHasChanged();

        try
        {
            var createdMessages = new List<AnydropMessage>();

            // Send text message first if there's content
            if (!string.IsNullOrWhiteSpace(messageContent))
            {
                var textMessage = await AnydropService.CreateMessageAsync(messageContent, "Text");
                if (textMessage != null)
                {
                    createdMessages.Add(textMessage);
                }
            }

            // Create messages with placeholder attachments for each file (non-blocking)
            var fileUploadTasks = new List<(AnydropMessage Message, IBrowserFile File, int AttachmentId)>();
            
            foreach (var file in selectedFiles)
            {
                try
                {
                    // Create empty message for the file
                    var fileMessage = await AnydropService.CreateMessageAsync(string.Empty, "File");
                    
                    // Create placeholder attachment (doesn't upload file yet)
                    var placeholderAttachment = await AnydropService.CreatePlaceholderAttachmentAsync(
                        fileMessage.Id, 
                        file.Name, 
                        file.Size, 
                        file.ContentType);
                    
                    // Add attachment to message for display
                    fileMessage.Attachments = new List<AnydropAttachment> { placeholderAttachment };
                    createdMessages.Add(fileMessage);
                    
                    // Queue for async upload
                    fileUploadTasks.Add((fileMessage, file, placeholderAttachment.Id));
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error creating placeholder for file: {FileName}", file.Name);
                }
            }

            // Add all created messages to the top of the list immediately
            foreach (var msg in createdMessages)
            {
                messages.Insert(0, msg);
                
                // If message has a LinkUrl but no title/description, fetch metadata asynchronously
                if (!string.IsNullOrEmpty(msg.LinkUrl) && string.IsNullOrEmpty(msg.LinkTitle))
                {
                    loadingMetadataMessageIds.Add(msg.Id);
                    _ = FetchAndUpdateMetadataAsync(msg.Id, msg.LinkUrl);
                }
            }

            // Clear input and allow user to continue
            messageContent = string.Empty;
            
            // Scroll to bottom (which is top in reverse flex)
            await JSRuntime.InvokeVoidAsync("eval", 
                "document.querySelector('.messages-container').scrollTop = 0");
            
            // Release UI immediately
            isSending = false;
            StateHasChanged();
            
            // Clear file selection AFTER capturing file upload tasks to avoid disposal issues
            selectedFiles.Clear();
            
            // Cancel any existing uploads
            _uploadCancellationTokenSource?.Cancel();
            _uploadCancellationTokenSource?.Dispose();
            _uploadCancellationTokenSource = new CancellationTokenSource();
            
            // Upload files asynchronously with proper task tracking
            _activeUploadTasks.Clear();
            foreach (var (message, file, attachmentId) in fileUploadTasks)
            {
                var uploadTask = UploadFileAsync(message.Id, file, attachmentId, _uploadCancellationTokenSource.Token);
                _activeUploadTasks.Add(uploadTask);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error sending message");
            isSending = false;
            StateHasChanged();
        }
    }
    
    private async Task UploadFileAsync(int messageId, IBrowserFile file, int attachmentId, CancellationToken cancellationToken = default)
    {
        try
        {
            // Update status to "Uploading"
            await AnydropService.UpdateAttachmentStatusAsync(attachmentId, Uploading);
            
            // Update the in-memory message object directly to avoid extra DB query
            var messageIndex = messages.FindIndex(m => m.Id == messageId);
            if (messageIndex >= 0 && messages[messageIndex].Attachments != null)
            {
                var attachment = messages[messageIndex].Attachments.FirstOrDefault(a => a.Id == attachmentId);
                if (attachment != null)
                {
                    attachment.UploadStatus = Uploading;
                    await InvokeAsync(StateHasChanged);
                }
            }
            
            // Check for cancellation
            cancellationToken.ThrowIfCancellationRequested();
            
            // Upload the file
            using var stream = file.OpenReadStream(maxAllowedSize: MaxFileSize);
            await AnydropService.UploadAttachmentFileAsync(attachmentId, stream);
            
            // Check for cancellation
            cancellationToken.ThrowIfCancellationRequested();
            
            // Update status to "Completed" - single DB query at the end
            await AnydropService.UpdateAttachmentStatusAsync(attachmentId, Completed);
            
            // Update in-memory message object
            if (messageIndex >= 0 && messages[messageIndex].Attachments != null)
            {
                var attachment = messages[messageIndex].Attachments.FirstOrDefault(a => a.Id == attachmentId);
                if (attachment != null)
                {
                    attachment.UploadStatus = Completed;
                    // Refresh from database to get the FilePath that was set during upload
                    var updatedMessage = await AnydropService.GetMessageByIdAsync(messageId);
                    if (updatedMessage != null)
                    {
                        messages[messageIndex] = updatedMessage;
                    }
                    await InvokeAsync(StateHasChanged);
                }
            }
            
            Logger.LogInformation("Successfully uploaded file: {FileName}", file.Name);
        }
        catch (OperationCanceledException)
        {
            Logger.LogInformation("Upload cancelled for file: {FileName}", file.Name);
            // Don't update status if cancelled - leave it as is
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error uploading file: {FileName}", file.Name);
            
            // Update status to "Failed" with sanitized error message
            try
            {
                // Sanitize error message - don't expose internal details
                var userFriendlyMessage = "Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇÂ¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠Â≠òÂú®ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ";
                await AnydropService.UpdateAttachmentStatusAsync(attachmentId, Failed, userFriendlyMessage);
                
                // Update in-memory message object
                var messageIndex = messages.FindIndex(m => m.Id == messageId);
                if (messageIndex >= 0 && messages[messageIndex].Attachments != null)
                {
                    var attachment = messages[messageIndex].Attachments.FirstOrDefault(a => a.Id == attachmentId);
                    if (attachment != null)
                    {
                        attachment.UploadStatus = Failed;
                        attachment.UploadErrorMessage = userFriendlyMessage;
                        await InvokeAsync(StateHasChanged);
                    }
                }
            }
            catch (Exception updateEx)
            {
                Logger.LogError(updateEx, "Error updating attachment status to Failed");
            }
        }
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        selectedFiles.AddRange(e.GetMultipleFiles(100));
        StateHasChanged();
    }

    private void OnMediaFilesSelected(InputFileChangeEventArgs e)
    {
        selectedFiles.AddRange(e.GetMultipleFiles(100));
        StateHasChanged();
    }

    private void OnDocumentFilesSelected(InputFileChangeEventArgs e)
    {
        selectedFiles.AddRange(e.GetMultipleFiles(100));
        StateHasChanged();
    }

    private void RemoveFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);
        StateHasChanged();
    }

    private async Task OpenFileDialog()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('fileInput').click()");
    }

    private async Task OpenMediaFileDialog()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('mediaFileInput').click()");
    }

    private async Task OpenDocumentFileDialog()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('documentFileInput').click()");
    }

    private async Task DownloadAttachment(int attachmentId)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("open", $"/api/anydrop/attachment/{attachmentId}/download", "_blank");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading attachment");
        }
    }

    private async Task DeleteMessage(int messageId)
    {
        try
        {
            await AnydropService.DeleteMessageAsync(messageId);
            messages.RemoveAll(m => m.Id == messageId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting message");
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private Icon GetIconForAttachment(AnydropAttachment attachment)
    {
        return attachment.AttachmentType switch
        {
            "Document" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Document(),
            "Audio" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Speaker1(),
            "Video" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Video(),
            "Image" => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Image(),
            _ => new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.DocumentText()
        };
    }

    // Preview Modal Methods
    private void OpenPreviewModal(AnydropAttachment attachment)
    {
        selectedAttachment = attachment;
        showPreviewModal = true;
        StateHasChanged();
    }

    private void ClosePreviewModal()
    {
        showPreviewModal = false;
        selectedAttachment = null;
        StateHasChanged();
    }

    // Search Modal Methods
    private void OpenSearchModal()
    {
        showSearchModal = true;
        modalSearchTerm = string.Empty;
        searchResults.Clear();
        StateHasChanged();
    }

    private void CloseSearchModal()
    {
        showSearchModal = false;
        modalSearchTerm = string.Empty;
        searchResults.Clear();
        StateHasChanged();
    }

    private void OnModalSearchInput(ChangeEventArgs e)
    {
        modalSearchTerm = e.Value?.ToString() ?? string.Empty;
        
        // Dispose existing timer to avoid multiple concurrent searches
        modalSearchDebounceTimer?.Dispose();
        
        if (string.IsNullOrWhiteSpace(modalSearchTerm))
        {
            searchResults.Clear();
            StateHasChanged();
            return;
        }
        
        modalSearchDebounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(PerformModalSearch);
        }, null, 500, Timeout.Infinite);
    }

    private async Task PerformModalSearch()
    {
        if (string.IsNullOrWhiteSpace(modalSearchTerm))
        {
            searchResults.Clear();
            StateHasChanged();
            return;
        }

        isModalSearching = true;
        StateHasChanged();

        try
        {
            searchResults = await AnydropService.SearchMessagesAsync(modalSearchTerm);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching messages in modal");
        }
        finally
        {
            isModalSearching = false;
            StateHasChanged();
        }
    }

    private async Task NavigateToMessage(int messageId)
    {
        // Close search modal
        CloseSearchModal();

        // Switch to "all" tab to show the message
        currentTab = "all";

        // Check if message is already loaded
        var messageExists = messages.Any(m => m.Id == messageId);
        
        if (!messageExists)
        {
            // Load messages including the target message
            // This is a simplified approach - you might need to load more context
            await LoadMessages();
        }

        // Scroll to the message and highlight it
        await Task.Delay(100); // Small delay to ensure DOM is updated
        await JSRuntime.InvokeVoidAsync("eval", 
            $"document.getElementById('message-{messageId}')?.scrollIntoView({{ behavior: 'smooth', block: 'center' }})");
        
        // Add highlight animation
        await JSRuntime.InvokeVoidAsync("eval", 
            $"document.getElementById('message-{messageId}')?.classList.add('highlight')");
        
        // Remove highlight after animation
        await Task.Delay(2000);
        await JSRuntime.InvokeVoidAsync("eval", 
            $"document.getElementById('message-{messageId}')?.classList.remove('highlight')");
    }

    private async Task OpenLinkInNewTab(string url)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("open", url, "_blank");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error opening link: {Url}", url);
        }
    }

    private async Task FetchAndUpdateMetadataAsync(int messageId, string url)
    {
        try
        {
            // Trigger background metadata fetch
            await AnydropService.UpdateLinkMetadataAsync(messageId, url);
            
            // Refresh the message from database to get updated metadata
            var updatedMessage = await AnydropService.GetMessageByIdAsync(messageId);
            if (updatedMessage != null)
            {
                // Find and update the message in the list
                var index = messages.FindIndex(m => m.Id == messageId);
                if (index >= 0)
                {
                    messages[index] = updatedMessage;
                }
            }
            
            // Remove from loading set
            loadingMetadataMessageIds.Remove(messageId);
            
            // Update UI
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching metadata for message {MessageId}", messageId);
            loadingMetadataMessageIds.Remove(messageId);
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private string GetAttachmentStatusClass(AnydropAttachment attachment)
    {
        return attachment.UploadStatus switch
        {
            Uploading => "uploading",
            Pending => "pending",
            Failed => "failed",
            _ => string.Empty
        };
    }
    
    private async Task HandleAttachmentClick(AnydropAttachment attachment)
    {
        // Only allow download/preview for completed uploads
        if (attachment.UploadStatus == Completed)
        {
            await DownloadAttachment(attachment.Id);
        }
    }

    public void Dispose()
    {
        searchDebounceTimer?.Dispose();
        modalSearchDebounceTimer?.Dispose();
        
        // Cancel any ongoing uploads - cancellation tokens will handle cleanup
        _uploadCancellationTokenSource?.Cancel();
        _uploadCancellationTokenSource?.Dispose();
    }
}
