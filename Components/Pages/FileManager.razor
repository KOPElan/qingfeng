@page "/file-manager"
@using QingFeng.Services
@using QingFeng.Models
@inject IFileManagerService FileManagerService
@rendermode InteractiveServer

<PageTitle>文件管理器</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">文件管理器</MudText>

<MudStack Row="true" Class="mb-4">
    <MudButton Variant="Variant.Filled" 
               Color="Color.Primary" 
               StartIcon="@Icons.Material.Filled.Refresh" 
               OnClick="RefreshFiles">
        刷新
    </MudButton>
    <MudButton Variant="Variant.Filled" 
               Color="Color.Secondary" 
               StartIcon="@Icons.Material.Filled.ArrowUpward" 
               OnClick="GoUp">
        上级目录
    </MudButton>
    <MudButton Variant="Variant.Filled" 
               Color="Color.Success" 
               StartIcon="@Icons.Material.Filled.CreateNewFolder" 
               OnClick="@(() => showCreateDialog = true)">
        新建文件夹
    </MudButton>
</MudStack>

@if (!string.IsNullOrEmpty(message))
{
    <MudAlert Severity="@(isError ? Severity.Error : Severity.Success)" 
              Class="mb-4" 
              CloseIconClicked="@(() => message = string.Empty)">
        @message
    </MudAlert>
}

<!-- Current Path -->
<MudPaper Elevation="1" Class="pa-3 mb-4">
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudIcon Icon="@Icons.Material.Filled.Folder" />
        <MudText Typo="Typo.body1"><strong>当前路径：</strong>@currentPath</MudText>
    </MudStack>
</MudPaper>

<!-- File List -->
<MudPaper Elevation="2" Class="pa-4">
    @if (files != null && files.Any())
    {
        <MudTable Items="@files" Hover="true" Dense="false" FixedHeader="true" Height="600px">
            <HeaderContent>
                <MudTh>名称</MudTh>
                <MudTh>类型</MudTh>
                <MudTh>大小</MudTh>
                <MudTh>修改时间</MudTh>
                <MudTh>操作</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="名称">
                    @if (context.IsDirectory)
                    {
                        <MudLink OnClick="@(() => NavigateTo(context.Path))" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Warning" Class="mr-2" />
                            @context.Name
                        </MudLink>
                    }
                    else
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Color="Color.Info" />
                            <MudText>@context.Name</MudText>
                        </MudStack>
                    }
                </MudTd>
                <MudTd DataLabel="类型">
                    <MudChip T="string" Size="Size.Small" 
                            Color="@(context.IsDirectory ? Color.Warning : Color.Info)" 
                            Variant="Variant.Outlined">
                        @(context.IsDirectory ? "文件夹" : "文件")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="大小">@context.SizeDisplay</MudTd>
                <MudTd DataLabel="修改时间">@context.LastModified.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
                <MudTd DataLabel="操作">
                    @if (context.Name != "..")
                    {
                        @if (!context.IsDirectory)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                          Color="Color.Error" 
                                          Size="Size.Small"
                                          OnClick="@(() => DeleteFile(context.Path))" />
                        }
                        else
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                          Color="Color.Error" 
                                          Size="Size.Small"
                                          OnClick="@(() => DeleteDirectory(context.Path))" />
                        }
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else if (files == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Class="ml-2">加载中...</MudText>
    }
    else
    {
        <MudText Color="Color.Secondary">此目录为空</MudText>
    }
</MudPaper>

<!-- Create Directory Dialog -->
<MudDialog @bind-Visible="showCreateDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CreateNewFolder" Class="mr-2" />
            新建文件夹
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="newFolderName" 
                     Label="文件夹名称" 
                     Variant="Variant.Outlined"
                     Placeholder="输入文件夹名称"
                     HelperText="请输入要创建的文件夹名称" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showCreateDialog = false)">取消</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateDirectory">创建</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<FileItemInfo>? files;
    private string currentPath = string.Empty;
    private string message = string.Empty;
    private bool isError = false;
    private bool showCreateDialog = false;
    private string newFolderName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Start at user's home directory or root
        if (OperatingSystem.IsWindows())
        {
            currentPath = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        }
        else
        {
            currentPath = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        }
        
        await RefreshFiles();
    }

    private async Task RefreshFiles()
    {
        try
        {
            files = await FileManagerService.GetFilesAsync(currentPath);
            message = string.Empty;
        }
        catch (Exception ex)
        {
            message = $"加载文件列表失败: {ex.Message}";
            isError = true;
        }
    }

    private async Task NavigateTo(string path)
    {
        currentPath = path;
        await RefreshFiles();
    }

    private async Task GoUp()
    {
        var parent = FileManagerService.GetParentPath(currentPath);
        if (!string.IsNullOrEmpty(parent) && parent != currentPath)
        {
            currentPath = parent;
            await RefreshFiles();
        }
    }

    private async Task DeleteFile(string path)
    {
        try
        {
            await FileManagerService.DeleteFileAsync(path);
            message = "文件已删除";
            isError = false;
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            message = $"删除文件失败: {ex.Message}";
            isError = true;
        }
    }

    private async Task DeleteDirectory(string path)
    {
        try
        {
            await FileManagerService.DeleteDirectoryAsync(path);
            message = "文件夹已删除";
            isError = false;
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            message = $"删除文件夹失败: {ex.Message}";
            isError = true;
        }
    }

    private async Task CreateDirectory()
    {
        if (string.IsNullOrWhiteSpace(newFolderName))
        {
            message = "请输入文件夹名称";
            isError = true;
            return;
        }

        try
        {
            var newPath = Path.Combine(currentPath, newFolderName);
            await FileManagerService.CreateDirectoryAsync(newPath);
            message = "文件夹已创建";
            isError = false;
            showCreateDialog = false;
            newFolderName = string.Empty;
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            message = $"创建文件夹失败: {ex.Message}";
            isError = true;
        }
    }
}
