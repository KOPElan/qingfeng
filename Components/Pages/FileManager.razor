@page "/file-manager"
@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Utilities
@using Microsoft.AspNetCore.Components.Forms
@inject IFileManagerService FileManagerService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>文件管理器</PageTitle>

<style>
    .file-manager-container {
        display: flex;
        height: calc(100vh - 180px);
        gap: 0;
    }
    
    .sidebar {
        width: 220px;
        background-color: var(--mud-palette-background);
        border-right: 1px solid var(--mud-palette-divider);
        overflow-y: auto;
        flex-shrink: 0;
    }
    
    .sidebar-section {
        padding: 16px 8px 8px 8px;
    }
    
    .sidebar-title {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        padding: 4px 12px;
        margin-bottom: 4px;
        font-weight: 500;
    }
    
    .sidebar-item {
        padding: 8px 12px;
        margin: 2px 4px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .sidebar-item:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    
    .sidebar-item.selected {
        background-color: var(--mud-palette-primary);
        color: white;
    }
    
    .sidebar-item .mud-icon-root {
        font-size: 20px;
    }
    
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .toolbar {
        padding: 12px 24px;
        border-bottom: 1px solid var(--mud-palette-divider);
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: var(--mud-palette-surface);
    }
    
    .breadcrumb-container {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }
    
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
    }
    
    .file-count {
        font-size: 13px;
        color: var(--mud-palette-text-secondary);
        margin-left: 8px;
    }
    
    .file-grid {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 20px;
        align-content: start;
    }
    
    .file-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .file-item:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    
    .folder-icon {
        font-size: 80px !important;
        color: #FFA726;
        margin-bottom: 8px;
    }
    
    .file-icon {
        font-size: 80px !important;
        color: #42A5F5;
        margin-bottom: 8px;
    }
    
    .file-name {
        font-size: 13px;
        text-align: center;
        word-break: break-word;
        margin-bottom: 4px;
    }
    
    .file-date {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
    }
    
    .status-bar {
        padding: 8px 24px;
        border-top: 1px solid var(--mud-palette-divider);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        background-color: var(--mud-palette-surface);
    }
    
    .path-display {
        color: var(--mud-palette-text-secondary);
    }
    
    .storage-info {
        color: var(--mud-palette-text-secondary);
    }
</style>

<div class="file-manager-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <!-- Shortcuts Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">收藏</div>
            @if (shortcuts != null)
            {
                @foreach (var shortcut in shortcuts)
                {
                    <div class="sidebar-item @(currentPath == shortcut.Path ? "selected" : "")" 
                         @onclick="@(() => NavigateTo(shortcut.Path))">
                        <i class="@GetShortcutIcon(shortcut.Type)"></i>
                        <span>@shortcut.Name</span>
                    </div>
                }
            }
        </div>
        
        <!-- Drives Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">存储</div>
            @if (drives != null)
            {
                @foreach (var drive in drives)
                {
                    <div class="sidebar-item @(currentPath == drive.Path || currentPath.StartsWith(drive.Path) ? "selected" : "")" 
                         @onclick="@(() => NavigateTo(drive.Path))">
                        <i class="@Icons.Material.Filled.Storage"></i>
                        <span>@drive.Name</span>
                    </div>
                }
            }
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Notification Area -->
        @if (!string.IsNullOrEmpty(notificationMessage))
        {
            <div class="alert @(notificationIsError ? "alert-danger" : "alert-success") alert-dismissible fade show m-3" role="alert">
                @notificationMessage
                <button type="button" class="btn-close" @onclick="ClearNotification" aria-label="Close"></button>
            </div>
        }
        
        <!-- Toolbar -->
        <div class="toolbar">
            <button type="button" class="btn btn-link text-white" @onclick="GoBack" disabled="@(navigationHistory.Count <= 1)">
                <i class="@Icons.Material.Filled.ArrowBack"></i>
            </button>
            <button type="button" class="btn btn-link text-white" @onclick="GoForward" disabled="@(forwardHistory.Count == 0)">
                <i class="@Icons.Material.Filled.ArrowForward"></i>
            </button>
            
            <div class="breadcrumb-container">
                <div class="breadcrumb">
                    <p class="small">Files</p>
                    @foreach (var part in GetPathParts())
                    {
                        <i class="@Icons.Material.Filled.ChevronRight"></i>
                        <a class="clickable" @onclick="(() => NavigateTo(part.Path))">@part.Name</a>
                    }
                </div>
                @if (files != null)
                {
                    <span class="file-count">@files.Count 项</span>
                }
            </div>
            
            <button type="button" class="btn btn-link text-white" @onclick="ShowUploadDialog" title="上传文件">
                <i class="@Icons.Material.Filled.Upload"></i>
            </button>
            <button type="button" class="btn btn-link text-white" @onclick="ShowCreateFolderDialog" title="新建文件夹">
                <i class="@Icons.Material.Filled.CreateNewFolder"></i>
            </button>
            <button type="button" class="btn btn-link text-white" @onclick="ShowSearchDialog" title="搜索">
                <i class="@Icons.Material.Filled.Search"></i>
            </button>
            <button type="button" class="btn btn-link text-white" @onclick="RefreshFiles" title="刷新">
                <i class="@Icons.Material.Filled.Refresh"></i>
            </button>
            <button type="button" class="btn btn-link text-white" @onclick="ToggleViewMode" title="切换视图">
                <i class="@(isGridView ? Icons.Material.Filled.ViewList : Icons.Material.Filled.ViewModule)"></i>
            </button>
        </div>
        
        <!-- File Grid View -->
        @if (isGridView)
        {
            <div class="file-grid">
                @if (files != null && files.Any())
                {
                    @foreach (var file in files.Where(f => f.Name != ".."))
                    {
                        <div class="file-item" @onclick="@(() => NavigateTo(file.Path))" title="@file.Path">
                            @if (file.IsDirectory)
                            {
                                <i class="@Icons.Material.Filled.Folder folder-icon"></i>
                            }
                            else
                            {
                                <i class="@GetFileIcon(file.Extension) file-icon"></i>
                            }
                            <div class="file-name">@file.Name</div>
                            @if (!file.IsDirectory)
                            {
                                <div class="file-date">@file.SizeDisplay</div>
                            }
                            <div class="file-date">@file.LastModified.ToString("dd/MM HH:mm")</div>
                        </div>
                    }
                }
                else if (files == null)
                {
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                }
            </div>
        }
        else
        {
            <!-- List View -->
            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                @if (files != null && files.Any())
                {
                    <table class="table table-custom">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>大小</th>
                                <th>修改时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var file in files)
                            {
                                <tr>
                                    <td>
                                        @if (file.IsDirectory)
                                        {
                                            <a @onclick="(() => NavigateTo(file.Path))" style="cursor: pointer;">
                                                <i class="@Icons.Material.Filled.Folder me-2"></i>
                                                @file.Name
                                            </a>
                                        }
                                        else
                                        {
                                            <div class="d-flex align-items-center" style="cursor: pointer;" @onclick="(() => NavigateTo(file.Path))">
                                                <i class="@GetFileIcon(file.Extension) me-2"></i>
                                                <span>@file.Name</span>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @(file.IsDirectory ? "badge-warning" : "badge-info")">
                                            @(file.IsDirectory ? "文件夹" : "文件")
                                        </span>
                                    </td>
                                    <td>@file.SizeDisplay</td>
                                    <td>@file.LastModified.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                    <td>
                                        @if (!file.IsDirectory && file.Name != "..")
                                        {
                                            <button type="button" class="btn btn-sm btn-link text-white" @onclick="(() => DownloadFile(file.Path))" title="下载">
                                                <i class="@Icons.Material.Filled.Download"></i>
                                            </button>
                                        }
                                        @if (file.Name != "..")
                                        {
                                            <button type="button" class="btn btn-sm btn-link text-white" @onclick="(() => ShowRenameDialog(file))" title="重命名">
                                                <i class="@Icons.Material.Filled.Edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-link text-white" @onclick="(() => ShowCopyDialog(file))" title="复制">
                                                <i class="@Icons.Material.Filled.ContentCopy"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-link text-white" @onclick="(() => ShowMoveDialog(file))" title="移动">
                                                <i class="@Icons.Material.Filled.DriveFileMove"></i>
                                            </button>
                                        }
                                        @if (!file.IsDirectory && file.Name != "..")
                                        {
                                            <button type="button" class="btn btn-sm btn-link text-danger" @onclick="(() => DeleteFile(file.Path))" title="删除">
                                                <i class="@Icons.Material.Filled.Delete"></i>
                                            </button>
                                        }
                                        @if (file.IsDirectory && file.Name != "..")
                                        {
                                            <button type="button" class="btn btn-sm btn-link text-danger" @onclick="(() => DeleteDirectory(file.Path))" title="删除">
                                                <i class="@Icons.Material.Filled.Delete"></i>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else if (files == null)
                {
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <p class="ml-2">加载中...</p>
                }
                else
                {
                    <p>此目录为空</p>
                }
            </div>
        }
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="path-display">
                <i class="@Icons.Material.Filled.Edit"></i>
                @GetSimplifiedPath()
            </div>
            <div class="storage-info">
                @if (storageTotal > 0)
                {
                    <span>@FileUtilities.FormatSize(storageAvailable) 可用/@FileUtilities.FormatSize(storageTotal)</span>
                }
            </div>
        </div>
    </div>
</div>

<!-- Upload File Dialog -->
@if (showUploadDialog)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h6>上传文件</h6>
                </div>
                <div class="modal-body-custom">
                    <label class="form-label">选择文件</label>
                    <InputFile OnChange="HandleFileUpload" class="form-control-custom" multiple />
                    @if (!string.IsNullOrEmpty(uploadMessage))
                    {
                        <div class="alert @(uploadSuccess ? "alert-success" : "alert-danger") mt-3">
                            @uploadMessage
                        </div>
                    }
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-custom" @onclick="CloseUploadDialog">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Create Folder Dialog -->
@if (showCreateFolderDialog)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h6>新建文件夹</h6>
                </div>
                <div class="modal-body-custom">
                    <label class="form-label">文件夹名称</label>
                    <input type="text" class="form-control-custom" @bind="newFolderName" placeholder="输入文件夹名称" />
                    @if (!string.IsNullOrEmpty(createFolderMessage))
                    {
                        <div class="alert @(createFolderSuccess ? "alert-success" : "alert-danger") mt-3">
                            @createFolderMessage
                        </div>
                    }
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-custom" @onclick="CloseCreateFolderDialog">取消</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="CreateFolder">创建</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Rename Dialog -->
@if (showRenameDialog)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h6>重命名</h6>
                </div>
                <div class="modal-body-custom">
                    <label class="form-label">新名称</label>
                    <input type="text" class="form-control-custom" @bind="renameNewName" placeholder="输入新名称" />
                    @if (!string.IsNullOrEmpty(renameMessage))
                    {
                        <div class="alert @(renameSuccess ? "alert-success" : "alert-danger") mt-3">
                            @renameMessage
                        </div>
                    }
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-custom" @onclick="CloseRenameDialog">取消</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="RenameItem">重命名</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Copy Dialog -->
@if (showCopyDialog)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h6>复制</h6>
                </div>
                <div class="modal-body-custom">
                    <label class="form-label">目标路径</label>
                    <input type="text" class="form-control-custom" @bind="copyDestination" placeholder="输入目标路径" />
                    @if (!string.IsNullOrEmpty(copyMessage))
                    {
                        <div class="alert @(copySuccess ? "alert-success" : "alert-danger") mt-3">
                            @copyMessage
                        </div>
                    }
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-custom" @onclick="CloseCopyDialog">取消</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="CopyItem">复制</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Move Dialog -->
@if (showMoveDialog)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h6>移动</h6>
                </div>
                <div class="modal-body-custom">
                    <label class="form-label">目标路径</label>
                    <input type="text" class="form-control-custom" @bind="moveDestination" placeholder="输入目标路径" />
                    @if (!string.IsNullOrEmpty(moveMessage))
                    {
                        <div class="alert @(moveSuccess ? "alert-success" : "alert-danger") mt-3">
                            @moveMessage
                        </div>
                    }
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-custom" @onclick="CloseMoveDialog">取消</button>
                    <button type="button" class="btn btn-custom-primary" @onclick="MoveItem">移动</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- Search Dialog -->
@if (showSearchDialog)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h6>搜索文件</h6>
                </div>
                <div class="modal-body-custom">
                    <div class="mb-3">
                        <label class="form-label">搜索关键词</label>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control-custom flex-grow-1" @bind="searchPattern" placeholder="输入文件名或模式，如 *.txt" />
                            <button type="button" class="btn btn-custom-primary" @onclick="SearchFiles">搜索</button>
                        </div>
                    </div>
                    @if (searchResults != null && searchResults.Any())
                    {
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>名称</th>
                                        <th>路径</th>
                                        <th>类型</th>
                                        <th>大小</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var result in searchResults)
                                    {
                                        <tr style="cursor: pointer;" @onclick="(() => NavigateToSearchResult(result))">
                                            <td>
                                                <i class="@(result.IsDirectory ? Icons.Material.Filled.Folder : Icons.Material.Filled.InsertDriveFile) me-2"></i>
                                                @result.Name
                                            </td>
                                            <td>@result.Path</td>
                                            <td>@(result.IsDirectory ? "文件夹" : "文件")</td>
                                            <td>@result.SizeDisplay</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    @if (searchResults != null && !searchResults.Any())
                    {
                        <div class="alert alert-info">未找到匹配的文件</div>
                    }
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-custom" @onclick="CloseSearchDialog">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- File Preview Dialog -->
@if (showPreviewDialog)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h6>文件预览: @previewFileName</h6>
                </div>
                <div class="modal-body-custom">
                    @if (previewIsImage)
                    {
                        <div style="text-align: center;">
                            <img src="@previewImageUrl" alt="@previewFileName" style="max-width: 100%; max-height: 600px;" />
                        </div>
                    }
                    else if (previewIsText)
                    {
                        <div style="max-height: 600px; overflow-y: auto;">
                            <pre style="background-color: var(--mud-palette-background); padding: 16px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word;">@previewTextContent</pre>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">此文件类型暂不支持预览</div>
                    }
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-custom-primary" @onclick="(() => DownloadFile(previewFilePath))">下载</button>
                    <button type="button" class="btn btn-custom" @onclick="ClosePreviewDialog">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<FileItemInfo>? files;
    private List<DriveItemInfo>? drives;
    private List<ShortcutItemInfo>? shortcuts;
    private string currentPath = string.Empty;
    private bool isGridView = true;
    private long storageTotal = 0;
    private long storageAvailable = 0;
    
    private Stack<string> navigationHistory = new Stack<string>();
    private Stack<string> forwardHistory = new Stack<string>();

    // Dialog states
    private bool showUploadDialog = false;
    private bool showCreateFolderDialog = false;
    private bool showRenameDialog = false;
    private bool showCopyDialog = false;
    private bool showMoveDialog = false;
    private bool showSearchDialog = false;
    private bool showPreviewDialog = false;

    // Dialog data
    private string newFolderName = string.Empty;
    private string renameNewName = string.Empty;
    private FileItemInfo? renameItem = null;
    private string copyDestination = string.Empty;
    private FileItemInfo? copyItem = null;
    private string moveDestination = string.Empty;
    private FileItemInfo? moveItem = null;
    private string searchPattern = string.Empty;
    private List<FileItemInfo>? searchResults = null;
    private string previewFilePath = string.Empty;
    private string previewFileName = string.Empty;
    private string previewImageUrl = string.Empty;
    private string previewTextContent = string.Empty;
    private bool previewIsImage = false;
    private bool previewIsText = false;

    // Messages
    private string uploadMessage = string.Empty;
    private bool uploadSuccess = false;
    private string createFolderMessage = string.Empty;
    private bool createFolderSuccess = false;
    private string renameMessage = string.Empty;
    private bool renameSuccess = false;
    private string copyMessage = string.Empty;
    private bool copySuccess = false;
    private string moveMessage = string.Empty;
    private bool moveSuccess = false;
    private string notificationMessage = string.Empty;
    private bool notificationIsError = false;

    protected override async Task OnInitializedAsync()
    {
        // Load drives and shortcuts
        drives = await FileManagerService.GetDrivesAsync();
        shortcuts = await FileManagerService.GetShortcutsAsync();
        
        // Start at user's home directory or first drive
        if (drives != null && drives.Any())
        {
            currentPath = drives.First().Path;
        }
        else if (OperatingSystem.IsWindows())
        {
            currentPath = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        }
        else
        {
            currentPath = "/";
        }
        
        navigationHistory.Push(currentPath);
        await RefreshFiles();
    }

    private async Task RefreshFiles()
    {
        try
        {
            files = await FileManagerService.GetFilesAsync(currentPath);
            var storage = await FileManagerService.GetStorageInfoAsync(currentPath);
            storageTotal = storage.total;
            storageAvailable = storage.available;
        }
        catch (Exception ex)
        {
            ShowNotification($"加载文件列表失败: {ex.Message}", true);
        }
    }

    private void ShowNotification(string message, bool isError = false)
    {
        notificationMessage = message;
        notificationIsError = isError;
        StateHasChanged();
    }

    private void ClearNotification()
    {
        notificationMessage = string.Empty;
        notificationIsError = false;
    }

    private async Task NavigateTo(string path)
    {
        if (Directory.Exists(path))
        {
            // Add current path to history if it's different
            if (currentPath != path)
            {
                navigationHistory.Push(currentPath);
                forwardHistory.Clear(); // Clear forward history on new navigation
            }
            
            currentPath = path;
            await RefreshFiles();
        }
        else if (File.Exists(path))
        {
            // Handle file click - show preview for supported file types
            var extension = Path.GetExtension(path).ToLowerInvariant();
            if (IsPreviewableFile(extension))
            {
                await ShowFilePreview(path);
            }
            else
            {
                // Download non-previewable files
                await DownloadFile(path);
            }
        }
    }

    private async Task GoBack()
    {
        if (navigationHistory.Count > 1)
        {
            forwardHistory.Push(currentPath);
            navigationHistory.Pop(); // Remove current
            currentPath = navigationHistory.Peek(); // Go to previous
            await RefreshFiles();
        }
    }

    private async Task GoForward()
    {
        if (forwardHistory.Count > 0)
        {
            navigationHistory.Push(currentPath);
            currentPath = forwardHistory.Pop();
            await RefreshFiles();
        }
    }

    private void ToggleViewMode()
    {
        isGridView = !isGridView;
    }

    private async Task DeleteFile(string path)
    {
        try
        {
            await FileManagerService.DeleteFileAsync(path);
            ShowNotification($"文件已删除: {Path.GetFileName(path)}", false);
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            ShowNotification($"删除文件失败: {ex.Message}", true);
        }
    }

    private async Task DeleteDirectory(string path)
    {
        try
        {
            await FileManagerService.DeleteDirectoryAsync(path);
            ShowNotification($"文件夹已删除: {Path.GetFileName(path)}", false);
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            ShowNotification($"删除文件夹失败: {ex.Message}", true);
        }
    }

    private List<(string Name, string Path)> GetPathParts()
    {
        var parts = new List<(string Name, string Path)>();
        
        if (string.IsNullOrEmpty(currentPath))
            return parts;
        
        var path = currentPath;
        var pathSegments = new List<string>();
        
        // Split path into segments
        while (!string.IsNullOrEmpty(path))
        {
            var dirInfo = new DirectoryInfo(path);
            if (dirInfo.Parent == null)
            {
                pathSegments.Insert(0, path);
                break;
            }
            pathSegments.Insert(0, dirInfo.Name);
            path = dirInfo.Parent.FullName;
        }
        
        // Build path parts
        var currentBuild = "";
        foreach (var segment in pathSegments)
        {
            if (string.IsNullOrEmpty(currentBuild))
            {
                currentBuild = segment;
            }
            else
            {
                currentBuild = Path.Combine(currentBuild, segment);
            }
            parts.Add((segment, currentBuild));
        }
        
        return parts;
    }

    private string GetSimplifiedPath()
    {
        if (string.IsNullOrEmpty(currentPath))
            return "/";
        
        var parts = currentPath.Split(Path.DirectorySeparatorChar, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length <= 3)
            return $"/ {string.Join(" / ", parts)}";
        
        return $"/ {parts[0]} / ... / {parts[parts.Length - 1]}";
    }

    private string GetShortcutIcon(string type)
    {
        return type switch
        {
            "documents" => Icons.Material.Filled.Description,
            "downloads" => Icons.Material.Filled.Download,
            "gallery" => Icons.Material.Filled.PhotoLibrary,
            "media" => Icons.Material.Filled.Movie,
            "backup" => Icons.Material.Filled.Backup,
            _ => Icons.Material.Filled.Folder
        };
    }

    private string GetFileIcon(string extension)
    {
        return extension.ToLowerInvariant() switch
        {
            ".pdf" => Icons.Material.Filled.PictureAsPdf,
            ".doc" or ".docx" => Icons.Material.Filled.Description,
            ".xls" or ".xlsx" => Icons.Material.Filled.TableChart,
            ".txt" or ".log" => Icons.Material.Filled.Description,
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".svg" or ".webp" => Icons.Material.Filled.Image,
            ".mp3" or ".wav" or ".flac" => Icons.Material.Filled.AudioFile,
            ".mp4" or ".avi" or ".mkv" or ".mov" => Icons.Material.Filled.VideoFile,
            ".zip" or ".rar" or ".7z" or ".tar" or ".gz" => Icons.Material.Filled.Archive,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    // File operation methods
    private async Task DownloadFile(string filePath)
    {
        try
        {
            var encodedPath = Uri.EscapeDataString(filePath);
            var downloadUrl = $"/api/files/download?path={encodedPath}";
            
            // Trigger download using JavaScript
            await JSRuntime.InvokeVoidAsync("open", downloadUrl, "_blank");
            ShowNotification($"开始下载: {Path.GetFileName(filePath)}", false);
        }
        catch (Exception ex)
        {
            ShowNotification($"下载文件失败: {ex.Message}", true);
        }
    }

    // Dialog methods
    private void ShowUploadDialog()
    {
        showUploadDialog = true;
        uploadMessage = string.Empty;
        uploadSuccess = false;
    }

    private void CloseUploadDialog()
    {
        showUploadDialog = false;
        uploadMessage = string.Empty;
        uploadSuccess = false;
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            uploadMessage = string.Empty;
            var uploadResults = new System.Text.StringBuilder();
            var successCount = 0;
            var failCount = 0;
            
            foreach (var file in e.GetMultipleFiles())
            {
                try
                {
                    using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 100); // 100MB max
                    using var memoryStream = new MemoryStream();
                    await stream.CopyToAsync(memoryStream);
                    var buffer = memoryStream.ToArray();
                    
                    await FileManagerService.UploadFileAsync(currentPath, file.Name, buffer);
                    uploadResults.AppendLine($"成功上传: {file.Name}");
                    successCount++;
                }
                catch (Exception ex)
                {
                    uploadResults.AppendLine($"上传失败 {file.Name}: {ex.Message}");
                    failCount++;
                }
            }
            
            uploadMessage = uploadResults.ToString();
            uploadSuccess = failCount == 0; // Only success if all files uploaded
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            uploadMessage = $"上传失败: {ex.Message}";
            uploadSuccess = false;
        }
    }

    private void ShowCreateFolderDialog()
    {
        showCreateFolderDialog = true;
        newFolderName = string.Empty;
        createFolderMessage = string.Empty;
        createFolderSuccess = false;
    }

    private void CloseCreateFolderDialog()
    {
        showCreateFolderDialog = false;
        newFolderName = string.Empty;
        createFolderMessage = string.Empty;
        createFolderSuccess = false;
    }

    private async Task CreateFolder()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(newFolderName))
            {
                createFolderMessage = "请输入文件夹名称";
                createFolderSuccess = false;
                return;
            }

            var folderPath = Path.Combine(currentPath, newFolderName);
            await FileManagerService.CreateDirectoryAsync(folderPath);
            
            createFolderMessage = "文件夹创建成功";
            createFolderSuccess = true;
            
            // Refresh files list separately to avoid overwriting success message
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - folder was created successfully
            }
            
            CloseCreateFolderDialog();
        }
        catch (Exception ex)
        {
            createFolderMessage = $"创建文件夹失败: {ex.Message}";
            createFolderSuccess = false;
        }
    }

    private void ShowRenameDialog(FileItemInfo item)
    {
        showRenameDialog = true;
        renameItem = item;
        renameNewName = item.Name;
        renameMessage = string.Empty;
        renameSuccess = false;
    }

    private void CloseRenameDialog()
    {
        showRenameDialog = false;
        renameItem = null;
        renameNewName = string.Empty;
        renameMessage = string.Empty;
        renameSuccess = false;
    }

    private async Task RenameItem()
    {
        try
        {
            if (renameItem == null || string.IsNullOrWhiteSpace(renameNewName))
            {
                renameMessage = "请输入新名称";
                renameSuccess = false;
                return;
            }

            var newPath = Path.Combine(Path.GetDirectoryName(renameItem.Path) ?? currentPath, renameNewName);
            await FileManagerService.RenameAsync(renameItem.Path, newPath);
            
            renameMessage = "重命名成功";
            renameSuccess = true;
            
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - rename was successful
            }
            
            CloseRenameDialog();
        }
        catch (Exception ex)
        {
            renameMessage = $"重命名失败: {ex.Message}";
            renameSuccess = false;
        }
    }

    private void ShowCopyDialog(FileItemInfo item)
    {
        showCopyDialog = true;
        copyItem = item;
        copyDestination = string.Empty; // Empty by default to avoid confusion
        copyMessage = string.Empty;
        copySuccess = false;
    }

    private void CloseCopyDialog()
    {
        showCopyDialog = false;
        copyItem = null;
        copyDestination = string.Empty;
        copyMessage = string.Empty;
        copySuccess = false;
    }

    private async Task CopyItem()
    {
        try
        {
            if (copyItem == null || string.IsNullOrWhiteSpace(copyDestination))
            {
                copyMessage = "请输入目标路径";
                copySuccess = false;
                return;
            }

            var destPath = Path.Combine(copyDestination, copyItem.Name);
            await FileManagerService.CopyAsync(copyItem.Path, destPath);
            
            copyMessage = "复制成功";
            copySuccess = true;
            
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - copy was successful
            }
            
            CloseCopyDialog();
        }
        catch (Exception ex)
        {
            copyMessage = $"复制失败: {ex.Message}";
            copySuccess = false;
        }
    }

    private void ShowMoveDialog(FileItemInfo item)
    {
        showMoveDialog = true;
        moveItem = item;
        moveDestination = string.Empty; // Empty by default to avoid confusion
        moveMessage = string.Empty;
        moveSuccess = false;
    }

    private void CloseMoveDialog()
    {
        showMoveDialog = false;
        moveItem = null;
        moveDestination = string.Empty;
        moveMessage = string.Empty;
        moveSuccess = false;
    }

    private async Task MoveItem()
    {
        try
        {
            if (moveItem == null || string.IsNullOrWhiteSpace(moveDestination))
            {
                moveMessage = "请输入目标路径";
                moveSuccess = false;
                return;
            }

            var destPath = Path.Combine(moveDestination, moveItem.Name);
            await FileManagerService.MoveAsync(moveItem.Path, destPath);
            
            moveMessage = "移动成功";
            moveSuccess = true;
            
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - move was successful
            }
            
            CloseMoveDialog();
        }
        catch (Exception ex)
        {
            moveMessage = $"移动失败: {ex.Message}";
            moveSuccess = false;
        }
    }

    private void ShowSearchDialog()
    {
        showSearchDialog = true;
        searchPattern = string.Empty;
        searchResults = null;
    }

    private void CloseSearchDialog()
    {
        showSearchDialog = false;
        searchPattern = string.Empty;
        searchResults = null;
    }

    private async Task SearchFiles()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(searchPattern))
            {
                ShowNotification("请输入搜索内容", true);
                return;
            }

            searchResults = await FileManagerService.SearchFilesAsync(currentPath, searchPattern);
            
            // Warn if large number of results
            if (searchResults.Count > 1000)
            {
                ShowNotification($"找到 {searchResults.Count} 个结果，显示可能较慢", false);
            }
        }
        catch (Exception ex)
        {
            ShowNotification($"搜索失败: {ex.Message}", true);
            searchResults = new List<FileItemInfo>();
        }
    }

    private async Task NavigateToSearchResult(FileItemInfo result)
    {
        CloseSearchDialog();
        
        if (result.IsDirectory)
        {
            await NavigateTo(result.Path);
        }
        else
        {
            var directory = Path.GetDirectoryName(result.Path);
            if (!string.IsNullOrEmpty(directory))
            {
                await NavigateTo(directory);
            }
        }
    }

    private bool IsPreviewableFile(string extension)
    {
        var imageExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".svg", ".webp" };
        var textExtensions = new[] { ".txt", ".log", ".md", ".json", ".xml", ".csv", ".html", ".css", ".js", ".cs", ".razor", ".sh", ".conf", ".config", ".yml", ".yaml" };
        
        return imageExtensions.Contains(extension) || textExtensions.Contains(extension);
    }

    private async Task ShowFilePreview(string filePath)
    {
        try
        {
            previewFilePath = filePath;
            previewFileName = Path.GetFileName(filePath);
            var extension = Path.GetExtension(filePath).ToLowerInvariant();
            
            var imageExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".svg", ".webp" };
            var textExtensions = new[] { ".txt", ".log", ".md", ".json", ".xml", ".csv", ".html", ".css", ".js", ".cs", ".razor", ".sh", ".conf", ".config", ".yml", ".yaml" };
            
            previewIsImage = imageExtensions.Contains(extension);
            previewIsText = textExtensions.Contains(extension);
            
            if (previewIsImage)
            {
                var encodedPath = Uri.EscapeDataString(filePath);
                previewImageUrl = $"/api/files/download?path={encodedPath}";
            }
            else if (previewIsText)
            {
                // Read text content (limit to 1MB for preview)
                var fileInfo = new FileInfo(filePath);
                if (fileInfo.Length > 1024 * 1024)
                {
                    previewTextContent = "文件太大，无法预览。请下载文件查看。";
                }
                else
                {
                    var bytes = await FileManagerService.ReadFileAsync(filePath);
                    try
                    {
                        var utf8 = new System.Text.UTF8Encoding(encoderShouldEmitUTF8Identifier: false, throwOnInvalidBytes: true);
                        previewTextContent = utf8.GetString(bytes);
                    }
                    catch (System.Text.DecoderFallbackException)
                    {
                        previewTextContent = "无法以 UTF-8 解码该文件内容，请下载后使用合适的程序打开。";
                    }
                }
            }
            
            showPreviewDialog = true;
        }
        catch (Exception ex)
        {
            ShowNotification($"预览文件失败: {ex.Message}", true);
        }
    }

    private void ClosePreviewDialog()
    {
        showPreviewDialog = false;
        previewFilePath = string.Empty;
        previewFileName = string.Empty;
        previewImageUrl = string.Empty;
        previewTextContent = string.Empty;
        previewIsImage = false;
        previewIsText = false;
    }
}
