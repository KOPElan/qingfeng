@page "/file-manager"
@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Utilities
@using Microsoft.AspNetCore.Components.Forms
@inject IFileManagerService FileManagerService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>文件管理器</PageTitle>

<style>
    .file-manager-container {
        display: flex;
        height: calc(100vh - 180px);
        gap: 0;
    }
    
    .sidebar {
        width: 220px;
        background-color: var(--neutral-layer-1);
        border-right: 1px solid var(--neutral-stroke-divider-rest);
        overflow-y: auto;
        flex-shrink: 0;
    }
    
    .sidebar-section {
        padding: 16px 8px 8px 8px;
    }
    
    .sidebar-title {
        font-size: 12px;
        color: var(--neutral-foreground-hint);
        padding: 4px 12px;
        margin-bottom: 4px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .sidebar-item {
        padding: 8px 12px;
        margin: 2px 4px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .sidebar-item:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
    
    .sidebar-item.selected {
        background-color: var(--accent-fill-rest);
        color: white;
    }
    
    .sidebar-item i {
        font-size: 20px;
    }
    
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .toolbar {
        padding: 12px 24px;
        border-bottom: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: var(--neutral-layer-2);
    }
    
    .breadcrumb-container {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }
    
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
    }
    
    .breadcrumb-link {
        cursor: pointer;
        text-decoration: none;
        color: var(--accent-fill-rest);
    }
    
    .breadcrumb-link:hover {
        text-decoration: underline;
    }
    
    .file-count {
        font-size: 13px;
        color: var(--neutral-foreground-hint);
        margin-left: 8px;
    }
    
    .file-grid {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 20px;
        align-content: start;
    }
    
    .file-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .file-item:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
    
    .folder-icon {
        font-size: 80px !important;
        color: #FFA726;
        margin-bottom: 8px;
    }
    
    .file-icon {
        font-size: 80px !important;
        color: #42A5F5;
        margin-bottom: 8px;
    }
    
    .file-name {
        font-size: 13px;
        text-align: center;
        word-break: break-word;
        margin-bottom: 4px;
    }
    
    .file-date {
        font-size: 11px;
        color: var(--neutral-foreground-hint);
    }
    
    .status-bar {
        padding: 8px 24px;
        border-top: 1px solid var(--neutral-stroke-divider-rest);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        background-color: var(--neutral-layer-2);
    }
    
    .path-display {
        color: var(--neutral-foreground-hint);
    }
    
    .storage-info {
        color: var(--neutral-foreground-hint);
    }
    
    .fluent-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .fluent-table th {
        text-align: left;
        padding: 0.75rem;
        border-bottom: 2px solid var(--neutral-stroke-divider-rest);
        font-weight: 600;
    }
    
    .fluent-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--neutral-stroke-divider-rest);
        vertical-align: middle;
    }
    
    .fluent-table tr:hover {
        background-color: var(--neutral-fill-secondary-hover);
    }
</style>

<div class="file-manager-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <!-- Favorites Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">
                <span>收藏</span>
                <FluentButton Appearance="Appearance.Stealth" 
                              IconOnly="true"
                              OnClick="ShowAddFavoriteDialog" 
                              Title="添加当前文件夹到收藏"
                              Style="padding: 0; min-width: auto;">
                    <i class="@Icons.Material.Filled.Add" style="font-size: 16px;"></i>
                </FluentButton>
            </div>
            @if (favoriteFolders != null && favoriteFolders.Any())
            {
                @foreach (var favorite in favoriteFolders)
                {
                    <div class="sidebar-item @(currentPath == favorite.Path ? "selected" : "")" 
                         @onclick="@(() => NavigateTo(favorite.Path))">
                        <i class="@GetFavoriteIcon(favorite.Icon)"></i>
                        <span style="flex: 1;">@favorite.Name</span>
                        <div @onclick:stopPropagation="true" style="display: flex; gap: 2px;">
                            <FluentButton Appearance="Appearance.Stealth" 
                                          IconOnly="true"
                                          OnClick="@(() => ShowEditFavoriteDialog(favorite))" 
                                          Title="编辑"
                                          Style="padding: 0; min-width: auto;">
                                <i class="@Icons.Material.Filled.Edit" style="font-size: 14px;"></i>
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Stealth" 
                                          IconOnly="true"
                                          OnClick="@(() => RemoveFavorite(favorite.Id))" 
                                          Title="删除"
                                          Style="padding: 0; min-width: auto; color: var(--error);">
                                <i class="@Icons.Material.Filled.Delete" style="font-size: 14px;"></i>
                            </FluentButton>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="color: var(--neutral-foreground-hint); font-size: 12px; padding: 4px 12px;">暂无收藏文件夹</div>
            }
        </div>

        <!-- Drives Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">存储</div>
            @if (drives != null)
            {
                @foreach (var drive in drives)
                {
                    <div class="sidebar-item @(currentPath == drive.Path || currentPath.StartsWith(drive.Path) ? "selected" : "")" 
                         @onclick="@(() => NavigateTo(drive.Path))">
                        <i class="@Icons.Material.Filled.Storage"></i>
                        <span>@drive.Name</span>
                    </div>
                }
            }
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Notification Area -->
        @if (!string.IsNullOrEmpty(notificationMessage))
        {
            <div style="margin: 1rem;">
                <FluentMessageBar Intent="@(notificationIsError ? MessageIntent.Error : MessageIntent.Success)" 
                                  OnDismiss="ClearNotification">
                    @notificationMessage
                </FluentMessageBar>
            </div>
        }
        
        <!-- Toolbar -->
        <div class="toolbar">
            <FluentButton Appearance="Appearance.Stealth" 
                          IconOnly="true"
                          OnClick="GoBack" 
                          Disabled="@(navigationHistory.Count <= 1)"
                          Title="后退">
                <i class="@Icons.Material.Filled.ArrowBack"></i>
            </FluentButton>
            <FluentButton Appearance="Appearance.Stealth" 
                          IconOnly="true"
                          OnClick="GoForward" 
                          Disabled="@(forwardHistory.Count == 0)"
                          Title="前进">
                <i class="@Icons.Material.Filled.ArrowForward"></i>
            </FluentButton>
            
            <div class="breadcrumb-container">
                <div class="breadcrumb">
                    <span style="color: var(--neutral-foreground-hint);">Files</span>
                    @foreach (var part in GetPathParts())
                    {
                        <i class="@Icons.Material.Filled.ChevronRight"></i>
                        <a class="breadcrumb-link" @onclick="(() => NavigateTo(part.Path))">@part.Name</a>
                    }
                </div>
                @if (files != null)
                {
                    <span class="file-count">@files.Count 项</span>
                }
            </div>
            
            <FluentButton Appearance="Appearance.Stealth" 
                          IconOnly="true"
                          OnClick="ShowUploadDialog" 
                          Title="上传文件">
                <i class="@Icons.Material.Filled.Upload"></i>
            </FluentButton>
            <FluentButton Appearance="Appearance.Stealth" 
                          IconOnly="true"
                          OnClick="ShowCreateFolderDialog" 
                          Title="新建文件夹">
                <i class="@Icons.Material.Filled.CreateNewFolder"></i>
            </FluentButton>
            <FluentButton Appearance="Appearance.Stealth" 
                          IconOnly="true"
                          OnClick="ShowSearchDialog" 
                          Title="搜索">
                <i class="@Icons.Material.Filled.Search"></i>
            </FluentButton>
            <FluentButton Appearance="Appearance.Stealth" 
                          IconOnly="true"
                          OnClick="RefreshFiles" 
                          Title="刷新">
                <i class="@Icons.Material.Filled.Refresh"></i>
            </FluentButton>
            <FluentButton Appearance="Appearance.Stealth" 
                          IconOnly="true"
                          OnClick="ToggleViewMode" 
                          Title="切换视图">
                <i class="@(isGridView ? Icons.Material.Filled.ViewList : Icons.Material.Filled.ViewModule)"></i>
            </FluentButton>
        </div>
        
        <!-- File Grid View -->
        @if (isGridView)
        {
            <div class="file-grid">
                @if (files != null && files.Any())
                {
                    @foreach (var file in files.Where(f => f.Name != ".."))
                    {
                        <div class="file-item" @onclick="@(() => NavigateTo(file.Path))" title="@file.Path">
                            @if (file.IsDirectory)
                            {
                                <i class="@Icons.Material.Filled.Folder folder-icon"></i>
                            }
                            else
                            {
                                <i class="@GetFileIcon(file.Extension) file-icon"></i>
                            }
                            <div class="file-name">@file.Name</div>
                            @if (!file.IsDirectory)
                            {
                                <div class="file-date">@file.SizeDisplay</div>
                            }
                            <div class="file-date">@file.LastModified.ToString("dd/MM HH:mm")</div>
                        </div>
                    }
                }
                else if (files == null)
                {
                    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="grid-column: 1 / -1; padding: 3rem;">
                        <FluentProgressRing />
                    </FluentStack>
                }
            </div>
        }
        else
        {
            <!-- List View -->
            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                @if (files != null && files.Any())
                {
                    <table class="fluent-table">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>大小</th>
                                <th>修改时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var file in files)
                            {
                                <tr>
                                    <td>
                                        @if (file.IsDirectory)
                                        {
                                            <a @onclick="(() => NavigateTo(file.Path))" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="@Icons.Material.Filled.Folder"></i>
                                                @file.Name
                                            </a>
                                        }
                                        else
                                        {
                                            <div style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" @onclick="(() => NavigateTo(file.Path))">
                                                <i class="@GetFileIcon(file.Extension)"></i>
                                                <span>@file.Name</span>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <FluentBadge Appearance="@(file.IsDirectory ? Appearance.Accent : Appearance.Neutral)">
                                            @(file.IsDirectory ? "文件夹" : "文件")
                                        </FluentBadge>
                                    </td>
                                    <td>@file.SizeDisplay</td>
                                    <td>@file.LastModified.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                    <td>
                                        @if (!file.IsDirectory && file.Name != "..")
                                        {
                                            <FluentButton Appearance="Appearance.Stealth" 
                                                          IconOnly="true"
                                                          OnClick="(() => DownloadFile(file.Path))" 
                                                          Title="下载">
                                                <i class="@Icons.Material.Filled.Download"></i>
                                            </FluentButton>
                                        }
                                        @if (file.Name != "..")
                                        {
                                            <FluentButton Appearance="Appearance.Stealth" 
                                                          IconOnly="true"
                                                          OnClick="(() => ShowRenameDialog(file))" 
                                                          Title="重命名">
                                                <i class="@Icons.Material.Filled.Edit"></i>
                                            </FluentButton>
                                            <FluentButton Appearance="Appearance.Stealth" 
                                                          IconOnly="true"
                                                          OnClick="(() => ShowCopyDialog(file))" 
                                                          Title="复制">
                                                <i class="@Icons.Material.Filled.ContentCopy"></i>
                                            </FluentButton>
                                            <FluentButton Appearance="Appearance.Stealth" 
                                                          IconOnly="true"
                                                          OnClick="(() => ShowMoveDialog(file))" 
                                                          Title="移动">
                                                <i class="@Icons.Material.Filled.DriveFileMove"></i>
                                            </FluentButton>
                                        }
                                        @if (!file.IsDirectory && file.Name != "..")
                                        {
                                            <FluentButton Appearance="Appearance.Stealth" 
                                                          IconOnly="true"
                                                          OnClick="(() => DeleteFile(file.Path))" 
                                                          Title="删除"
                                                          Style="color: var(--error);">
                                                <i class="@Icons.Material.Filled.Delete"></i>
                                            </FluentButton>
                                        }
                                        @if (file.IsDirectory && file.Name != "..")
                                        {
                                            <FluentButton Appearance="Appearance.Stealth" 
                                                          IconOnly="true"
                                                          OnClick="(() => DeleteDirectory(file.Path))" 
                                                          Title="删除"
                                                          Style="color: var(--error);">
                                                <i class="@Icons.Material.Filled.Delete"></i>
                                            </FluentButton>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else if (files == null)
                {
                    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 3rem;">
                        <FluentProgressRing />
                    </FluentStack>
                }
                else
                {
                    <p>此目录为空</p>
                }
            </div>
        }
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="path-display">
                <i class="@Icons.Material.Filled.Edit"></i>
                @GetSimplifiedPath()
            </div>
            <div class="storage-info">
                @if (storageTotal > 0)
                {
                    <span>@FileUtilities.FormatSize(storageAvailable) 可用/@FileUtilities.FormatSize(storageTotal)</span>
                }
            </div>
        </div>
    </div>
</div>


<!-- Upload File Dialog -->
<FluentDialog Hidden="@(!showUploadDialog)" Modal="true" OnDismiss="CloseUploadDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">上传文件</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>选择文件</FluentLabel>
            <InputFile OnChange="HandleFileUpload" multiple />
            @if (!string.IsNullOrEmpty(uploadMessage))
            {
                <FluentMessageBar Intent="@(uploadSuccess ? MessageIntent.Success : MessageIntent.Error)">
                    @uploadMessage
                </FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseUploadDialog">关闭</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Create Folder Dialog -->
<FluentDialog Hidden="@(!showCreateFolderDialog)" Modal="true" OnDismiss="CloseCreateFolderDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">新建文件夹</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>文件夹名称</FluentLabel>
            <FluentTextField @bind-Value="newFolderName" Placeholder="输入文件夹名称" Style="width: 100%;" />
            @if (!string.IsNullOrEmpty(createFolderMessage))
            {
                <FluentMessageBar Intent="@(createFolderSuccess ? MessageIntent.Success : MessageIntent.Error)">
                    @createFolderMessage
                </FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseCreateFolderDialog">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="CreateFolder">创建</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Rename Dialog -->
<FluentDialog Hidden="@(!showRenameDialog)" Modal="true" OnDismiss="CloseRenameDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">重命名</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>新名称</FluentLabel>
            <FluentTextField @bind-Value="renameNewName" Placeholder="输入新名称" Style="width: 100%;" />
            @if (!string.IsNullOrEmpty(renameMessage))
            {
                <FluentMessageBar Intent="@(renameSuccess ? MessageIntent.Success : MessageIntent.Error)">
                    @renameMessage
                </FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseRenameDialog">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="RenameItem">重命名</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Copy Dialog -->
<FluentDialog Hidden="@(!showCopyDialog)" Modal="true" OnDismiss="CloseCopyDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">复制</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>目标路径</FluentLabel>
            <FluentTextField @bind-Value="copyDestination" Placeholder="输入目标路径" Style="width: 100%;" />
            @if (!string.IsNullOrEmpty(copyMessage))
            {
                <FluentMessageBar Intent="@(copySuccess ? MessageIntent.Success : MessageIntent.Error)">
                    @copyMessage
                </FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseCopyDialog">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="CopyItem">复制</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Move Dialog -->
<FluentDialog Hidden="@(!showMoveDialog)" Modal="true" OnDismiss="CloseMoveDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">移动</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>目标路径</FluentLabel>
            <FluentTextField @bind-Value="moveDestination" Placeholder="输入目标路径" Style="width: 100%;" />
            @if (!string.IsNullOrEmpty(moveMessage))
            {
                <FluentMessageBar Intent="@(moveSuccess ? MessageIntent.Success : MessageIntent.Error)">
                    @moveMessage
                </FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseMoveDialog">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="MoveItem">移动</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Search Dialog -->
<FluentDialog Hidden="@(!showSearchDialog)" Modal="true" OnDismiss="CloseSearchDialog" Style="min-width: 600px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">搜索文件</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>搜索关键词</FluentLabel>
            <FluentStack Orientation="Orientation.Horizontal">
                <FluentTextField @bind-Value="searchPattern" Placeholder="输入文件名或模式，如 *.txt" Style="flex: 1;" />
                <FluentButton Appearance="Appearance.Accent" OnClick="SearchFiles">搜索</FluentButton>
            </FluentStack>
            @if (searchResults != null && searchResults.Any())
            {
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="fluent-table">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>路径</th>
                                <th>类型</th>
                                <th>大小</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in searchResults)
                            {
                                <tr style="cursor: pointer;" @onclick="(() => NavigateToSearchResult(result))">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="@(result.IsDirectory ? Icons.Material.Filled.Folder : Icons.Material.Filled.InsertDriveFile)"></i>
                                            @result.Name
                                        </div>
                                    </td>
                                    <td>@result.Path</td>
                                    <td>@(result.IsDirectory ? "文件夹" : "文件")</td>
                                    <td>@result.SizeDisplay</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            @if (searchResults != null && !searchResults.Any())
            {
                <FluentMessageBar Intent="MessageIntent.Info">未找到匹配的文件</FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseSearchDialog">关闭</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Add/Edit Favorite Dialog -->
<FluentDialog Hidden="@(!showFavoriteDialog)" Modal="true" OnDismiss="CloseFavoriteDialog">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">@(editingFavorite == null ? "添加到收藏" : "编辑收藏")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>名称</FluentLabel>
            <FluentTextField @bind-Value="favoriteName" Placeholder="输入收藏夹名称" Style="width: 100%;" />
            
            @if (editingFavorite == null)
            {
                <FluentLabel>路径</FluentLabel>
                <FluentTextField @bind-Value="favoritePath" Placeholder="文件夹路径" ReadOnly="true" Style="width: 100%;" />
            }
            
            <FluentLabel>图标</FluentLabel>
            <FluentSelect TOption="string"
                          Items="@(new[] { "folder", "star", "description", "download", "photo_library", "movie", "audiotrack", "work", "school", "home" })"
                          OptionText="@GetFavoriteOptionText"
                          OptionValue="@(item => item)"
                          @bind-Value="favoriteIcon"
                          Style="width: 100%;" />
            
            @if (!string.IsNullOrEmpty(favoriteMessage))
            {
                <FluentMessageBar Intent="@(favoriteSuccess ? MessageIntent.Success : MessageIntent.Error)">
                    @favoriteMessage
                </FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseFavoriteDialog">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="SaveFavorite">保存</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- File Preview Dialog -->
<FluentDialog Hidden="@(!showPreviewDialog)" Modal="true" OnDismiss="ClosePreviewDialog" Style="min-width: 800px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">文件预览: @previewFileName</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <div style="max-height: 600px; overflow-y: auto;">
            @if (previewIsImage)
            {
                <div style="text-align: center;">
                    <img src="@previewImageUrl" alt="@previewFileName" style="max-width: 100%; max-height: 600px;" />
                </div>
            }
            else if (previewIsText)
            {
                <pre style="background-color: var(--neutral-layer-1); padding: 16px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word;">@previewTextContent</pre>
            }
            else if (previewIsPdf || previewIsDocx || previewIsXlsx)
            {
                <div id="documentPreviewContainer" style="background-color: var(--neutral-layer-2); color: var(--neutral-foreground-rest);">
                    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 3rem;">
                        <FluentProgressRing />
                        <FluentLabel>正在加载文档预览...</FluentLabel>
                    </FluentStack>
                </div>
            }
            else
            {
                <FluentMessageBar Intent="MessageIntent.Info">此文件类型暂不支持预览</FluentMessageBar>
            }
        </div>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="(() => DownloadFile(previewFilePath))">下载</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="ClosePreviewDialog">关闭</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<FileItemInfo>? files;
    private List<DriveItemInfo>? drives;
    private List<FavoriteFolder>? favoriteFolders;
    private string currentPath = string.Empty;
    private bool isGridView = true;
    private long storageTotal = 0;
    private long storageAvailable = 0;
    
    private Stack<string> navigationHistory = new Stack<string>();
    private Stack<string> forwardHistory = new Stack<string>();

    // Dialog states
    private bool showUploadDialog = false;
    private bool showCreateFolderDialog = false;
    private bool showRenameDialog = false;
    private bool showCopyDialog = false;
    private bool showMoveDialog = false;
    private bool showSearchDialog = false;
    private bool showPreviewDialog = false;
    private bool showFavoriteDialog = false;

    // Dialog data
    private string newFolderName = string.Empty;
    private string renameNewName = string.Empty;
    private FileItemInfo? renameItem = null;
    private string copyDestination = string.Empty;
    private FileItemInfo? copyItem = null;
    private string moveDestination = string.Empty;
    private FileItemInfo? moveItem = null;
    private string searchPattern = string.Empty;
    private List<FileItemInfo>? searchResults = null;
    private string previewFilePath = string.Empty;
    private string previewFileName = string.Empty;
    private string previewImageUrl = string.Empty;
    private string previewTextContent = string.Empty;
    private bool previewIsImage = false;
    private bool previewIsText = false;
    private bool previewIsPdf = false;
    private bool previewIsDocx = false;
    private bool previewIsXlsx = false;
    private string previewFileUrl = string.Empty;

    // Favorite dialog data
    private FavoriteFolder? editingFavorite = null;
    private string favoriteName = string.Empty;
    private string favoritePath = string.Empty;
    private string favoriteIcon = "folder";
    private string favoriteMessage = string.Empty;
    private bool favoriteSuccess = false;

    // Messages
    private string uploadMessage = string.Empty;
    private bool uploadSuccess = false;
    private string createFolderMessage = string.Empty;
    private bool createFolderSuccess = false;
    private string renameMessage = string.Empty;
    private bool renameSuccess = false;
    private string copyMessage = string.Empty;
    private bool copySuccess = false;
    private string moveMessage = string.Empty;
    private bool moveSuccess = false;
    private string notificationMessage = string.Empty;
    private bool notificationIsError = false;

    protected override async Task OnInitializedAsync()
    {
        // Load drives, shortcuts, and favorites
        drives = await FileManagerService.GetDrivesAsync();        
        favoriteFolders = await FileManagerService.GetFavoriteFoldersAsync();
        
        // Start at user's home directory or first drive
        if (drives != null && drives.Any())
        {
            currentPath = drives.First().Path;
        }
        else if (OperatingSystem.IsWindows())
        {
            currentPath = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        }
        else
        {
            currentPath = "/";
        }
        
        navigationHistory.Push(currentPath);
        await RefreshFiles();
    }

    private async Task RefreshFiles()
    {
        try
        {
            files = await FileManagerService.GetFilesAsync(currentPath);
            var storage = await FileManagerService.GetStorageInfoAsync(currentPath);
            storageTotal = storage.total;
            storageAvailable = storage.available;
        }
        catch (Exception ex)
        {
            ShowNotification($"加载文件列表失败: {ex.Message}", true);
        }
    }

    private void ShowNotification(string message, bool isError = false)
    {
        notificationMessage = message;
        notificationIsError = isError;
        StateHasChanged();
    }

    private void ClearNotification()
    {
        notificationMessage = string.Empty;
        notificationIsError = false;
    }

    private async Task NavigateTo(string path)
    {
        if (Directory.Exists(path))
        {
            // Add current path to history if it's different
            if (currentPath != path)
            {
                navigationHistory.Push(currentPath);
                forwardHistory.Clear(); // Clear forward history on new navigation
            }
            
            currentPath = path;
            await RefreshFiles();
        }
        else if (File.Exists(path))
        {
            // Handle file click - show preview for supported file types
            var extension = Path.GetExtension(path).ToLowerInvariant();
            if (IsPreviewableFile(extension))
            {
                await ShowFilePreview(path);
            }
            else
            {
                // Download non-previewable files
                await DownloadFile(path);
            }
        }
    }

    private async Task GoBack()
    {
        if (navigationHistory.Count > 1)
        {
            forwardHistory.Push(currentPath);
            navigationHistory.Pop(); // Remove current
            currentPath = navigationHistory.Peek(); // Go to previous
            await RefreshFiles();
        }
    }

    private async Task GoForward()
    {
        if (forwardHistory.Count > 0)
        {
            navigationHistory.Push(currentPath);
            currentPath = forwardHistory.Pop();
            await RefreshFiles();
        }
    }

    private void ToggleViewMode()
    {
        isGridView = !isGridView;
    }

    private async Task DeleteFile(string path)
    {
        try
        {
            await FileManagerService.DeleteFileAsync(path);
            ShowNotification($"文件已删除: {Path.GetFileName(path)}", false);
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            ShowNotification($"删除文件失败: {ex.Message}", true);
        }
    }

    private async Task DeleteDirectory(string path)
    {
        try
        {
            await FileManagerService.DeleteDirectoryAsync(path);
            ShowNotification($"文件夹已删除: {Path.GetFileName(path)}", false);
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            ShowNotification($"删除文件夹失败: {ex.Message}", true);
        }
    }

    private List<(string Name, string Path)> GetPathParts()
    {
        var parts = new List<(string Name, string Path)>();
        
        if (string.IsNullOrEmpty(currentPath))
            return parts;
        
        var path = currentPath;
        var pathSegments = new List<string>();
        
        // Split path into segments
        while (!string.IsNullOrEmpty(path))
        {
            var dirInfo = new DirectoryInfo(path);
            if (dirInfo.Parent == null)
            {
                pathSegments.Insert(0, path);
                break;
            }
            pathSegments.Insert(0, dirInfo.Name);
            path = dirInfo.Parent.FullName;
        }
        
        // Build path parts
        var currentBuild = "";
        foreach (var segment in pathSegments)
        {
            if (string.IsNullOrEmpty(currentBuild))
            {
                currentBuild = segment;
            }
            else
            {
                currentBuild = Path.Combine(currentBuild, segment);
            }
            parts.Add((segment, currentBuild));
        }
        
        return parts;
    }

    private string GetSimplifiedPath()
    {
        if (string.IsNullOrEmpty(currentPath))
            return "/";
        
        var parts = currentPath.Split(Path.DirectorySeparatorChar, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length <= 3)
            return $"/ {string.Join(" / ", parts)}";
        
        return $"/ {parts[0]} / ... / {parts[parts.Length - 1]}";
    }

    private string GetShortcutIcon(string type)
    {
        return type switch
        {
            "documents" => Icons.Material.Filled.Description,
            "downloads" => Icons.Material.Filled.Download,
            "gallery" => Icons.Material.Filled.PhotoLibrary,
            "media" => Icons.Material.Filled.Movie,
            "backup" => Icons.Material.Filled.Backup,
            _ => Icons.Material.Filled.Folder
        };
    }

    private string GetFileIcon(string extension)
    {
        return extension.ToLowerInvariant() switch
        {
            ".pdf" => Icons.Material.Filled.PictureAsPdf,
            ".doc" or ".docx" => Icons.Material.Filled.Description,
            ".xls" or ".xlsx" => Icons.Material.Filled.TableChart,
            ".txt" or ".log" => Icons.Material.Filled.Description,
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".svg" or ".webp" => Icons.Material.Filled.Image,
            ".mp3" or ".wav" or ".flac" => Icons.Material.Filled.AudioFile,
            ".mp4" or ".avi" or ".mkv" or ".mov" => Icons.Material.Filled.VideoFile,
            ".zip" or ".rar" or ".7z" or ".tar" or ".gz" => Icons.Material.Filled.Archive,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    // File operation methods
    private async Task DownloadFile(string filePath)
    {
        try
        {
            var encodedPath = Uri.EscapeDataString(filePath);
            var downloadUrl = $"/api/files/download?path={encodedPath}";
            
            // Trigger download using JavaScript
            await JSRuntime.InvokeVoidAsync("open", downloadUrl, "_blank");
            ShowNotification($"开始下载: {Path.GetFileName(filePath)}", false);
        }
        catch (Exception ex)
        {
            ShowNotification($"下载文件失败: {ex.Message}", true);
        }
    }

    // Dialog methods
    private void ShowUploadDialog()
    {
        showUploadDialog = true;
        uploadMessage = string.Empty;
        uploadSuccess = false;
    }

    private void CloseUploadDialog()
    {
        showUploadDialog = false;
        uploadMessage = string.Empty;
        uploadSuccess = false;
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            uploadMessage = string.Empty;
            var uploadResults = new System.Text.StringBuilder();
            var successCount = 0;
            var failCount = 0;
            
            foreach (var file in e.GetMultipleFiles())
            {
                try
                {
                    using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 100); // 100MB max
                    using var memoryStream = new MemoryStream();
                    await stream.CopyToAsync(memoryStream);
                    var buffer = memoryStream.ToArray();
                    
                    await FileManagerService.UploadFileAsync(currentPath, file.Name, buffer);
                    uploadResults.AppendLine($"成功上传: {file.Name}");
                    successCount++;
                }
                catch (Exception ex)
                {
                    uploadResults.AppendLine($"上传失败 {file.Name}: {ex.Message}");
                    failCount++;
                }
            }
            
            uploadMessage = uploadResults.ToString();
            uploadSuccess = failCount == 0; // Only success if all files uploaded
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            uploadMessage = $"上传失败: {ex.Message}";
            uploadSuccess = false;
        }
    }

    private void ShowCreateFolderDialog()
    {
        showCreateFolderDialog = true;
        newFolderName = string.Empty;
        createFolderMessage = string.Empty;
        createFolderSuccess = false;
    }

    private void CloseCreateFolderDialog()
    {
        showCreateFolderDialog = false;
        newFolderName = string.Empty;
        createFolderMessage = string.Empty;
        createFolderSuccess = false;
    }

    private async Task CreateFolder()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(newFolderName))
            {
                createFolderMessage = "请输入文件夹名称";
                createFolderSuccess = false;
                return;
            }

            var folderPath = Path.Combine(currentPath, newFolderName);
            await FileManagerService.CreateDirectoryAsync(folderPath);
            
            createFolderMessage = "文件夹创建成功";
            createFolderSuccess = true;
            
            // Refresh files list separately to avoid overwriting success message
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - folder was created successfully
            }
            
            CloseCreateFolderDialog();
        }
        catch (Exception ex)
        {
            createFolderMessage = $"创建文件夹失败: {ex.Message}";
            createFolderSuccess = false;
        }
    }

    private void ShowRenameDialog(FileItemInfo item)
    {
        showRenameDialog = true;
        renameItem = item;
        renameNewName = item.Name;
        renameMessage = string.Empty;
        renameSuccess = false;
    }

    private void CloseRenameDialog()
    {
        showRenameDialog = false;
        renameItem = null;
        renameNewName = string.Empty;
        renameMessage = string.Empty;
        renameSuccess = false;
    }

    private async Task RenameItem()
    {
        try
        {
            if (renameItem == null || string.IsNullOrWhiteSpace(renameNewName))
            {
                renameMessage = "请输入新名称";
                renameSuccess = false;
                return;
            }

            var newPath = Path.Combine(Path.GetDirectoryName(renameItem.Path) ?? currentPath, renameNewName);
            await FileManagerService.RenameAsync(renameItem.Path, newPath);
            
            renameMessage = "重命名成功";
            renameSuccess = true;
            
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - rename was successful
            }
            
            CloseRenameDialog();
        }
        catch (Exception ex)
        {
            renameMessage = $"重命名失败: {ex.Message}";
            renameSuccess = false;
        }
    }

    private void ShowCopyDialog(FileItemInfo item)
    {
        showCopyDialog = true;
        copyItem = item;
        copyDestination = string.Empty; // Empty by default to avoid confusion
        copyMessage = string.Empty;
        copySuccess = false;
    }

    private void CloseCopyDialog()
    {
        showCopyDialog = false;
        copyItem = null;
        copyDestination = string.Empty;
        copyMessage = string.Empty;
        copySuccess = false;
    }

    private async Task CopyItem()
    {
        try
        {
            if (copyItem == null || string.IsNullOrWhiteSpace(copyDestination))
            {
                copyMessage = "请输入目标路径";
                copySuccess = false;
                return;
            }

            var destPath = Path.Combine(copyDestination, copyItem.Name);
            await FileManagerService.CopyAsync(copyItem.Path, destPath);
            
            copyMessage = "复制成功";
            copySuccess = true;
            
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - copy was successful
            }
            
            CloseCopyDialog();
        }
        catch (Exception ex)
        {
            copyMessage = $"复制失败: {ex.Message}";
            copySuccess = false;
        }
    }

    private void ShowMoveDialog(FileItemInfo item)
    {
        showMoveDialog = true;
        moveItem = item;
        moveDestination = string.Empty; // Empty by default to avoid confusion
        moveMessage = string.Empty;
        moveSuccess = false;
    }

    private void CloseMoveDialog()
    {
        showMoveDialog = false;
        moveItem = null;
        moveDestination = string.Empty;
        moveMessage = string.Empty;
        moveSuccess = false;
    }

    private async Task MoveItem()
    {
        try
        {
            if (moveItem == null || string.IsNullOrWhiteSpace(moveDestination))
            {
                moveMessage = "请输入目标路径";
                moveSuccess = false;
                return;
            }

            var destPath = Path.Combine(moveDestination, moveItem.Name);
            await FileManagerService.MoveAsync(moveItem.Path, destPath);
            
            moveMessage = "移动成功";
            moveSuccess = true;
            
            try
            {
                await RefreshFiles();
            }
            catch
            {
                // Ignore refresh errors - move was successful
            }
            
            CloseMoveDialog();
        }
        catch (Exception ex)
        {
            moveMessage = $"移动失败: {ex.Message}";
            moveSuccess = false;
        }
    }

    private void ShowSearchDialog()
    {
        showSearchDialog = true;
        searchPattern = string.Empty;
        searchResults = null;
    }

    private void CloseSearchDialog()
    {
        showSearchDialog = false;
        searchPattern = string.Empty;
        searchResults = null;
    }

    private async Task SearchFiles()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(searchPattern))
            {
                ShowNotification("请输入搜索内容", true);
                return;
            }

            searchResults = await FileManagerService.SearchFilesAsync(currentPath, searchPattern);
            
            // Warn if large number of results
            if (searchResults.Count > 1000)
            {
                ShowNotification($"找到 {searchResults.Count} 个结果，显示可能较慢", false);
            }
        }
        catch (Exception ex)
        {
            ShowNotification($"搜索失败: {ex.Message}", true);
            searchResults = new List<FileItemInfo>();
        }
    }

    private async Task NavigateToSearchResult(FileItemInfo result)
    {
        CloseSearchDialog();
        
        if (result.IsDirectory)
        {
            await NavigateTo(result.Path);
        }
        else
        {
            var directory = Path.GetDirectoryName(result.Path);
            if (!string.IsNullOrEmpty(directory))
            {
                await NavigateTo(directory);
            }
        }
    }

    private bool IsPreviewableFile(string extension)
    {
        var imageExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".svg", ".webp" };
        var textExtensions = new[] { ".txt", ".log", ".md", ".json", ".xml", ".csv", ".html", ".css", ".js", ".cs", ".razor", ".sh", ".conf", ".config", ".yml", ".yaml" };
        var pdfExtensions = new[] { ".pdf" };
        var officeExtensions = new[] { ".doc", ".docx", ".xls", ".xlsx" };
        
        return imageExtensions.Contains(extension) || textExtensions.Contains(extension) || 
               pdfExtensions.Contains(extension) || officeExtensions.Contains(extension);
    }

    private async Task ShowFilePreview(string filePath)
    {
        try
        {
            previewFilePath = filePath;
            previewFileName = Path.GetFileName(filePath);
            var extension = Path.GetExtension(filePath).ToLowerInvariant();
            
            var imageExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".svg", ".webp" };
            var textExtensions = new[] { ".txt", ".log", ".md", ".json", ".xml", ".csv", ".html", ".css", ".js", ".cs", ".razor", ".sh", ".conf", ".config", ".yml", ".yaml" };
            
            previewIsImage = imageExtensions.Contains(extension);
            previewIsText = textExtensions.Contains(extension);
            previewIsPdf = extension == ".pdf";
            previewIsDocx = extension == ".docx" || extension == ".doc";
            previewIsXlsx = extension == ".xlsx" || extension == ".xls";
            
            // Warn users about limited support for legacy formats
            if (extension == ".doc")
            {
                ShowNotification("该文件为旧版 Word (.doc) 格式，在线预览可能不完整或无法显示。建议下载后使用本地应用程序打开。", false);
            }
            else if (extension == ".xls")
            {
                ShowNotification("该文件为旧版 Excel (.xls) 格式，在线预览可能不完整。建议下载后使用本地应用程序打开。", false);
            }
            
            if (previewIsImage)
            {
                var encodedPath = Uri.EscapeDataString(filePath);
                previewImageUrl = $"/api/files/download?path={encodedPath}";
            }
            else if (previewIsText)
            {
                // Read text content (limit to 1MB for preview)
                var fileInfo = new FileInfo(filePath);
                if (fileInfo.Length > 1024 * 1024)
                {
                    previewTextContent = "文件太大，无法预览。请下载文件查看。";
                }
                else
                {
                    var bytes = await FileManagerService.ReadFileAsync(filePath);
                    try
                    {
                        var utf8 = new System.Text.UTF8Encoding(encoderShouldEmitUTF8Identifier: false, throwOnInvalidBytes: true);
                        previewTextContent = utf8.GetString(bytes);
                    }
                    catch (System.Text.DecoderFallbackException)
                    {
                        previewTextContent = "无法以 UTF-8 解码该文件内容，请下载后使用合适的程序打开。";
                    }
                }
            }
            else if (previewIsPdf || previewIsDocx || previewIsXlsx)
            {
                // For PDF and Office documents, we need to provide the download URL
                // Note: Path validation and access control is enforced by the backend API endpoint
                // via FileManagerService.IsPathAllowed() to prevent unauthorized file access
                var encodedPath = Uri.EscapeDataString(filePath);
                previewFileUrl = $"/api/files/download?path={encodedPath}";
            }
            
            showPreviewDialog = true;
            
            // Trigger JavaScript rendering for PDF and Office documents after dialog is shown
            if (previewIsPdf || previewIsDocx || previewIsXlsx)
            {
                // Ensure the dialog is rendered before triggering JavaScript rendering
                await InvokeAsync(StateHasChanged);
                await Task.Yield();
                await RenderDocument(extension);
            }
        }
        catch (Exception ex)
        {
            ShowNotification($"预览文件失败: {ex.Message}", true);
        }
    }

    private async Task ClosePreviewDialog()
    {
        showPreviewDialog = false;
        
        // Cleanup document preview containers
        if (previewIsPdf || previewIsDocx || previewIsXlsx)
        {
            await JSRuntime.InvokeVoidAsync("documentPreview.cleanup", "documentPreviewContainer");
        }
        
        previewFilePath = string.Empty;
        previewFileName = string.Empty;
        previewImageUrl = string.Empty;
        previewTextContent = string.Empty;
        previewFileUrl = string.Empty;
        previewIsImage = false;
        previewIsText = false;
        previewIsPdf = false;
        previewIsDocx = false;
        previewIsXlsx = false;
    }
    
    private async Task RenderDocument(string extension)
    {
        try
        {
            object? result = null;
            if (extension == ".pdf")
            {
                result = await JSRuntime.InvokeAsync<object>("documentPreview.initPdfViewer", "documentPreviewContainer", previewFileUrl);
            }
            else if (extension == ".docx" || extension == ".doc")
            {
                result = await JSRuntime.InvokeAsync<object>("documentPreview.initDocxViewer", "documentPreviewContainer", previewFileUrl);
            }
            else if (extension == ".xlsx" || extension == ".xls")
            {
                result = await JSRuntime.InvokeAsync<object>("documentPreview.initXlsxViewer", "documentPreviewContainer", previewFileUrl);
            }
            
            // Check if rendering failed and display error in container
            if (result != null)
            {
                var resultDict = result as System.Text.Json.JsonElement?;
                if (resultDict.HasValue && resultDict.Value.TryGetProperty("success", out var successProp))
                {
                    if (!successProp.GetBoolean())
                    {
                        var errorMsg = resultDict.Value.TryGetProperty("error", out var errorProp) 
                            ? errorProp.GetString() ?? "未知错误"
                            : "未知错误";
                        await JSRuntime.InvokeVoidAsync("documentPreview.displayError", "documentPreviewContainer", $"文档加载失败: {errorMsg}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Display error in preview container instead of just showing notification
            try
            {
                await JSRuntime.InvokeVoidAsync("documentPreview.displayError", "documentPreviewContainer", "文档预览失败，请稍后重试。");
            }
            catch
            {
                // Fallback to notification if JavaScript fails
                ShowNotification($"渲染文档失败: {ex.Message}", true);
            }
        }
    }

    // Favorites management methods
    private void ShowAddFavoriteDialog()
    {
        editingFavorite = null;
        favoriteName = Path.GetFileName(currentPath) ?? "新收藏";
        favoritePath = currentPath;
        favoriteIcon = "folder";
        favoriteMessage = string.Empty;
        favoriteSuccess = false;
        showFavoriteDialog = true;
    }

    private void ShowEditFavoriteDialog(FavoriteFolder favorite)
    {
        editingFavorite = favorite;
        favoriteName = favorite.Name;
        favoritePath = favorite.Path;
        favoriteIcon = favorite.Icon;
        favoriteMessage = string.Empty;
        favoriteSuccess = false;
        showFavoriteDialog = true;
    }

    private void CloseFavoriteDialog()
    {
        showFavoriteDialog = false;
        editingFavorite = null;
        favoriteName = string.Empty;
        favoritePath = string.Empty;
        favoriteIcon = "folder";
        favoriteMessage = string.Empty;
        favoriteSuccess = false;
    }

    private async Task SaveFavorite()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(favoriteName))
            {
                favoriteMessage = "请输入收藏夹名称";
                favoriteSuccess = false;
                return;
            }

            if (favoriteName.Length > 200)
            {
                favoriteMessage = "收藏夹名称不能超过200个字符";
                favoriteSuccess = false;
                return;
            }

            if (editingFavorite == null)
            {
                // Add new favorite
                await FileManagerService.AddFavoriteFolderAsync(favoriteName, favoritePath, favoriteIcon);
                favoriteMessage = "添加收藏成功";
            }
            else
            {
                // Update existing favorite
                await FileManagerService.UpdateFavoriteFolderAsync(editingFavorite.Id, favoriteName, favoriteIcon);
                favoriteMessage = "更新收藏成功";
            }
            
            favoriteSuccess = true;
            
            // Reload favorites
            favoriteFolders = await FileManagerService.GetFavoriteFoldersAsync();
            
            // Close dialog after short delay
            await Task.Delay(1000);
            CloseFavoriteDialog();
        }
        catch (Exception ex)
        {
            favoriteMessage = $"操作失败: {ex.Message}";
            favoriteSuccess = false;
        }
    }

    private async Task RemoveFavorite(int id)
    {
        try
        {
            await FileManagerService.RemoveFavoriteFolderAsync(id);
            ShowNotification("删除收藏成功", false);
            
            // Reload favorites
            favoriteFolders = await FileManagerService.GetFavoriteFoldersAsync();
        }
        catch (Exception ex)
        {
            ShowNotification($"删除收藏失败: {ex.Message}", true);
        }
    }

    private string GetFavoriteIcon(string icon)
    {
        return icon switch
        {
            "star" => Icons.Material.Filled.Star,
            "description" => Icons.Material.Filled.Description,
            "download" => Icons.Material.Filled.Download,
            "photo_library" => Icons.Material.Filled.PhotoLibrary,
            "movie" => Icons.Material.Filled.Movie,
            "audiotrack" => Icons.Material.Filled.AudioFile,
            "work" => Icons.Material.Filled.Work,
            "school" => Icons.Material.Filled.School,
            "home" => Icons.Material.Filled.Home,
            _ => Icons.Material.Filled.Folder
        };
    }
    
    private string GetFavoriteOptionText(string icon)
    {
        return icon switch
        {
            "folder" => "文件夹",
            "star" => "星标",
            "description" => "文档",
            "download" => "下载",
            "photo_library" => "图片",
            "movie" => "视频",
            "audiotrack" => "音乐",
            "work" => "工作",
            "school" => "学习",
            "home" => "主页",
            _ => "文件夹"
        };
    }
}
