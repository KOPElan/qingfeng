@page "/file-manager"
@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Utilities
@inject IFileManagerService FileManagerService
@rendermode InteractiveServer

<PageTitle>文件管理器</PageTitle>

<style>
    .file-manager-container {
        display: flex;
        height: calc(100vh - 180px);
        gap: 0;
    }
    
    .sidebar {
        width: 220px;
        background-color: var(--mud-palette-background);
        border-right: 1px solid var(--mud-palette-divider);
        overflow-y: auto;
        flex-shrink: 0;
    }
    
    .sidebar-section {
        padding: 16px 8px 8px 8px;
    }
    
    .sidebar-title {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        padding: 4px 12px;
        margin-bottom: 4px;
        font-weight: 500;
    }
    
    .sidebar-item {
        padding: 8px 12px;
        margin: 2px 4px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .sidebar-item:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    
    .sidebar-item.selected {
        background-color: var(--mud-palette-primary);
        color: white;
    }
    
    .sidebar-item .mud-icon-root {
        font-size: 20px;
    }
    
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .toolbar {
        padding: 12px 24px;
        border-bottom: 1px solid var(--mud-palette-divider);
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: var(--mud-palette-surface);
    }
    
    .breadcrumb-container {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }
    
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
    }
    
    .file-count {
        font-size: 13px;
        color: var(--mud-palette-text-secondary);
        margin-left: 8px;
    }
    
    .file-grid {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 20px;
        align-content: start;
    }
    
    .file-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .file-item:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    
    .folder-icon {
        font-size: 80px !important;
        color: #FFA726;
        margin-bottom: 8px;
    }
    
    .file-icon {
        font-size: 80px !important;
        color: #42A5F5;
        margin-bottom: 8px;
    }
    
    .file-name {
        font-size: 13px;
        text-align: center;
        word-break: break-word;
        margin-bottom: 4px;
    }
    
    .file-date {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
    }
    
    .status-bar {
        padding: 8px 24px;
        border-top: 1px solid var(--mud-palette-divider);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        background-color: var(--mud-palette-surface);
    }
    
    .path-display {
        color: var(--mud-palette-text-secondary);
    }
    
    .storage-info {
        color: var(--mud-palette-text-secondary);
    }
</style>

<div class="file-manager-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <!-- Shortcuts Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">收藏</div>
            @if (shortcuts != null)
            {
                @foreach (var shortcut in shortcuts)
                {
                    <div class="sidebar-item @(currentPath == shortcut.Path ? "selected" : "")" 
                         @onclick="@(() => NavigateTo(shortcut.Path))">
                        <i class="@GetShortcutIcon(shortcut.Type)"></i>
                        <span>@shortcut.Name</span>
                    </div>
                }
            }
        </div>
        
        <!-- Drives Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">存储</div>
            @if (drives != null)
            {
                @foreach (var drive in drives)
                {
                    <div class="sidebar-item @(currentPath == drive.Path || currentPath.StartsWith(drive.Path) ? "selected" : "")" 
                         @onclick="@(() => NavigateTo(drive.Path))">
                        <i class="@Icons.Material.Filled.Storage"></i>
                        <span>@drive.Name</span>
                    </div>
                }
            }
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Toolbar -->
        <div class="toolbar">
            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.ArrowBack" 
                          @@onclick="GoBack" disabled="@(navigationHistory.Count <= 1)" />
            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.ArrowForward"
                          @@onclick="GoForward" disabled="@(forwardHistory.Count == 0)" />
            
            <div class="breadcrumb-container">
                <div class="breadcrumb">
                    <p class="small">Files</p>
                    @foreach (var part in GetPathParts())
                    {
                        <i class="@Icons.Material.Filled.ChevronRight"></i>
                        <a Typo="Typo.body2" @onclick="(() => NavigateTo(part.Path))">@part.Name</a>
                    }
                </div>
                @if (files != null)
                {
                    <span class="file-count">@files.Count 项</span>
                }
            </div>
            
            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.Help" />
            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.VideoLibrary" />
            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.FolderShared" />
            <button type="button" class="btn btn-custom-primary">
                导入
            </button>
            <button type="button" class="btn btn-link text-white" Icon="@(isGridView ? Icons.Material.Filled.ViewList : Icons.Material.Filled.ViewModule)"
                          @@onclick="ToggleViewMode" />
            <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.GridView" />
        </div>
        
        <!-- File Grid View -->
        @if (isGridView)
        {
            <div class="file-grid">
                @if (files != null && files.Any())
                {
                    @foreach (var file in files.Where(f => f.Name != ".."))
                    {
                        <div class="file-item" @onclick="@(() => NavigateTo(file.Path))">
                            @if (file.IsDirectory)
                            {
                                <i class="@Icons.Material.Filled.Folder"></i>
                            }
                            else
                            {
                                <i class="@Icons.Material.Filled.InsertDriveFile"></i>
                            }
                            <div class="file-name">@file.Name</div>
                            <div class="file-date">@file.LastModified.ToString("dd/MM HH:mm")</div>
                        </div>
                    }
                }
                else if (files == null)
                {
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                }
            </div>
        }
        else
        {
            <!-- List View -->
            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                @if (files != null && files.Any())
                {
                    <table class="table table-custom"><tbody>
                        <thead><tr>
                            <th>名称</th>
                            <th>类型</th>
                            <th>大小</th>
                            <th>修改时间</th>
                            <th>操作</th>
                        </tr></thead>
                        <tr>
                            <td>
                                @if (context.IsDirectory)
                                {
                                    <a @onclick="(() => NavigateTo(context.Path))">
                                        <i class="@Icons.Material.Filled.Folder"></i>
                                        @context.Name
                                    </a>
                                }
                                else
                                {
                                    <div class="d-flex flex-column gap-2" Row="true" AlignItems="AlignItems.Center">
                                        <i class="@Icons.Material.Filled.InsertDriveFile"></i>
                                        <p>@context.Name</p>
                                    </div>
                                }
                            </td>
                            <td>
                                <span class="badge badge-custom Color="@(context.IsDirectory ? Color.Warning : Color.Info)">
                                    @(context.IsDirectory ? "文件夹" : "文件")
                                </span>
                            </td>
                            <td>@context.SizeDisplay</td>
                            <td>@context.LastModified.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>
                                @if (!context.IsDirectory)
                                {
                                    <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.Delete" @onclick="(() => DeleteFile(context.Path))" />
                                }
                                else
                                {
                                    <button type="button" class="btn btn-link text-white" Icon="@Icons.Material.Filled.Delete" @onclick="(() => DeleteDirectory(context.Path))" />
                                }
                            </td>
                        </tr>
                    </tbody></table>
                }
                else if (files == null)
                {
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <p class="ml-2">加载中...</p>
                }
                else
                {
                    <p>此目录为空</p>
                }
            </div>
        }
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="path-display">
                <i class="@Icons.Material.Filled.Edit"></i>
                @GetSimplifiedPath()
            </div>
            <div class="storage-info">
                @if (storageTotal > 0)
                {
                    <span>@FileUtilities.FormatSize(storageAvailable) 可用/@FileUtilities.FormatSize(storageTotal)</span>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<FileItemInfo>? files;
    private List<DriveItemInfo>? drives;
    private List<ShortcutItemInfo>? shortcuts;
    private string currentPath = string.Empty;
    private bool isGridView = true;
    private long storageTotal = 0;
    private long storageAvailable = 0;
    
    private Stack<string> navigationHistory = new Stack<string>();
    private Stack<string> forwardHistory = new Stack<string>();

    protected override async Task OnInitializedAsync()
    {
        // Load drives and shortcuts
        drives = await FileManagerService.GetDrivesAsync();
        shortcuts = await FileManagerService.GetShortcutsAsync();
        
        // Start at user's home directory or first drive
        if (drives != null && drives.Any())
        {
            currentPath = drives.First().Path;
        }
        else if (OperatingSystem.IsWindows())
        {
            currentPath = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
        }
        else
        {
            currentPath = "/";
        }
        
        navigationHistory.Push(currentPath);
        await RefreshFiles();
    }

    private async Task RefreshFiles()
    {
        try
        {
            files = await FileManagerService.GetFilesAsync(currentPath);
            var storage = await FileManagerService.GetStorageInfoAsync(currentPath);
            storageTotal = storage.total;
            storageAvailable = storage.available;
        }
        catch (Exception ex)
        {
            // Log error silently or handle as needed
            Console.WriteLine($"加载文件列表失败: {ex.Message}");
        }
    }

    private async Task NavigateTo(string path)
    {
        if (Directory.Exists(path))
        {
            // Add current path to history if it's different
            if (currentPath != path)
            {
                navigationHistory.Push(currentPath);
                forwardHistory.Clear(); // Clear forward history on new navigation
            }
            
            currentPath = path;
            await RefreshFiles();
        }
        else if (File.Exists(path))
        {
            // Handle file click - could add file preview/download here
            Console.WriteLine("文件操作功能即将推出");
        }
    }

    private async Task GoBack()
    {
        if (navigationHistory.Count > 1)
        {
            forwardHistory.Push(currentPath);
            navigationHistory.Pop(); // Remove current
            currentPath = navigationHistory.Peek(); // Go to previous
            await RefreshFiles();
        }
    }

    private async Task GoForward()
    {
        if (forwardHistory.Count > 0)
        {
            navigationHistory.Push(currentPath);
            currentPath = forwardHistory.Pop();
            await RefreshFiles();
        }
    }

    private void ToggleViewMode()
    {
        isGridView = !isGridView;
    }

    private async Task DeleteFile(string path)
    {
        try
        {
            await FileManagerService.DeleteFileAsync(path);
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"删除文件失败: {ex.Message}");
        }
    }

    private async Task DeleteDirectory(string path)
    {
        try
        {
            await FileManagerService.DeleteDirectoryAsync(path);
            await RefreshFiles();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"删除文件夹失败: {ex.Message}");
        }
    }

    private List<(string Name, string Path)> GetPathParts()
    {
        var parts = new List<(string Name, string Path)>();
        
        if (string.IsNullOrEmpty(currentPath))
            return parts;
        
        var path = currentPath;
        var pathSegments = new List<string>();
        
        // Split path into segments
        while (!string.IsNullOrEmpty(path))
        {
            var dirInfo = new DirectoryInfo(path);
            if (dirInfo.Parent == null)
            {
                pathSegments.Insert(0, path);
                break;
            }
            pathSegments.Insert(0, dirInfo.Name);
            path = dirInfo.Parent.FullName;
        }
        
        // Build path parts
        var currentBuild = "";
        foreach (var segment in pathSegments)
        {
            if (string.IsNullOrEmpty(currentBuild))
            {
                currentBuild = segment;
            }
            else
            {
                currentBuild = Path.Combine(currentBuild, segment);
            }
            parts.Add((segment, currentBuild));
        }
        
        return parts;
    }

    private string GetSimplifiedPath()
    {
        if (string.IsNullOrEmpty(currentPath))
            return "/";
        
        var parts = currentPath.Split(Path.DirectorySeparatorChar, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length <= 3)
            return $"/ {string.Join(" / ", parts)}";
        
        return $"/ {parts[0]} / ... / {parts[parts.Length - 1]}";
    }

    private string GetShortcutIcon(string type)
    {
        return type switch
        {
            "documents" => Icons.Material.Filled.Description,
            "downloads" => Icons.Material.Filled.Download,
            "gallery" => Icons.Material.Filled.PhotoLibrary,
            "media" => Icons.Material.Filled.Movie,
            "backup" => Icons.Material.Filled.Backup,
            _ => Icons.Material.Filled.Folder
        };
    }
}
