@page "/initial-setup"
@layout AuthLayout
@using QingFeng.Models
@using QingFeng.Services
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="setup-container">
    <FluentCard class="setup-card">
        <div class="setup-header">
            <FluentLabel Typo="Typography.H3" Style="color: white; margin: 0;">ğŸ›¡ï¸ åˆå§‹è®¾ç½®</FluentLabel>
            <FluentLabel Typo="Typography.Body" Style="color: rgba(255, 255, 255, 0.9); margin-top: 0.5rem;">æ¬¢è¿ä½¿ç”¨æ¸…é£ï¼è¯·åˆ›å»ºç®¡ç†å‘˜è´¦å·ä»¥å¼€å§‹ä½¿ç”¨ã€‚</FluentLabel>
        </div>

        <div class="setup-body">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <FluentMessageBar Intent="MessageIntent.Error" Style="margin-bottom: 1rem;">
                    @errorMessage
                </FluentMessageBar>
            }

            <FluentTextField @bind-Value="username" 
                           Placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜ç”¨æˆ·å" 
                           Label="ç”¨æˆ·å"
                           Hint="ç”¨æˆ·åå°†ç”¨äºç™»å½•ç³»ç»Ÿ"
                           Style="width: 100%; margin-bottom: 1rem;" />

            <FluentTextField @bind-Value="password" 
                           Type="TextFieldType.Password"
                           Placeholder="è¯·è¾“å…¥å¯†ç " 
                           Label="å¯†ç "
                           Hint="å»ºè®®ä½¿ç”¨å¼ºå¯†ç ä¿æŠ¤æ‚¨çš„è´¦å·å®‰å…¨"
                           Style="width: 100%; margin-bottom: 1rem;" />

            <FluentTextField @bind-Value="confirmPassword" 
                           Type="TextFieldType.Password"
                           Placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " 
                           Label="ç¡®è®¤å¯†ç "
                           Style="width: 100%; margin-bottom: 1.5rem;" />

            <FluentButton Appearance="Appearance.Accent" 
                         OnClick="CreateAdminAccount" 
                         Disabled="@isCreating"
                         Style="width: 100%;">
                @if (isCreating)
                {
                    <FluentProgressRing Style="width: 20px; height: 20px; margin-right: 0.5rem;" />
                    <span>åˆ›å»ºä¸­...</span>
                }
                else
                {
                    <span>âœ“ åˆ›å»ºç®¡ç†å‘˜è´¦å·</span>
                }
            </FluentButton>
        </div>

        <div class="setup-footer">
            <FluentLabel Typo="Typography.Body" Style="color: #6c757d;">
                â„¹ï¸ ç®¡ç†å‘˜æ‹¥æœ‰ç³»ç»Ÿçš„å®Œå…¨æ§åˆ¶æƒé™ï¼ŒåŒ…æ‹¬è®¾ç½®ã€Dockerç®¡ç†å’Œç£ç›˜ç®¡ç†ã€‚
            </FluentLabel>
        </div>
    </FluentCard>
</div>

@code {
    private string username = "";
    private string password = "";
    private string confirmPassword = "";
    private string errorMessage = "";
    private bool isCreating = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var hasAdmin = await AuthService.HasAdminUserAsync();
            if (hasAdmin)
            {
                Navigation.NavigateTo("/login", forceLoad: true);
            }
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task CreateAdminAccount()
    {
        errorMessage = "";

        var hasAdmin = await AuthService.HasAdminUserAsync();
        if (hasAdmin)
        {
            errorMessage = "ç®¡ç†å‘˜è´¦å·å·²å­˜åœ¨ï¼Œè¯·ç™»å½•";
            return;
        }

        if (string.IsNullOrWhiteSpace(username))
        {
            errorMessage = "è¯·è¾“å…¥ç”¨æˆ·å";
            return;
        }

        if (username.Length < 3)
        {
            errorMessage = "ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦";
            return;
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "è¯·è¾“å…¥å¯†ç ";
            return;
        }

        if (password.Length < 8)
        {
            errorMessage = "å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦";
            return;
        }

        if (password != confirmPassword)
        {
            errorMessage = "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´";
            return;
        }

        try
        {
            isCreating = true;
            StateHasChanged();

            await AuthService.CreateUserAsync(username, password, User.RoleAdmin);
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            errorMessage = $"åˆ›å»ºè´¦å·å¤±è´¥ï¼š{ex.Message}";
        }
        finally
        {
            isCreating = false;
            StateHasChanged();
        }
    }
}

<style>
    .setup-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
    }

    .setup-card {
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .setup-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
    }

    .setup-body {
        padding: 2rem;
    }

    .setup-footer {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-top: 1px solid #e9ecef;
    }
</style>
