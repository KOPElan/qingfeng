@page "/settings"
@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Components.Panels
@inherits AuthorizedPageBase
@inject ISystemSettingService SystemSettingService
@inject ILocalizationService LocalizationService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>@LocalizationService.GetString("Settings") - @LocalizationService.GetString("AppTitle")</PageTitle>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
    <FluentLabel Typo="Typography.H3">
        ⚙️ @LocalizationService.GetString("SystemSettings")
    </FluentLabel>

    @if (settingsByCategory.Any())
    {
        @foreach (var category in settingsByCategory.Keys.OrderBy(k => k))
        {
            <FluentCard Style="margin-bottom: 1.5rem;">
                <FluentLabel Typo="Typography.H5" Style="margin-bottom: 1rem;">
                    @GetCategoryDisplayName(category)
                </FluentLabel>
                <FluentStack Orientation="Orientation.Vertical">
                    @{
                        var categorySettings = settingsByCategory[category].ToList();
                    }
                    @for (var i = 0; i < categorySettings.Count; i++)
                    {
                        var setting = categorySettings[i];
                        <FluentStack Orientation="Orientation.Horizontal" 
                                     Style="@($"justify-content: space-between; align-items: center; padding: 1rem 0;{(i < categorySettings.Count - 1 ? " border-bottom: 1px solid var(--neutral-stroke-divider-rest);" : "")}")">
                            <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                                <FluentLabel Style="font-weight: 600;">@GetSettingDisplayName(setting.Key)</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">@setting.Description</FluentLabel>
                            </FluentStack>
                            <div>
                                @if (setting.Key == "language")
                                {
                                    <FluentSelect TOption="string"
                                                  Items="@(new[] { "zh-CN", "en-US" })"
                                                  OptionText="@(item => item == "zh-CN" ? LocalizationService.GetString("Language_Chinese") : LocalizationService.GetString("Language_English"))"
                                                  OptionValue="@(item => item)"
                                                  Value="@setting.Value"
                                                  ValueChanged="@(value => UpdateLanguageSetting(value ?? "zh-CN"))"
                                                  Style="width: 200px;" />
                                }
                                else if (setting.DataType == "bool")
                                {
                                    <FluentSwitch Value="@(setting.Value == "true")"
                                                  ValueChanged="@(value => UpdateSetting(setting.Key, value ? "true" : "false"))" />
                                }
                                else if (setting.DataType == "int")
                                {
                                    <FluentNumberField TValue="int"
                                                       Value="@(int.TryParse(setting.Value, out var intVal) ? intVal : 0)"
                                                       ValueChanged="@(value => UpdateSetting(setting.Key, value.ToString()))"
                                                       Style="width: 150px;" />
                                }
                                else
                                {
                                    <FluentTextField Value="@setting.Value"
                                                     ValueChanged="@(value => UpdateSetting(setting.Key, value ?? ""))"
                                                     Style="width: 250px;" />
                                }
                            </div>
                        </FluentStack>
                    }
                </FluentStack>
            </FluentCard>
        }
    }
    else
    {
        <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 3rem;">
            <FluentLabel>@LocalizationService.GetString("LoadingSettings")</FluentLabel>
        </FluentStack>
    }
    
    <!-- Network Management Section -->
    <FluentCard Style="margin-bottom: 1.5rem;">
        <NetworkManagementPanel />
    </FluentCard>
</FluentStack>

@if (showSaveMessage)
{
    <div style="position: fixed; bottom: 1rem; right: 1rem; z-index: 1000;">
        <FluentMessageBar Intent="MessageIntent.Success">
            ✓ @LocalizationService.GetString("SettingsSaved")
        </FluentMessageBar>
    </div>
}

@code {
    private Dictionary<string, List<SystemSetting>> settingsByCategory = new();
    private bool showSaveMessage = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
    }

    private async Task LoadSettingsAsync()
    {
        var allSettings = await SystemSettingService.GetAllSettingsAsync();
        settingsByCategory = allSettings
            .GroupBy(s => s.Category)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private async Task UpdateSetting(string key, string value)
    {
        try
        {
            // Find the setting to preserve category and description
            var setting = settingsByCategory.Values
                .SelectMany(s => s)
                .FirstOrDefault(s => s.Key == key);

            if (setting != null)
            {
                await SystemSettingService.SetSettingAsync(key, value, setting.Category, setting.Description);
                setting.Value = value;
                
                showSaveMessage = true;
                StateHasChanged();
                
                // Use Timer instead of Task.Delay to prevent memory leaks
                _ = Task.Run(async () =>
                {
                    await Task.Delay(2000);
                    await InvokeAsync(() =>
                    {
                        showSaveMessage = false;
                        StateHasChanged();
                    });
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating setting: {ex.Message}");
        }
    }

    private async Task UpdateLanguageSetting(string cultureName)
    {
        try
        {
            // Update the setting in database
            await SystemSettingService.SetSettingAsync("language", cultureName, "Appearance", "UI language");
            
            // Update the localization service culture
            await LocalizationService.SetCultureAsync(cultureName);
            
            // Update local state
            var setting = settingsByCategory.Values
                .SelectMany(s => s)
                .FirstOrDefault(s => s.Key == "language");
            
            if (setting != null)
            {
                setting.Value = cultureName;
            }
            
            showSaveMessage = true;
            StateHasChanged();
            
            // Reload the page to apply language changes
            _ = Task.Run(async () =>
            {
                await Task.Delay(1000);
                await InvokeAsync(() =>
                {
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                });
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating language setting: {ex.Message}");
        }
    }

    private string GetCategoryDisplayName(string category)
    {
        return category switch
        {
            "Appearance" => LocalizationService.GetString("Category_Appearance"),
            "Features" => LocalizationService.GetString("Category_Features"),
            "System" => LocalizationService.GetString("Category_System"),
            "Network" => LocalizationService.GetString("Category_Network"),
            _ => category
        };
    }

    private string GetSettingDisplayName(string key)
    {
        return key switch
        {
            "theme" => LocalizationService.GetString("Setting_Theme"),
            "language" => LocalizationService.GetString("Setting_Language"),
            "welcomeMessage" => LocalizationService.GetString("Setting_WelcomeMessage"),
            "enableWeather" => LocalizationService.GetString("Setting_EnableWeather"),
            "weatherLocation" => LocalizationService.GetString("Setting_WeatherLocation"),
            "refreshInterval" => LocalizationService.GetString("Setting_RefreshInterval"),
            "enableNotifications" => LocalizationService.GetString("Setting_EnableNotifications"),
            "anydropStoragePath" => LocalizationService.GetString("Setting_AnydropStoragePath"),
            _ => key
        };
    }
}

