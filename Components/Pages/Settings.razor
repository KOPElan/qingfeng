@page "/settings"
@using QingFeng.Services
@using QingFeng.Models
@using QingFeng.Components.Panels
@using System.Text.Json
@using Microsoft.FluentUI.AspNetCore.Components
@inherits AuthorizedPageBase
@inject ISystemSettingService SystemSettingService
@inject ILocalizationService LocalizationService
@inject IScheduledTaskService ScheduledTaskService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>@LocalizationService.GetString("Settings") - @LocalizationService.GetString("AppTitle")</PageTitle>

@if (!IsAuthorized)
{
    <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
        <FluentProgressRing />
    </FluentStack>
    return;
}

<FluentStack Orientation="Orientation.Vertical" Style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
    <FluentLabel Typo="Typography.H3">
        ⚙️ @LocalizationService.GetString("SystemSettings")
    </FluentLabel>

    @if (settingsByCategory.Any())
    {
        @foreach (var category in settingsByCategory.Keys.OrderBy(k => k))
        {
            <FluentCard Style="margin-bottom: 1.5rem;">
                <FluentLabel Typo="Typography.H5" Style="margin-bottom: 1rem;">
                    @GetCategoryDisplayName(category)
                </FluentLabel>
                <FluentStack Orientation="Orientation.Vertical">
                    @{
                        var categorySettings = settingsByCategory[category].ToList();
                    }
                    @for (var i = 0; i < categorySettings.Count; i++)
                    {
                        var setting = categorySettings[i];
                        <FluentStack Orientation="Orientation.Horizontal" 
                                     Style="@($"justify-content: space-between; align-items: center; padding: 1rem 0;{(i < categorySettings.Count - 1 ? " border-bottom: 1px solid var(--neutral-stroke-divider-rest);" : "")}")">
                            <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                                <FluentLabel Style="font-weight: 600;">@GetSettingDisplayName(setting.Key)</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint);">@setting.Description</FluentLabel>
                            </FluentStack>
                            <div>
                                @if (setting.Key == "language")
                                {
                                    <FluentSelect TOption="string"
                                                  Items="@(new[] { "zh-CN", "en-US" })"
                                                  OptionText="@(item => item == "zh-CN" ? LocalizationService.GetString("Language_Chinese") : LocalizationService.GetString("Language_English"))"
                                                  OptionValue="@(item => item)"
                                                  Value="@setting.Value"
                                                  ValueChanged="@(value => UpdateLanguageSetting(value ?? "zh-CN"))"
                                                  Style="width: 200px;" />
                                }
                                else if (setting.DataType == "bool")
                                {
                                    <FluentSwitch Value="@(setting.Value == "true")"
                                                  ValueChanged="@(value => UpdateSetting(setting.Key, value ? "true" : "false"))" />
                                }
                                else if (setting.DataType == "int")
                                {
                                    <FluentNumberField TValue="int"
                                                       Value="@(int.TryParse(setting.Value, out var intVal) ? intVal : 0)"
                                                       ValueChanged="@(value => UpdateSetting(setting.Key, value.ToString()))"
                                                       Style="width: 150px;" />
                                }
                                else
                                {
                                    <FluentTextField Value="@setting.Value"
                                                     ValueChanged="@(value => UpdateSetting(setting.Key, value ?? ""))"
                                                     Style="width: 250px;" />
                                }
                            </div>
                        </FluentStack>
                    }
                </FluentStack>
            </FluentCard>
        }
    }
    else
    {
        <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 3rem;">
            <FluentLabel>@LocalizationService.GetString("LoadingSettings")</FluentLabel>
        </FluentStack>
    }
    
    <!-- Network Management Section -->
    <FluentCard Style="margin-bottom: 1.5rem;">
        <NetworkManagementPanel />
    </FluentCard>
</FluentStack>

@if (showSaveMessage)
{
    <div style="position: fixed; bottom: 1rem; right: 1rem; z-index: 1000;">
        <FluentMessageBar Intent="MessageIntent.Success">
            ✓ @LocalizationService.GetString("SettingsSaved")
        </FluentMessageBar>
    </div>
}

<!-- Anydrop Migration Confirmation Dialog -->
<FluentDialog Hidden="@(!showAnydropMigrationDialog)" Modal="true" OnDismiss="CancelAnydropMigration" Style="min-width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">确认Anydrop目录迁移</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
            <FluentMessageBar Intent="MessageIntent.Warning">
                <strong>⚠️ 重要提示</strong>
            </FluentMessageBar>
            <FluentLabel>
                您正在更改Anydrop附件存储目录：
            </FluentLabel>
            <FluentStack Orientation="Orientation.Vertical" Style="gap: 0.5rem; padding: 1rem; background: var(--neutral-layer-2); border-radius: 8px;">
                <FluentLabel Style="font-weight: 600;">原目录：</FluentLabel>
                <FluentLabel Style="font-family: monospace;">@oldAnydropPath</FluentLabel>
                <FluentLabel Style="font-weight: 600; margin-top: 0.5rem;">新目录：</FluentLabel>
                <FluentLabel Style="font-family: monospace;">@newAnydropPath</FluentLabel>
            </FluentStack>
            <FluentLabel>
                所有现有文件将被迁移到新目录。此过程将在后台执行，您可以在定时任务页面查看迁移进度。
            </FluentLabel>
            <FluentLabel Style="color: var(--neutral-foreground-hint); font-size: 0.9rem;">
                注意：迁移完成前，请不要修改或删除原目录中的文件。
            </FluentLabel>
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CancelAnydropMigration">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="ConfirmAnydropMigration">确认并开始迁移</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private Dictionary<string, List<SystemSetting>> settingsByCategory = new();
    private bool showSaveMessage = false;
    private bool showAnydropMigrationDialog = false;
    private string oldAnydropPath = string.Empty;
    private string newAnydropPath = string.Empty;
    private string pendingAnydropPathKey = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
    }

    private async Task LoadSettingsAsync()
    {
        var allSettings = await SystemSettingService.GetAllSettingsAsync();
        settingsByCategory = allSettings
            .GroupBy(s => s.Category)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private async Task UpdateSetting(string key, string value)
    {
        try
        {
            // Special handling for anydropStoragePath change
            if (key == "anydropStoragePath")
            {
                var setting = settingsByCategory.Values
                    .SelectMany(s => s)
                    .FirstOrDefault(s => s.Key == key);
                
                if (setting != null && setting.Value != value)
                {
                    // Store the old and new paths
                    oldAnydropPath = setting.Value;
                    newAnydropPath = value;
                    pendingAnydropPathKey = key;
                    
                    // Show confirmation dialog
                    showAnydropMigrationDialog = true;
                    StateHasChanged();
                    return; // Don't save yet, wait for confirmation
                }
            }
            
            // Find the setting to preserve category and description
            var setting2 = settingsByCategory.Values
                .SelectMany(s => s)
                .FirstOrDefault(s => s.Key == key);

            if (setting2 != null)
            {
                await SystemSettingService.SetSettingAsync(key, value, setting2.Category, setting2.Description);
                setting2.Value = value;
                
                showSaveMessage = true;
                StateHasChanged();
                
                // Use Timer instead of Task.Delay to prevent memory leaks
                _ = Task.Run(async () =>
                {
                    await Task.Delay(2000);
                    await InvokeAsync(() =>
                    {
                        showSaveMessage = false;
                        StateHasChanged();
                    });
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating setting: {ex.Message}");
        }
    }

    private async Task UpdateLanguageSetting(string cultureName)
    {
        try
        {
            // Update the setting in database
            await SystemSettingService.SetSettingAsync("language", cultureName, "Appearance", "UI language");
            
            // Update the localization service culture
            await LocalizationService.SetCultureAsync(cultureName);
            
            // Update local state
            var setting = settingsByCategory.Values
                .SelectMany(s => s)
                .FirstOrDefault(s => s.Key == "language");
            
            if (setting != null)
            {
                setting.Value = cultureName;
            }
            
            showSaveMessage = true;
            StateHasChanged();
            
            // Reload the page to apply language changes
            _ = Task.Run(async () =>
            {
                await Task.Delay(1000);
                await InvokeAsync(() =>
                {
                    NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
                });
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating language setting: {ex.Message}");
        }
    }

    private void CancelAnydropMigration()
    {
        showAnydropMigrationDialog = false;
        oldAnydropPath = string.Empty;
        newAnydropPath = string.Empty;
        pendingAnydropPathKey = string.Empty;
        
        // Reload settings to reset the UI
        _ = LoadSettingsAsync();
    }

    private async Task ConfirmAnydropMigration()
    {
        try
        {
            // Create migration task
            var config = new AnydropMigrationConfig
            {
                SourceDirectory = oldAnydropPath,
                DestinationDirectory = newAnydropPath
            };
            var configJson = JsonSerializer.Serialize(config);
            
            var task = new ScheduledTask
            {
                Name = $"Anydrop文件迁移",
                Description = $"从 {oldAnydropPath} 迁移到 {newAnydropPath}",
                TaskType = "AnydropMigration",
                Configuration = configJson,
                IsEnabled = true,
                IsOneTime = true,
                IntervalMinutes = 0
            };
            
            var createdTask = await ScheduledTaskService.CreateTaskAsync(task);
            
            // Update the setting
            var setting = settingsByCategory.Values
                .SelectMany(s => s)
                .FirstOrDefault(s => s.Key == pendingAnydropPathKey);
                
            if (setting != null)
            {
                await SystemSettingService.SetSettingAsync(pendingAnydropPathKey, newAnydropPath, setting.Category, setting.Description);
                setting.Value = newAnydropPath;
            }
            
            // Trigger immediate execution
            await ScheduledTaskService.RunTaskNowAsync(createdTask.Id);
            
            showAnydropMigrationDialog = false;
            showSaveMessage = true;
            StateHasChanged();
            
            // Reset temp variables
            oldAnydropPath = string.Empty;
            newAnydropPath = string.Empty;
            pendingAnydropPathKey = string.Empty;
            
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                await InvokeAsync(() =>
                {
                    showSaveMessage = false;
                    StateHasChanged();
                });
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating migration task: {ex.Message}");
            showAnydropMigrationDialog = false;
        }
    }

    private string GetCategoryDisplayName(string category)
    {
        return category switch
        {
            "Appearance" => LocalizationService.GetString("Category_Appearance"),
            "Features" => LocalizationService.GetString("Category_Features"),
            "System" => LocalizationService.GetString("Category_System"),
            "Network" => LocalizationService.GetString("Category_Network"),
            _ => category
        };
    }

    private string GetSettingDisplayName(string key)
    {
        return key switch
        {
            "theme" => LocalizationService.GetString("Setting_Theme"),
            "language" => LocalizationService.GetString("Setting_Language"),
            "welcomeMessage" => LocalizationService.GetString("Setting_WelcomeMessage"),
            "enableWeather" => LocalizationService.GetString("Setting_EnableWeather"),
            "weatherLocation" => LocalizationService.GetString("Setting_WeatherLocation"),
            "refreshInterval" => LocalizationService.GetString("Setting_RefreshInterval"),
            "enableNotifications" => LocalizationService.GetString("Setting_EnableNotifications"),
            "anydropStoragePath" => LocalizationService.GetString("Setting_AnydropStoragePath"),
            _ => key
        };
    }
}

