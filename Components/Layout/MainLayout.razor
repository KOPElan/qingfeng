@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@implements IDisposable
@using QingFeng.Utilities

@if (_isHomePage)
{
    @Body
}
else
{
    <div class="d-flex" style="min-height: 100vh;">
        <!-- Sidebar -->
        <div class="sidebar-custom @(_drawerOpen ? "" : "collapsed")" style="width: 250px; position: fixed; left: 0; top: 0; height: 100vh; z-index: 1030;">
            <div class="p-3">
                <h5 class="text-white mb-4">My Portal</h5>
                <NavMenu />
            </div>
        </div>

        <!-- Main content area -->
        <div class="flex-grow-1" style="margin-left: @(_drawerOpen ? "250px" : "0"); transition: margin-left 0.3s ease;">
            <!-- App Bar -->
            <div class="app-bar-custom">
                <button class="btn btn-link text-white" @onclick="ToggleDrawer" title="Toggle menu">
                    <i class="@Icons.Material.Filled.Menu" style="font-size: 1.5rem;"></i>
                </button>
                <div class="flex-grow-1"></div>
                <button class="btn btn-link text-white tooltip-custom" @onclick="ToggleDarkMode" title="切换主题">
                    <i class="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" style="font-size: 1.5rem;"></i>
                    <span class="tooltip-text">切换主题</span>
                </button>
            </div>

            <!-- Page content -->
            <div class="container-fluid p-4" style="max-width: 1400px;">
                @Body
            </div>
        </div>
    </div>
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private bool _isHomePage = false;

    protected override void OnInitialized()
    {
        UpdateIsHomePage();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateIsHomePage();
        StateHasChanged();
    }

    private void UpdateIsHomePage()
    {
        _isHomePage = NavigationManager.ToBaseRelativePath(NavigationManager.Uri) == string.Empty;
    }

    private async Task ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
        await JS.InvokeVoidAsync("drawerManager.toggle");
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        await JS.InvokeVoidAsync("themeManager.toggle");
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
