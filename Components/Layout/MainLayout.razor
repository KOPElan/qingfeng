@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@implements IDisposable
@using QingFeng.Services
@inject IAuthenticationService AuthService

<FluentDesignTheme @bind-Mode="@_mode" 
                   @bind-OfficeColor="@_officeColor"
                   StorageName="theme" />

@if (_isAuthPage)
{
    @* Simple layout for login and setup pages *@
    @Body
}
else if (_isHomePage)
{
    @Body
    <!-- Navigation Dock on homepage -->
    <NavMenu />
}
else
{
    <FluentLayout>
        <!-- Background Gradient Blobs for all pages -->
        <div class="gradient-bg">
            <div class="gradient-blob gradient-blob-1"></div>
            <div class="gradient-blob gradient-blob-2"></div>
            <div class="gradient-blob gradient-blob-3"></div>
        </div>

        <FluentHeader>
            <div class="header-brand">
                <FluentLabel Typo="Typography.H5">🖥️ 个人门户</FluentLabel>
            </div>
            <FluentSpacer />
            <div class="header-actions">
                @if (!string.IsNullOrEmpty(_currentUsername))
                {
                    <FluentLabel>@_currentUsername</FluentLabel>
                    <FluentButton Appearance="Appearance.Lightweight" 
                                 OnClick="Logout" 
                                 Title="退出登录" 
                                 aria-label="退出登录">退出</FluentButton>
                }
                <FluentButton Appearance="Appearance.Lightweight" 
                             OnClick="ToggleDarkMode" 
                             Title="切换主题 (Light/Dark/System)" 
                             aria-label="切换主题 Light Dark System">
                    @(_mode switch 
                    {
                        DesignThemeModes.Light => "☀️",
                        DesignThemeModes.Dark => "🌙",
                        DesignThemeModes.System => "💻",
                        _ => "💻"
                    })
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" 
                             OnClick="NavigateToSettings" 
                             Title="设置" 
                             aria-label="设置">⚙️</FluentButton>
            </div>
        </FluentHeader>

        <FluentBodyContent>
            <div class="content-wrapper">
                @Body
            </div>
        </FluentBodyContent>

        <FluentFooter>
            © @DateTime.Now.Year 个人家庭实验室门户. Designed for efficiency.
        </FluentFooter>

        <!-- Navigation Dock -->
        <NavMenu />
    </FluentLayout>
}

<!-- Fluent UI Providers -->
<FluentDialogProvider />
<FluentToastProvider />
<FluentTooltipProvider />
<FluentMessageBarProvider />

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private DesignThemeModes _mode = DesignThemeModes.System;
    private OfficeColor? _officeColor = OfficeColor.Default;
    private bool _isHomePage = false;
    private bool _isAuthPage = false;
    private string? _currentUsername;

    protected override async Task OnInitializedAsync()
    {
        UpdateIsHomePage();
        UpdateIsAuthPage();
        NavigationManager.LocationChanged += OnLocationChanged;
        await UpdateCurrentUserAsync();
    }

    private async Task UpdateCurrentUserAsync()
    {
        var currentUser = await AuthService.GetCurrentUserAsync();
        _currentUsername = currentUser?.Username;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateIsHomePage();
        UpdateIsAuthPage();
        await UpdateCurrentUserAsync();
        StateHasChanged();
    }

    private void UpdateIsHomePage()
    {
        var path = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        _isHomePage = string.IsNullOrEmpty(path) || path.Equals("/", StringComparison.OrdinalIgnoreCase);
    }

    private void UpdateIsAuthPage()
    {
        var path = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        _isAuthPage = path.StartsWith("login", StringComparison.OrdinalIgnoreCase) || 
                      path.StartsWith("initial-setup", StringComparison.OrdinalIgnoreCase);
    }

    private void ToggleDarkMode()
    {
        _mode = _mode switch
        {
            DesignThemeModes.Light => DesignThemeModes.Dark,
            DesignThemeModes.Dark => DesignThemeModes.System,
            DesignThemeModes.System => DesignThemeModes.Light,
            _ => DesignThemeModes.Light
        };
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }

    private void NavigateToSettings()
    {
        NavigationManager.NavigateTo("/settings");
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
