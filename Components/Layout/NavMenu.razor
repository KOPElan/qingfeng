@using QingFeng.Utilities
@using QingFeng.Services
@using QingFeng.Models
@inject NavigationManager NavigationManager
@inject IDockItemService DockItemService
@implements IDisposable

<!-- Dock-style Navigation Menu -->
<div class="bottom-dock">
    <div class="dock-container">
        @foreach (var item in dockItems)
        {
            if (item.IsSystemItem && item.ItemId == "home")
            {
                <NavLink href="@item.Url" Match="NavLinkMatch.All" class="dock-item">
                    <div class="dock-icon-bg" style="background: @item.IconBackground;">
                        <span class="material-symbols-outlined" style="font-size: 28px; color: @item.IconColor;">@item.Icon</span>
                    </div>
                    <span class="dock-tooltip">@item.Title</span>
                    <div class="dock-indicator @(IsActive(item.Url) ? "" : "inactive")"></div>
                </NavLink>
            }
            else if (item.ItemId == "system-monitor")
            {
                <NavLink href="@item.Url" class="dock-item">
                    <div class="dock-icon-bg" style="background: @item.IconBackground;">
                        <span class="material-symbols-outlined" style="font-size: 28px; color: @item.IconColor;">@item.Icon</span>
                    </div>
                    <span class="dock-tooltip">@item.Title</span>
                    <div class="dock-indicator @(IsActive(item.Url) ? "" : "inactive")"></div>
                </NavLink>
            }
            else
            {
                <NavLink href="@item.Url" class="dock-item">
                    <div class="dock-icon-bg" style="background: @item.IconBackground;">
                        <span class="material-symbols-outlined" style="font-size: 28px; color: @item.IconColor;">@item.Icon</span>
                    </div>
                    <span class="dock-tooltip">@item.Title</span>
                    <div class="dock-indicator @(IsActive(item.Url) ? "" : "inactive")"></div>
                </NavLink>
            }
        }
        
        <!-- Add dock item button -->
        <button class="dock-item add-dock-btn" @onclick="NavigateToDockManagement" title="管理 Dock">
            <div class="dock-icon-bg" style="background: rgba(255, 255, 255, 0.1);">
                <span class="material-symbols-outlined" style="font-size: 28px; color: white;">add</span>
            </div>
            <span class="dock-tooltip">添加</span>
        </button>
    </div>
</div>

@code {
    private List<DockItem> dockItems = new();
    private Timer? refreshTimer;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDockItemsAsync();
        NavigationManager.LocationChanged += OnLocationChanged;
        
        // Refresh dock items periodically
        refreshTimer = new Timer(async _ => await InvokeAsync(async () =>
        {
            await LoadDockItemsAsync();
            StateHasChanged();
        }), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }
    
    private async Task LoadDockItemsAsync()
    {
        dockItems = await DockItemService.GetAllDockItemsAsync();
    }
    
    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }
    
    private bool IsActive(string href)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        if (href == "/")
        {
            return string.IsNullOrEmpty(relativePath);
        }
        return relativePath.StartsWith(href.TrimStart('/'));
    }
    
    private void NavigateToDockManagement()
    {
        NavigationManager.NavigateTo("/dock-management");
    }
    
    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        refreshTimer?.Dispose();
    }
}
