@using QingFeng.Utilities
@using QingFeng.Services
@using QingFeng.Models
@inject NavigationManager NavigationManager
@inject IDockItemService DockItemService
@inject ILocalizationService LocalizationService
@implements IDisposable

<!-- Dock-style Navigation Menu -->
<div style="position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 50; width: auto; max-width: 90vw;">
    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem 2rem; background: var(--neutral-layer-floating); backdrop-filter: blur(12px); border: 1px solid var(--neutral-stroke-layer-rest); border-radius: 3rem; box-shadow: var(--elevation-shadow-flyout); transition: all 0.3s ease;">
        @foreach (var item in dockItems)
        {
            if (item.IsSystemItem && item.ItemId == "home")
            {
                <NavLink href="@item.Url" Match="NavLinkMatch.All" style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; min-width: 3rem; text-decoration: none; background: none; border: none; padding: 0; cursor: pointer;">
                    <div style="width: 60px; height: 60px; border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; background: @item.IconBackground; box-shadow: var(--elevation-shadow-card-rest); transition: all 0.3s ease; border: 1px solid var(--neutral-stroke-layer-rest);">
                        <span class="material-symbols-outlined" style="font-size: 32px; color: @item.IconColor;">@item.Icon</span>
                    </div>
                    <div style="position: absolute; top: -3rem; transform: scale(0); transition: all 0.2s; background: var(--neutral-layer-card-container); backdrop-filter: blur(12px); color: var(--neutral-foreground-rest); font-size: 0.6875rem; font-weight: 700; padding: 0.5rem 0.75rem; border-radius: 0.75rem; white-space: nowrap; opacity: 0; box-shadow: var(--elevation-shadow-flyout); border: 1px solid var(--neutral-stroke-layer-rest);">@item.Title</div>
                    <div style="width: 0.25rem; height: 0.25rem; border-radius: 50%; background: @(IsActive(item.Url) ? "var(--accent-fill-rest)" : "transparent"); box-shadow: @(IsActive(item.Url) ? "0 0 8px var(--accent-fill-rest)" : "none"); margin-top: 0.5rem;"></div>
                </NavLink>
            }
            else if (item.ItemId == "system-monitor")
            {
                <NavLink href="@item.Url" style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; min-width: 3rem; text-decoration: none; background: none; border: none; padding: 0; cursor: pointer;">
                    <div style="width: 60px; height: 60px; border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; background: @item.IconBackground; box-shadow: var(--elevation-shadow-card-rest); transition: all 0.3s ease; border: 1px solid var(--neutral-stroke-layer-rest);">
                        <span class="material-symbols-outlined" style="font-size: 32px; color: @item.IconColor;">@item.Icon</span>
                    </div>
                    <div style="position: absolute; top: -3rem; transform: scale(0); transition: all 0.2s; background: var(--neutral-layer-card-container); backdrop-filter: blur(12px); color: var(--neutral-foreground-rest); font-size: 0.6875rem; font-weight: 700; padding: 0.5rem 0.75rem; border-radius: 0.75rem; white-space: nowrap; opacity: 0; box-shadow: var(--elevation-shadow-flyout); border: 1px solid var(--neutral-stroke-layer-rest);">@item.Title</div>
                    <div style="width: 0.25rem; height: 0.25rem; border-radius: 50%; background: @(IsActive(item.Url) ? "var(--accent-fill-rest)" : "transparent"); box-shadow: @(IsActive(item.Url) ? "0 0 8px var(--accent-fill-rest)" : "none"); margin-top: 0.5rem;"></div>
                </NavLink>
            }
            else
            {
                <NavLink href="@item.Url" style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; min-width: 3rem; text-decoration: none; background: none; border: none; padding: 0; cursor: pointer;">
                    <div style="width: 60px; height: 60px; border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; background: @item.IconBackground; box-shadow: var(--elevation-shadow-card-rest); transition: all 0.3s ease; border: 1px solid var(--neutral-stroke-layer-rest);">
                        <span class="material-symbols-outlined" style="font-size: 32px; color: @item.IconColor;">@item.Icon</span>
                    </div>
                    <div style="position: absolute; top: -3rem; transform: scale(0); transition: all 0.2s; background: var(--neutral-layer-card-container); backdrop-filter: blur(12px); color: var(--neutral-foreground-rest); font-size: 0.6875rem; font-weight: 700; padding: 0.5rem 0.75rem; border-radius: 0.75rem; white-space: nowrap; opacity: 0; box-shadow: var(--elevation-shadow-flyout); border: 1px solid var(--neutral-stroke-layer-rest);">@item.Title</div>
                    <div style="width: 0.25rem; height: 0.25rem; border-radius: 50%; background: @(IsActive(item.Url) ? "var(--accent-fill-rest)" : "transparent"); box-shadow: @(IsActive(item.Url) ? "0 0 8px var(--accent-fill-rest)" : "none"); margin-top: 0.5rem;"></div>
                </NavLink>
            }
        }
        
        <!-- Add dock item button -->
        <button @onclick="NavigateToDockManagement" title="@LocalizationService.GetString("ManageDock")" style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; min-width: 3rem; text-decoration: none; background: none; border: none; padding: 0; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;">
            <div style="width: 60px; height: 60px; border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; background: var(--neutral-fill-stealth-rest); box-shadow: var(--elevation-shadow-card-rest); transition: all 0.3s ease; border: 1px solid var(--neutral-stroke-layer-rest);">
                <span class="material-symbols-outlined" style="font-size: 32px; color: var(--neutral-foreground-rest);">add</span>
            </div>
            <div style="position: absolute; top: -3rem; transform: scale(0); transition: all 0.2s; background: var(--neutral-layer-card-container); backdrop-filter: blur(12px); color: var(--neutral-foreground-rest); font-size: 0.6875rem; font-weight: 700; padding: 0.5rem 0.75rem; border-radius: 0.75rem; white-space: nowrap; opacity: 0; box-shadow: var(--elevation-shadow-flyout); border: 1px solid var(--neutral-stroke-layer-rest);">@LocalizationService.GetString("Add")</div>
        </button>
    </div>
</div>

<style>
    /* Hover effects for dock items */
    a[style*="dock-item"]:hover > div:first-child,
    button[style*="dock-item"]:hover > div:first-child {
        transform: scale(1.1) translateY(-0.75rem);
    }
    
    a[style*="dock-item"]:hover > div:nth-child(2),
    button[style*="dock-item"]:hover > div:nth-child(2) {
        transform: scale(1);
        opacity: 1;
    }
    
    button[style*="dock-item"]:hover {
        opacity: 1;
    }
</style>

@code {
    private List<DockItem> dockItems = new();
    private Timer? refreshTimer;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDockItemsAsync();
        NavigationManager.LocationChanged += OnLocationChanged;
        
        // Refresh dock items periodically
        refreshTimer = new Timer(async _ => await InvokeAsync(async () =>
        {
            await LoadDockItemsAsync();
            StateHasChanged();
        }), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }
    
    private async Task LoadDockItemsAsync()
    {
        dockItems = await DockItemService.GetAllDockItemsAsync();
    }
    
    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }
    
    private bool IsActive(string href)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        if (href == "/")
        {
            return string.IsNullOrEmpty(relativePath);
        }
        return relativePath.StartsWith(href.TrimStart('/'));
    }
    
    private void NavigateToDockManagement()
    {
        NavigationManager.NavigateTo("/dock-management");
    }
    
    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        refreshTimer?.Dispose();
    }
}
