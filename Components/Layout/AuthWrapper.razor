@using QingFeng.Services
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

@if (isChecking)
{
    <div class="loading-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    @ChildContent
}

@code {
    [Parameter]
    public RenderFragment ChildContent { get; set; } = default!;
    
    private bool isChecking = true;

    protected override async Task OnInitializedAsync()
    {
        // Skip check for initial-setup and login pages
        var currentPath = Navigation.ToBaseRelativePath(Navigation.Uri).ToLower();
        if (currentPath.StartsWith("initial-setup") || currentPath.StartsWith("login"))
        {
            isChecking = false;
            return;
        }

        // Check if admin user exists
        var hasAdmin = await AuthService.HasAdminUserAsync();
        if (!hasAdmin)
        {
            // No admin exists, redirect to initial setup
            Navigation.NavigateTo("/initial-setup", forceLoad: true);
            return;
        }

        // Check if user is logged in
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser == null)
        {
            // Not logged in, redirect to login
            var returnUrl = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/login?returnUrl={returnUrl}", forceLoad: true);
            return;
        }

        isChecking = false;
    }
}
