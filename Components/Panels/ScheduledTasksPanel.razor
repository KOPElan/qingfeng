@using QingFeng.Services
@using QingFeng.Models
@using Microsoft.FluentUI.AspNetCore.Components
@using Icon = Microsoft.FluentUI.AspNetCore.Components.Icon
@using System.Text.Json
@inject IScheduledTaskService ScheduledTaskService
@inject ILogger<ScheduledTasksPanel> Logger

<FluentStack Orientation="Orientation.Vertical" Style="gap: 1rem;">
    <FluentStack Orientation="Orientation.Horizontal" Style="justify-content: space-between; align-items: center;">
        <FluentLabel Typo="Typography.H5">定时任务管理</FluentLabel>
        <FluentButton Appearance="Appearance.Accent" OnClick="ShowCreateTaskDialog">
            <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Add())" />
            新建任务
        </FluentButton>
    </FluentStack>

    @if (tasks == null)
    {
        <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 2rem;">
            <FluentProgressRing />
        </FluentStack>
    }
    else if (!tasks.Any())
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            暂无定时任务，点击"新建任务"创建第一个任务
        </FluentMessageBar>
    }
    else
    {
        <FluentDataGrid Items="@tasks.AsQueryable()" Style="width: 100%;">
            <PropertyColumn Property="@(t => t.Name)" Title="任务名称" />
            <TemplateColumn Title="任务类型">
                <FluentBadge Appearance="Appearance.Neutral">
                    @GetTaskTypeDisplay(context.TaskType)
                </FluentBadge>
            </TemplateColumn>
            <TemplateColumn Title="执行频率">
                @if (context.IntervalMinutes >= 1440)
                {
                    <span>@(context.IntervalMinutes / 1440) 天</span>
                }
                else if (context.IntervalMinutes >= 60)
                {
                    <span>@(context.IntervalMinutes / 60) 小时</span>
                }
                else
                {
                    <span>@context.IntervalMinutes 分钟</span>
                }
            </TemplateColumn>
            <TemplateColumn Title="状态">
                <FluentBadge Appearance="@GetStatusAppearance(context.Status)">
                    @GetStatusDisplay(context.Status)
                </FluentBadge>
            </TemplateColumn>
            <TemplateColumn Title="最后运行">
                @(context.LastRunTime?.ToLocalTime().ToString("MM-dd HH:mm") ?? "未运行")
            </TemplateColumn>
            <TemplateColumn Title="下次运行">
                @(context.NextRunTime?.ToLocalTime().ToString("MM-dd HH:mm") ?? "-")
            </TemplateColumn>
            <TemplateColumn Title="启用">
                <FluentSwitch Value="@context.IsEnabled"
                              ValueChanged="@(value => ToggleTaskEnabled(context.Id, value))" />
            </TemplateColumn>
            <TemplateColumn Title="操作">
                <FluentButton Appearance="Appearance.Stealth" 
                              IconOnly="true"
                              OnClick="@(() => RunTaskNow(context.Id))" 
                              Title="立即运行"
                              Disabled="@(context.Status == "Running")">
                    <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Play())" />
                </FluentButton>
                <FluentButton Appearance="Appearance.Stealth" 
                              IconOnly="true"
                              OnClick="@(() => ShowEditTaskDialog(context))" 
                              Title="编辑">
                    <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Edit())" />
                </FluentButton>
                <FluentButton Appearance="Appearance.Stealth" 
                              IconOnly="true"
                              OnClick="@(() => DeleteTask(context.Id))" 
                              Title="删除"
                              Style="color: var(--error);">
                    <FluentIcon Value="@((Icon)new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Delete())" />
                </FluentButton>
            </TemplateColumn>
        </FluentDataGrid>
    }
</FluentStack>

<!-- Create/Edit Task Dialog -->
<FluentDialog Hidden="@(!showTaskDialog)" Modal="true" OnDismiss="CloseTaskDialog" Style="min-width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H5">@(editingTask == null ? "新建定时任务" : "编辑定时任务")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>任务名称</FluentLabel>
            <FluentTextField @bind-Value="taskName" Placeholder="输入任务名称" Style="width: 100%;" />
            
            <FluentLabel>任务描述</FluentLabel>
            <FluentTextArea @bind-Value="taskDescription" Placeholder="输入任务描述（可选）" Style="width: 100%;" Rows="2" />
            
            <FluentLabel>任务类型</FluentLabel>
            <FluentSelect TOption="string"
                          Items="@(new[] { "FileIndexing" })"
                          OptionText="@GetTaskTypeDisplay"
                          OptionValue="@(item => item)"
                          @bind-Value="taskType"
                          Style="width: 100%;"
                          Disabled="@(editingTask != null)" />
            
            @if (taskType == "FileIndexing")
            {
                <FluentLabel>索引目录</FluentLabel>
                <FluentTextField @bind-Value="taskConfigRootPath" Placeholder="输入要索引的目录路径" Style="width: 100%;" />
            }
            
            <FluentLabel>执行频率（分钟）</FluentLabel>
            <FluentNumberField TValue="int" @bind-Value="taskInterval" Min="1" Style="width: 100%;" />
            <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">
                提示：60分钟 = 1小时，1440分钟 = 1天
            </FluentLabel>
            
            <FluentCheckbox @bind-Value="taskEnabled">启用任务</FluentCheckbox>
            
            @if (!string.IsNullOrEmpty(taskDialogMessage))
            {
                <FluentMessageBar Intent="@(taskDialogSuccess ? MessageIntent.Success : MessageIntent.Error)">
                    @taskDialogMessage
                </FluentMessageBar>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="CloseTaskDialog">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="SaveTask">保存</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<ScheduledTask>? tasks;
    private bool showTaskDialog = false;
    private ScheduledTask? editingTask = null;
    
    // Task dialog state
    private string taskName = string.Empty;
    private string taskDescription = string.Empty;
    private string taskType = "FileIndexing";
    private string taskConfigRootPath = string.Empty;
    private int taskInterval = 1440; // Default: 1 day
    private bool taskEnabled = true;
    private string taskDialogMessage = string.Empty;
    private bool taskDialogSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTasksAsync();
    }

    private async Task LoadTasksAsync()
    {
        try
        {
            tasks = await ScheduledTaskService.GetAllTasksAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "加载定时任务失败");
            tasks = new List<ScheduledTask>();
        }
    }

    private void ShowCreateTaskDialog()
    {
        editingTask = null;
        taskName = string.Empty;
        taskDescription = string.Empty;
        taskType = "FileIndexing";
        taskConfigRootPath = "/";
        taskInterval = 1440;
        taskEnabled = true;
        taskDialogMessage = string.Empty;
        taskDialogSuccess = false;
        showTaskDialog = true;
    }

    private void ShowEditTaskDialog(ScheduledTask task)
    {
        editingTask = task;
        taskName = task.Name;
        taskDescription = task.Description;
        taskType = task.TaskType;
        taskInterval = task.IntervalMinutes;
        taskEnabled = task.IsEnabled;
        taskDialogMessage = string.Empty;
        taskDialogSuccess = false;
        
        // Parse configuration
        if (task.TaskType == "FileIndexing" && !string.IsNullOrEmpty(task.Configuration))
        {
            try
            {
                var config = JsonSerializer.Deserialize<FileIndexingConfig>(task.Configuration);
                taskConfigRootPath = config?.RootPath ?? "/";
            }
            catch
            {
                taskConfigRootPath = "/";
            }
        }
        
        showTaskDialog = true;
    }

    private void CloseTaskDialog()
    {
        showTaskDialog = false;
        editingTask = null;
        taskDialogMessage = string.Empty;
        taskDialogSuccess = false;
    }

    private async Task SaveTask()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(taskName))
            {
                taskDialogMessage = "请输入任务名称";
                taskDialogSuccess = false;
                return;
            }

            if (taskInterval < 1)
            {
                taskDialogMessage = "执行频率必须大于0";
                taskDialogSuccess = false;
                return;
            }

            // Build configuration
            string configuration = string.Empty;
            if (taskType == "FileIndexing")
            {
                if (string.IsNullOrWhiteSpace(taskConfigRootPath))
                {
                    taskDialogMessage = "请输入索引目录";
                    taskDialogSuccess = false;
                    return;
                }
                
                var config = new FileIndexingConfig { RootPath = taskConfigRootPath };
                configuration = JsonSerializer.Serialize(config);
            }

            if (editingTask == null)
            {
                // Create new task
                var newTask = new ScheduledTask
                {
                    Name = taskName,
                    Description = taskDescription,
                    TaskType = taskType,
                    Configuration = configuration,
                    IntervalMinutes = taskInterval,
                    IsEnabled = taskEnabled
                };
                
                await ScheduledTaskService.CreateTaskAsync(newTask);
                taskDialogMessage = "任务创建成功";
            }
            else
            {
                // Update existing task
                editingTask.Name = taskName;
                editingTask.Description = taskDescription;
                editingTask.TaskType = taskType;
                editingTask.Configuration = configuration;
                editingTask.IntervalMinutes = taskInterval;
                editingTask.IsEnabled = taskEnabled;
                
                await ScheduledTaskService.UpdateTaskAsync(editingTask);
                taskDialogMessage = "任务更新成功";
            }
            
            taskDialogSuccess = true;
            
            // Reload tasks
            await LoadTasksAsync();
            
            // Close dialog after delay
            await Task.Delay(1000);
            CloseTaskDialog();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "保存任务失败");
            taskDialogMessage = $"保存失败: {ex.Message}";
            taskDialogSuccess = false;
        }
    }

    private async Task ToggleTaskEnabled(int taskId, bool enabled)
    {
        try
        {
            await ScheduledTaskService.SetTaskEnabledAsync(taskId, enabled);
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "切换任务状态失败");
        }
    }

    private async Task RunTaskNow(int taskId)
    {
        try
        {
            await ScheduledTaskService.RunTaskNowAsync(taskId);
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "运行任务失败");
        }
    }

    private async Task DeleteTask(int taskId)
    {
        try
        {
            await ScheduledTaskService.DeleteTaskAsync(taskId);
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "删除任务失败");
        }
    }

    private string GetTaskTypeDisplay(string taskType)
    {
        return taskType switch
        {
            "FileIndexing" => "文件索引",
            _ => taskType
        };
    }

    private string GetStatusDisplay(string status)
    {
        return status switch
        {
            "Idle" => "空闲",
            "Running" => "运行中",
            "Completed" => "已完成",
            "Failed" => "失败",
            _ => status
        };
    }

    private Appearance GetStatusAppearance(string status)
    {
        return status switch
        {
            "Running" => Appearance.Accent,
            "Completed" => Appearance.Accent,
            "Failed" => Appearance.Neutral,
            _ => Appearance.Neutral
        };
    }

    private class FileIndexingConfig
    {
        public string RootPath { get; set; } = string.Empty;
    }
}
